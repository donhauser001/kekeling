# é™ªè¯Šå‘˜èµ„é‡‘åŸŸæ€»è®¾è®¡å›¾

> **ç‰ˆæœ¬**: v2.0  
> **æœ€åæ›´æ–°**: 2025-12-13  
> **å…³è”æ–‡æ¡£**: [02-APIæ¥å£å¥‘çº¦.md](./02-APIæ¥å£å¥‘çº¦.md) Â· [03-ä»»åŠ¡å¡æ‹†è§£.md](./03-ä»»åŠ¡å¡æ‹†è§£.md) Â· [04-P2å®¡æ ¸æ‰“æ¬¾è®¾è®¡.md](./04-P2å®¡æ ¸æ‰“æ¬¾è®¾è®¡.md) Â· [07-å®‰å…¨å®¡è®¡æŠ¥å‘Š.md](./07-å®‰å…¨å®¡è®¡æŠ¥å‘Š.md)

---

## ç›®æ ‡

æŠŠ"æç°ç›¸å…³çš„ä¸€åˆ‡"æ”¶æ•›æˆä¸€ä¸ª**å¯æ‰©å±•ã€å¯å®¡è®¡ã€ä½é£é™©**çš„èµ„é‡‘åŸŸã€‚

## è¾¹ç•ŒåŸåˆ™ï¼ˆä¸‰æ¡é“å¾‹ï¼‰

| # | åŸåˆ™ | è¯´æ˜ |
|---|------|------|
| 1 | **ç»ˆç«¯åªå‘èµ·ï¼Œä¸è£å†³** | é™ªè¯Šå‘˜ç«¯æ°¸è¿œä¸èƒ½æ”¹æç°çŠ¶æ€ |
| 2 | **åå°æ˜¯èµ„é‡‘çœŸç›¸æº** | çŠ¶æ€æœºã€æ‰“æ¬¾ã€å¤±è´¥åŸå› ã€å®¡è®¡æ—¥å¿—å…¨éƒ¨åœ¨ Admin åŸŸ |
| 3 | **å¼ºçŠ¶æ€æœº + å¼ºå®¡è®¡** | ä»»ä½•èµ„é‡‘åŠ¨ä½œå¿…é¡»å¯è¿½æº¯ |

---

## 1. é¢†åŸŸè¾¹ç•Œä¸é€šé“

### Bounded Context

| Context | è´£ä»» | Token/é€šé“ | å†™æƒé™ |
|---------|------|------------|--------|
| **Escort App**<br>ï¼ˆé™ªè¯Šå‘˜å·¥ä½œå°ï¼‰ | å‘èµ·æç°ã€æŸ¥çœ‹è‡ªå·±çš„æç°è®°å½• | `escortRequest`<br>`/escort-app/**` | âŒ ç¦æ­¢å†™å…¥æç°çŠ¶æ€ |
| **Admin Console**<br>ï¼ˆç³»ç»Ÿåå°ï¼‰ | å®¡æ ¸ã€æ‰“æ¬¾ã€å¯¼å‡ºã€æŸ¥è¯¢ä»»æ„é™ªè¯Šå‘˜æç° | `adminRequest`<br>`/admin/**` | âœ… **å”¯ä¸€**å†™å…¥çŠ¶æ€çš„åœ°æ–¹ |
| **Settlement**<br>ï¼ˆç»“ç®—/è´¢åŠ¡å†…æ ¸ï¼‰ | ä½£é‡‘å…¥è´¦ã€å¯æç°ä½™é¢ç»“ç®—ã€å†»ç»“/è§£å†» | å†…éƒ¨æœåŠ¡/äº‹ä»¶é©±åŠ¨ | âœ… å†™ä½™é¢ã€å†™ç»“ç®—æµæ°´ |

### é€šé“éš”ç¦»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é™ªè¯Šå‘˜ç»ˆç«¯                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  escortRequest(/escort-app/**)                      â”‚   â”‚
â”‚  â”‚  â€¢ å‘èµ·æç°ç”³è¯· (POST /withdraw/requests)           â”‚   â”‚
â”‚  â”‚  â€¢ æŸ¥çœ‹è‡ªå·±çš„è®°å½• (GET /withdraw/records)           â”‚   â”‚
â”‚  â”‚  â€¢ âŒ ç¦æ­¢ï¼šä¿®æ”¹çŠ¶æ€ã€å®¡æ ¸ã€æ‰“æ¬¾                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åç«¯æœåŠ¡                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  çŠ¶æ€æœºæ ¡éªŒ + å®¡è®¡æ—¥å¿— + å°è´¦è®°å½•                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç®¡ç†åå°                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  adminRequest(/admin/escorts/withdraw-records/**)   â”‚   â”‚
â”‚  â”‚  â€¢ æŸ¥çœ‹ä»»æ„è®°å½• (GET /admin/escorts/withdraw-records) â”‚   â”‚
â”‚  â”‚  â€¢ å¯¼å‡º (GET /withdraw-records/export)              â”‚   â”‚
â”‚  â”‚  â€¢ âœ… å®¡æ ¸ (POST /withdraw-records/:id/review)      â”‚   â”‚
â”‚  â”‚  â€¢ âœ… æ‰“æ¬¾ (POST /withdraw-records/:id/payout)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒå¯¹è±¡æ¨¡å‹ï¼ˆæ•°æ®åº“ï¼‰

### 2.1 EscortWalletï¼ˆé™ªè¯Šå‘˜é’±åŒ…ï¼‰

```typescript
interface EscortWallet {
  id: string
  escortId: string
  balance: Decimal           // å¯æç°ä½™é¢
  frozenBalance: Decimal     // å†»ç»“ä½™é¢ï¼ˆæç°ä¸­ï¼‰
  totalEarned: Decimal       // ç´¯è®¡æ”¶å…¥
  totalWithdrawn: Decimal    // ç´¯è®¡å·²æç°
}
```

### 2.2 Withdrawalï¼ˆæç°ç”³è¯·ï¼‰

```typescript
interface Withdrawal {
  id: string
  walletId: string
  amount: Decimal            // æç°é‡‘é¢
  fee: Decimal               // æ‰‹ç»­è´¹
  actualAmount: Decimal      // å®é™…åˆ°è´¦ = amount - fee
  method: 'wechat' | 'alipay' | 'bank'
  account: string            // æ”¶æ¬¾è´¦æˆ·
  status: WithdrawStatus
  
  // å®¡æ ¸ä¿¡æ¯
  reviewedAt?: Date
  reviewedBy?: string
  reviewNote?: string
  
  // æ‰“æ¬¾ä¿¡æ¯
  transferNo?: string        // äº¤æ˜“å·
  transferAt?: Date          // æ‰“æ¬¾æ—¶é—´
  failReason?: string        // å¤±è´¥åŸå› 
  
  createdAt: Date
  updatedAt: Date
  
  // å…³è”
  logs: WithdrawLog[]
}

type WithdrawStatus = 
  | 'pending'      // å¾…å®¡æ ¸
  | 'approved'     // å·²å®¡æ ¸
  | 'rejected'     // å·²é©³å›
  | 'processing'   // æ‰“æ¬¾ä¸­
  | 'completed'    // å·²å®Œæˆ
  | 'failed'       // æ‰“æ¬¾å¤±è´¥
```

### 2.3 WithdrawLogï¼ˆæ“ä½œæ—¥å¿—ï¼‰

```typescript
interface WithdrawLog {
  id: string
  withdrawId: string
  action: 'create' | 'approve' | 'reject' | 'payout' | 'complete' | 'fail'
  operator: 'system' | 'admin'
  operatorId?: string
  operatorName?: string
  message?: string
  oldStatus?: string
  newStatus?: string
  createdAt: Date
}
```

### 2.4 AdminAuditLogï¼ˆå®¡è®¡æ—¥å¿—ï¼‰

```typescript
interface AdminAuditLog {
  id: string
  adminId?: string
  adminName?: string
  module: 'withdraw' | 'refund' | 'settlement'
  action: 'export' | 'approve' | 'reject' | 'payout' | 'fail'
  targetId?: string
  targetType?: string
  detail?: string      // JSON
  filters?: string     // JSONï¼ˆå¯¼å‡ºç­›é€‰æ¡ä»¶ï¼‰
  ip?: string
  userAgent?: string
  createdAt: Date
}
```

### 2.5 WalletTransactionï¼ˆé’±åŒ…æµæ°´ï¼‰

```typescript
interface WalletTransaction {
  id: string
  walletId: string
  type: 'income' | 'bonus' | 'frozen' | 'unfrozen' | 'withdraw'
  amount: Decimal
  balanceAfter: Decimal
  withdrawId?: string
  title: string
  remark?: string
  createdAt: Date
}
```

---

## 3. èµ„é‡‘çŠ¶æ€æœºï¼ˆæç°ï¼‰

### è®¾è®¡æ„å›¾

ç¦æ­¢ä»»æ„è·³è½¬ï¼Œé¿å…"è¡¥ä¸å¼çŠ¶æ€"å¯¼è‡´è´¢åŠ¡å¯¹ä¸ä¸Šè´¦ã€‚

### çŠ¶æ€æµè½¬å›¾

```mermaid
stateDiagram-v2
    [*] --> pending: é™ªè¯Šå‘˜æäº¤ç”³è¯·
    pending --> approved: Admin å®¡æ ¸é€šè¿‡
    pending --> rejected: Admin é©³å› (å†™ rejectReason)
    approved --> processing: Admin å‘èµ·æ‰“æ¬¾
    approved --> failed: æ‰“æ¬¾å¤±è´¥
    processing --> completed: æ‰“æ¬¾æˆåŠŸ (å†™äº¤æ˜“å·)
    processing --> failed: æ‰“æ¬¾å¤±è´¥ (å†™ failReason)
    rejected --> [*]
    completed --> [*]
    failed --> [*]
```

### åç«¯çŠ¶æ€æœºå®šä¹‰ï¼ˆå·²å®ç°ï¼‰

```typescript
const WITHDRAW_STATE_MACHINE = {
  pending: ['approved', 'rejected'],
  approved: ['processing', 'failed'],
  processing: ['completed', 'failed'],
  // ç»ˆæ€ï¼Œä¸å¯å˜æ›´
  completed: [],
  rejected: [],
  failed: [],
};

function validateStateTransition(currentStatus: string, targetStatus: string): boolean {
  const allowedTransitions = WITHDRAW_STATE_MACHINE[currentStatus] || [];
  return allowedTransitions.includes(targetStatus);
}
```

### çŠ¶æ€æµè½¬è¡¨

| å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | è§¦å‘è€… | å¿…å¡«å­—æ®µ | é™„å¸¦æ“ä½œ |
|----------|----------|--------|----------|----------|
| `pending` | `approved` | Admin | - | å†™ WithdrawLog + AdminAuditLog |
| `pending` | `rejected` | Admin | `rejectReason` | è§£å†»ä½™é¢ + å†™æµæ°´ + å†™æ—¥å¿— |
| `approved` | `processing` | Admin | - | å†™æ—¥å¿— |
| `approved` | `failed` | Admin | `failReason` | è§£å†»ä½™é¢ + å†™æµæ°´ + å†™æ—¥å¿— |
| `processing` | `completed` | Admin | `transactionNo` | æ‰£å‡å†»ç»“ + ç´¯è®¡æç° + å†™æ—¥å¿— |
| `processing` | `failed` | Admin | `failReason` | è§£å†»ä½™é¢ + å†™æµæ°´ + å†™æ—¥å¿— |

### ğŸš« ç¦æ­¢çš„çŠ¶æ€è·³è½¬ï¼ˆè¿”å› 409ï¼‰

```typescript
// âŒ åç«¯å¿…é¡»æ‹’ç»ä»¥ä¸‹è·³è½¬
pending â†’ completed      // å¿…é¡»ç»è¿‡ approved + processing
pending â†’ processing     // å¿…é¡»å…ˆ approved
rejected â†’ approved      // ç»ˆæ€ä¸å¯é€†
failed â†’ completed       // ç»ˆæ€ä¸å¯é€†
completed â†’ *            // ç»ˆæ€ä¸å¯é€†
```

### å…³é”®æŠ¤æ 

| è§„åˆ™ | è¯´æ˜ | å®ç°çŠ¶æ€ |
|------|------|----------|
| **äº¤æ˜“å·å¿…å¡«** | `processing â†’ completed` å¿…é¡»ä¼´éš `transactionNo` | âœ… å·²å®ç° |
| **å¤±è´¥åŸå› å¿…å¡«** | `â†’ failed` å¿…é¡»ä¼´éš `failReason` | âœ… å·²å®ç° |
| **é©³å›åŸå› å¿…å¡«** | `â†’ rejected` å¿…é¡»ä¼´éš `rejectReason` | âœ… å·²å®ç° |
| **CONFIRM ç¡®è®¤** | æ‰“æ¬¾æ“ä½œå¿…é¡»è¾“å…¥ `CONFIRM` | âœ… å·²å®ç° |
| **äº¤æ˜“å·å”¯ä¸€** | é˜²æ­¢é‡å¤æ‰“æ¬¾ | âœ… å·²å®ç° |

---

## 4. ä½™é¢ä¸å°è´¦ï¼ˆLedgerï¼‰è§„åˆ™

### 4.1 é’±åŒ…å­—æ®µè¯´æ˜

| å­—æ®µ | è¯´æ˜ | å˜æ›´æ—¶æœº |
|------|------|----------|
| `balance` | å¯æç°ä½™é¢ | è®¢å•å®Œæˆ+ã€æç°ç”³è¯·-ã€é©³å›/å¤±è´¥+ |
| `frozenBalance` | å†»ç»“ä½™é¢ | æç°ç”³è¯·+ã€æ‰“æ¬¾æˆåŠŸ-ã€é©³å›/å¤±è´¥- |
| `totalWithdrawn` | ç´¯è®¡å·²æç° | æ‰“æ¬¾æˆåŠŸ+ |

### 4.2 æç°å¯¹é’±åŒ…çš„å½±å“

| æ—¶ç‚¹ | è¡Œä¸º | é’±åŒ…å˜åŒ– | æµæ°´ç±»å‹ |
|------|------|----------|----------|
| æç°æäº¤ | `pending` åˆ›å»º | `balance -= amount`<br>`frozenBalance += amount` | `frozen` |
| å®¡æ ¸é©³å› | `rejected` | `balance += amount`<br>`frozenBalance -= amount` | `unfrozen` |
| æ‰“æ¬¾æˆåŠŸ | `completed` | `frozenBalance -= amount`<br>`totalWithdrawn += netAmount` | - |
| æ‰“æ¬¾å¤±è´¥ | `failed` | `balance += amount`<br>`frozenBalance -= amount` | `unfrozen` |

### 4.3 æµæ°´ç¤ºä¾‹

```
æ—¶é—´          ç±»å‹        é‡‘é¢      ä½™é¢å˜åŒ–    è¯´æ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
12-01 10:00  income      +500.00   500.00     è®¢å•ä½£é‡‘
12-05 14:00  income      +300.00   800.00     è®¢å•ä½£é‡‘
12-10 09:00  frozen      -400.00   400.00     å‘èµ·æç°ï¼Œå†»ç»“
12-10 11:00  (æ‰“æ¬¾æˆåŠŸ)    -        400.00     æ‰“æ¬¾æˆåŠŸï¼Œæ‰£å‡å†»ç»“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                         å½“å‰å¯æç°ä½™é¢: 400.00
                         ç´¯è®¡å·²æç°: 400.00
```

---

## 5. API è®¾è®¡æ€»è§ˆ

### 5.1 Escort Appï¼ˆä»…è‡ªæŸ¥ + å‘èµ·ï¼‰

| API | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| è·å–æç°é¡µç»Ÿè®¡ | `GET /escort-app/withdraw/stats` | å¯æç°ã€å¤„ç†ä¸­ã€è§„åˆ™ã€è´¦æˆ· |
| è·å–æç°è®°å½•åˆ—è¡¨ | `GET /escort-app/withdraw/records` | ä»…æœ¬äººè®°å½• |
| å‘èµ·æç°ç”³è¯· | `POST /escort-app/withdraw/requests` | åªå…è®¸åˆ›å»º `pending` |
| è·å–æç°è¯¦æƒ… | `GET /escort-app/withdraw/records/:id` | ä»…æœ¬äºº |

### 5.2 Admin Consoleï¼ˆèµ„é‡‘çœŸç›¸æºï¼‰

| API | è·¯å¾„ | è¯´æ˜ | çŠ¶æ€ |
|-----|------|------|------|
| æç°è®°å½•åˆ—è¡¨ | `GET /admin/escorts/withdraw-records` | æ”¯æŒç­›é€‰/åˆ†é¡µ | âœ… P0 |
| æç°ç»Ÿè®¡ | `GET /admin/escorts/withdraw-records/stats` | å¾…å¤„ç†/å·²å®Œæˆç»Ÿè®¡ | âœ… P0 |
| æç°è®°å½•è¯¦æƒ… | `GET /admin/escorts/withdraw-records/:id` | åŸºç¡€è¯¦æƒ… | âœ… P1 |
| æç°è¯¦æƒ…ï¼ˆå«æ—¥å¿—ï¼‰| `GET /admin/escorts/withdraw-records/:id/detail` | å«æ“ä½œæ—¥å¿— | âœ… P2 |
| æ“ä½œæ—¥å¿— | `GET /admin/escorts/withdraw-records/:id/logs` | ä»…æ—¥å¿— | âœ… P2 |
| å¯¼å‡º | `GET /admin/escorts/withdraw-records/export` | CSV/Excel | âœ… P1 |
| å®¡æ ¸ | `POST /admin/escorts/withdraw-records/:id/review` | é€šè¿‡/é©³å› | âœ… P2 |
| æ‰“æ¬¾ | `POST /admin/escorts/withdraw-records/:id/payout` | ğŸ”´ é«˜å± | âœ… P2 |
| æ ‡è®°å¤±è´¥ | `POST /admin/escorts/withdraw-records/:id/fail` | æ‰‹åŠ¨æ ‡è®° | âœ… P2 |

---

## 6. åå° UI ä¿¡æ¯æ¶æ„

### 6.1 é¡µé¢ç»“æ„

```
/admin
â”œâ”€â”€ /escorts                           # é™ªè¯Šå‘˜ç®¡ç†
â”‚   â”œâ”€â”€ (list)                         # åˆ—è¡¨é¡µ
â”‚   â””â”€â”€ /:id                           # è¯¦æƒ…é¡µ
â”‚       â”œâ”€â”€ Tab: åŸºç¡€ä¿¡æ¯
â”‚       â”œâ”€â”€ Tab: è®¢å•
â”‚       â”œâ”€â”€ Tab: æ”¶å…¥
â”‚       â””â”€â”€ Tab: æç°è®°å½•              â† âœ… ADMIN-WD-04
â”‚
â””â”€â”€ /escorts/withdraw-records          # æç°è®°å½•ä¸­å¿ƒ
    â”œâ”€â”€ (list)                         # åˆ—è¡¨é¡µ â† âœ… ADMIN-WD-01
    â”‚   â”œâ”€â”€ ç­›é€‰
    â”‚   â”œâ”€â”€ åˆ†é¡µ
    â”‚   â”œâ”€â”€ å¯¼å‡º                       â† âœ… ADMIN-WD-03
    â”‚   â””â”€â”€ æŸ¥çœ‹è¯¦æƒ… â†’ Drawer          â† âœ… ADMIN-WD-02
    â”‚
    â”œâ”€â”€ Drawer: è¯¦æƒ…æŠ½å±‰ (åªè¯»)
    â”‚   â”œâ”€â”€ åŸºç¡€ä¿¡æ¯
    â”‚   â”œâ”€â”€ é‡‘é¢ä¿¡æ¯
    â”‚   â”œâ”€â”€ è´¦æˆ·ä¿¡æ¯
    â”‚   â”œâ”€â”€ çŠ¶æ€ä¿¡æ¯
    â”‚   â””â”€â”€ æ“ä½œæ—¥å¿—                   â† âœ… FE-WD-P2-03
    â”‚
    â”œâ”€â”€ Drawer: å®¡æ ¸æŠ½å±‰               â† âœ… FE-WD-P2-01
    â”‚   â”œâ”€â”€ ç”³è¯·ä¿¡æ¯ï¼ˆåªè¯»ï¼‰
    â”‚   â”œâ”€â”€ å®¡æ ¸å†³ç­–ï¼ˆé€šè¿‡/é©³å›ï¼‰
    â”‚   â””â”€â”€ é©³å›åŸå› ï¼ˆé©³å›æ—¶å¿…å¡«ï¼‰
    â”‚
    â””â”€â”€ Modal: æ‰“æ¬¾ç¡®è®¤                â† âœ… FE-WD-P2-02
        â”œâ”€â”€ å±é™©è­¦å‘Š
        â”œâ”€â”€ æ‰“æ¬¾ä¿¡æ¯ç¡®è®¤
        â”œâ”€â”€ CONFIRM è¾“å…¥æ¡†ï¼ˆç¦æ­¢ç²˜è´´ï¼‰
        â””â”€â”€ æ‰“æ¬¾æ–¹å¼é€‰æ‹©
```

### 6.2 ç»„ä»¶æ¸…å•

| ç»„ä»¶ | æ–‡ä»¶ | è¯´æ˜ | çŠ¶æ€ |
|------|------|------|------|
| è¯¦æƒ…æŠ½å±‰ | `WithdrawDetailDrawer.tsx` | åªè¯»è¯¦æƒ… | âœ… |
| å¯¼å‡ºæŒ‰é’® | `WithdrawExportButton.tsx` | CSV/Excel å¯¼å‡º | âœ… |
| å¯å¤ç”¨åˆ—è¡¨ | `WithdrawRecordList.tsx` | è¯¦æƒ…é¡µ Tab å¤ç”¨ | âœ… |
| å®¡æ ¸æŠ½å±‰ | `WithdrawReviewDrawer.tsx` | é€šè¿‡/é©³å› | âœ… |
| æ‰“æ¬¾å¼¹çª— | `WithdrawPayoutModal.tsx` | é«˜å±ç¡®è®¤ | âœ… |
| æ“ä½œæ—¥å¿—æ—¶é—´çº¿ | `WithdrawLogsTimeline.tsx` | æ—¥å¿—å±•ç¤º | âœ… |
| æƒé™æ§åˆ¶ | `withdrawPermissions.ts` | æŒ‰é’®å¯è§æ€§ | âœ… |

---

## 7. æƒé™ä¸å®¡è®¡

### 7.1 æƒé™åˆ†å±‚

| æƒé™ä»£ç  | èƒ½åŠ› | è§’è‰²å»ºè®® |
|----------|------|----------|
| `withdraw.read` | æŸ¥çœ‹åˆ—è¡¨/è¯¦æƒ… | å®¢æœã€è´¢åŠ¡ã€è¿è¥ |
| `withdraw.export` | å¯¼å‡º | è´¢åŠ¡ã€è¿è¥ |
| `withdraw.approve` | å®¡æ ¸é€šè¿‡/é©³å› | é£æ§ä¸»ç®¡ã€è´¢åŠ¡ |
| `withdraw.payout` | å‘èµ·æ‰“æ¬¾ | è´¢åŠ¡ä¸»ç®¡ |

### 7.2 å‰ç«¯æƒé™æ§åˆ¶

```typescript
// withdrawPermissions.ts
export function canShowAction(
  status: AdminWithdrawStatus,
  permissions: WithdrawPermissions,
  action: WithdrawActionType
): boolean {
  if (action === 'review') {
    return status === 'pending' && permissions.approve
  }
  if (action === 'payout') {
    return status === 'approved' && permissions.payout
  }
  return false
}
```

æ ¸å¿ƒè§„åˆ™ï¼š
- **æ— æƒé™ä¸æ¸²æŸ“æŒ‰é’®**ï¼ˆé disabledï¼‰
- `review`: `pending` + `approve` æƒé™
- `payout`: `approved` + `payout` æƒé™

### 7.3 å®¡è®¡æ—¥å¿—

ä»¥ä¸‹åŠ¨ä½œå¿…é¡»å†™ `WithdrawLog` + `AdminAuditLog`ï¼š

| åŠ¨ä½œ | WithdrawLog.action | AdminAuditLog.action |
|------|-------------------|---------------------|
| å¯¼å‡º | - | `export` |
| å®¡æ ¸é€šè¿‡ | `approve` | `approve` |
| å®¡æ ¸é©³å› | `reject` | `reject` |
| å‘èµ·æ‰“æ¬¾ | `payout` | `payout` |
| æ‰“æ¬¾æˆåŠŸ | `complete` | - |
| æ‰“æ¬¾å¤±è´¥ | `fail` | `fail` |

---

## 8. æ•°æ®è„±æ•

### 8.1 è„±æ•å‡½æ•°ï¼ˆå·²å®ç°ï¼‰

```typescript
// æ‰‹æœºå·è„±æ•
function maskPhone(phone: string): string {
  if (!phone || phone.length < 7) return phone;
  return phone.slice(0, 3) + '****' + phone.slice(-4);
}
// 13812345678 â†’ 138****5678

// è´¦æˆ·è„±æ•
function maskAccount(account: string): string {
  if (!account || account.length < 4) return account;
  return '****' + account.slice(-4);
}
// 6228480012345678 â†’ ****5678
```

### 8.2 è„±æ•åœºæ™¯

| åœºæ™¯ | å­—æ®µ | å¤„ç† |
|------|------|------|
| åˆ—è¡¨å±•ç¤º | `escortPhoneMasked` | è„±æ• |
| åˆ—è¡¨å±•ç¤º | `accountMasked` | è„±æ• |
| å¯¼å‡º CSV | æ‰‹æœºå·ã€è´¦æˆ· | è„±æ• |
| å®¡è®¡æ—¥å¿— | æ•æ„Ÿæ•°æ® | ä¸è®°å½•å®Œæ•´å€¼ |

---

## 9. é£é™©æ¸…å•ä¸ç¡¬æŠ¤æ 

### 9.1 å…¸å‹é£é™©

| é£é™© | åæœ | é˜²æŠ¤æªæ–½ | çŠ¶æ€ |
|------|------|----------|------|
| **é‡å¤æ‰“æ¬¾** | èµ„é‡‘æŸå¤± | äº¤æ˜“å·å”¯ä¸€çº¦æŸ + å¹‚ç­‰è®¾è®¡ | âœ… |
| **çŠ¶æ€ä¸ä½™é¢ä¸ä¸€è‡´** | è´¢åŠ¡å¯¹ä¸ä¸Šè´¦ | å¼ºå°è´¦ + çŠ¶æ€æœº | âœ… |
| **ç»ˆç«¯è¶Šæƒæ”¹çŠ¶æ€** | ç»•è¿‡å®¡æ‰¹ | é€šé“éš”ç¦» + åç«¯æ ¡éªŒ | âœ… |
| **å¯¼å‡ºæ³„éœ²æ•æ„Ÿä¿¡æ¯** | éšç§åˆè§„é£é™© | è„±æ• + å®¡è®¡æ—¥å¿— | âœ… |
| **æ‰“æ¬¾åˆ°é”™è¯¯è´¦æˆ·** | èµ„é‡‘æŸå¤± | äºŒæ¬¡ç¡®è®¤ï¼ˆCONFIRMï¼‰ | âœ… |
| **çŠ¶æ€è·³è½¬** | æµç¨‹æ··ä¹± | çŠ¶æ€æœºå¼ºæ ¡éªŒ | âœ… |

### 9.2 ç¡¬æŠ¤æ ï¼ˆå·²å®ç°ï¼‰

```typescript
// 1. ä»… Admin åŸŸå¯å†™çŠ¶æ€
@Controller('admin/escorts/withdraw-records')

// 2. çŠ¶æ€æœºæ ¡éªŒ
if (!validateStateTransition(withdrawal.status, targetStatus)) {
  throw new ConflictException(`çŠ¶æ€è½¬æ¢éæ³•: ${withdrawal.status} â†’ ${targetStatus}`);
}

// 3. äº¤æ˜“å·å”¯ä¸€çº¦æŸ
const existing = await prisma.withdrawal.findFirst({
  where: { transferNo: transactionNo, id: { not: id } },
});
if (existing) {
  throw new ConflictException('äº¤æ˜“å·å·²å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æ˜¯å¦é‡å¤æ‰“æ¬¾');
}

// 4. CONFIRM äºŒæ¬¡ç¡®è®¤
if (operatorConfirmText !== 'CONFIRM') {
  throw new BadRequestException('ç¡®è®¤æ–‡æœ¬ä¸åŒ¹é…ï¼Œè¯·è¾“å…¥ CONFIRM');
}

// 5. äº‹åŠ¡ä¿æŠ¤
await prisma.$transaction(async (tx) => {
  // çŠ¶æ€å˜æ›´ + é’±åŒ…æ›´æ–° + æ—¥å¿—è®°å½•
});
```

---

## 10. å®ŒæˆçŠ¶æ€

| ä¼˜å…ˆçº§ | äº¤ä»˜ç‰© | ä»»åŠ¡å¡ | çŠ¶æ€ |
|--------|--------|--------|------|
| **P0** | åå°æç°è®°å½•åˆ—è¡¨é¡µ | ADMIN-WD-01 | âœ… å·²å®Œæˆ |
| **P1-1** | è¯¦æƒ…æŠ½å±‰ï¼ˆåªè¯»ï¼‰ | ADMIN-WD-02 | âœ… å·²å®Œæˆ |
| **P1-2** | å¯¼å‡º CSV/Excel | ADMIN-WD-03 | âœ… å·²å®Œæˆ |
| **P1-3** | é™ªè¯Šå‘˜è¯¦æƒ…é¡µ Tab | ADMIN-WD-04 | âœ… å·²å®Œæˆ |
| **P2-BE** | çŠ¶æ€æœº + å®¡æ ¸ API + æ‰“æ¬¾ API | BE-WD-P2-01~04 | âœ… å·²å®Œæˆ |
| **P2-FE** | å®¡æ ¸ Drawer + æ‰“æ¬¾ Modal + æ—¥å¿— | FE-WD-P2-01~04 | âœ… å·²å®Œæˆ |
| **P2-QA** | å›å½’æµ‹è¯• + å®‰å…¨å®¡è®¡ | QA/SEC-WD-P2 | âœ… å·²å®Œæˆ |

---

## é™„å½•ï¼šä¸€å¥è¯æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                     â”‚
â”‚   ç»ˆç«¯ï¼ˆé™ªè¯Šå‘˜ï¼‰ â†’ åªè´Ÿè´£"å‘èµ·è¯·æ±‚"                  â”‚
â”‚   åå°ï¼ˆAdminï¼‰  â†’ æ‰æ˜¯"èµ„é‡‘çœŸç›¸æº"                  â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™å¥—è®¾è®¡ä¿è¯ï¼š
- âœ… ä¸ç®¡å‰ç«¯æ€ä¹ˆæŠ–åŠ¨ï¼Œèµ„é‡‘æµå‘å§‹ç»ˆæ¸…æ™°å¯è¿½æº¯
- âœ… ä¸ä¼šåå™¬å‰ç«¯æ¶æ„ï¼Œä¸ä¼šç ´ååŒä¼šè¯æ¨¡å‹
- âœ… æƒé™åˆ†æ˜ï¼Œå®¡è®¡å®Œæ•´ï¼Œåˆè§„å¯æŸ¥
- âœ… çŠ¶æ€æœºä¿æŠ¤ï¼Œé˜²æ­¢éæ³•çŠ¶æ€è·³è½¬
- âœ… äºŒæ¬¡ç¡®è®¤ï¼Œé˜²æ­¢è¯¯æ“ä½œ
