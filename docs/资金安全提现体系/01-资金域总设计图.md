# é™ªè¯Šå‘˜èµ„é‡‘åŸŸæ€»è®¾è®¡å›¾

> **ç‰ˆæœ¬**: v1.0  
> **æœ€åæ›´æ–°**: 2024-12-12  
> **å…³è”æ–‡æ¡£**: [02-APIæ¥å£å¥‘çº¦.md](./02-APIæ¥å£å¥‘çº¦.md) Â· [03-ä»»åŠ¡å¡æ‹†è§£.md](./03-ä»»åŠ¡å¡æ‹†è§£.md) Â· [04-P2å®¡æ ¸æ‰“æ¬¾è®¾è®¡.md](./04-P2å®¡æ ¸æ‰“æ¬¾è®¾è®¡.md)

---

## ç›®æ ‡

æŠŠ"æç°ç›¸å…³çš„ä¸€åˆ‡"æ”¶æ•›æˆä¸€ä¸ª**å¯æ‰©å±•ã€å¯å®¡è®¡ã€ä½é£é™©**çš„èµ„é‡‘åŸŸã€‚

## è¾¹ç•ŒåŸåˆ™ï¼ˆä¸‰æ¡é“å¾‹ï¼‰

| # | åŸåˆ™ | è¯´æ˜ |
|---|------|------|
| 1 | **ç»ˆç«¯åªå‘èµ·ï¼Œä¸è£å†³** | é™ªè¯Šå‘˜ç«¯æ°¸è¿œä¸èƒ½æ”¹æç°çŠ¶æ€ |
| 2 | **åå°æ˜¯èµ„é‡‘çœŸç›¸æº** | çŠ¶æ€æœºã€æ‰“æ¬¾ã€å¤±è´¥åŸå› ã€å®¡è®¡æ—¥å¿—å…¨éƒ¨åœ¨ Admin åŸŸ |
| 3 | **å¼ºçŠ¶æ€æœº + å¼ºå®¡è®¡** | ä»»ä½•èµ„é‡‘åŠ¨ä½œå¿…é¡»å¯è¿½æº¯ |

---

## 1. é¢†åŸŸè¾¹ç•Œä¸é€šé“

### Bounded Context

| Context | è´£ä»» | Token/é€šé“ | å†™æƒé™ |
|---------|------|------------|--------|
| **Escort App**<br>ï¼ˆé™ªè¯Šå‘˜å·¥ä½œå°ï¼‰ | å‘èµ·æç°ã€æŸ¥çœ‹è‡ªå·±çš„æç°è®°å½• | `escortRequest`<br>`/escort-app/**` | âŒ ç¦æ­¢å†™å…¥æç°çŠ¶æ€ |
| **Admin Console**<br>ï¼ˆç³»ç»Ÿåå°ï¼‰ | å®¡æ ¸ã€æ‰“æ¬¾ã€å¯¼å‡ºã€æŸ¥è¯¢ä»»æ„é™ªè¯Šå‘˜æç° | `adminRequest`<br>`/admin/**` | âœ… **å”¯ä¸€**å†™å…¥çŠ¶æ€çš„åœ°æ–¹ |
| **Settlement**<br>ï¼ˆç»“ç®—/è´¢åŠ¡å†…æ ¸ï¼Œå¯é€‰ï¼‰ | ä½£é‡‘å…¥è´¦ã€å¯æç°ä½™é¢ç»“ç®—ã€å†»ç»“/è§£å†» | å†…éƒ¨æœåŠ¡/äº‹ä»¶é©±åŠ¨ | âœ… å†™ä½™é¢ã€å†™ç»“ç®—æµæ°´ |

### é€šé“éš”ç¦»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é™ªè¯Šå‘˜ç»ˆç«¯                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  escortRequest(/escort-app/**)                      â”‚   â”‚
â”‚  â”‚  â€¢ å‘èµ·æç°ç”³è¯· (POST /withdraw/requests)           â”‚   â”‚
â”‚  â”‚  â€¢ æŸ¥çœ‹è‡ªå·±çš„è®°å½• (GET /withdraw/records)           â”‚   â”‚
â”‚  â”‚  â€¢ âŒ ç¦æ­¢ï¼šä¿®æ”¹çŠ¶æ€ã€å®¡æ ¸ã€æ‰“æ¬¾                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åç«¯æœåŠ¡                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  çŠ¶æ€æœºæ ¡éªŒ + å®¡è®¡æ—¥å¿— + å°è´¦è®°å½•                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç®¡ç†åå°                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  adminRequest(/admin/**)                            â”‚   â”‚
â”‚  â”‚  â€¢ æŸ¥çœ‹ä»»æ„è®°å½• (GET /withdraw-records)             â”‚   â”‚
â”‚  â”‚  â€¢ å¯¼å‡º (GET /withdraw-records/export)              â”‚   â”‚
â”‚  â”‚  â€¢ âœ… å®¡æ ¸ (POST /withdraw/:id/approve)             â”‚   â”‚
â”‚  â”‚  â€¢ âœ… æ‰“æ¬¾ (POST /withdraw/:id/payout)              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ ¸å¿ƒå¯¹è±¡æ¨¡å‹ï¼ˆæ¦‚å¿µ ERï¼‰

```mermaid
erDiagram
    ESCORT ||--o{ ORDER_COMMISSION : earns
    ESCORT ||--o{ LEDGER_ENTRY : has
    ESCORT ||--o{ WITHDRAW_REQUEST : requests
    WITHDRAW_REQUEST ||--o{ WITHDRAW_LOG : logs
    WITHDRAW_REQUEST }o--|| PAYOUT_ACCOUNT : uses
    WITHDRAW_REQUEST }o--|| PAYOUT_TRANSACTION : maps
```

### 2.1 ESCORTï¼ˆé™ªè¯Šå‘˜ï¼‰

```typescript
interface Escort {
  id: string
  name: string
  phoneMasked: string    // 138****8888
  level: string          // ç­‰çº§
}
```

### 2.2 LEDGER_ENTRYï¼ˆå°è´¦æ¡ç›®ï¼‰

```typescript
interface LedgerEntry {
  id: string
  escortId: string
  type: LedgerType
  amount: number         // æ­£æ•°=å…¥è´¦ï¼Œè´Ÿæ•°=æ‰£å‡
  refType: string        // å…³è”ç±»å‹
  refId: string          // å…³è” ID
  createdAt: string
}

type LedgerType =
  | 'order'              // è®¢å•æ”¶å…¥
  | 'bonus'              // å¥–åŠ±
  | 'adjust'             // è°ƒæ•´
  | 'withdraw_hold'      // æç°å†»ç»“
  | 'withdraw_done'      // æç°å®Œæˆ
  | 'withdraw_fail'      // æç°å¤±è´¥ï¼ˆé‡Šæ”¾ï¼‰
  | 'manual_adjust'      // [P2/æœªæ¥] äººå·¥è°ƒè´¦ï¼ˆä»… superadminï¼Œç”¨äºçº¿ä¸‹æç«¯çº é”™ï¼‰
```

### 2.3 WITHDRAW_REQUESTï¼ˆæç°ç”³è¯·ï¼‰

```typescript
interface WithdrawRequest {
  id: string
  withdrawNo: string     // æç°å•å· WD202412120001
  escortId: string
  amount: number         // æç°é‡‘é¢
  fee: number            // æ‰‹ç»­è´¹
  netAmount: number      // å®é™…åˆ°è´¦ = amount - fee
  status: WithdrawStatus
  failReason?: string    // ä»… rejected/failed æ—¶æœ‰å€¼
  createdAt: string      // ç”³è¯·æ—¶é—´
  approvedAt?: string    // å®¡æ ¸æ—¶é—´
  paidAt?: string        // æ‰“æ¬¾æ—¶é—´
}

type WithdrawStatus = 
  | 'pending'      // å¾…å®¡æ ¸
  | 'approved'     // å·²å®¡æ ¸
  | 'rejected'     // å·²é©³å›
  | 'processing'   // æ‰“æ¬¾ä¸­
  | 'completed'    // å·²å®Œæˆ
  | 'failed'       // æ‰“æ¬¾å¤±è´¥
  | 'cancelled'    // å·²å–æ¶ˆ
```

### 2.4 WITHDRAW_LOGï¼ˆæ“ä½œæ—¥å¿—ï¼‰

```typescript
interface WithdrawLog {
  id: string
  withdrawId: string
  action: 'create' | 'submit' | 'approve' | 'reject' | 'payout' | 'success' | 'fail'
  operatorType: 'system' | 'admin'
  operatorName?: string  // admin æ—¶å¡«å†™
  message?: string
  createdAt: string
}
```

### 2.5 PAYOUT_ACCOUNTï¼ˆæ”¶æ¬¾è´¦æˆ·ï¼‰

```typescript
interface PayoutAccount {
  id: string
  escortId: string
  type: 'bank' | 'alipay' | 'wechat'
  accountNoMasked: string  // è„±æ• 622****1234
  bankName?: string
  isDefault: boolean
}
```

### 2.6 PAYOUT_TRANSACTIONï¼ˆæ‰“æ¬¾äº¤æ˜“ï¼‰

```typescript
interface PayoutTransaction {
  id: string
  withdrawId: string
  channel: 'alipay' | 'wechat' | 'bank'
  transactionNo: string      // ç¬¬ä¸‰æ–¹äº¤æ˜“å·ï¼ˆå”¯ä¸€çº¦æŸï¼‰
  rawResponseMasked: string  // æ¸ é“åŸå§‹å›æ‰§ï¼ˆè„±æ•ï¼‰
  createdAt: string
}
```

---

## 3. èµ„é‡‘çŠ¶æ€æœºï¼ˆæç°ï¼‰

### è®¾è®¡æ„å›¾

ç¦æ­¢ä»»æ„è·³è½¬ï¼Œé¿å…"è¡¥ä¸å¼çŠ¶æ€"å¯¼è‡´è´¢åŠ¡å¯¹ä¸ä¸Šè´¦ã€‚

### çŠ¶æ€æµè½¬å›¾

```mermaid
stateDiagram-v2
    [*] --> pending: é™ªè¯Šå‘˜æäº¤ç”³è¯·
    pending --> approved: Admin å®¡æ ¸é€šè¿‡
    pending --> rejected: Admin é©³å› (å†™ rejectReason)
    pending --> cancelled: é™ªè¯Šå‘˜å–æ¶ˆ
    approved --> processing: Admin å‘èµ·æ‰“æ¬¾
    processing --> completed: æ¸ é“æˆåŠŸ (å†™äº¤æ˜“å·)
    processing --> failed: æ¸ é“å¤±è´¥ (å†™ failReason)
    rejected --> [*]
    cancelled --> [*]
    completed --> [*]
    failed --> [*]
```

### çŠ¶æ€æµè½¬è¡¨

| å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ | è§¦å‘è€… | å¿…å¡«å­—æ®µ |
|----------|----------|--------|----------|
| `pending` | `approved` | Admin | - |
| `pending` | `rejected` | Admin | `rejectReason` |
| `pending` | `cancelled` | Escort | - |
| `approved` | `processing` | Admin | - |
| `processing` | `completed` | System | `transactionNo` |
| `processing` | `failed` | System | `failReason` |

### ğŸš« ç¦æ­¢çš„çŠ¶æ€è·³è½¬

```typescript
// âŒ åç«¯å¿…é¡»æ‹’ç»ä»¥ä¸‹è·³è½¬
pending â†’ completed      // å¿…é¡»ç»è¿‡ approved + processing
pending â†’ processing     // å¿…é¡»å…ˆ approved
approved â†’ completed     // å¿…é¡»å…ˆ processing
rejected â†’ approved      // ç»ˆæ€ä¸å¯é€†
failed â†’ completed       // ç»ˆæ€ä¸å¯é€†
```

### å…³é”®æŠ¤æ 

| è§„åˆ™ | è¯´æ˜ |
|------|------|
| **äº¤æ˜“å·å¿…å¡«** | `processing â†’ completed` å¿…é¡»ä¼´éš `transactionNo` |
| **å¤±è´¥åŸå› å¿…å¡«** | `processing â†’ failed` å¿…é¡»ä¼´éš `failReason` |
| **ç¦æ­¢è‡ªåŠ¨é‡è¯•** | `failed` ä¸è‡ªåŠ¨é‡è¯•ï¼Œé¿å…é‡å¤æ‰“æ¬¾ |
| **é‡è¯•èµ°å®¡è®¡** | é‡è¯•å¿…é¡»èµ° P2 æ“ä½œæµï¼ˆé‡æ–°å‘èµ·æ‰“æ¬¾å¹¶å†™å®¡è®¡ï¼‰ |

---

## 4. ä½™é¢ä¸å°è´¦ï¼ˆLedgerï¼‰è§„åˆ™

### 4.1 æ ¸å¿ƒç†å¿µ

> **"ä½™é¢"ä¸æ˜¯å­—æ®µï¼Œæ˜¯å°è´¦çš„è§†å›¾**

```typescript
// å¯æç°ä½™é¢ = æ‰€æœ‰å…¥è´¦ - æ‰€æœ‰æ‰£å‡
const availableBalance = ledgerEntries
  .filter(e => INCOME_TYPES.includes(e.type))
  .reduce((sum, e) => sum + e.amount, 0)
  - ledgerEntries
  .filter(e => DEDUCTION_TYPES.includes(e.type))
  .reduce((sum, e) => sum + Math.abs(e.amount), 0)
```

### 4.2 æç°å¯¹å°è´¦çš„å½±å“

| æ—¶ç‚¹ | è¡Œä¸º | Ledger Entry |
|------|------|--------------|
| æç°æäº¤ | `pending` åˆ›å»º | `withdraw_hold = -amount`ï¼ˆå†»ç»“ï¼‰ |
| å®¡æ ¸é©³å› | `rejected` | `withdraw_hold = +amount`ï¼ˆåå‘å†²å›ï¼‰ |
| æ‰“æ¬¾æˆåŠŸ | `completed` | `withdraw_done = -amount`ï¼ˆç¡®è®¤æ‰£å‡ï¼‰ |
| æ‰“æ¬¾å¤±è´¥ | `failed` | `withdraw_fail = +amount`ï¼ˆé‡Šæ”¾å†»ç»“ï¼‰ |

### 4.3 å°è´¦æµæ°´ç¤ºä¾‹

```
æ—¶é—´          ç±»å‹              é‡‘é¢      ä½™é¢å˜åŒ–    è¯´æ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
12-01 10:00  order            +500.00   500.00     è®¢å•ä½£é‡‘
12-05 14:00  order            +300.00   800.00     è®¢å•ä½£é‡‘
12-10 09:00  withdraw_hold    -400.00   400.00     å‘èµ·æç°ï¼Œå†»ç»“
12-10 11:00  withdraw_done    -400.00   400.00     æ‰“æ¬¾æˆåŠŸï¼Œç¡®è®¤æ‰£å‡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                              å½“å‰å¯æç°ä½™é¢: 400.00
```

---

## 5. API è®¾è®¡æ€»è§ˆ

### 5.1 Escort Appï¼ˆä»…è‡ªæŸ¥ + å‘èµ·ï¼‰

| API | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| è·å–æç°é¡µç»Ÿè®¡ | `GET /escort-app/withdraw/stats` | å¯æç°ã€å¤„ç†ä¸­ã€è§„åˆ™ã€è´¦æˆ·ã€æœ€è¿‘è®°å½• |
| è·å–æç°è®°å½•åˆ—è¡¨ | `GET /escort-app/withdraw/records` | ä»…æœ¬äººè®°å½•ï¼Œåˆ†é¡µ/ç­›é€‰ |
| å‘èµ·æç°ç”³è¯· | `POST /escort-app/withdraw/requests` | åªå…è®¸åˆ›å»º `pending` |
| è·å–æç°è¯¦æƒ… | `GET /escort-app/withdraw/records/:id` | ä»…æœ¬äººï¼ŒåŒ…å«çŠ¶æ€ä¸å¿…è¦å­—æ®µ |

#### æ¥å£ç¤ºä¾‹ï¼šæç°é¡µç»Ÿè®¡

```typescript
// GET /escort-app/withdraw/stats
interface WithdrawStatsResponse {
  availableBalance: number      // å¯æç°ä½™é¢
  processingAmount: number      // å¤„ç†ä¸­é‡‘é¢
  totalWithdrawn: number        // ç´¯è®¡å·²æç°
  
  withdrawRule: {
    minAmount: number           // æœ€ä½æç°é‡‘é¢
    maxAmount: number           // å•ç¬”ä¸Šé™
    feeRate: number             // æ‰‹ç»­è´¹ç‡
    minFee: number              // æœ€ä½æ‰‹ç»­è´¹
  }
  
  payoutAccounts: PayoutAccount[]  // æ”¶æ¬¾è´¦æˆ·åˆ—è¡¨
  
  recentRecords: WithdrawRecord[]  // æœ€è¿‘ 5 æ¡è®°å½•
}
```

### 5.2 Admin Consoleï¼ˆèµ„é‡‘çœŸç›¸æºï¼‰

| API | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| æç°è®°å½•åˆ—è¡¨ | `GET /admin/escorts/withdraw-records` | æ”¯æŒç­›é€‰/åˆ†é¡µ |
| æç°è®°å½•è¯¦æƒ… | `GET /admin/escorts/withdraw-records/:id` | å« failReasonã€äº¤æ˜“å·ã€æ—¥å¿— |
| å¯¼å‡º | `GET /admin/escorts/withdraw-records/export` | `?format=csv\|xlsx` |
| é™ªè¯Šå‘˜ç»´åº¦æŸ¥è¯¢ | `GET /admin/escorts/:escortId/withdraw-records` | è¯¦æƒ…é¡µ Tab å¤ç”¨ |
| å®¡æ ¸é€šè¿‡ | `POST /admin/withdraw/:id/approve` | P2ï¼Œéœ€æƒé™ |
| å®¡æ ¸é©³å› | `POST /admin/withdraw/:id/reject` | P2ï¼Œéœ€ reason |
| å‘èµ·æ‰“æ¬¾ | `POST /admin/withdraw/:id/payout` | P2ï¼Œéœ€äºŒæ¬¡ç¡®è®¤ |

---

## 6. åå° UI ä¿¡æ¯æ¶æ„

### 6.1 é¡µé¢ç»“æ„

```
/admin
â”œâ”€â”€ /escorts                           # é™ªè¯Šå‘˜ç®¡ç†
â”‚   â”œâ”€â”€ (list)                         # åˆ—è¡¨é¡µ
â”‚   â””â”€â”€ /:id                           # è¯¦æƒ…é¡µ
â”‚       â”œâ”€â”€ Tab: åŸºç¡€ä¿¡æ¯
â”‚       â”œâ”€â”€ Tab: è®¢å•
â”‚       â”œâ”€â”€ Tab: æ”¶å…¥
â”‚       â””â”€â”€ Tab: æç°è®°å½• (P1)         â† ADMIN-WD-04
â”‚
â””â”€â”€ /escorts/withdraw-records          # æç°è®°å½•ä¸­å¿ƒ (P0)
    â”œâ”€â”€ (list)                         # åˆ—è¡¨é¡µ â† ADMIN-WD-01
    â”‚   â”œâ”€â”€ ç­›é€‰
    â”‚   â”œâ”€â”€ åˆ†é¡µ
    â”‚   â”œâ”€â”€ å¯¼å‡º (P1)                  â† ADMIN-WD-03
    â”‚   â””â”€â”€ æŸ¥çœ‹è¯¦æƒ… â†’ Drawer (P1)     â† ADMIN-WD-02
    â”‚
    â””â”€â”€ Drawer: è¯¦æƒ…æŠ½å±‰ (åªè¯»)
        â”œâ”€â”€ åŸºç¡€ä¿¡æ¯
        â”œâ”€â”€ é‡‘é¢ä¿¡æ¯
        â”œâ”€â”€ è´¦æˆ·ä¿¡æ¯
        â”œâ”€â”€ çŠ¶æ€ä¿¡æ¯
        â””â”€â”€ æ“ä½œæ—¥å¿—
```

### 6.2 åˆ—è¡¨é¡µç­›é€‰å™¨

```typescript
interface WithdrawRecordFilters {
  status?: WithdrawStatus           // çŠ¶æ€ç­›é€‰
  dateRange?: '7d' | '30d' | 'custom'  // æ—¶é—´èŒƒå›´
  startDate?: string                // è‡ªå®šä¹‰å¼€å§‹
  endDate?: string                  // è‡ªå®šä¹‰ç»“æŸ
  escortId?: string                 // é™ªè¯Šå‘˜ ID
  keyword?: string                  // å•å·/æ‰‹æœº/äº¤æ˜“å·
}
```

---

## 7. æƒé™ä¸å®¡è®¡

### 7.1 æƒé™åˆ†å±‚

| æƒé™ä»£ç  | èƒ½åŠ› | è§’è‰²å»ºè®® |
|----------|------|----------|
| `withdraw.read` | æŸ¥çœ‹åˆ—è¡¨/è¯¦æƒ… | å®¢æœã€è´¢åŠ¡ã€é£æ§ |
| `withdraw.export` | å¯¼å‡º | è´¢åŠ¡ã€è¿è¥ |
| `withdraw.approve` | å®¡æ ¸é€šè¿‡/é©³å› | é£æ§ä¸»ç®¡ |
| `withdraw.payout` | å‘èµ·æ‰“æ¬¾ | è´¢åŠ¡ä¸»ç®¡ |
| `withdraw.admin` | å…¨æƒé™ | è¶…çº§ç®¡ç†å‘˜ |

### 7.2 å®¡è®¡æ—¥å¿—ï¼ˆå¼ºåˆ¶ï¼‰

ä»¥ä¸‹åŠ¨ä½œå¿…é¡»å†™ `WITHDRAW_LOG` + `ADMIN_AUDIT_LOG`ï¼š

| åŠ¨ä½œ | æ—¥å¿—å†…å®¹ |
|------|----------|
| **å¯¼å‡º** | è°å¯¼å‡ºã€ç­›é€‰æ¡ä»¶ã€å¯¼å‡ºæ¡æ•° |
| **å®¡æ ¸é€šè¿‡** | æ“ä½œäººã€æ—¶é—´ã€ç›®æ ‡è®°å½• |
| **å®¡æ ¸é©³å›** | æ“ä½œäººã€æ—¶é—´ã€é©³å›åŸå›  |
| **å‘èµ·æ‰“æ¬¾** | æ“ä½œäººã€æ—¶é—´ã€é‡‘é¢ã€è´¦æˆ· |
| **æ‰“æ¬¾æˆåŠŸ** | äº¤æ˜“å·ã€æ¸ é“ã€æ—¶é—´ |
| **æ‰“æ¬¾å¤±è´¥** | å¤±è´¥åŸå› ã€æ¸ é“å›æ‰§ |

### 7.3 å®¡è®¡æ—¥å¿—ç¤ºä¾‹

```json
{
  "id": "log_001",
  "withdrawId": "wd_001",
  "action": "approve",
  "operatorType": "admin",
  "operatorId": "admin_001",
  "operatorName": "å¼ ä¸‰",
  "message": "å®¡æ ¸é€šè¿‡",
  "metadata": {
    "ip": "192.168.1.100",
    "userAgent": "Chrome/120"
  },
  "createdAt": "2024-12-12T10:00:00Z"
}
```

---

## 8. ç­›é€‰ä¸è·¯ç”±å‚æ•°è§„èŒƒ

### 8.1 queryKey è®¾è®¡

```typescript
// åˆ—è¡¨é¡µ queryKey
const queryKey = [
  'admin',
  'withdraw-records',
  {
    status,
    dateRange,
    startDate,
    endDate,
    escortId,
    keyword,
    page,
    pageSize,
  },
]

// è¯¦æƒ…é¡µ Tab queryKey
const queryKey = [
  'admin',
  'withdraw-records',
  {
    escortId,    // å›ºå®š
    page,
    pageSize,
    status,
  },
]
```

### 8.2 å‰ç«¯è§„èŒƒ

| è§„èŒƒ | è¯´æ˜ |
|------|------|
| **ç­›é€‰é©±åŠ¨ queryKey** | ç­›é€‰å˜åŒ–å¿…é¡»é©±åŠ¨ queryKey å˜åŒ– |
| **ç¦æ­¢æ‰‹åŠ¨ refetch** | é¿å…æ‰‹åŠ¨ refetch é€ æˆç«æ€ |
| **URL åŒæ­¥** | ç­›é€‰æ¡ä»¶åŒæ­¥åˆ° URLï¼Œæ”¯æŒåˆ†äº«/åˆ·æ–° |

---

## 9. é£é™©æ¸…å•ä¸ç¡¬æŠ¤æ 

### 9.1 å…¸å‹é£é™©

| é£é™© | åæœ | é˜²æŠ¤æªæ–½ |
|------|------|----------|
| **é‡å¤æ‰“æ¬¾** | èµ„é‡‘æŸå¤± | äº¤æ˜“å·å”¯ä¸€çº¦æŸ + å¹‚ç­‰è®¾è®¡ |
| **çŠ¶æ€ä¸ä½™é¢ä¸ä¸€è‡´** | è´¢åŠ¡å¯¹ä¸ä¸Šè´¦ | å¼ºå°è´¦ + çŠ¶æ€æœº |
| **ç»ˆç«¯è¶Šæƒæ”¹çŠ¶æ€** | ç»•è¿‡å®¡æ‰¹ | é€šé“éš”ç¦» + åç«¯æ ¡éªŒ |
| **å¯¼å‡ºæ³„éœ²æ•æ„Ÿä¿¡æ¯** | éšç§åˆè§„é£é™© | è„±æ• + å®¡è®¡æ—¥å¿— |
| **æ‰“æ¬¾åˆ°é”™è¯¯è´¦æˆ·** | èµ„é‡‘æŸå¤± | äºŒæ¬¡ç¡®è®¤ + è´¦æˆ·æ ¸éªŒ |

### 9.2 ç¡¬æŠ¤æ ï¼ˆå¿…é¡»å®ç°ï¼‰

```typescript
// 1. ä»… Admin åŸŸå¯å†™çŠ¶æ€
if (context !== 'admin') {
  throw new ForbiddenError('ç»ˆç«¯ç¦æ­¢ä¿®æ”¹æç°çŠ¶æ€')
}

// 2. çŠ¶æ€æœºæ ¡éªŒ
if (!isValidTransition(currentStatus, targetStatus)) {
  throw new BadRequestError(`éæ³•çŠ¶æ€è·³è½¬: ${currentStatus} â†’ ${targetStatus}`)
}

// 3. äº¤æ˜“å·å”¯ä¸€çº¦æŸ
@Unique(['transactionNo'])
class PayoutTransaction { ... }

// 4. æ•æ„Ÿå­—æ®µè„±æ•
function maskPhone(phone: string): string {
  return phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')
}

// 5. å¯¼å‡ºå®¡è®¡
await auditLog.create({
  action: 'export',
  operator: currentAdmin,
  metadata: { filters, count },
})
```

---

## 10. P0/P1/P2 è·¯çº¿å›¾

| ä¼˜å…ˆçº§ | äº¤ä»˜ç‰© | ä»»åŠ¡å¡ | çŠ¶æ€ |
|--------|--------|--------|------|
| **P0** | åå°æç°è®°å½•åˆ—è¡¨é¡µ | ADMIN-WD-01 | âœ… å·²å®Œæˆ |
| **P1-1** | è¯¦æƒ…æŠ½å±‰ï¼ˆåªè¯»ï¼‰ | ADMIN-WD-02 | â³ å¾…å¼€å‘ |
| **P1-2** | å¯¼å‡º CSV/Excel | ADMIN-WD-03 | â³ å¾…å¼€å‘ |
| **P1-3** | é™ªè¯Šå‘˜è¯¦æƒ…é¡µ Tab | ADMIN-WD-04 | â³ å¾…å¼€å‘ |
| **P2** | äººå·¥å®¡æ ¸/æ‰“æ¬¾æµ | ADMIN-WD-05 | ğŸ“‹ å¾…è®¾è®¡ |

---

## é™„å½•ï¼šä¸€å¥è¯æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                     â”‚
â”‚   ç»ˆç«¯ï¼ˆé™ªè¯Šå‘˜ï¼‰ â†’ åªè´Ÿè´£"å‘èµ·è¯·æ±‚"                  â”‚
â”‚   åå°ï¼ˆAdminï¼‰  â†’ æ‰æ˜¯"èµ„é‡‘çœŸç›¸æº"                  â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™å¥—è®¾è®¡ä¿è¯ï¼š
- âœ… ä¸ç®¡å‰ç«¯æ€ä¹ˆæŠ–åŠ¨ï¼Œèµ„é‡‘æµå‘å§‹ç»ˆæ¸…æ™°å¯è¿½æº¯
- âœ… ä¸ä¼šåå™¬å‰ç«¯æ¶æ„ï¼Œä¸ä¼šç ´ååŒä¼šè¯æ¨¡å‹
- âœ… æƒé™åˆ†æ˜ï¼Œå®¡è®¡å®Œæ•´ï¼Œåˆè§„å¯æŸ¥
