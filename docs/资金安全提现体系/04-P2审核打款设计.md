# P2 陪诊员提现审核/打款 - 交互设计 & 系统约束

> **版本**: v2.0  
> **最后更新**: 2025-12-13  
> **状态**: ✅ 已完成实现  
> **定位**: 资金裁决域（Admin Only）  
> **原则**: 慢、稳、可回溯、不可误触  
> **关联文档**: [01-资金域总设计图.md](./01-资金域总设计图.md) · [02-API接口契约.md](./02-API接口契约.md) · [03-任务卡拆解.md](./03-任务卡拆解.md) · [05-前端组件规范.md](./05-前端组件规范.md) · [07-安全审计报告.md](./07-安全审计报告.md)  
> **签字确认**: 产品 ☐ · 财务 ☐ · 风控 ☐ · 技术 ☐

---

## ⚠️ 设计红线（先立护栏）

### ❶ 这是"裁决台"，不是"操作台"

| ❌ 禁止 | 原因 |
|--------|------|
| 不追求效率最大化 | 每一次打款都是"可被追责"的行为 |
| 不做批量一键操作 | 批量 = 批量风险 |
| 不允许"顺手点一下" | 误触 = 资金事故 |

### ❷ 审核 ≠ 打款（必须两步）

| 阶段 | 角色 | 能做什么 | 权限 |
|------|------|----------|------|
| **审核** | 财务/运营 | 通过 / 驳回 | `withdraw.approve` |
| **打款** | 财务（更高权限） | 执行打款 | `withdraw.payout` |

- 即便是同一个人，也必须**两次明确操作**
- 状态机**不允许一步到位**

### ❸ 所有"钱相关动作"必须留下 3 条痕迹

| # | 痕迹 | 说明 |
|---|------|------|
| 1 | 状态机变更 | `withdraw_requests.status` |
| 2 | Ledger 记账 | `ledger_entries` |
| 3 | Admin 审计日志 | `admin_audit_log` + `withdraw_logs` |

**缺一条 = 设计不合格**

---

## 1. 状态机（P2 完整版）

### 状态流转图

```
pending
  │
  ├──► approved ──► processing ──► completed
  │                     │
  │                     └──► failed
  │
  └──► rejected
```

### 状态流转表

| 当前状态 | 目标状态 | 触发者 | 必填字段 | Ledger 操作 |
|----------|----------|--------|----------|-------------|
| `pending` | `approved` | Admin | - | 无 |
| `pending` | `rejected` | Admin | `rejectReason` | 释放冻结 |
| `approved` | `processing` | Admin | - | 无 |
| `processing` | `completed` | System | `transactionNo` | 冻结→确认扣减 |
| `processing` | `failed` | System | `failReason` | 释放冻结 |

### 🚫 非法跳转（后端强制 409）

```typescript
// ❌ 禁止的跳转
pending → processing     // 必须先 approved
pending → completed      // 禁止跳过审核和打款
approved → completed     // 禁止跳过打款
completed → *            // 终态不可逆
failed → *               // 终态不可逆
rejected → *             // 终态不可逆
```

---

## 2. 页面结构设计（Admin）

### 2.1 提现列表页（P2 升级版）

#### 操作列设计（克制）

```
[查看详情]   [审核]   [打款]
```

| 操作 | 显示条件 | 权限要求 |
|------|----------|----------|
| 查看详情 | 所有状态 | `withdraw.read` |
| 审核 | `status === 'pending'` | `withdraw.approve` |
| 打款 | `status === 'approved'` | `withdraw.payout` |

#### ❌ 禁止行为

- 禁止"审核并打款"合并按钮
- 禁止批量勾选打款
- 禁止快捷按钮/快捷键

---

### 2.2 审核操作（第一关）

#### 触发方式

点击「审核」→ 打开 **审核确认 Drawer**

#### Drawer 结构

```
┌─────────────────────────────────────────────────┐
│ 审核提现申请                               [×]  │
├─────────────────────────────────────────────────┤
│                                                 │
│ 【A. 信息只读区】（不可折叠）                    │
│ ┌─────────────────────────────────────────────┐ │
│ │ 陪诊员: 王小明 (ID: esc_001)                │ │
│ │ 手机:   138****8888                         │ │
│ │ 提现金额: ¥500.00                           │ │
│ │ 到账账户: 招商银行 ****6789                 │ │
│ │ 当前可提现余额: ¥1,280.00                   │ │
│ │ 提交时间: 2024-12-12 10:30                  │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ 【B. 风险提示区】（如有）                        │
│ ┌─────────────────────────────────────────────┐ │
│ │ ⚠️ 今日已申请次数: 3 次                      │ │
│ │ ⚠️ 本月累计提现: ¥8,500.00                   │ │
│ │ ⚠️ 风控标记: manual_check                   │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ 【C. 审核动作区】（唯一可操作）                  │
│ ┌─────────────────────────────────────────────┐ │
│ │ ( ) 审核通过                                │ │
│ │ ( ) 驳回申请                                │ │
│ │                                             │ │
│ │ 驳回原因: [________________] （驳回时必填）  │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ 【D. 二次确认】                                 │
│ ┌─────────────────────────────────────────────┐ │
│ │ ⚠️ 确认后将进入下一阶段，不可撤销            │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│        [取消]     [确认审核通过] / [确认驳回]   │
│                                                 │
└─────────────────────────────────────────────────┘
```

#### 审核成功后

| 操作 | 系统行为 |
|------|----------|
| 审核通过 | `pending → approved`，写日志 |
| 驳回申请 | `pending → rejected`，写日志 + 释放冻结 |

**❌ 不做任何资金变动（通过时）**

---

### 2.3 打款操作（第二关，重型）

> ⚠️ **这是 P2 的核心危险点**

#### 触发条件

- `status === 'approved'`
- 当前用户权限 `≥ withdraw.payout`

#### 打款确认 Modal（非 Drawer）

**用 Modal 是刻意制造"心理停顿"**

```
┌───────────────────────────────────────────────────────┐
│                    确认打款操作                        │
├───────────────────────────────────────────────────────┤
│                                                       │
│  ① 核心提示（红色背景）                               │
│  ┌─────────────────────────────────────────────────┐  │
│  │  ⚠️ 本操作将真实发生资金打款                     │  │
│  │     请确认以下信息无误                           │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│  ② 关键信息复核（加粗）                               │
│  ┌─────────────────────────────────────────────────┐  │
│  │  提现金额:   ¥500.00                            │  │
│  │  到账账户:   招商银行 ****6789                  │  │
│  │  陪诊员 ID:  esc_001                            │  │
│  │  当前状态:   ✅ 已审核通过                       │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│  ③ 打款方式选择                                       │
│  ┌─────────────────────────────────────────────────┐  │
│  │  (●) 手动打款（线下）                           │  │
│  │  ( ) 支付通道打款（预留）                       │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│  ④ 二次确认（必须手动输入）                           │
│  ┌─────────────────────────────────────────────────┐  │
│  │  请输入 CONFIRM 确认打款:                       │  │
│  │  [________________]                             │  │
│  │  （不可复制粘贴）                               │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│  ⑤ 操作按钮                                          │
│                                                       │
│              [取消]        [确认打款并记录]           │
│                                                       │
└───────────────────────────────────────────────────────┘
```

#### 打款后的系统行为

**成功路径**

| 步骤 | 系统行为 |
|------|----------|
| 状态变更 | `approved → processing → completed` |
| Ledger | 冻结 → 确认扣减 |
| 写入 | `withdraw_logs` + `admin_audit_log` |
| 回写 | `transactionNo`（如有） |

**失败路径**

| 步骤 | 系统行为 |
|------|----------|
| 状态变更 | `processing → failed` |
| Ledger | 释放冻结 |
| 必填 | `failReason` |
| 写入 | `withdraw_logs` + `admin_audit_log` |

---

### 2.4 详情页（P1 + P2 汇合点）

#### 提现详情 Drawer（增强）

```
┌─────────────────────────────────────────────────┐
│ 提现详情                                   [×]  │
├─────────────────────────────────────────────────┤
│                                                 │
│ 【状态时间轴】                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │  ● pending ─── ● approved ─── ● completed   │ │
│ │    10:30         11:00          11:30       │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ 【基础信息】                                    │
│  提现单号: WD202412120001                       │
│  金额/手续费/到账: ¥500 / ¥0 / ¥500            │
│  账户: 招商银行 ****6789                        │
│                                                 │
│ 【操作日志】（P2 新增，时间倒序）               │
│ ┌─────────────────────────────────────────────┐ │
│ │  时间       操作       操作人    备注        │ │
│ │  ─────────────────────────────────────────  │ │
│ │  11:30     打款成功    adminB    tx_123...  │ │
│ │  11:00     审核通过    adminA    -          │ │
│ │  10:30     提交申请    system    -          │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ 【失败信息】（仅 failed 状态显示）              │
│ ┌─────────────────────────────────────────────┐ │
│ │  失败原因: 银行卡信息不匹配                  │ │
│ │  渠道回执: ERR_CARD_MISMATCH (脱敏)          │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
└─────────────────────────────────────────────────┘
```

---

## 3. 权限模型（必须写死）

### 权限定义

| 权限代码 | 能力 | 建议角色 |
|----------|------|----------|
| `withdraw.read` | 查看列表/详情 | 客服、财务、运营 |
| `withdraw.export` | 导出 | 财务、运营 |
| `withdraw.approve` | 审核通过/驳回 | 风控主管、财务 |
| `withdraw.payout` | 执行打款 | 财务主管 |

### 权限矩阵

| 角色 | read | export | approve | payout |
|------|:----:|:------:|:-------:|:------:|
| 客服 | ✅ | ❌ | ❌ | ❌ |
| 运营 | ✅ | ✅ | ❌ | ❌ |
| 财务 | ✅ | ✅ | ✅ | ❌ |
| 财务主管 | ✅ | ✅ | ✅ | ✅ |
| 超级管理员 | ✅ | ✅ | ✅ | ✅ |

### ❌ 禁止行为

- 禁止 `approve` + `payout` 权限自动合并
- 禁止无权限用户看到操作按钮

---

## 4. API 设计（P2 新增）

### 4.1 审核通过

```http
POST /admin/withdraw/:id/approve
```

**Request**

```typescript
interface ApproveRequest {
  // 无额外参数
}
```

**Response**

```typescript
interface ApproveResponse {
  success: boolean
  withdraw: WithdrawRecordDetail
  log: WithdrawLog
}
```

### 4.2 审核驳回

```http
POST /admin/withdraw/:id/reject
```

**Request**

```typescript
interface RejectRequest {
  reason: string  // 必填，驳回原因
}
```

### 4.3 执行打款

```http
POST /admin/withdraw/:id/payout
```

**Request**

```typescript
interface PayoutRequest {
  payoutMethod: 'manual' | 'channel'  // 打款方式
  confirmation: 'CONFIRM'             // 二次确认，必须是 CONFIRM
  transactionNo?: string              // 手动打款时填写
}
```

**Response**

```typescript
interface PayoutResponse {
  success: boolean
  withdraw: WithdrawRecordDetail
  log: WithdrawLog
}
```

### 4.4 错误码

| HTTP | 业务码 | 场景 |
|------|--------|------|
| 403 | 10403 | 无 `withdraw.approve` 或 `withdraw.payout` 权限 |
| 409 | 10409 | 状态机非法跳转 |
| 422 | 10422 | 参数校验失败（如驳回原因为空） |
| 422 | 10423 | 二次确认不是 CONFIRM |

---

## 5. 工程级安全护栏

### 代码注释（强制写入）

```typescript
/**
 * ⚠️ 提现打款为高危操作
 *
 * 红线规则：
 * 1. 禁止批量操作
 * 2. 禁止跳状态（必须 pending → approved → processing）
 * 3. 禁止前端拼状态（必须走后端状态机）
 * 4. 禁止无审计日志
 * 5. 禁止无 Ledger 记录
 *
 * 每次打款必须留下 3 条痕迹：
 * - withdraw_requests.status
 * - ledger_entries
 * - admin_audit_log + withdraw_logs
 */
```

### 后端校验清单

```typescript
// 审核接口校验
if (withdraw.status !== 'pending') {
  throw new ConflictError('只能审核 pending 状态的提现')
}
if (!hasPermission('withdraw.approve')) {
  throw new ForbiddenError('无审核权限')
}

// 打款接口校验
if (withdraw.status !== 'approved') {
  throw new ConflictError('只能打款 approved 状态的提现')
}
if (!hasPermission('withdraw.payout')) {
  throw new ForbiddenError('无打款权限')
}
if (request.confirmation !== 'CONFIRM') {
  throw new ValidationError('二次确认失败')
}
```

---

## 6. P2 任务卡拆解

> 📄 **详细任务卡**: [03-任务卡拆解.md](./03-任务卡拆解.md)

### 任务总览（可直接贴 Jira）

| 卡号 | 标题 | 负责人 | 预估 |
|------|------|--------|------|
| **BE-WD-P2-01** | 提现状态机与非法跳转防护 | 后端 | 4h |
| **BE-WD-P2-02** | 提现审核 API | 后端 | 4h |
| **BE-WD-P2-03** | 提现打款 API | 后端 | 6h |
| **BE-WD-P2-04** | 提现操作日志接口 | 后端 | 2h |
| **FE-WD-P2-01** | 审核 Drawer | 前端 | 4h |
| **FE-WD-P2-02** | 打款确认 Modal | 前端 | 6h |
| **FE-WD-P2-03** | 提现详情日志区 | 前端 | 3h |
| **FE-WD-P2-04** | 权限可见性控制 | 前端 | 2h |
| **QA-WD-P2-01** | 提现流程回归测试 | QA | 4h |
| **SEC-WD-P2-01** | 资金域审计检查 | 安全 | 4h |

**P2 总预估**: 39h（含 QA 和安全审计）

### 任务依赖图

```
    Backend                           Frontend
    ───────                           ────────
    BE-WD-P2-01（状态机）
         │
         ├──► BE-WD-P2-02（审核 API）──► FE-WD-P2-01（审核 Drawer）
         │                                    │
         │                                    ▼
         ├──► BE-WD-P2-03（打款 API）──► FE-WD-P2-02（打款 Modal）
         │
         └──► BE-WD-P2-04（日志 API）──► FE-WD-P2-03（日志区）

    FE-WD-P2-04（权限控制）── 可并行

    QA/Security（后端完成后）
    ────────────────────────
    QA-WD-P2-01（回归测试）
    SEC-WD-P2-01（审计检查）
```

---

## 7. 验收 Gate

### P2 准入条件（开工前）

- [x] P0 + P1 全部完成并验收
- [x] 状态机后端测试覆盖 100%
- [x] 审计日志功能已上线
- [x] 权限矩阵已配置
- [ ] 产品/财务/风控三方签字确认本文档

### P2 完成标准

- [x] 审核/打款两步分离，无合并操作
- [x] 打款二次确认（输入 CONFIRM）
- [x] 每次操作留下 3 条痕迹（状态机 + Ledger + 审计日志）
- [x] 状态机后端强制 409
- [x] 权限校验生效（canShowAction）
- [x] 无批量操作入口

---

## 签字确认

| 角色 | 姓名 | 日期 | 签字 |
|------|------|------|------|
| 产品 | | | ☐ |
| 财务 | | | ☐ |
| 风控 | | | ☐ |
| 技术 | | | ☐ |

---

## 附录：一句话总结

```
┌─────────────────────────────────────────────────────┐
│                                                     │
│   审核 ≠ 打款                                       │
│   慢 = 安全                                         │
│   每一次打款，都是一次"可被追责"的行为              │
│                                                     │
└─────────────────────────────────────────────────────┘
```
