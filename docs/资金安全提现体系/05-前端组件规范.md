# Admin 资金域操作前端组件规范

> **版本**: v2.0  
> **最后更新**: 2025-12-13  
> **状态**: ✅ 已完成实现  
> **适用范围**: 陪诊员提现审核/打款（P2），以及未来所有「资金裁决类」后台操作  
> **目标**: 降低误操作概率、统一交互语义、保证可审计性、确保权限边界清晰  
> **关联文档**: [03-任务卡拆解.md](./03-任务卡拆解.md) · [04-P2审核打款设计.md](./04-P2审核打款设计.md) · [07-安全审计报告.md](./07-安全审计报告.md)  
> **代码位置**: `src/features/escort-withdraw-records/`

---

## 0. 核心原则

| # | 原则 | 说明 |
|---|------|------|
| 1 | **不展示灰按钮** | 无权限或状态不允许时，按钮不渲染（避免"我点不了但我能看见"的误导） |
| 2 | **强状态驱动** | 所有操作按钮只由记录 `status` 决定，不允许前端自行推断"应该可以" |
| 3 | **高危操作必须二次确认** | 打款类操作必须走 Modal，包含明确的复核信息与"CONFIRM"输入 |
| 4 | **提交幂等与防重复** | 同一操作在提交中必须锁 UI，禁止重复点击；返回冲突时提示"已被处理" |
| 5 | **文案单一语义** | 同一操作在全站只用一种按钮文案、提示文案、成功失败文案 |
| 6 | **所有动作都必须可追溯** | 成功后必须触发"刷新详情 + 日志区"，让操作者立即看到审计结果 |

---

## 1. 组件清单与职责

### 1.1 WithdrawActionBar

> 提现详情页（Drawer）顶部或底部的操作区容器

| 属性 | 说明 |
|------|------|
| **输入** | `record`, `permissions`, `onActionSuccess()` |
| **输出** | 按状态渲染 0~2 个操作按钮（审核、打款） |

```typescript
interface WithdrawActionBarProps {
  record: WithdrawRecord
  permissions: WithdrawPermissions
  onActionSuccess: () => void
}
```

### 1.2 ReviewWithdrawButton

> 发起"审核"流程入口（打开审核 Drawer/Modal）

| 属性 | 值 |
|------|-----|
| 呈现 | Primary（但不使用危险色） |
| 图标 | `ShieldCheck` 或 `CheckCircle2` |

### 1.3 PayoutWithdrawButton

> 发起"打款确认"流程入口（打开高危 Modal）

| 属性 | 值 |
|------|-----|
| 呈现 | **Danger**（高危色），且必须带图标提示 |
| 图标 | `CreditCard` 或 `Banknote` |

### 1.4 ReviewWithdrawDrawer

> 通过/驳回的表单容器（轻中危）

**包含内容**：
- 操作说明
- 通过/驳回选择
- 驳回原因
- 提交与取消

### 1.5 PayoutConfirmModal

> 打款二次确认（高危）

**包含内容**：
- 关键字段复核卡
- 打款方式
- 输入 CONFIRM
- 最终确认按钮

---

## 2. 状态机到按钮映射（唯一真源）

> 提现状态：`pending` | `approved` | `processing` | `completed` | `failed`

| status | 可见按钮 | 备注 |
|--------|----------|------|
| `pending` | **审核** | 有 `REVIEW` 权限才显示 |
| `approved` | **打款** | 有 `PAYOUT` 权限才显示 |
| `processing` | 无 | 仅展示"处理中"状态标签 |
| `completed` | 无 | 仅展示"已完成" |
| `failed` | 无 | 仅展示失败原因 |

### 🚫 禁止规则

- ❌ 禁止在 `pending` 同时出现"打款"
- ❌ 禁止在 `approved` 仍然出现"审核"

### 实现代码

```typescript
type WithdrawAction = 'review' | 'payout'

function canShowAction(
  record: WithdrawRecord,
  perms: WithdrawPermissions,
  action: WithdrawAction
): boolean {
  if (action === 'review') {
    return record.status === 'pending' && perms.REVIEW
  }
  if (action === 'payout') {
    return record.status === 'approved' && perms.PAYOUT
  }
  return false
}

// 使用示例
{canShowAction(record, perms, 'review') && (
  <ReviewWithdrawButton onClick={openReviewDrawer} />
)}

{canShowAction(record, perms, 'payout') && (
  <PayoutWithdrawButton onClick={openPayoutModal} />
)}
```

---

## 3. 权限规范（不渲染，不禁用）

### 权限点定义

| 权限 | 说明 |
|------|------|
| `ADMIN_WITHDRAW_VIEW` | 查看列表/详情 |
| `ADMIN_WITHDRAW_REVIEW` | 审核通过/驳回 |
| `ADMIN_WITHDRAW_PAYOUT` | 执行打款 |

### 渲染规则

| 权限缺失 | UI 行为 |
|----------|---------|
| 无 `VIEW` | 列表不可见或进入即 403 页（产品策略决定） |
| 无 `REVIEW` | `pending` 也不显示"审核"按钮 |
| 无 `PAYOUT` | `approved` 也不显示"打款"按钮 |

### 🚫 禁止行为

```typescript
// ❌ 错误：灰色按钮 + tooltip
<Button disabled={!hasPermission} title="你没有权限">
  审核
</Button>

// ✅ 正确：无权限直接不渲染
{hasPermission('withdraw.review') && (
  <Button onClick={handleReview}>审核</Button>
)}
```

**不要灰按钮，不要 tooltip "你没有权限"。**  
权限不足是系统规则，不应把"诱因"留在 UI 上。

---

## 4. 按钮规范（样式、文案、图标、位置）

### 4.1 按钮文案（固定）

| 场景 | 文案 |
|------|------|
| 审核入口按钮 | `审核` |
| 审核提交-通过 | `确认通过` |
| 审核提交-驳回 | `确认驳回` |
| 打款入口按钮 | `打款` |
| 打款提交按钮 | `确认打款` |

### 4.2 图标建议（lucide-react）

| 操作 | 图标 | 备注 |
|------|------|------|
| 审核 | `ShieldCheck` / `CheckCircle2` | - |
| 打款 | `CreditCard` / `Banknote` | 必须配合 Danger 样式 |
| 处理中 | `Loader2` | 旋转动画 |

### 4.3 按钮层级

| 操作 | 样式 |
|------|------|
| 审核 | `Primary` |
| 打款 | `Destructive` / `Danger` |
| 取消 | `Secondary` / `Ghost` |

### 4.4 位置与顺序

**Drawer/Modal 底部操作区**：

```
┌─────────────────────────────────────────┐
│                                         │
│   [取消]              [确认通过/打款]   │
│   ↑                         ↑           │
│   左侧                     右侧         │
└─────────────────────────────────────────┘
```

**列表页操作列**：

- 仅显示一个主入口：`审核` 或 `打款`（按状态）
- 不同时显示多个操作按钮

---

## 5. 禁用态与 Loading

### 5.1 允许禁用的唯一场景

| 场景 | 说明 |
|------|------|
| 网络请求进行中 | `isSubmitting === true` |
| 表单未满足约束 | 驳回未填原因 / CONFIRM 未匹配 |

### 5.2 禁用态提示（按钮旁，非按钮内）

| 场景 | 提示文案 |
|------|----------|
| 审核驳回未填原因 | `请填写驳回原因` |
| 打款未输入 CONFIRM | `请输入 CONFIRM 以继续` |
| 提交中 | 按钮文案保持不变 + loading spinner |

```typescript
// 正确的禁用提示方式
<div className="flex flex-col gap-2">
  <Button 
    disabled={!canSubmit || isSubmitting}
    loading={isSubmitting}
  >
    {isSubmitting ? <Loader2 className="animate-spin" /> : null}
    确认打款
  </Button>
  {!isConfirmValid && (
    <span className="text-sm text-muted-foreground">
      请输入 CONFIRM 以继续
    </span>
  )}
</div>
```

### 5.3 🚫 禁止的禁用方式

| ❌ 禁止 | 原因 |
|--------|------|
| 因"无权限"禁用 | 应直接不渲染 |
| 因"状态不允许"禁用 | 应直接不渲染 |

---

## 6. 审核 Drawer 规范（ReviewWithdrawDrawer）

### 6.1 结构

```
┌─────────────────────────────────────────────────┐
│ 提现审核                                   [×]  │
├─────────────────────────────────────────────────┤
│                                                 │
│ 【只读信息卡】                                  │
│ ┌─────────────────────────────────────────────┐ │
│ │  提现单号: WD202412120001                   │ │
│ │  陪诊员:   张三 (ID: esc_001)               │ │
│ │  金额:     ¥500.00                          │ │
│ │  到账账户: 招商银行 ****6789                │ │
│ │  申请时间: 2024-12-12 10:30                 │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ 【操作选择】                                    │
│ ┌─────────────────────────────────────────────┐ │
│ │  (●) 通过                                   │ │
│ │  ( ) 驳回                                   │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│ 【驳回原因】（仅驳回时显示）                    │
│ ┌─────────────────────────────────────────────┐ │
│ │  [textarea, 最少 6 字]                      │ │
│ │                                             │ │
│ │  快捷选项:                                  │ │
│ │  • 账户信息不一致                           │ │
│ │  • 风控命中                                 │ │
│ │  • 重复提现                                 │ │
│ │  • 资料不完整                               │ │
│ │  • 其他（必填说明）                         │ │
│ └─────────────────────────────────────────────┘ │
│                                                 │
│        [取消]              [确认通过/确认驳回]  │
│                                                 │
└─────────────────────────────────────────────────┘
```

### 6.2 驳回原因建议枚举

```typescript
const REJECT_REASONS = [
  { value: 'account_mismatch', label: '账户信息不一致' },
  { value: 'risk_control', label: '风控命中' },
  { value: 'duplicate', label: '重复提现' },
  { value: 'incomplete', label: '资料不完整' },
  { value: 'other', label: '其他（必填说明）' },
] as const
```

### 6.3 成功提示

| 操作 | Toast 文案 |
|------|------------|
| 通过 | `已通过，状态已更新为"待打款"。` |
| 驳回 | `已驳回，状态已更新为"失败"。` |

---

## 7. 打款确认 Modal 规范（PayoutConfirmModal，高危）

### 7.1 必须是 Modal（禁止 Drawer）

> **原因**：Modal 更具"终局感"，降低误触。

### 7.2 结构（固定）

```
┌───────────────────────────────────────────────────────┐
│                      确认打款                          │
├───────────────────────────────────────────────────────┤
│                                                       │
│  ① 危险提示块（红色边框/背景）                        │
│  ┌─────────────────────────────────────────────────┐  │
│  │  ⚠️ 此操作不可撤销                              │  │
│  │     请确认已完成线下/渠道打款核对                │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│  ② 关键信息复核（必须展示）                           │
│  ┌─────────────────────────────────────────────────┐  │
│  │  提现单号:   WD202412120001                     │  │
│  │  金额:       ¥500.00                            │  │
│  │  到账账户:   招商银行 ****6789                  │  │
│  │  陪诊员:     张三 (esc_001)                     │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│  ③ 打款方式选择                                       │
│  ┌─────────────────────────────────────────────────┐  │
│  │  (●) 人工线下打款                               │  │
│  │  ( ) 支付渠道打款（预留）                       │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│  ④ 交易号输入（可选，渠道打款时必填）                 │
│  ┌─────────────────────────────────────────────────┐  │
│  │  [交易号/流水号输入框]                          │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│  ⑤ 输入确认文本（必须）                               │
│  ┌─────────────────────────────────────────────────┐  │
│  │  请输入 CONFIRM 以继续:                         │  │
│  │  [________________]                             │  │
│  │  （禁止复制粘贴）                               │  │
│  └─────────────────────────────────────────────────┘  │
│                                                       │
│              [取消]            [确认打款]             │
│             Secondary           Danger                │
│                                                       │
└───────────────────────────────────────────────────────┘
```

### 7.3 禁止复制粘贴 CONFIRM

```typescript
<Input
  value={confirmText}
  onChange={(e) => setConfirmText(e.target.value)}
  onPaste={(e) => {
    e.preventDefault()
    toast.warning('请手动输入 CONFIRM')
  }}
  placeholder="输入 CONFIRM"
/>
```

### 7.4 结果反馈

| 结果 | Toast 文案 |
|------|------------|
| 成功 | `打款已提交，状态更新为"已完成"。` |
| 失败 | `打款失败：{failReason}（请查看操作日志）` |

---

## 8. Toast / Banner 文案规范（统一口径）

### 8.1 通用错误

| HTTP 状态码 | 文案 |
|-------------|------|
| 401 | `登录已过期，请重新登录。` |
| 403 | `无权限执行该操作。` |
| 409（状态冲突） | `该提现已被其他人处理，请刷新后查看最新状态。` |
| 5xx | `系统繁忙，请稍后重试。` |

### 8.2 审核

| 场景 | 文案 |
|------|------|
| 成功-通过 | `已通过，状态已更新为"待打款"。` |
| 成功-驳回 | `已驳回，状态已更新为"失败"。` |
| 失败 | `审核失败，请重试或联系管理员。` |

### 8.3 打款

| 场景 | 文案 |
|------|------|
| 成功 | `打款已提交，状态更新为"已完成"。` |
| 失败 | `打款失败，请查看失败原因与操作日志。` |

### 8.4 实现示例

```typescript
const ERROR_MESSAGES: Record<number, string> = {
  401: '登录已过期，请重新登录。',
  403: '无权限执行该操作。',
  409: '该提现已被其他人处理，请刷新后查看最新状态。',
}

function handleApiError(error: ApiError) {
  const message = ERROR_MESSAGES[error.status] ?? '系统繁忙，请稍后重试。'
  toast.error(message)
  
  if (error.status === 409) {
    // 刷新数据
    queryClient.invalidateQueries(['admin', 'withdraw-records'])
  }
}
```

---

## 9. 刷新策略（必须做）

> 每次审核/打款成功后，必须刷新以下数据：

### 9.1 需要刷新的 Query

| Query Key | 说明 |
|-----------|------|
| `['admin', 'withdraw-records']` | 列表 |
| `['admin', 'withdraw-record', id]` | 详情 |
| `['admin', 'withdraw-record', id, 'logs']` | 日志 |

### 9.2 实现代码

```typescript
const queryClient = useQueryClient()

async function onActionSuccess(withdrawId: string) {
  // 批量刷新
  await Promise.all([
    queryClient.invalidateQueries(['admin', 'withdraw-records']),
    queryClient.invalidateQueries(['admin', 'withdraw-record', withdrawId]),
    queryClient.invalidateQueries(['admin', 'withdraw-record', withdrawId, 'logs']),
  ])
}
```

### 9.3 目的

让操作者**操作后立刻看到审计结果**，降低二次误操作。

---

## 10. 完整实现接口参考

### 10.1 权限与状态判断

```typescript
interface WithdrawPermissions {
  VIEW: boolean
  REVIEW: boolean
  PAYOUT: boolean
}

type WithdrawStatus = 'pending' | 'approved' | 'processing' | 'completed' | 'failed'

type WithdrawAction = 'review' | 'payout'

/**
 * 判断是否可以显示某个操作按钮
 * 
 * @example
 * canShowAction(record, perms, 'review') // pending + REVIEW 权限
 * canShowAction(record, perms, 'payout') // approved + PAYOUT 权限
 */
function canShowAction(
  record: { status: WithdrawStatus },
  perms: WithdrawPermissions,
  action: WithdrawAction
): boolean {
  if (action === 'review') {
    return record.status === 'pending' && perms.REVIEW
  }
  if (action === 'payout') {
    return record.status === 'approved' && perms.PAYOUT
  }
  return false
}
```

### 10.2 WithdrawActionBar 组件

```typescript
interface WithdrawActionBarProps {
  record: WithdrawRecord
  permissions: WithdrawPermissions
  onReviewClick: () => void
  onPayoutClick: () => void
}

export function WithdrawActionBar({
  record,
  permissions,
  onReviewClick,
  onPayoutClick,
}: WithdrawActionBarProps) {
  return (
    <div className="flex gap-2">
      {canShowAction(record, permissions, 'review') && (
        <Button onClick={onReviewClick}>
          <ShieldCheck className="mr-2 h-4 w-4" />
          审核
        </Button>
      )}
      
      {canShowAction(record, permissions, 'payout') && (
        <Button variant="destructive" onClick={onPayoutClick}>
          <CreditCard className="mr-2 h-4 w-4" />
          打款
        </Button>
      )}
    </div>
  )
}
```

### 10.3 审核 Mutation

```typescript
const reviewMutation = useMutation({
  mutationFn: (data: ReviewRequest) => 
    adminApi.post(`/admin/withdraw-records/${id}/review`, data),
  onSuccess: (_, variables) => {
    const message = variables.action === 'approve'
      ? '已通过，状态已更新为"待打款"。'
      : '已驳回，状态已更新为"失败"。'
    toast.success(message)
    onActionSuccess(id)
    onClose()
  },
  onError: handleApiError,
})
```

### 10.4 打款 Mutation

```typescript
const payoutMutation = useMutation({
  mutationFn: (data: PayoutRequest) =>
    adminApi.post(`/admin/withdraw-records/${id}/payout`, data),
  onSuccess: () => {
    toast.success('打款已提交，状态更新为"已完成"。')
    onActionSuccess(id)
    onClose()
  },
  onError: (error: ApiError) => {
    if (error.data?.failReason) {
      toast.error(`打款失败：${error.data.failReason}（请查看操作日志）`)
    } else {
      handleApiError(error)
    }
  },
})
```

---

## 11. 设计审计清单（已完成验证）

### 权限与渲染

- [x] 无权限是否真的"不渲染按钮"（非 disabled）
- [x] 无 `VIEW` 权限是否 403 页面
- [x] 无 `REVIEW` 权限是否隐藏审核按钮
- [x] 无 `PAYOUT` 权限是否隐藏打款按钮

### 状态与按钮

- [x] `pending` 状态是否只出现"审核"
- [x] `approved` 状态是否只出现"打款"
- [x] `processing` / `completed` / `failed` 是否无操作按钮

### 高危操作

- [x] 打款是否使用 Modal（非 Drawer）
- [x] 打款 Modal 是否包含关键信息复核
- [x] 打款 Modal 是否需要输入 CONFIRM
- [x] CONFIRM 输入框是否禁止粘贴

### 错误处理

- [x] 409 冲突是否有明确提示并引导刷新
- [x] 401/403/5xx 是否有统一错误提示
- [x] 网络错误是否有兜底提示

### 数据刷新

- [x] 成功后是否刷新列表数据
- [x] 成功后是否刷新详情数据
- [x] 成功后是否刷新日志数据

### 防重复

- [x] 提交中是否 loading 状态
- [x] 提交中是否禁用按钮
- [x] 提交中是否禁用关闭 Modal/Drawer

---

## 附录：一句话总结

```
┌─────────────────────────────────────────────────────┐
│                                                     │
│   无权限 → 不渲染                                   │
│   状态不允许 → 不渲染                               │
│   高危操作 → Modal + CONFIRM                        │
│   成功 → 立刻刷新，立刻可见审计结果                 │
│                                                     │
└─────────────────────────────────────────────────────┘
```
