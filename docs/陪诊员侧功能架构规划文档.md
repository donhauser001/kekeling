# 陪诊员侧功能架构规划文档

> 文档版本：v1.2  
> 创建日期：2024-12-11  
> 更新日期：2024-12-11  
> 状态：✅ 第一阶段已完成

---

## 一、背景与需求

### 1.1 当前状态

目前系统中的服务管理模块完全面向 **用户（消费者）** 设计：

- 服务基本信息（名称、描述、分类）
- 价格配置（价格、原价、计价单位）
- 服务内容（富文本详情）
- 服务亮点与须知
- 服务保障（关联模块）
- 关联流程（时长、超时策略）

### 1.2 需求分析

系统存在另一个重要角色 —— **陪诊员（服务提供者）**，他们需要：

| 需求 | 说明 | 实施阶段 |
|------|------|---------|
| **分成比例** | 了解每个服务项目完成后能获得的收入比例 | 🟢 当前阶段 |
| **操作规范** | 查看服务的标准操作流程、注意事项、质量要求等 | 🟢 当前阶段 |
| **独立账号** | 陪诊员使用独立的账号系统 | 🟡 后续阶段 |
| **订单管理** | 接单、服务、结算等功能 | 🟡 后续阶段 |

### 1.3 设计目标

1. **数据隔离**：用户和陪诊员看到的信息有差异
2. **内容复用**：操作规范可被多个服务共享
3. **独立管理**：操作规范作为独立内容模块，便于维护更新
4. **扩展性强**：为未来功能（版本管理、阅读确认、考核）预留空间

### 1.4 实施范围

#### 当前阶段（本文档范围）
- ✅ 操作规范模块（分类管理 + 内容管理）
- ✅ 服务编辑页扩展（分成比例 + 关联操作规范）
- ✅ 后台管理界面

#### 后续阶段（本文档仅做架构预留）
- ⏳ 陪诊员独立账号系统
- ⏳ 陪诊员端应用
- ⏳ 订单分成结算

---

## 二、架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         服务管理中心                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │  服务保障模块    │    │  操作规范模块    │   ← 独立内容模块   │
│  │  (已实现)       │    │  (当前实现)      │                    │
│  └────────┬────────┘    └────────┬────────┘                    │
│           │                      │                              │
│           │    M:N 关联          │    M:N 关联                  │
│           ▼                      ▼                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                     Service（服务）                        │  │
│  ├──────────────────────────────────────────────────────────┤  │
│  │  用户视角                    │  陪诊员视角（当前实现）    │  │
│  │  ├── 基本信息               │  ├── 分成比例 ✅           │  │
│  │  ├── 价格配置               │  ├── 分成说明 ✅           │  │
│  │  ├── 服务内容               │  └── 操作规范（关联）✅    │  │
│  │  ├── 服务亮点/须知          │                             │  │
│  │  ├── 服务保障（关联）       │                             │  │
│  │  └── 关联流程               │                             │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     后续阶段（架构预留）                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │  陪诊员账号系统  │    │  订单结算系统    │                    │
│  │  (独立账号)     │    │  (分成快照)      │                    │
│  └─────────────────┘    └─────────────────┘                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 模块关系图

```
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│   ┌─────────────────────┐                                       │
│   │ OperationGuide      │                                       │
│   │ Category            │ 1:N                                   │
│   │ (操作规范分类)      │◄─────────┐                            │
│   └─────────────────────┘          │                            │
│                                    │                            │
│   ┌─────────────────────┐          │                            │
│   │ OperationGuide      │──────────┘                            │
│   │ (操作规范)          │                                       │
│   └──────────┬──────────┘                                       │
│              │                                                  │
│              │ M:N                                              │
│              ▼                                                  │
│   ┌─────────────────────────────────────┐                      │
│   │ OperationGuideOnService             │                      │
│   │ (中间表)                            │                      │
│   └──────────┬──────────────────────────┘                      │
│              │                                                  │
│              │ M:N                                              │
│              ▼                                                  │
│   ┌─────────────────────┐          ┌─────────────────────┐     │
│   │ Service             │          │ ServiceGuarantee    │     │
│   │ (服务)              │◄────────►│ (服务保障)          │     │
│   │                     │   M:N    │                     │     │
│   │ + commissionRate    │          └─────────────────────┘     │
│   │ + commissionNote    │                                       │
│   └─────────────────────┘                                       │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

---

## 三、数据模型设计

### 3.1 操作规范分类（OperationGuideCategory）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | String (UUID) | ✅ | 主键 |
| name | String | ✅ | 分类名称，如「陪诊规范」「跑腿规范」 |
| description | String? | | 分类描述 |
| icon | String? | | 分类图标（lucide 图标名） |
| sort | Int | ✅ | 排序权重，默认 0 |
| status | String | ✅ | 状态：active / inactive，默认 active |
| createdAt | DateTime | ✅ | 创建时间 |
| updatedAt | DateTime | ✅ | 更新时间 |

**预置分类：**
| 名称 | 图标 | 说明 |
|------|------|------|
| 陪诊规范 | `stethoscope` | 医院陪诊相关 |
| 跑腿规范 | `package` | 代办事务相关 |
| 售后规范 | `headphones` | 退款、投诉处理 |
| 安全规范 | `shield` | 人身安全、隐私保护 |
| 服务礼仪 | `heart-handshake` | 着装、言行举止 |

### 3.2 操作规范（OperationGuide）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | String (UUID) | ✅ | 主键 |
| categoryId | String | ✅ | 关联分类 |
| title | String | ✅ | 标题 |
| summary | String? | | 摘要（列表展示，建议 100 字内） |
| content | String (Text) | ✅ | 富文本内容 |
| coverImage | String? | | 封面图（可选） |
| tags | String[] | | 标签数组 |
| sort | Int | ✅ | 排序权重，默认 0 |
| status | String | ✅ | 状态：active / inactive / draft，默认 draft |
| createdAt | DateTime | ✅ | 创建时间 |
| updatedAt | DateTime | ✅ | 更新时间 |

### 3.3 操作规范-服务关联表（OperationGuideOnService）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | String (UUID) | ✅ | 主键 |
| guideId | String | ✅ | 关联操作规范 |
| serviceId | String | ✅ | 关联服务 |
| sort | Int | ✅ | 在该服务中的排序，默认 0 |
| createdAt | DateTime | ✅ | 创建时间 |

**唯一约束：** `(guideId, serviceId)` 组合唯一

### 3.4 服务模型扩展（Service）

在现有 Service 模型基础上新增字段：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| commissionRate | Int | | 分成比例（0-100），默认 70 |
| commissionNote | String? | | 分成说明（如特殊条件、阶梯分成等） |

**约束规则：**
- commissionRate 范围：0-100
- commissionRate 默认值：70
- 显示格式：整数百分比（如 70%）

---

## 四、Prisma Schema 设计

```prisma
// ========== 操作规范模块 ==========

// 操作规范分类
model OperationGuideCategory {
  id          String           @id @default(uuid())
  name        String
  description String?
  icon        String?
  sort        Int              @default(0)
  status      String           @default("active")  // active, inactive
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  guides      OperationGuide[]

  @@map("operation_guide_categories")
}

// 操作规范
model OperationGuide {
  id          String                    @id @default(uuid())
  categoryId  String                    @map("category_id")
  title       String
  summary     String?
  content     String                    @db.Text
  coverImage  String?                   @map("cover_image")
  tags        String[]
  sort        Int                       @default(0)
  status      String                    @default("draft")  // active, inactive, draft
  createdAt   DateTime                  @default(now()) @map("created_at")
  updatedAt   DateTime                  @updatedAt @map("updated_at")

  category    OperationGuideCategory    @relation(fields: [categoryId], references: [id])
  services    OperationGuideOnService[]

  @@map("operation_guides")
}

// 操作规范-服务关联
model OperationGuideOnService {
  id        String         @id @default(uuid())
  guideId   String         @map("guide_id")
  serviceId String         @map("service_id")
  sort      Int            @default(0)
  createdAt DateTime       @default(now()) @map("created_at")

  guide     OperationGuide @relation(fields: [guideId], references: [id], onDelete: Cascade)
  service   Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([guideId, serviceId])
  @@map("operation_guide_on_service")
}
```

**Service 模型扩展（在现有基础上添加）：**
```prisma
model Service {
  // ... 现有字段 ...
  
  // 陪诊员配置（新增）
  commissionRate    Int?      @default(70) @map("commission_rate")   // 分成比例 0-100
  commissionNote    String?   @map("commission_note")                // 分成说明
  
  // 关联操作规范（新增）
  operationGuides   OperationGuideOnService[]
  
  // ... 现有关联 ...
}
```

---

## 五、后台管理界面设计

### 5.1 操作规范管理（新增页面）

**路由：** `/operation-guides`

**功能：**
- 分类管理（侧边栏或顶部 Tab）
- 规范列表（卡片展示）
- 新建/编辑规范（富文本编辑器）
- 搜索、筛选、排序
- 状态管理（启用/停用/草稿）

**界面布局：**
```
┌─────────────────────────────────────────────────────────────────┐
│  操作规范管理                                    [+ 新建规范]   │
├─────────────────────────────────────────────────────────────────┤
│  [全部] [陪诊规范] [跑腿规范] [售后规范] [安全规范] [管理分类]  │
│                                                                 │
│  🔍 搜索规范...                                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 📋 三甲医院陪诊标准流程                                   │  │
│  │ 陪诊规范  ·  已启用  ·  关联 5 个服务                    │  │
│  │                                                          │  │
│  │ 详细描述陪诊员在三甲医院执行陪诊服务的完整流程，包括...  │  │
│  │                                          [编辑] [更多 ▼] │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 📋 患者隐私保护规范                                       │  │
│  │ 安全规范  ·  已启用  ·  关联 12 个服务                   │  │
│  │                                                          │  │
│  │ 在服务过程中如何保护患者个人信息和医疗隐私，包括...      │  │
│  │                                          [编辑] [更多 ▼] │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 分类管理对话框

```
┌─────────────────────────────────────────┐
│  管理操作规范分类                  [×]  │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ ⋮⋮ 🩺 陪诊规范                  │   │
│  │    医院陪诊相关         [编辑]  │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ ⋮⋮ 📦 跑腿规范                  │   │
│  │    代办事务相关         [编辑]  │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ ⋮⋮ 🎧 售后规范                  │   │
│  │    退款、投诉处理       [编辑]  │   │
│  └─────────────────────────────────┘   │
│                                         │
│  [+ 添加分类]                           │
│                                         │
└─────────────────────────────────────────┘
```

### 5.3 服务编辑页扩展

在服务编辑页面右侧边栏，新增「陪诊员配置」卡片：

```
┌─────────────────────────────────────────┐
│ 👤 陪诊员配置                           │
├─────────────────────────────────────────┤
│                                         │
│  分成比例                               │
│  ┌───────────────────────────────────┐ │
│  │ 70                              % │ │
│  └───────────────────────────────────┘ │
│  陪诊员完成服务后获得的收入比例          │
│                                         │
│  分成说明（可选）                        │
│  ┌───────────────────────────────────┐ │
│  │ 首单额外奖励 10%                  │ │
│  └───────────────────────────────────┘ │
│                                         │
├─────────────────────────────────────────┤
│                                         │
│  关联操作规范              [管理规范 →] │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │ ⋮⋮ ☑ 三甲医院陪诊标准流程       │   │
│  │      陪诊规范 · 详细描述陪诊...  │   │
│  ├─────────────────────────────────┤   │
│  │ ⋮⋮ ☑ 患者隐私保护规范           │   │
│  │      安全规范 · 在服务过程中...  │   │
│  ├─────────────────────────────────┤   │
│  │    ☐ 服务结束确认流程           │   │
│  │      陪诊规范 · 服务完成后...    │   │
│  └─────────────────────────────────┘   │
│                                         │
│  已选规范支持拖拽排序                    │
│  [加载更多]                             │
│                                         │
└─────────────────────────────────────────┘
```

**交互说明：**
- 分成比例输入框：数字输入，范围 0-100
- 关联操作规范：勾选启用，已选项支持拖拽排序
- 点击「管理规范」跳转到操作规范管理页

### 5.4 侧边栏导航更新

在「业务中心」下新增菜单项：

```
业务中心
├── 服务管理
├── 服务分类
├── 流程管理
├── 服务保障
└── 操作规范    ← 新增
```

---

## 六、API 设计

### 6.1 操作规范分类 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /operation-guide-categories | 获取分类列表 |
| POST | /operation-guide-categories | 创建分类 |
| PUT | /operation-guide-categories/:id | 更新分类 |
| DELETE | /operation-guide-categories/:id | 删除分类 |

### 6.2 操作规范 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /operation-guides | 获取规范列表（支持分页、筛选） |
| GET | /operation-guides/active | 获取启用的规范（用于选择器） |
| GET | /operation-guides/:id | 获取规范详情 |
| POST | /operation-guides | 创建规范 |
| PUT | /operation-guides/:id | 更新规范 |
| PATCH | /operation-guides/:id/status | 更新规范状态 |
| DELETE | /operation-guides/:id | 删除规范 |

### 6.3 服务 API 扩展

更新服务创建/更新 DTO，新增字段：

```typescript
// CreateServiceDto / UpdateServiceDto 新增
{
  commissionRate?: number;  // 分成比例 0-100，默认 70
  commissionNote?: string;  // 分成说明
  guideIds?: string[];      // 操作规范 ID 数组（按顺序）
}
```

---

## 七、实施计划

### 第一阶段：数据基础（1 天）

| 任务 | 说明 |
|------|------|
| 更新 Prisma Schema | 创建 3 个新模型，Service 新增 2 个字段 |
| 数据库迁移 | `prisma db push` |
| 种子数据 | 预置操作规范分类 |

### 第二阶段：后端开发（1 天）

| 任务 | 说明 |
|------|------|
| operation-guide-categories 模块 | CRUD + 状态管理 |
| operation-guides 模块 | CRUD + 关联服务统计 |
| services 模块扩展 | 支持 commissionRate、guideIds |

### 第三阶段：前端类型与 Hooks（0.5 天）

| 任务 | 说明 |
|------|------|
| 类型定义 | OperationGuideCategory、OperationGuide |
| React Query Hooks | useOperationGuideCategories、useOperationGuides 等 |
| Service 类型扩展 | 新增 commissionRate、operationGuides |

### 第四阶段：后台界面（2 天）

| 任务 | 说明 |
|------|------|
| 操作规范管理页 | 列表、搜索、筛选、状态管理 |
| 规范编辑对话框 | 表单、富文本编辑器 |
| 分类管理对话框 | CRUD、拖拽排序 |
| 服务编辑页扩展 | 陪诊员配置卡片 |
| 侧边栏更新 | 新增菜单项 |

**预计总工时：4.5 天**

---

## 八、后续阶段规划（架构预留）

### 8.1 陪诊员账号系统

```prisma
// 陪诊员（独立账号）
model Staff {
  id              String    @id @default(uuid())
  phone           String    @unique
  password        String
  realName        String
  idCard          String?
  avatar          String?
  level           String    @default("normal")  // normal, senior, gold
  status          String    @default("pending") // pending, approved, rejected, disabled
  approvedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  certifications  StaffCertification[]
  orders          Order[]

  @@map("staffs")
}

// 陪诊员资质证书
model StaffCertification {
  id          String   @id @default(uuid())
  staffId     String
  type        String   // id_card, health_cert, training_cert
  imageUrl    String
  verifiedAt  DateTime?
  createdAt   DateTime @default(now())

  staff       Staff    @relation(fields: [staffId], references: [id])

  @@map("staff_certifications")
}
```

### 8.2 订单分成快照

```prisma
model Order {
  // ... 现有字段 ...
  
  // 分成快照（下单时记录，不受后续修改影响）
  commissionRate     Int       @map("commission_rate")       // 分成比例快照
  commissionAmount   Decimal   @map("commission_amount") @db.Decimal(10, 2)  // 陪诊员分成金额
  platformAmount     Decimal   @map("platform_amount") @db.Decimal(10, 2)    // 平台收入金额
  
  // 关联陪诊员
  staffId            String?   @map("staff_id")
  staff              Staff?    @relation(fields: [staffId], references: [id])
}
```

### 8.3 分成规则引擎（高级）

```prisma
// 分成规则（支持复杂分成逻辑）
model CommissionRule {
  id          String   @id @default(uuid())
  name        String
  priority    Int      @default(0)           // 优先级，数字越大优先级越高
  conditions  Json                           // 条件表达式
  rate        Int                            // 分成比例
  bonus       Decimal? @db.Decimal(10, 2)    // 额外奖励金额
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("commission_rules")
}

// conditions 示例：
// { "staffLevel": "gold" }                    → 金牌陪诊员
// { "serviceCategory": "陪诊服务" }           → 特定服务分类
// { "isFirstOrder": true }                    → 首单
// { "orderAmount": { "gte": 500 } }           → 订单金额 >= 500
```

---

## 九、风险与注意事项

| 风险 | 应对措施 |
|------|---------|
| 操作规范内容过长影响加载 | 列表只显示摘要，详情页按需加载 |
| 分成比例修改影响历史订单 | 后续阶段实现订单快照机制 |
| 操作规范更新后陪诊员未阅读 | 预留阅读确认机制，后续可强制要求阅读新版本 |
| 富文本内容安全性 | 后端做 XSS 过滤，前端使用安全渲染 |

---

## 十、验收标准

### 当前阶段验收清单

**操作规范模块：**
- [x] 可以创建、编辑、删除操作规范分类
- [x] 分类支持管理（通过对话框）
- [x] 可以创建、编辑、删除操作规范（富文本）
- [x] 可以按分类筛选操作规范
- [x] 可以搜索操作规范
- [x] 可以切换操作规范状态（启用/停用/草稿）
- [x] 显示操作规范关联的服务数量

**服务编辑页扩展：**
- [x] 可以设置分成比例（0-100%）
- [x] 可以填写分成说明
- [x] 可以选择关联的操作规范
- [x] 已选操作规范支持拖拽排序
- [x] 侧边栏显示「操作规范」菜单项

**✅ 第一阶段已于 2024-12-11 完成实施**

---

## 十一、总结

本方案通过引入独立的「操作规范」模块和服务级分成配置，实现了：

1. **陪诊员视角数据** - 分成比例、操作规范
2. **内容独立管理** - 操作规范可复用、易维护
3. **与现有架构一致** - 复用「服务保障」的设计模式
4. **扩展性强** - 为陪诊员账号系统、订单分成结算预留架构

**当前阶段聚焦：**
- 操作规范管理（分类 + 内容）
- 服务分成配置
- 后台管理界面

**后续阶段再实现：**
- 陪诊员独立账号系统
- 陪诊员端应用
- 订单分成结算
