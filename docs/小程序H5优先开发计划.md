# 科科灵小程序 H5 优先开发计划

> **版本**: v1.0  
> **日期**: 2024-12-08  
> **策略**: Browser (H5) >>> Simulator (微信模拟器) >>> Real Device (真机)

---

## 📋 计划概述

### 核心理念

利用浏览器的开发效率优势（热更新快、调试工具强、无需真机），完成 **90% 的业务逻辑开发**，最后花 **10% 的时间**适配微信环境。

### 时间规划

| 阶段 | 天数 | 目标 |
|------|------|------|
| 环境整备 | Day 1 上午 | H5 环境跑通 |
| C 端开发 | Day 1 下午 - Day 2 | 服务展示、下单、支付 |
| B 端开发 | Day 3 | 陪诊员工作台 |
| 真机适配 | Day 4 - Day 5 | 样式修复、真实 API 对接 |

### 数据准备 ✅ 已就绪

| 类型 | 数量 | 状态 |
|------|------|------|
| 医院 | 50 家 | ✅ |
| 科室 | 858 个 | ✅ |
| 医生 | 723 位 | ✅ |
| 服务分类 | 4 类 | ✅ |
| 服务项目 | 7 个 | ✅ |
| 陪诊员 | 10 人 (4 人接单中) | ✅ |

---

## 🛠️ 第一阶段：环境整备 (Day 1 上午)

### 1.1 启动命令

```bash
# 终端 1: 启动后端 (端口 3000)
cd server
pnpm dev

# 终端 2: 启动 H5 (端口 10086)
cd miniapp
pnpm dev:h5

# 浏览器打开
http://localhost:10086
```

### 1.2 环境验证清单

| 检查项 | 验证方式 | 预期结果 |
|--------|----------|----------|
| 后端启动 | 访问 `http://localhost:3000/api/docs` | Swagger 文档页面 |
| H5 启动 | 访问 `http://localhost:10086` | 小程序首页 |
| CORS 正常 | F12 Console 无跨域报错 | ✅ |
| API 代理 | Network 查看 `/api` 请求 | 返回 200 |

### 1.3 已完成的环境配置 ✅

```
✅ server/src/main.ts - CORS 已开启
✅ miniapp/config/dev.ts - H5 端口 10086 + API 代理
✅ miniapp/src/services/request.ts - H5 自动识别
✅ miniapp/src/utils/env-adapter.ts - Mock 适配层
✅ server/src/modules/test - 测试接口模块
```

---

## 💻 第二阶段：C 端业务开发 (Day 1 下午 - Day 2)

### Day 1 下午：服务展示与下单

#### 2.1 首页模块

**文件**: `miniapp/src/pages/index/index.tsx`

| 功能点 | API | 状态 |
|--------|-----|------|
| 轮播图 | `GET /api/home/banners` | 待对接 |
| 服务分类 | `GET /api/service-categories` | 待对接 |
| 热门服务 | `GET /api/services?isHot=true` | 待对接 |
| 推荐陪诊员 | `GET /api/escorts?limit=4` | 待对接 |

**开发要点**:
```tsx
// 使用 env-adapter 处理定位
import { mockGetLocation } from '@/utils/env-adapter'

const handleGetCity = async () => {
  const { latitude, longitude } = await mockGetLocation()
  // 调用逆地理编码获取城市名
}
```

#### 2.2 服务列表/详情

**文件**: 
- `miniapp/src/pages/services/index.tsx`
- `miniapp/src/pages/services/detail.tsx`

| 功能点 | API | 状态 |
|--------|-----|------|
| 服务列表 | `GET /api/services` | 待对接 |
| 服务详情 | `GET /api/services/:id` | 待对接 |
| 服务内容展示 | 解析 `serviceIncludes` JSON | 待开发 |
| 服务须知展示 | 解析 `serviceNotes` JSON | 待开发 |

#### 2.3 预约下单页

**文件**: `miniapp/src/pages/booking/index.tsx`

**表单字段**:
```typescript
interface BookingForm {
  serviceId: string       // 服务 ID
  hospitalId: string      // 医院 ID
  departmentId?: string   // 科室 ID (可选)
  doctorId?: string       // 医生 ID (可选)
  patientId: string       // 就诊人 ID
  appointmentDate: string // 预约日期
  appointmentTime: string // 预约时段
  userRemark?: string     // 备注
}
```

**API 调用顺序**:
```
1. GET /api/hospitals (选医院)
      ↓
2. GET /api/hospitals/:id/departments (选科室)
      ↓
3. GET /api/departments/:id/doctors (选医生)
      ↓
4. GET /api/patients (选就诊人)
      ↓
5. POST /api/orders (提交订单)
```

**开发要点**:
```tsx
// 表单联动示例
const [hospitals, setHospitals] = useState([])
const [departments, setDepartments] = useState([])
const [doctors, setDoctors] = useState([])

// 选择医院后加载科室
const handleHospitalChange = async (hospitalId: string) => {
  const depts = await get(`/hospitals/${hospitalId}/departments`)
  setDepartments(depts)
  setDoctors([]) // 清空医生
}

// 选择科室后加载医生
const handleDepartmentChange = async (departmentId: string) => {
  const docs = await get(`/departments/${departmentId}/doctors`)
  setDoctors(docs)
}
```

### Day 2：支付与订单管理

#### 2.4 支付流程

**H5 模拟支付流程**:

```
┌─────────────────────────────────────────────────────────────┐
│                      H5 模拟支付流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. POST /api/orders        →  创建订单 (status: pending)   │
│                                        ↓                    │
│  2. mockRequestPayment()    →  弹出确认框                   │
│                                        ↓                    │
│  3. 用户点击"支付成功"       →  确认                         │
│                                        ↓                    │
│  4. POST /api/test/pay-order/:id  →  订单状态改为 paid     │
│                                        ↓                    │
│  5. 跳转订单详情页          →  显示"待接单"                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**代码示例**:
```tsx
import { mockRequestPayment } from '@/utils/env-adapter'
import { post } from '@/services/request'

const handlePay = async (orderId: string, amount: number) => {
  try {
    // 1. 弹出模拟支付确认框
    await mockRequestPayment({ 
      orderId, 
      totalAmount: amount 
    })
    
    // 2. 调用测试接口改状态 (仅 H5 开发时)
    if (process.env.TARO_ENV === 'h5') {
      await post(`/test/pay-order/${orderId}`)
    }
    
    // 3. 跳转成功页
    Taro.redirectTo({ url: `/pages/orders/detail?id=${orderId}` })
  } catch (err) {
    Taro.showToast({ title: '支付取消', icon: 'none' })
  }
}
```

#### 2.5 订单列表/详情

**文件**:
- `miniapp/src/pages/orders/index.tsx`
- `miniapp/src/pages/orders/detail.tsx`

| 功能点 | API | 状态 |
|--------|-----|------|
| 订单列表 | `GET /api/orders` | 待对接 |
| 订单详情 | `GET /api/orders/:id` | 待对接 |
| 取消订单 | `POST /api/orders/:id/cancel` | 待对接 |
| 申请退款 | `POST /api/orders/:id/refund/request` | 待对接 |

**订单状态展示**:
```typescript
const STATUS_CONFIG = {
  pending: { label: '待支付', color: '#faad14', action: '去支付' },
  paid: { label: '待接单', color: '#1890ff', action: null },
  confirmed: { label: '已确认', color: '#722ed1', action: null },
  assigned: { label: '已派单', color: '#13c2c2', action: '联系陪诊员' },
  in_progress: { label: '服务中', color: '#52c41a', action: '联系陪诊员' },
  completed: { label: '已完成', color: '#8c8c8c', action: '去评价' },
  cancelled: { label: '已取消', color: '#ff4d4f', action: null },
}
```

---

## 👨‍⚕️ 第三阶段：B 端陪诊员工作台 (Day 3)

### 3.1 工作台入口

**入口方式**: 在搜索框输入 `*#06#`

```tsx
// 在搜索组件中监听
import { checkDebugCommand } from '@/utils/env-adapter'

const handleSearch = (value: string) => {
  if (checkDebugCommand(value)) return // 进入工作台
  // 正常搜索逻辑...
}
```

**路由**: `/pages/workbench/index`

### 3.2 工作台页面结构

```
pages/workbench/
├── index.tsx          # 工作台首页 (今日任务概览)
├── orders/
│   ├── pool.tsx       # 抢单大厅
│   ├── mine.tsx       # 我的订单
│   └── detail.tsx     # 订单详情
├── profile/
│   ├── index.tsx      # 个人中心
│   └── settings.tsx   # 设置
└── components/
    ├── OrderCard.tsx  # 订单卡片
    └── StatCard.tsx   # 统计卡片
```

### 3.3 抢单大厅

**文件**: `miniapp/src/pages/workbench/orders/pool.tsx`

**API**:
```typescript
// 获取可抢订单列表
GET /api/escort/orders/pool
Query: { cityCode, hospitalId, limit }

// 抢单
POST /api/escort/orders/:id/grab
Response: { success: true } | { error: '订单已被抢走' }
```

**并发测试方法**:
1. 在浏览器开两个标签页
2. 分别登录不同陪诊员账号
3. 同时点击抢单按钮
4. 验证只有一人成功

### 3.4 订单执行流程

```
┌─────────────────────────────────────────────────────────────┐
│                    陪诊员执行订单流程                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  status: assigned    →  [我已到达]  →  status: confirmed    │
│                                              ↓              │
│  status: confirmed   →  [开始服务]  →  status: in_progress  │
│                                              ↓              │
│  status: in_progress →  [服务完成]  →  status: completed    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**API 调用**:
```typescript
// 确认到达
POST /api/escort/orders/:id/arrive

// 开始服务
POST /api/escort/orders/:id/start

// 完成服务
POST /api/escort/orders/:id/complete
```

---

## 📲 第四阶段：真机迁移与适配 (Day 4 - Day 5)

### Day 4：样式与原生能力修复

#### 4.1 启动命令切换

```bash
# 停止 H5
Ctrl + C

# 启动微信小程序编译
pnpm dev:weapp

# 打开微信开发者工具
# 导入项目目录: miniapp/dist
```

#### 4.2 样式适配清单

| 问题 | 解决方案 |
|------|----------|
| SafeArea (刘海屏) | 使用 `safe-area-inset-bottom` |
| TabBar 高度差异 | 使用 Taro 的 `getSystemInfo` 动态计算 |
| ScrollView 滚动条 | 隐藏或自定义样式 |
| 字体大小不一致 | 检查 `designWidth: 750` 配置 |
| 图片比例变形 | 使用 `mode="aspectFill"` |

#### 4.3 原生 API 替换

```tsx
// 修改前 (H5 Mock)
import { mockLogin, mockGetLocation } from '@/utils/env-adapter'

// 修改后 (生产环境)
// env-adapter.ts 会自动判断环境，无需修改代码
// isH5 = false 时会调用真实的 Taro API
```

#### 4.4 微信登录对接

```tsx
// 1. 获取 code
const { code } = await mockLogin() // 小程序环境会调用真实 Taro.login

// 2. 调用后端换取 token
const { token, user } = await post('/auth/wechat-login', { code })

// 3. 存储 token
setToken(token)
```

### Day 5：全链路联调测试

#### 5.1 测试场景清单

| 场景 | 测试点 | 预期 |
|------|--------|------|
| 弱网 | 开发者工具 Slow 3G | 请求超时提示 |
| 定位拒绝 | 系统设置禁用定位 | 使用默认城市 |
| 手机号拒绝 | 用户拒绝授权 | 提示手动输入 |
| 表单错误 | 身份证格式错 | 红色错误提示 |
| 支付失败 | 余额不足/取消 | 返回订单详情 |
| 并发抢单 | 两人同时抢 | 只有一人成功 |

#### 5.2 真机预览

```bash
# 1. 微信开发者工具 -> 预览 -> 扫码

# 2. 测试设备清单
- iPhone 15 Pro (iOS 17)
- iPhone SE (小屏)
- 小米 14 (Android 14)
- 低端安卓机 (性能测试)
```

---

## 📡 测试接口汇总

### H5 开发专用接口 (仅开发环境)

| 端点 | 方法 | 功能 | 使用场景 |
|------|------|------|----------|
| `/api/test/pay-order/:id` | POST | 模拟支付 | 支付流程测试 |
| `/api/test/update-order-status/:id` | POST | 强制改状态 | 跳过状态校验 |
| `/api/test/mock-login` | POST | 模拟登录 | 无微信环境登录 |
| `/api/test/quick-order` | POST | 快速建单 | 批量创建测试订单 |
| `/api/test/users` | GET | 测试用户 | 查看可用用户 |
| `/api/test/escorts` | GET | 测试陪诊员 | 查看可用陪诊员 |
| `/api/test/cleanup` | POST | 清理数据 | 清理 mock 数据 |

### 业务接口 (生产可用)

详见 [API接口规范文档](./API接口规范文档.md)

---

## ⚠️ 注意事项

### 1. 生产环境前必做

```typescript
// server/src/app.module.ts
// ⚠️ 上线前注释掉 TestModule
import { TestModule } from './modules/test/test.module';

@Module({
  imports: [
    // ...
    // TestModule, // ← 注释掉！
  ],
})
```

### 2. 域名备案要求

| 域名 | 用途 | 状态 |
|------|------|------|
| `api.yourdomain.com` | 后端 API | 待备案 |
| `cdn.yourdomain.com` | 静态资源 | 待备案 |

### 3. 微信支付准备

| 事项 | 负责人 | 状态 |
|------|--------|------|
| 商户号 (Mch ID) | 运营 | 待申请 |
| API 证书 | 运营 | 待配置 |
| 支付回调域名 | 开发 | 待配置 |

---

## 📊 进度跟踪

### 每日 Checklist

#### Day 1 ☐
- [ ] H5 环境启动成功
- [ ] 首页数据对接
- [ ] 服务列表/详情页对接
- [ ] 预约下单页表单开发

#### Day 2 ☐
- [ ] 支付流程 (Mock) 跑通
- [ ] 订单列表/详情页对接
- [ ] 取消订单功能
- [ ] 就诊人管理页面

#### Day 3 ☐
- [ ] 陪诊员工作台首页
- [ ] 抢单大厅页面
- [ ] 订单执行流程 (到达/开始/完成)
- [ ] 并发抢单测试

#### Day 4 ☐
- [ ] 切换微信小程序编译
- [ ] 样式适配修复
- [ ] 真实登录对接
- [ ] 定位权限处理

#### Day 5 ☐
- [ ] 弱网测试
- [ ] 授权拒绝测试
- [ ] 表单校验测试
- [ ] 真机全流程测试

---

## 🎯 成功标准

### MVP 上线标准

1. **C 端用户**: 可以完成 浏览服务 → 下单 → 支付 → 查看订单 全流程
2. **B 端陪诊员**: 可以完成 抢单 → 执行 → 完成 全流程
3. **无阻塞性 Bug**: 核心流程无崩溃、无白屏
4. **性能达标**: 首屏加载 < 3秒 (4G 网络)

---

*文档版本: v1.0 | 最后更新: 2024-12-08*

