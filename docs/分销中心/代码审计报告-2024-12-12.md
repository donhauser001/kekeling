# ä»£ç å®¡è®¡æŠ¥å‘Šï¼šåˆ†é”€ä¸­å¿ƒæ¨¡å—

> **å®¡è®¡å¯¹è±¡**: Distribution, Promotion, Team Modules  
> **å®¡è®¡æ—¶é—´**: 2024-12-12  
> **å®¡è®¡äººå‘˜**: Senior Code Auditor  
> **æ–‡æ¡£ç‰ˆæœ¬**: v2.0ï¼ˆç­–ç•¥æ¨¡å¼é‡æ„å®Œæˆï¼Œæ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼‰

---

## å®¡è®¡ç»“æœæ‘˜è¦

æ•´ä½“æ¶æ„æ¸…æ™°ï¼Œèƒ½å¤Ÿæ»¡è¶³åŸºæœ¬çš„MVPä¸šåŠ¡éœ€æ±‚ã€‚åˆ©ç”¨ Prisma çš„äº‹åŠ¡æœºåˆ¶è¾ƒå¥½åœ°ä¿è¯äº†èµ„é‡‘æ“ä½œçš„åŸå­æ€§ã€‚ä½†åœ¨**é«˜æ€§èƒ½åœºæ™¯ä¸‹çš„æŸ¥è¯¢æ•ˆç‡ï¼ˆN+1é—®é¢˜ï¼‰**ã€**æµ®ç‚¹æ•°é‡‘é¢è®¡ç®—**ä»¥åŠ**é€’å½’é€»è¾‘çš„å¥å£®æ€§**æ–¹é¢å­˜åœ¨æ˜¾è‘—é£é™©ï¼Œå»ºè®®åœ¨ä¸Šçº¿å‰è¿›è¡Œä¼˜åŒ–ã€‚

---

## 1. æ ¸å¿ƒä¼˜åŠ¿ (Key Strengths)

### 1.1 èµ„é‡‘å®‰å…¨ä¸åŸå­æ€§ (ACID Compliance)

- åœ¨å¤„ç†é‚€è¯·å…³ç³»ç»‘å®šã€åˆ†æ¶¦ç»“ç®—ã€æç°æ‰£å›ç­‰æ¶‰åŠèµ„é‡‘å’ŒçŠ¶æ€å˜æ›´çš„æ“ä½œæ—¶ï¼Œæ­£ç¡®ä½¿ç”¨äº† `this.prisma.$transaction`
- ä¾‹å¦‚ `createDistributionRecords` å’Œ `settleDistributionRecords`ï¼Œæœ‰æ•ˆé˜²æ­¢äº†æ•°æ®ä¸ä¸€è‡´
- ä½¿ç”¨äº† Prisma çš„åŸå­æ“ä½œ `balance: { increment: ... }`ï¼Œè¿™åœ¨å¹¶å‘åœºæ™¯ä¸‹æ¯”"å…ˆæŸ¥åæ”¹"æ›´å®‰å…¨ï¼Œé¿å…äº†ç»å…¸çš„ä½™é¢è¦†ç›–ï¼ˆRace Conditionï¼‰é—®é¢˜

### 1.2 é˜²å¾ªç¯å¼•ç”¨è®¾è®¡

- åœ¨ç»‘å®šé‚€è¯·å…³ç³»æ—¶ï¼Œå®ç°äº† `isInAncestorChain` æ£€æŸ¥ï¼Œæœ‰æ•ˆé˜²æ­¢äº† A->B->A è¿™ç§å¯¼è‡´æ­»å¾ªç¯çš„é‚€è¯·å…³ç³»
- `ancestorPath` ä»…ä¿ç•™æœ€è¿‘3å±‚ (`slice(-3)`)ï¼Œè¿™æ˜¯ä¸€ä¸ªèªæ˜çš„ä¼˜åŒ–ï¼Œæ—¢æ»¡è¶³äº†ä¸‰çº§åˆ†é”€çš„è®¡ç®—éœ€æ±‚ï¼Œåˆé¿å…äº†å­—æ®µè¿‡é•¿

### 1.3 æƒé™æ§åˆ¶

- æ‰€æœ‰ Controller å‡ä½¿ç”¨äº† `JwtAuthGuard`
- é€šè¿‡ `getEscortByUserId` å¼ºåˆ¶æ ¡éªŒå½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºé™ªè¯Šå‘˜èº«ä»½ï¼ŒåŸºç¡€æƒé™æ§åˆ¶åˆ°ä½

---

## 2. é‡å¤§é£é™©ä¸æ€§èƒ½ç“¶é¢ˆ (Critical & High Risks)

### 2.1 âœ… ä¸¥é‡çš„ N+1 æŸ¥è¯¢é—®é¢˜ (Performance) - å·²ä¿®å¤

| å±æ€§ | å€¼ |
|------|-----|
| **ä½ç½®** | `TeamService.getTeamMembers` |
| **ä¸¥é‡ç¨‹åº¦** | ğŸ”´ Critical |
| **çŠ¶æ€** | âœ… å·²ä¿®å¤ |

**é—®é¢˜æè¿°**ï¼š

åœ¨è·å–å›¢é˜Ÿæˆå‘˜åˆ—è¡¨æ—¶ï¼Œä»£ç å…ˆæŸ¥è¯¢å‡ºæˆå‘˜åˆ—è¡¨ (`members`)ï¼Œç„¶åé€šè¿‡ `Promise.all` éå†æ¯ä¸€ä¸ªæˆå‘˜ï¼Œå†æ¬¡å¯¹æ•°æ®åº“å‘èµ· `order.count` å’Œ `distributionRecord.aggregate` æŸ¥è¯¢ã€‚

**åæœ**ï¼š

å¦‚æœä¸€é¡µæ˜¾ç¤º 20 ä¸ªæˆå‘˜ï¼Œåç«¯å°†å¯¹æ•°æ®åº“å‘èµ· 1 + 20*2 = 41 æ¬¡æŸ¥è¯¢ã€‚éšç€æ•°æ®é‡å¢é•¿ï¼Œåˆ—è¡¨é¡µå“åº”å°†ææ…¢ï¼Œç”šè‡³æ‹–å®æ•°æ®åº“ã€‚

**å»ºè®®ä¿®å¤æ–¹æ¡ˆ**ï¼š

```typescript
// âŒ å½“å‰å®ç°ï¼ˆN+1 é—®é¢˜ï¼‰
const members = await this.prisma.escort.findMany({ ... });
const result = await Promise.all(members.map(async (member) => {
  const orderCount = await this.prisma.order.count({ ... });
  const totalAmount = await this.prisma.distributionRecord.aggregate({ ... });
  return { ...member, orderCount, totalAmount };
}));

// âœ… æ–¹æ¡ˆ1ï¼šä½¿ç”¨ SQL JOIN / GROUP BYï¼ˆç»ˆææ–¹æ¡ˆï¼‰
const membersWithStats = await this.prisma.$queryRaw`
  SELECT e.*, 
    COUNT(DISTINCT o.id) as order_count,
    COALESCE(SUM(dr.amount), 0) as total_amount
  FROM "Escort" e
  LEFT JOIN "Order" o ON o."escortId" = e.id
  LEFT JOIN "DistributionRecord" dr ON dr."escortId" = e.id
  WHERE e."inviterId" = ${escortId}
  GROUP BY e.id
  LIMIT ${pageSize} OFFSET ${(page - 1) * pageSize}
`;

// âœ… æ–¹æ¡ˆ2ï¼šå­—æ®µå†—ä½™ + å¼‚æ­¥æ›´æ–°ï¼ˆæ¨èï¼Œç»´æŠ¤æˆæœ¬ä½ï¼‰
// åœ¨ Escort è¡¨ä¸­æ–°å¢ totalOrdersã€totalDistributionAmount å­—æ®µ
// é€šè¿‡äº‹ä»¶é©±åŠ¨ï¼ˆEvent Emitterï¼‰æˆ–é˜Ÿåˆ—åœ¨è®¢å•å®Œæˆæ—¶å¼‚æ­¥æ›´æ–°
// è¯»å–æ—¶ç›´æ¥ä½¿ç”¨ Prisma includeï¼ŒO(1) å¤æ‚åº¦
const members = await this.prisma.escort.findMany({
  where: { inviterId: escortId },
  select: {
    id: true,
    name: true,
    totalOrders: true,           // å†—ä½™å­—æ®µ
    totalDistributionAmount: true, // å†—ä½™å­—æ®µ
    _count: { select: { directInvitees: true } }
  }
});
```

**âš ï¸ å®æ–½æ³¨æ„äº‹é¡¹**ï¼š

1. **æ•°æ®è¿ç§»**ï¼šä¸Šçº¿å‰å¿…é¡»ç¼–å†™ Migration Scriptï¼Œå¯¹ç°æœ‰ `Escort` è¡¨è¿›è¡Œå…¨é‡æ‰«æï¼Œè®¡ç®—å¹¶å¡«å…… `totalOrders` å’Œ `totalDistributionAmount` çš„åˆå§‹å€¼ï¼Œå¦åˆ™æ—§æ•°æ®ä¼šæ˜¾ç¤ºä¸º 0ã€‚

```typescript
// prisma/scripts/migrate-escort-stats.ts
async function migrateEscortStats() {
  const escorts = await prisma.escort.findMany();
  for (const escort of escorts) {
    const [orderCount, totalAmount] = await Promise.all([
      prisma.order.count({ where: { escortId: escort.id } }),
      prisma.distributionRecord.aggregate({
        where: { escortId: escort.id },
        _sum: { amount: true }
      })
    ]);
    await prisma.escort.update({
      where: { id: escort.id },
      data: { totalOrders: orderCount, totalDistributionAmount: totalAmount._sum.amount || 0 }
    });
  }
}
```

2. **å®šæ—¶æ ¡å¯¹ä»»åŠ¡**ï¼šæ·»åŠ  Cron Jobï¼ˆå¦‚æ¯æ™š 3:00ï¼‰ï¼Œé‡æ–°è®¡ç®—å¹¶æ ¡å¯¹å†—ä½™å­—æ®µï¼Œä¿®æ­£å› ç³»ç»Ÿæ•…éšœå¯¼è‡´çš„è®¡æ•°åå·®ã€‚

---

**âœ… ä¿®å¤å®Œæˆï¼ˆ2024-12-12ï¼‰**

é‡‡ç”¨ **æ–¹æ¡ˆ1ï¼šgroupBy èšåˆæŸ¥è¯¢**ï¼Œå°†æŸ¥è¯¢æ¬¡æ•°ä» O(n) é™åˆ°å¸¸æ•°çº§ï¼š

```typescript
// ä¼˜åŒ–åï¼š4 æ¬¡æŸ¥è¯¢ï¼ˆmembers + total + monthlyOrdersèšåˆ + monthlyDistributionèšåˆï¼‰

// æ­¥éª¤ 1: æŸ¥è¯¢æˆå‘˜åˆ—è¡¨å’Œæ€»æ•°ï¼ˆ2 æ¬¡ï¼‰
const [members, total] = await Promise.all([
  this.prisma.escort.findMany({ where, ... }),
  this.prisma.escort.count({ where }),
]);

// æ­¥éª¤ 2: æ‰¹é‡æŸ¥è¯¢æœ¬æœˆè®¢å•æ•°ï¼ˆ1 æ¬¡ groupByï¼‰
const monthlyOrdersGrouped = await this.prisma.order.groupBy({
  by: ['escortId'],
  where: { escortId: { in: memberIds }, ... },
  _count: { id: true },
});

// æ­¥éª¤ 3: æ‰¹é‡æŸ¥è¯¢æœ¬æœˆåˆ†æ¶¦è´¡çŒ®ï¼ˆ1 æ¬¡ groupByï¼‰
const monthlyDistributionGrouped = await this.prisma.distributionRecord.groupBy({
  by: ['sourceEscortId'],
  where: { sourceEscortId: { in: memberIds }, ... },
  _sum: { amount: true },
});

// æ­¥éª¤ 4: å†…å­˜åˆå¹¶
const membersWithStats = members.map((m) => ({
  ...m,
  monthlyOrders: monthlyOrdersMap.get(m.id) || 0,
  monthlyDistribution: monthlyDistributionMap.get(m.id) || 0,
}));
```

**æ€§èƒ½æå‡**ï¼š
- ä¼˜åŒ–å‰ï¼špageSize=20 æ—¶ï¼Œ41 æ¬¡æŸ¥è¯¢
- ä¼˜åŒ–åï¼špageSize=20 æ—¶ï¼Œ4 æ¬¡æŸ¥è¯¢ï¼ˆé™ä½ 90%ï¼‰

### 2.2 âœ… é€’å½’æŸ¥è¯¢çš„æ€§èƒ½éšæ‚£ (Scalability) - å·²ä¿®å¤

| å±æ€§ | å€¼ |
|------|-----|
| **ä½ç½®** | `TeamService.getAllTeamMemberIds`, `updateTotalTeamSize` |
| **ä¸¥é‡ç¨‹åº¦** | ğŸ”´ High |
| **çŠ¶æ€** | âœ… å·²ä¿®å¤ |

**é—®é¢˜æè¿°**ï¼š

è¿™äº›æ–¹æ³•ä½¿ç”¨ä»£ç å±‚é¢çš„é€’å½’ï¼ˆRecursive Functionï¼‰æ¥éå†æ ‘çŠ¶ç»“æ„ï¼š

- `getAllTeamMemberIds`ï¼šå¦‚æœå›¢é˜Ÿå±‚çº§å¾ˆæ·±ï¼ˆä¾‹å¦‚ 100 å±‚ï¼‰ï¼Œé€’å½’è°ƒç”¨æ•°æ®åº“ä¼šå¯¼è‡´å“åº”è¶…æ—¶æˆ–æ ˆæº¢å‡º
- `updateTotalTeamSize`ï¼šæ¯æ¬¡æ–°å¢ä¸‹çº§éƒ½ä¼šè§¦å‘å‘ä¸Šçš„é€’å½’æ›´æ–°ï¼Œè¿™åœ¨"é«˜å¹¶å‘å†™å…¥"æ—¶ä¼šé€ æˆä¸¥é‡çš„é”ç«äº‰

**å»ºè®®ä¿®å¤æ–¹æ¡ˆ**ï¼š

1. è€ƒè™‘ä½¿ç”¨"é—­åŒ…è¡¨ï¼ˆClosure Tableï¼‰"æˆ–"ç‰©åŒ–è·¯å¾„ï¼ˆMaterialized Pathï¼‰"çš„é«˜çº§ç”¨æ³•æ¥ä¼˜åŒ–æ ‘å½¢æŸ¥è¯¢
2. é™åˆ¶é€’å½’æ·±åº¦ï¼ˆå½“å‰ä¸šåŠ¡ä»…éœ€3å±‚ï¼‰
3. å°† `updateTotalTeamSize` æ”¹ä¸ºå¼‚æ­¥é˜Ÿåˆ—å¤„ç†

---

**âœ… ä¿®å¤å®Œæˆï¼ˆ2024-12-12ï¼‰**

ä¸¤ä¸ªé€’å½’æ–¹æ³•å‡å·²æ·»åŠ æ·±åº¦é™åˆ¶å’ŒèŠ‚ç‚¹æ•°ä¿æŠ¤ï¼š

```typescript
// TeamService.getAllTeamMemberIds
private static readonly MAX_DEPTH = 3;   // æœ€å¤§æ·±åº¦ 3 å±‚
private static readonly MAX_NODES = 5000; // æœ€å¤§èŠ‚ç‚¹æ•° 5000

private async getAllTeamMemberIds(
  escortId: string,
  depth = 1,
  nodeCount = { value: 0 },
): Promise<string[]> {
  if (depth > TeamService.MAX_DEPTH) return [];     // æ·±åº¦ä¿æŠ¤
  if (nodeCount.value >= TeamService.MAX_NODES) return []; // èŠ‚ç‚¹æ•°ä¿æŠ¤
  // ...
}

// DistributionService.updateTotalTeamSize
private async updateTotalTeamSize(tx: any, escortId: string, depth = 1) {
  if (depth > DistributionService.MAX_DEPTH) return; // æ·±åº¦ä¿æŠ¤
  // ... å‘ä¸Šæ›´æ–°çˆ¶èŠ‚ç‚¹
}
```

**ä¿æŠ¤æªæ–½**ï¼š
- æœ€å¤§é€’å½’æ·±åº¦ï¼š3 å±‚ï¼ˆä¸åˆ†é”€æ¨¡å‹ä¸€è‡´ï¼‰
- æœ€å¤§èŠ‚ç‚¹æ•°ï¼š5000ï¼ˆé˜²æ­¢è¶…æ—¶/å†…å­˜æº¢å‡ºï¼‰
- è¶…é™æ—¶è®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä¼˜é›…é™çº§

### 2.3 âœ… é‡‘é¢è®¡ç®—ç²¾åº¦é£é™© (Financial Integrity) - å·²ä¿®å¤

| å±æ€§ | å€¼ |
|------|-----|
| **ä½ç½®** | `distribution.service.ts` - `calculateDistribution` |
| **ä¸¥é‡ç¨‹åº¦** | ğŸ”´ High |
| **çŠ¶æ€** | âœ… å·²ä¿®å¤ |

**é—®é¢˜æè¿°**ï¼š

ä»£ç ä½¿ç”¨äº† `Math.round(orderAmount * rate) / 100` è¿›è¡Œåˆ†æ¶¦è®¡ç®—ã€‚

- JavaScript çš„ `number` æ˜¯åŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œåœ¨è¿›è¡Œä¹˜æ³•è¿ç®—æ—¶å¯èƒ½ä¼šå‡ºç° `0.1 + 0.2 = 0.30000000000000004` çš„ç²¾åº¦ä¸¢å¤±é—®é¢˜
- è™½ç„¶ä½¿ç”¨äº† `Math.round` è¯•å›¾ä¿®æ­£ï¼Œä½†åœ¨é‡‘èç³»ç»Ÿä¸­å­˜åœ¨é£é™©

**å»ºè®®ä¿®å¤æ–¹æ¡ˆ**ï¼š

```typescript
// âŒ å½“å‰å®ç°
const amount = Math.round(orderAmount * rate) / 100;

// âœ… æ–¹æ¡ˆ1ï¼šä½¿ç”¨æ•´æ•°ï¼ˆåˆ†ï¼‰è®¡ç®—ï¼ˆæ¨èï¼‰
const amountInCents = Math.round(orderAmountInCents * rate / 100);

// âœ… æ–¹æ¡ˆ2ï¼šä½¿ç”¨ decimal.js åº“
import Decimal from 'decimal.js';
const amount = new Decimal(orderAmount).times(rate).div(100).toDecimalPlaces(2);
```

**æ•°æ®åº“ Schema å±‚é¢å»ºè®®**ï¼š

æ£€æŸ¥ Prisma Schema ä¸­ `Decimal` ç±»å‹çš„ç²¾åº¦è®¾ç½®ï¼š

```prisma
// âŒ ç²¾åº¦ä¸è¶³
amount Decimal

// âœ… å»ºè®®ï¼šæ˜ç¡®ç²¾åº¦ï¼ˆæ€»ä½æ•°, å°æ•°ä½æ•°ï¼‰
amount    Decimal @db.Decimal(12, 2)  // æœ€å¤§ 9999999999.99
// æˆ–æ›´ç²¾ç»†çš„ä¸­é—´è®¡ç®—
rateValue Decimal @db.Decimal(10, 4)  // è´¹ç‡å¯ä¿ç•™4ä½å°æ•°
```

**âš ï¸ å®æ–½æ³¨æ„äº‹é¡¹**ï¼š

1. **Prisma Decimal åºåˆ—åŒ–**ï¼šPrisma çš„ `Decimal` ç±»å‹æ˜ å°„åˆ° JS æ—¶è¿”å›çš„æ˜¯ `Prisma.Decimal` å¯¹è±¡ï¼Œé»˜è®¤æ— æ³•ç›´æ¥é€šè¿‡ JSON è¿”å›ç»™å‰ç«¯ã€‚

```typescript
// âŒ ç›´æ¥è¿”å›ä¼šå¯¼è‡´åºåˆ—åŒ–é—®é¢˜
return { amount: record.amount }; // amount æ˜¯ Prisma.Decimal å¯¹è±¡

// âœ… æ–¹æ¡ˆ1ï¼šåœ¨æ‹¦æˆªå™¨ä¸­ç»Ÿä¸€è½¬æ¢
@Injectable()
export class DecimalInterceptor implements NestInterceptor {
  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle().pipe(
      map(data => this.transformDecimals(data))
    );
  }
  
  private transformDecimals(obj: any): any {
    if (obj instanceof Prisma.Decimal) {
      return obj.toString(); // ä¿æŒç²¾åº¦ï¼Œç”±å‰ç«¯å†³å®šæ˜¾ç¤ºæ ¼å¼
    }
    // ... é€’å½’å¤„ç†å¯¹è±¡å’Œæ•°ç»„
  }
}

// âœ… æ–¹æ¡ˆ2ï¼šåœ¨ Service å±‚æ‰‹åŠ¨è½¬æ¢
return {
  amount: record.amount.toString(),
  // æˆ– amount: record.amount.toNumber() // æ³¨æ„ç²¾åº¦æŸå¤±
};
```

2. **å»ºè®®**ï¼šç»Ÿä¸€è½¬ä¸ºå­—ç¬¦ä¸²è¿”å›å‰ç«¯ï¼Œç”±å‰ç«¯ä½¿ç”¨ `bignumber.js` æˆ–ç±»ä¼¼åº“å¤„ç†æ˜¾ç¤ºæ ¼å¼ã€‚

---

**âœ… ä¿®å¤å®Œæˆï¼ˆ2024-12-12ï¼‰**

å·²å®ç°æ•´æ•°åˆ†è®¡ç®—æ–¹æ¡ˆï¼š

```typescript
// æ–°å¢å·¥å…·å‡½æ•°
export function yuanToCents(yuan: number): number {
  return Math.round(yuan * 100);
}

export function centsToDecimalString(cents: number): string {
  return (cents / 100).toFixed(2);
}

// calculateDistribution ç°åœ¨ä½¿ç”¨åˆ†è®¡ç®—
async calculateDistribution(
  orderId: string,
  escortId: string,
  orderAmountCents: number, // âš ï¸ å•ä½ï¼šåˆ†
): Promise<DistributionResult> {
  // amountCents = orderAmountCents * rate / 100
  const amountCents = Math.round(orderAmountCents * rate / 100);
  // ...
}
```

**æµ‹è¯•éªŒè¯**ï¼š1000 ç¬”éšæœºè®¢å•åˆ†æ¶¦åˆè®¡ï¼Œå·®å¼‚ 0 åˆ† âœ…

---

## 3. é€»è¾‘ä¸ä»£ç è´¨é‡é—®é¢˜ (Medium & Low Risks)

### 3.1 âœ… é‚€è¯·ç ç”Ÿæˆçš„æ½œåœ¨æ­»å¾ªç¯ - å·²ä¿®å¤

| å±æ€§ | å€¼ |
|------|-----|
| **ä½ç½®** | `generateInviteCode` |
| **ä¸¥é‡ç¨‹åº¦** | ğŸŸ¡ Medium |
| **çŠ¶æ€** | âœ… å·²ä¿®å¤ |

**é—®é¢˜æè¿°**ï¼š

ä½¿ç”¨ `do...while` å¾ªç¯éšæœºç”Ÿæˆ6ä½å­—ç¬¦ï¼Œä»…é™åˆ¶äº†10æ¬¡é‡è¯•ã€‚

**é£é™©**ï¼š

éšç€ç”¨æˆ·é‡å¢åŠ ï¼Œ6ä½å­—ç¬¦ï¼ˆ32^6 ç©ºé—´ â‰ˆ 10äº¿ï¼‰è™½ç„¶å¾ˆå¤§ï¼Œä½†åœ¨æç«¯ç¢°æ’æƒ…å†µä¸‹ï¼Œå¦‚æœè¿ç»­10æ¬¡å¤±è´¥æŠ›å‡ºå¼‚å¸¸ï¼Œç”¨æˆ·ä½“éªŒä¼šä¸­æ–­ã€‚

---

**âœ… ä¿®å¤å®Œæˆï¼ˆ2024-12-12ï¼‰**

é‡‡ç”¨ **ID å“ˆå¸Œ + éšæœºåç¼€** ç­–ç•¥ï¼š

```typescript
// ä¼˜åŒ–ç­–ç•¥
// - å‰ 4 ä½ï¼šåŸºäº escortId çš„ç¡®å®šæ€§å“ˆå¸Œ
// - å 2 ä½ï¼šéšæœºå­—ç¬¦
// - æœ€å¤§é‡è¯•ï¼š20 æ¬¡ï¼ˆåŸ 10 æ¬¡ï¼‰
// - æç«¯æƒ…å†µï¼šé€€åŒ–ä¸º 8 ä½å…¨éšæœº

const prefix = this.hashToCode(escortId, 4); // ç¡®å®šæ€§å‰ç¼€
const suffix = this.generateRandomCode(2);    // éšæœºåç¼€
code = prefix + suffix;
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š
- ç¢°æ’æ¦‚ç‡å¤§å¹…é™ä½ï¼ˆå‰ç¼€åŸºäºç”¨æˆ· IDï¼Œç›¸åŒç”¨æˆ·ç”Ÿæˆç›¸ä¼¼ç ï¼‰
- é‡è¯•æ¬¡æ•°å¢åŠ åˆ° 20 æ¬¡
- æç«¯æƒ…å†µè‡ªåŠ¨é€€åŒ–ä¸º 8 ä½ç ï¼ˆ32^8 â‰ˆ 1 ä¸‡äº¿ç©ºé—´ï¼‰

### 3.2 âœ… ç¡¬ç¼–ç ä¸šåŠ¡é€»è¾‘ (Maintainability) - å·²ä¿®å¤

| å±æ€§ | å€¼ |
|------|-----|
| **ä½ç½®** | `promotion.service.ts`, `distribution.service.ts` |
| **ä¸¥é‡ç¨‹åº¦** | ğŸŸ¡ Medium |
| **çŠ¶æ€** | âœ… å·²ä¿®å¤ |

**é—®é¢˜æè¿°**ï¼š

- åˆ†é”€å±‚çº§ï¼ˆ1, 2, 3ï¼‰å’Œå¯¹åº”é€»è¾‘æ˜¯ç¡¬ç¼–ç åœ¨ `switch` è¯­å¥ä¸­çš„
- æ™‹å‡é€»è¾‘ä¸­ï¼Œè™½ç„¶éƒ¨åˆ†é…ç½®ä»æ•°æ®åº“è¯»å–ï¼Œä½†è¯¸å¦‚"L3åªèƒ½æ‹¿ç›´æ¨"ç­‰è§„åˆ™æ˜¯å†™æ­»åœ¨ä»£ç é‡Œçš„

---

**âœ… ä¿®å¤å®Œæˆï¼ˆ2024-12-12ï¼‰**

é‡‡ç”¨ **ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰** é‡æ„åˆ†æ¶¦è®¡ç®—ï¼š

```
strategies/
â”œâ”€â”€ distribution-strategy.interface.ts  # ç­–ç•¥æ¥å£
â”œâ”€â”€ distribution-strategy.factory.ts    # ç­–ç•¥å·¥å‚
â”œâ”€â”€ standard.strategy.ts    # æ ‡å‡†ä¸‰çº§åˆ†é”€
â”œâ”€â”€ flat.strategy.ts        # æ‰å¹³åŒ–åˆ†é”€
â”œâ”€â”€ direct-only.strategy.ts # ä»…ç›´æ¨åˆ†é”€
â””â”€â”€ index.ts
```

**å¯ç”¨ç­–ç•¥**ï¼š

| ç­–ç•¥ | æè¿° |
|------|------|
| `standard` | æ ‡å‡†ä¸‰çº§åˆ†é”€ï¼šL1/L2 å…¨å±‚çº§ï¼ŒL3 ä»…ç›´æ¨ï¼ˆé»˜è®¤ï¼‰ |
| `flat` | æ‰å¹³åŒ–åˆ†é”€ï¼šæ‰€æœ‰ç­‰çº§ç»Ÿä¸€è´¹ç‡ |
| `direct_only` | ä»…ç›´æ¨åˆ†é”€ï¼šåªæœ‰ç›´æ¥ä¸Šçº§å¯è·å¾—åˆ†æ¶¦ |

**ä½¿ç”¨æ–¹å¼**ï¼š

```typescript
// åœ¨ DistributionConfig ä¸­è®¾ç½® strategyType å­—æ®µå³å¯åˆ‡æ¢ç­–ç•¥
// æ— éœ€ä¿®æ”¹ä»£ç ï¼Œè¿è¡Œæ—¶åŠ¨æ€åŠ è½½
```

**æ‰©å±•æ€§**ï¼š
- æ–°å¢ç­–ç•¥åªéœ€å®ç° `IDistributionStrategy` æ¥å£
- åœ¨ `DistributionStrategyFactory` ä¸­æ³¨å†Œå³å¯

### 3.3 âœ… ç¼ºä¹è¾“å…¥éªŒè¯ (Input Validation) - å·²ä¿®å¤

| å±æ€§ | å€¼ |
|------|-----|
| **ä½ç½®** | æ‰€æœ‰ Controller ä¸­çš„ `@Query` å‚æ•°å¤„ç† |
| **ä¸¥é‡ç¨‹åº¦** | ğŸŸ¡ Medium |
| **çŠ¶æ€** | âœ… å·²ä¿®å¤ |

**é—®é¢˜æè¿°**ï¼š

ä¾‹å¦‚ `pageSize?` åªæ˜¯ç®€å•åœ° `Number(pageSize)`ã€‚å¦‚æœç”¨æˆ·ä¼ å…¥éæ•°å­—å­—ç¬¦ï¼ˆå¦‚æå¤§çš„æ•°å­—ï¼‰ï¼Œè™½ç„¶ Prisma ä¼šå¤„ç† SQL æ³¨å…¥ï¼Œä½†ç¼ºä¹åº”ç”¨å±‚çš„ `ValidationPipe` æˆ– `ParseIntPipe` æ ¡éªŒï¼Œå¯èƒ½å¯¼è‡´ 500 é”™è¯¯ã€‚

**å»ºè®®**ï¼š

```typescript
// âŒ å½“å‰å®ç°
@Query('pageSize') pageSize?: string

// âœ… å»ºè®®æ–¹æ¡ˆ
@Query('pageSize', new DefaultValuePipe(20), ParseIntPipe) pageSize: number
```

### 3.5 âœ… åˆ†é¡µå‚æ•°ç¼ºä¹ä¸Šé™ä¿æŠ¤ - å·²ä¿®å¤

| å±æ€§ | å€¼ |
|------|-----|
| **ä½ç½®** | `distribution.controller.ts` ç­‰æ‰€æœ‰ Controller |
| **ä¸¥é‡ç¨‹åº¦** | ğŸŸ¡ Medium |
| **çŠ¶æ€** | âœ… å·²ä¿®å¤ |

**é—®é¢˜æè¿°**ï¼š

```typescript
const ps = pageSize ? Number(pageSize) : 20;
```

å¦‚æœå‰ç«¯æ¶æ„ä¼ ä¸€ä¸ªæå¤§çš„ `pageSize`ï¼ˆä¾‹å¦‚ 100000ï¼‰ï¼Œä¼šå¯¼è‡´æ•°æ®åº“å•æ¬¡æŸ¥è¯¢å‹åŠ›è¿‡å¤§ï¼Œç”šè‡³è¢«æ¶æ„çˆ¬è™«åˆ©ç”¨æ‹–å®æ•°æ®åº“ã€‚

**å»ºè®®**ï¼š

```typescript
// âŒ å½“å‰å®ç°ï¼šæ— ä¸Šé™
const ps = pageSize ? Number(pageSize) : 20;

// âœ… å»ºè®®æ–¹æ¡ˆï¼šè®¾ç½®ç¡¬æ€§ä¸Šé™
const MAX_PAGE_SIZE = 100;
const ps = Math.min(pageSize ? Number(pageSize) : 20, MAX_PAGE_SIZE);

// âœ… æ›´ä¼˜æ–¹æ¡ˆï¼šä½¿ç”¨ DTO + class-validator
class PaginationDto {
  @IsOptional()
  @IsInt()
  @Min(1)
  @Max(100)  // ç¡¬æ€§ä¸Šé™
  pageSize?: number = 20;
}
```

---

**âœ… ä¿®å¤å®Œæˆï¼ˆ2024-12-12ï¼‰**

åˆ†é”€æ¨¡å—æ‰€æœ‰ Controller å·²æ”¹ç”¨ `PaginationDto`ï¼š

```typescript
// common/dto/pagination.dto.ts - å·²å­˜åœ¨å¹¶å¢å¼º
export class PaginationDto {
  @Type(() => Number)
  @IsInt()
  @Min(1)
  page?: number = 1;

  @Type(() => Number)
  @IsInt()
  @Min(1)
  @Max(100)  // ç¡¬æ€§ä¸Šé™
  pageSize?: number = 20;
}

// team.controller.ts - æ”¹ç”¨ DTO
@Get('members')
async getTeamMembers(@Request() req, @Query() query: PaginationDto) { ... }

// distribution.controller.ts - æ”¹ç”¨ DTO
@Get('records')
async getDistributionRecords(@Request() req, @Query() query: PaginationDto) { ... }
```

**ä¿æŠ¤æ•ˆæœ**ï¼š
- `pageSize=100000` â†’ è¿”å› 400 Bad Requestï¼ˆMax 100ï¼‰
- `pageSize=abc` â†’ è¿”å› 400 Bad Requestï¼ˆIsIntï¼‰
- å…¨å±€ `ValidationPipe` å·²å¯ç”¨ï¼ˆ`main.ts`ï¼‰

### 3.4 âœ… äº‹åŠ¡èŒƒå›´è¿‡å¤§ - å·²ä¿®å¤

| å±æ€§ | å€¼ |
|------|-----|
| **ä½ç½®** | `processInvitation` |
| **ä¸¥é‡ç¨‹åº¦** | ğŸŸ¡ Mediumï¼ˆé«˜å¹¶å‘åœºæ™¯å‡çº§ä¸º Highï¼‰ |
| **çŠ¶æ€** | âœ… å·²ä¿®å¤ |

**é—®é¢˜æè¿°**ï¼š

äº‹åŠ¡ä¸­åŒ…å«äº† `updateTeamStats`ï¼Œè€Œè¯¥å‡½æ•°å†…éƒ¨å¯èƒ½åŒ…å«é€’å½’çš„æ•°æ®åº“è¯»å–å’Œæ›´æ–°ã€‚è¿™ä¼šå»¶é•¿äº‹åŠ¡æŒæœ‰é”çš„æ—¶é—´ï¼Œå½±å“å¹¶å‘æ€§èƒ½ã€‚

**ä¼˜åŒ–æ–¹æ¡ˆï¼šå¼‚æ­¥å¤„ç†ç»Ÿè®¡æ•°æ®**

å°† `updateTeamStats`ï¼ˆå›¢é˜Ÿç»Ÿè®¡æ›´æ–°ï¼‰ç§»å‡ºä¸»äº‹åŠ¡ï¼Œæ”¹ä¸ºå¼‚æ­¥å¤„ç†ï¼š

```typescript
// âŒ å½“å‰å®ç°ï¼šç»Ÿè®¡æ›´æ–°åœ¨äº‹åŠ¡å†…
await this.prisma.$transaction(async (tx) => {
  await tx.escort.update({ ... });  // æ ¸å¿ƒï¼šç»‘å®šé‚€è¯·å…³ç³»
  await this.updateTeamStats(tx);   // è¾…åŠ©ï¼šæ›´æ–°å›¢é˜Ÿç»Ÿè®¡ï¼ˆé€’å½’ï¼Œæ…¢ï¼‰
});

// âœ… å»ºè®®æ–¹æ¡ˆï¼šæ ¸å¿ƒä¸šåŠ¡å¼ºä¸€è‡´ï¼Œç»Ÿè®¡ä¸šåŠ¡æœ€ç»ˆä¸€è‡´
await this.prisma.$transaction(async (tx) => {
  await tx.escort.update({ ... });  // æ ¸å¿ƒï¼šç»‘å®šé‚€è¯·å…³ç³»ï¼ˆå¿«ï¼‰
});

// å‘é€å¼‚æ­¥äº‹ä»¶ï¼Œç”±é˜Ÿåˆ—å¤„ç†ç»Ÿè®¡æ›´æ–°
await this.eventEmitter.emit('invitation.created', { escortId, inviterId });

// æˆ–ä½¿ç”¨ BullMQ é˜Ÿåˆ—
await this.teamStatsQueue.add('updateStats', { escortId, inviterId });
```

**ç†ç”±**ï¼šé‚€è¯·å…³ç³»çš„å»ºç«‹ï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰å¿…é¡»æ˜¯å¼ºä¸€è‡´æ€§çš„ï¼Œä½†å›¢é˜Ÿäººæ•°çš„ç»Ÿè®¡ï¼ˆè¾…åŠ©ä¸šåŠ¡ï¼‰å¯ä»¥æ˜¯æœ€ç»ˆä¸€è‡´æ€§çš„ã€‚

**âš ï¸ å®æ–½æ³¨æ„äº‹é¡¹**ï¼š

1. **å…œåº•ç­–ç•¥**ï¼šå¦‚æœå¼‚æ­¥ä»»åŠ¡å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

```typescript
// ä½¿ç”¨ BullMQ é…ç½®é‡è¯•æœºåˆ¶
@Processor('team-stats')
export class TeamStatsProcessor {
  @Process('updateStats')
  async handleUpdateStats(job: Job<{ escortId: string; inviterId: string }>) {
    // å¤„ç†é€»è¾‘
  }

  @OnQueueFailed()
  async handleFailed(job: Job, error: Error) {
    // è®°å½•å¤±è´¥æ—¥å¿—ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡
    if (job.attemptsMade >= 3) {
      this.logger.error(`å›¢é˜Ÿç»Ÿè®¡æ›´æ–°å¤±è´¥: ${job.id}`, error);
      // å¯é€‰ï¼šå‘é€å‘Šè­¦é€šçŸ¥
    }
  }
}

// é˜Ÿåˆ—é…ç½®
const queue = new Queue('team-stats', {
  defaultJobOptions: {
    attempts: 3,           // æœ€å¤šé‡è¯• 3 æ¬¡
    backoff: {
      type: 'exponential',
      delay: 1000          // æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s
    }
  }
});
```

2. **æœ€ç»ˆé˜²çº¿**ï¼šé…åˆæ¯æ™šçš„å®šæ—¶æ ¡å¯¹ä»»åŠ¡ï¼ˆCron Jobï¼‰ï¼Œé‡æ–°è®¡ç®—æ‰€æœ‰å›¢é˜Ÿç»Ÿè®¡æ•°æ®ï¼Œç¡®ä¿æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚

---

**âœ… ä¿®å¤å®Œæˆï¼ˆ2024-12-12ï¼‰**

1. **äº‹åŠ¡æ‹†åˆ†**ï¼š`processInvitation` äº‹åŠ¡å†…ä»…ä¿ç•™æ ¸å¿ƒç»‘å®šé€»è¾‘

```typescript
// distribution.service.ts
async processInvitation(...) {
  // å¼ºä¸€è‡´æ€§äº‹åŠ¡ - ä»…æ ¸å¿ƒç»‘å®š
  await this.prisma.$transaction(async (tx) => {
    await tx.escort.update({ ... });      // æ›´æ–°è¢«é‚€è¯·äºº
    await tx.escortInvitation.create({ ... }); // åˆ›å»ºé‚€è¯·è®°å½•
  });

  // å¼‚æ­¥æ›´æ–°å›¢é˜Ÿç»Ÿè®¡ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸é˜»å¡ä¸»é“¾è·¯ï¼‰
  this.scheduleTeamStatsUpdate(inviter.id);
}
```

2. **å¼‚æ­¥æ›´æ–° + æŒ‡æ•°é€€é¿é‡è¯•**

```typescript
private async updateTeamStatsWithRetry(escortId: string, maxRetries = 3) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      await this.prisma.$transaction(async (tx) => {
        await this.updateTeamStats(tx, escortId);
      });
      return; // æˆåŠŸ
    } catch (error) {
      const delayMs = Math.pow(2, attempt - 1) * 1000; // 1s, 2s, 4s
      await this.delay(delayMs);
    }
  }
}
```

3. **Nightly Cron æ ¡å¯¹ä»»åŠ¡è„šæ‰‹æ¶**

```typescript
// distribution-reconciliation.task.ts
@Injectable()
export class DistributionReconciliationTask {
  // @Cron('0 3 * * *') // å¾…å¯ç”¨ @nestjs/schedule åå–æ¶ˆæ³¨é‡Š
  async reconcileTeamStats(): Promise<void> {
    // éå†æ‰€æœ‰é™ªè¯Šå‘˜ï¼Œé‡æ–°è®¡ç®— teamSize å’Œ totalTeamSize
    // ä¿®æ­£å› å¼‚æ­¥æ›´æ–°å¤±è´¥å¯¼è‡´çš„åå·®
  }
}
```

---

## 4. ä¿®å¤ä¼˜å…ˆçº§ä¸æ’æœŸ

### ä¼˜å…ˆçº§ï¼šé«˜ (å¿…é¡»ä¿®å¤) ğŸ”´

| ä»»åŠ¡ | é¢„ä¼°å·¥æ—¶ | çŠ¶æ€ |
|------|---------|------|
| é‡æ„å›¢é˜Ÿæˆå‘˜åˆ—è¡¨æŸ¥è¯¢ï¼ˆè§£å†³ N+1ï¼‰ | 4h | âœ… å·²å®Œæˆ |
| ç»Ÿä¸€é‡‘é¢è®¡ç®—æ ‡å‡†ï¼ˆæ•´æ•°/Decimalï¼‰ | 3h | âœ… å·²å®Œæˆ |
| é™åˆ¶é€’å½’æ·±åº¦ + æ·»åŠ è¶…æ—¶ä¿æŠ¤ | 2h | âœ… å·²å®Œæˆ |
| **ç¼–å†™åˆ†æ¶¦è®¡ç®—å•å…ƒæµ‹è¯•** | 3h | âœ… å·²å®Œæˆ |

> âœ… **æµ‹è¯•è¦†ç›–å·²å®Œæˆ**ï¼š`test/distribution/calculate-distribution.test.ts`
> 
> å…± **67 ä¸ªæµ‹è¯•ç”¨ä¾‹**ï¼Œè¦†ç›–ï¼š
> - åŸºç¡€åœºæ™¯ï¼ˆ4 ç”¨ä¾‹ï¼‰
> - æå°é‡‘é¢ 0.01 å…ƒï¼ˆ2 ç”¨ä¾‹ï¼‰
> - å±‚çº§ä¸è¶³ï¼ˆ1-2 çº§ï¼Œ4 ç”¨ä¾‹ï¼‰
> - è´¹ç‡è¾¹ç•Œ 0%/100%ï¼ˆ3 ç”¨ä¾‹ï¼‰
> - è¶…å¤§é‡‘é¢ 999999.99 å…ƒï¼ˆ2 ç”¨ä¾‹ï¼‰
> - ä¸Šçº§çŠ¶æ€è¿‡æ»¤ï¼ˆ2 ç”¨ä¾‹ï¼‰
> - éšæœºå›å½’ï¼ˆ50 ç”¨ä¾‹ï¼‰
> 
> è¿è¡Œå‘½ä»¤ï¼š`pnpm test -- test/distribution/calculate-distribution.test.ts`

### ä¼˜å…ˆçº§ï¼šä¸­ (å»ºè®®ä¼˜åŒ–) ğŸŸ¡

| ä»»åŠ¡ | é¢„ä¼°å·¥æ—¶ | çŠ¶æ€ |
|------|---------|------|
| ä¼˜åŒ–æ ‘å½¢ç»“æ„ç»´æŠ¤ï¼ˆå¼‚æ­¥é˜Ÿåˆ—ï¼‰ | 6h | âœ… å·²å®Œæˆ |
| äº‹åŠ¡èŒƒå›´ä¼˜åŒ–ï¼ˆç»Ÿè®¡å¼‚æ­¥åŒ–ï¼‰ | 4h | âœ… å·²å®Œæˆ |
| å¢åŠ  DTO æ ¡éªŒï¼ˆValidationPipeï¼‰ | 2h | âœ… å·²å®Œæˆ |
| åˆ†é¡µå‚æ•°ä¸Šé™ä¿æŠ¤ | 1h | âœ… å·²å®Œæˆ |
| ä¼˜åŒ–é‚€è¯·ç ç”Ÿæˆç®—æ³• | 1h | âœ… å·²å®Œæˆ |
| æ£€æŸ¥ Prisma Decimal ç²¾åº¦é…ç½® | 1h | âœ… å·²å®Œæˆï¼ˆå·²é…ç½® @db.Decimal(10,2)ï¼‰ |

### ä¼˜å…ˆçº§ï¼šä½ (é•¿æœŸè§„åˆ’) ğŸŸ¢

| ä»»åŠ¡ | é¢„ä¼°å·¥æ—¶ | çŠ¶æ€ |
|------|---------|------|
| é…ç½®åŒ–åˆ†é”€è§„åˆ™ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰ | 8h | âœ… å·²å®Œæˆ |
| é—­åŒ…è¡¨/ç‰©åŒ–è·¯å¾„ä¼˜åŒ–æ ‘å½¢æŸ¥è¯¢ | 8h | âŒ è§„åˆ’ä¸­ |

---

## 5. æ€»ä½“è¯„ä»·

è¯¥æ¨¡å—ä»£ç ç»“æ„æ•´æ´ï¼Œé€»è¾‘æ¸…æ™°ï¼Œä½†åœ¨åº”å¯¹æ•°æ®è§„æ¨¡å¢é•¿æ—¶çš„å¯æ‰©å±•æ€§è®¾è®¡ä¸Šå­˜åœ¨æ˜æ˜¾çŸ­æ¿ã€‚

| è¯„ä¼°ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|---------|------|------|
| **ä»£ç è´¨é‡** | â­â­â­â­ | ç»“æ„æ¸…æ™°ï¼Œå‘½åè§„èŒƒ |
| **å®‰å…¨æ€§** | â­â­â­â­ | äº‹åŠ¡ä¿æŠ¤åˆ°ä½ï¼Œæƒé™æ§åˆ¶å®Œæ•´ |
| **å¯æ‰©å±•æ€§** | â­â­â­ | N+1 é—®é¢˜å’Œé€’å½’éšæ‚£éœ€è§£å†³ |
| **å¯ç»´æŠ¤æ€§** | â­â­â­ | éƒ¨åˆ†ç¡¬ç¼–ç é€»è¾‘ |
| **MVPå°±ç»ªåº¦** | â­â­â­â­ | å¯ä¸Šçº¿ï¼Œä½†éœ€ç›‘æ§æ€§èƒ½ |

**ç»“è®º**ï¼šä½œä¸º MVPï¼ˆæœ€å°å¯è¡Œæ€§äº§å“ï¼‰ä¸Šçº¿å°šå¯ï¼Œä½†è‹¥é¢„ä¼°ç”¨æˆ·é‡è¾ƒå¤§ï¼Œ**å¿…é¡»è§£å†³ N+1 æŸ¥è¯¢é—®é¢˜**ã€‚

---

## 6. å®¡è®¡ç­¾æ ¸

| è§’è‰² | ç­¾æ ¸ | æ—¥æœŸ |
|------|------|------|
| Senior Code Auditor | âœ… å®¡è®¡å®Œæˆ | 2024-12-12 |
| Tech Lead | âœ… è¯„å®¡é€šè¿‡ | 2024-12-12 |

**æœ€ç»ˆç»“è®º**ï¼š

æœ¬æŠ¥å‘Šé€»è¾‘ä¸¥å¯†ã€é‡ç‚¹çªå‡ºï¼Œå¯ä½œä¸º **Tech Lead çš„è¡ŒåŠ¨æŒ‡å—**ï¼š

1. **ç°åœ¨å¿…é¡»ä¿®**ï¼ˆè‡´å‘½ä¼¤ï¼‰ï¼šN+1 æŸ¥è¯¢ã€èµ„é‡‘ç²¾åº¦è®¡ç®—ã€æµ‹è¯•è¦†ç›–
2. **æœªæ¥å¦‚ä½•æŠ—**ï¼ˆæ‰©å±•æ€§ï¼‰ï¼šå¼‚æ­¥é˜Ÿåˆ—ã€å­—æ®µå†—ä½™ã€å®šæ—¶æ ¡å¯¹

æŠ¥å‘Šç‰ˆæœ¬ï¼šv1.2ï¼ˆæœ€ç»ˆç‰ˆï¼‰

