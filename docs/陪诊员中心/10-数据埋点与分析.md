# 数据埋点与分析规划文档

> 返回 [陪诊员中心总览](./README.md)  
> 状态：✅ 已规划  
> 版本：v1.0  
> 创建日期：2024-12-11

---

## 一、概述

### 1.1 埋点系统定位

数据埋点系统用于收集用户行为数据和业务指标，为运营决策、产品优化、风控监测提供数据支撑。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据埋点与分析架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  数据采集层                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ 小程序端    │  │ 管理后台    │  │ 后端服务    │  │ 第三方平台  │       │
│  │             │  │             │  │             │  │             │       │
│  │ · 页面浏览  │  │ · 操作日志  │  │ · 业务事件  │  │ · 支付回调  │       │
│  │ · 用户行为  │  │ · 审批流程  │  │ · 状态变更  │  │ · 短信状态  │       │
│  │ · 性能数据  │  │ · 配置变更  │  │ · 接口调用  │  │ · 微信回调  │       │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘       │
│         │                │                │                │               │
│         └────────────────┴────────────────┴────────────────┘               │
│                                    │                                        │
│                                    ▼                                        │
│  数据处理层                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        事件收集服务                                  │   │
│  │                                                                     │   │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐       │   │
│  │  │ 数据校验  │→ │ 数据清洗  │→ │ 数据聚合  │→ │ 数据存储  │       │   │
│  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  数据存储层                                                                  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐                  │
│  │ PostgreSQL    │  │ ClickHouse    │  │ Redis         │                  │
│  │ (原始事件)    │  │ (OLAP分析)    │  │ (实时指标)    │                  │
│  └───────────────┘  └───────────────┘  └───────────────┘                  │
│                                    │                                        │
│                                    ▼                                        │
│  数据应用层                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ 实时看板    │  │ 数据报表    │  │ 风控监测    │  │ 智能推荐    │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 埋点原则

| 原则 | 说明 |
|------|------|
| **最小必要** | 只采集业务必需的数据，不过度收集 |
| **准确可靠** | 确保数据准确性，有校验和补偿机制 |
| **性能优先** | 埋点不影响主业务流程和用户体验 |
| **隐私合规** | 遵守隐私政策，敏感数据脱敏处理 |

---

## 二、关键业务指标

### 2.1 陪诊员相关指标

```typescript
// 陪诊员运营指标
interface EscortMetrics {
  // 规模指标
  totalEscorts: number;              // 陪诊员总数
  activeEscorts: number;             // 活跃陪诊员数（30天内有接单）
  newEscortsToday: number;           // 今日新增
  newEscortsThisMonth: number;       // 本月新增
  
  // 审核指标
  pendingReviewCount: number;        // 待审核数量
  avgReviewTime: number;             // 平均审核时长（小时）
  approvalRate: number;              // 审核通过率
  
  // 等级分布
  levelDistribution: {
    senior: number;
    intermediate: number;
    junior: number;
    trainee: number;
  };
  
  // 活跃度指标
  dailyActiveRate: number;           // 日活率
  weeklyActiveRate: number;          // 周活率
  monthlyActiveRate: number;         // 月活率
  avgWorkingHours: number;           // 平均每日接单时长
  
  // 流失指标
  churnRate30d: number;              // 30日流失率
  inactiveCount: number;             // 不活跃人数（7天未上线）
}

// 陪诊员个人指标
interface EscortPersonalMetrics {
  escortId: string;
  
  // 订单指标
  totalOrders: number;               // 累计订单数
  monthlyOrders: number;             // 本月订单数
  avgOrdersPerDay: number;           // 日均订单数
  orderCompletionRate: number;       // 订单完成率
  
  // 收入指标
  totalEarnings: number;             // 累计收入
  monthlyEarnings: number;           // 本月收入
  avgOrderEarnings: number;          // 单均收入
  
  // 服务质量指标
  rating: number;                    // 当前评分
  ratingTrend: number;               // 评分趋势（较上月）
  complaintRate: number;             // 投诉率
  onTimeRate: number;                // 准时率
  
  // 抢单指标
  grabAttempts: number;              // 抢单次数
  grabSuccessRate: number;           // 抢单成功率
  avgGrabResponseTime: number;       // 平均抢单响应时间（秒）
}
```

### 2.2 订单相关指标

```typescript
// 订单运营指标
interface OrderMetrics {
  // 订单量
  totalOrders: number;               // 累计订单数
  todayOrders: number;               // 今日订单数
  monthlyOrders: number;             // 本月订单数
  orderGrowthRate: number;           // 订单增长率（环比）
  
  // 订单状态分布
  statusDistribution: {
    pending: number;
    paid: number;
    assigned: number;
    inProgress: number;
    completed: number;
    cancelled: number;
    refunded: number;
  };
  
  // 派单指标
  avgAssignTime: number;             // 平均派单时长（分钟）
  grabSuccessRate: number;           // 抢单成功率
  manualAssignRate: number;          // 人工派单率
  autoAssignRate: number;            // 自动派单率
  unassignedRate: number;            // 未派单率（超时未接）
  
  // 完成指标
  completionRate: number;            // 订单完成率
  avgServiceDuration: number;        // 平均服务时长（分钟）
  
  // 取消/退款指标
  cancellationRate: number;          // 取消率
  refundRate: number;                // 退款率
  cancellationReasons: Array<{
    reason: string;
    count: number;
    percentage: number;
  }>;
  
  // 金额指标
  totalGMV: number;                  // 总交易额
  todayGMV: number;                  // 今日交易额
  avgOrderAmount: number;            // 客单价
  totalRefundAmount: number;         // 退款总额
}
```

### 2.3 分销相关指标

```typescript
// 分销运营指标
interface DistributionMetrics {
  // 规模指标
  totalL1Partners: number;           // 城市合伙人数
  totalL2Leaders: number;            // 团队长数
  totalInvitations: number;          // 累计邀请人数
  monthlyNewInvitations: number;     // 本月新邀请数
  
  // 转化指标
  inviteConversionRate: number;      // 邀请转化率（注册/邀请）
  activationRate: number;            // 激活率（首单/注册）
  
  // 分润指标
  totalDistributionAmount: number;   // 累计分润总额
  monthlyDistributionAmount: number; // 本月分润总额
  avgDistributionPerOrder: number;   // 单均分润
  
  // 团队指标
  avgTeamSize: number;               // 平均团队规模
  topTeamLeaders: Array<{
    escortId: string;
    name: string;
    teamSize: number;
    teamGMV: number;
  }>;
  
  // 晋升指标
  promotionCount: number;            // 晋升人数
  avgPromotionDays: number;          // 平均晋升周期（天）
}
```

### 2.4 用户相关指标

```typescript
// 用户端指标
interface UserMetrics {
  // 规模指标
  totalUsers: number;                // 注册用户总数
  newUsersToday: number;             // 今日新增
  newUsersThisMonth: number;         // 本月新增
  
  // 活跃指标
  dau: number;                       // 日活
  wau: number;                       // 周活
  mau: number;                       // 月活
  
  // 转化指标
  viewToOrderRate: number;           // 浏览→下单转化率
  orderToPayRate: number;            // 下单→支付转化率
  
  // 复购指标
  repurchaseRate: number;            // 复购率
  avgPurchaseFrequency: number;      // 人均购买次数
  avgPurchaseInterval: number;       // 平均复购间隔（天）
  
  // 满意度指标
  avgRating: number;                 // 平均评分
  nps: number;                       // NPS 净推荐值
  complaintRate: number;             // 投诉率
}
```

---

## 三、埋点事件定义

### 3.1 小程序端事件

```typescript
// 页面浏览事件
interface PageViewEvent {
  event: 'page_view';
  properties: {
    pagePath: string;           // 页面路径
    pageTitle: string;          // 页面标题
    referrer: string;           // 来源页面
    stayDuration?: number;      // 停留时长（离开时上报）
    scrollDepth?: number;       // 滚动深度
  };
}

// 用户端行为事件
enum UserBehaviorEvent {
  // 陪诊员相关
  ESCORT_LIST_VIEW = 'escort_list_view',           // 查看陪诊员列表
  ESCORT_CARD_CLICK = 'escort_card_click',         // 点击陪诊员卡片
  ESCORT_DETAIL_VIEW = 'escort_detail_view',       // 查看陪诊员详情
  ESCORT_FILTER_USE = 'escort_filter_use',         // 使用筛选功能
  ESCORT_SORT_USE = 'escort_sort_use',             // 使用排序功能
  ESCORT_BOOK_CLICK = 'escort_book_click',         // 点击预约按钮
  
  // 订单相关
  ORDER_CREATE_START = 'order_create_start',       // 开始创建订单
  ORDER_SERVICE_SELECT = 'order_service_select',   // 选择服务
  ORDER_HOSPITAL_SELECT = 'order_hospital_select', // 选择医院
  ORDER_PATIENT_SELECT = 'order_patient_select',   // 选择就诊人
  ORDER_ESCORT_SELECT = 'order_escort_select',     // 选择陪诊员
  ORDER_SUBMIT = 'order_submit',                   // 提交订单
  ORDER_PAY_START = 'order_pay_start',             // 开始支付
  ORDER_PAY_SUCCESS = 'order_pay_success',         // 支付成功
  ORDER_PAY_CANCEL = 'order_pay_cancel',           // 取消支付
  ORDER_CANCEL = 'order_cancel',                   // 取消订单
  ORDER_REVIEW_SUBMIT = 'order_review_submit',     // 提交评价
  
  // 搜索相关
  SEARCH_START = 'search_start',                   // 开始搜索
  SEARCH_RESULT_CLICK = 'search_result_click',     // 点击搜索结果
  SEARCH_NO_RESULT = 'search_no_result',           // 无搜索结果
}

// 陪诊员端行为事件
enum EscortBehaviorEvent {
  // 工作台相关
  WORKBENCH_VIEW = 'workbench_view',               // 查看工作台
  WORK_STATUS_CHANGE = 'work_status_change',       // 切换工作状态
  
  // 抢单相关
  ORDER_POOL_VIEW = 'order_pool_view',             // 查看抢单大厅
  ORDER_POOL_REFRESH = 'order_pool_refresh',       // 刷新抢单池
  ORDER_GRAB_CLICK = 'order_grab_click',           // 点击抢单
  ORDER_GRAB_SUCCESS = 'order_grab_success',       // 抢单成功
  ORDER_GRAB_FAIL = 'order_grab_fail',             // 抢单失败
  
  // 服务流程
  ORDER_ARRIVE_CONFIRM = 'order_arrive_confirm',   // 确认到达
  ORDER_SERVICE_START = 'order_service_start',     // 开始服务
  ORDER_SERVICE_COMPLETE = 'order_service_complete', // 完成服务
  
  // 收入相关
  EARNINGS_VIEW = 'earnings_view',                 // 查看收入
  WITHDRAW_APPLY = 'withdraw_apply',               // 申请提现
  
  // 邀请相关
  INVITE_PAGE_VIEW = 'invite_page_view',           // 查看邀请页
  INVITE_CODE_COPY = 'invite_code_copy',           // 复制邀请码
  INVITE_POSTER_GENERATE = 'invite_poster_generate', // 生成邀请海报
  INVITE_SHARE = 'invite_share',                   // 分享邀请
  
  // 团队相关
  TEAM_VIEW = 'team_view',                         // 查看团队
  TEAM_MEMBER_CLICK = 'team_member_click',         // 点击团队成员
}
```

### 3.2 后端业务事件

```typescript
// 后端业务事件（自动采集）
enum BackendBusinessEvent {
  // 陪诊员生命周期
  ESCORT_CREATED = 'escort_created',               // 陪诊员创建
  ESCORT_REVIEW_APPROVED = 'escort_review_approved', // 审核通过
  ESCORT_REVIEW_REJECTED = 'escort_review_rejected', // 审核拒绝
  ESCORT_LEVEL_CHANGED = 'escort_level_changed',   // 等级变更
  ESCORT_STATUS_CHANGED = 'escort_status_changed', // 状态变更
  ESCORT_ACCOUNT_BOUND = 'escort_account_bound',   // 账号绑定
  
  // 订单生命周期
  ORDER_CREATED = 'order_created',                 // 订单创建
  ORDER_PAID = 'order_paid',                       // 订单支付
  ORDER_ASSIGNED = 'order_assigned',               // 订单派单
  ORDER_ARRIVED = 'order_arrived',                 // 陪诊员到达
  ORDER_STARTED = 'order_started',                 // 服务开始
  ORDER_COMPLETED = 'order_completed',             // 服务完成
  ORDER_CANCELLED = 'order_cancelled',             // 订单取消
  ORDER_REFUNDED = 'order_refunded',               // 订单退款
  
  // 结算事件
  COMMISSION_SETTLED = 'commission_settled',       // 分成结算
  WITHDRAWAL_REQUESTED = 'withdrawal_requested',   // 提现申请
  WITHDRAWAL_APPROVED = 'withdrawal_approved',     // 提现审核通过
  WITHDRAWAL_REJECTED = 'withdrawal_rejected',     // 提现审核拒绝
  WITHDRAWAL_COMPLETED = 'withdrawal_completed',   // 提现完成
  
  // 分销事件
  INVITATION_CREATED = 'invitation_created',       // 创建邀请
  INVITATION_ACCEPTED = 'invitation_accepted',     // 接受邀请
  DISTRIBUTION_SETTLED = 'distribution_settled',   // 分润结算
  PROMOTION_ACHIEVED = 'promotion_achieved',       // 晋升成功
  
  // 评价事件
  REVIEW_CREATED = 'review_created',               // 评价创建
  REVIEW_REPLIED = 'review_replied',               // 评价回复
}
```

### 3.3 事件数据结构

```typescript
// 通用事件结构
interface TrackingEvent {
  // 事件标识
  eventId: string;                   // 事件唯一 ID
  eventName: string;                 // 事件名称
  eventTime: string;                 // 事件时间 ISO8601
  
  // 用户标识
  userId?: string;                   // 用户 ID
  escortId?: string;                 // 陪诊员 ID
  deviceId: string;                  // 设备 ID
  sessionId: string;                 // 会话 ID
  
  // 设备信息
  platform: 'miniapp' | 'h5' | 'admin' | 'server';
  deviceType?: string;               // 设备类型
  osName?: string;                   // 操作系统
  osVersion?: string;                // 系统版本
  appVersion?: string;               // 应用版本
  
  // 位置信息（可选）
  latitude?: number;
  longitude?: number;
  cityCode?: string;
  
  // 业务属性
  properties: Record<string, any>;
  
  // 来源信息
  source?: string;                   // 来源渠道
  campaign?: string;                 // 活动标识
  referrer?: string;                 // 引荐来源
}
```

---

## 四、数据模型

### 4.1 原始事件表

```prisma
model TrackingEvent {
  id              String   @id @default(uuid())
  
  // 事件信息
  eventName       String   @map("event_name")
  eventTime       DateTime @map("event_time")
  
  // 用户标识
  userId          String?  @map("user_id")
  escortId        String?  @map("escort_id")
  deviceId        String   @map("device_id")
  sessionId       String   @map("session_id")
  
  // 设备信息
  platform        String
  deviceType      String?  @map("device_type")
  osName          String?  @map("os_name")
  osVersion       String?  @map("os_version")
  appVersion      String?  @map("app_version")
  
  // 位置
  latitude        Float?
  longitude       Float?
  cityCode        String?  @map("city_code")
  
  // 业务属性
  properties      Json
  
  // 来源
  source          String?
  campaign        String?
  referrer        String?
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([eventName])
  @@index([userId])
  @@index([escortId])
  @@index([eventTime])
  @@map("tracking_events")
}
```

### 4.2 聚合指标表

```prisma
// 每日陪诊员指标快照
model EscortDailyMetrics {
  id              String   @id @default(uuid())
  escortId        String   @map("escort_id")
  date            DateTime @db.Date
  
  // 订单指标
  orderCount      Int      @default(0) @map("order_count")
  completedCount  Int      @default(0) @map("completed_count")
  cancelledCount  Int      @default(0) @map("cancelled_count")
  
  // 收入指标
  earnings        Decimal  @default(0) @db.Decimal(10, 2)
  distributionIncome Decimal @default(0) @db.Decimal(10, 2) @map("distribution_income")
  
  // 抢单指标
  grabAttempts    Int      @default(0) @map("grab_attempts")
  grabSuccess     Int      @default(0) @map("grab_success")
  
  // 服务指标
  avgServiceDuration Int?  @map("avg_service_duration")  // 分钟
  onTimeCount     Int      @default(0) @map("on_time_count")
  lateCount       Int      @default(0) @map("late_count")
  
  // 评价指标
  reviewCount     Int      @default(0) @map("review_count")
  avgRating       Float?   @map("avg_rating")
  
  // 工作时长
  workingMinutes  Int      @default(0) @map("working_minutes")
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@unique([escortId, date])
  @@index([date])
  @@map("escort_daily_metrics")
}

// 每日订单指标快照
model OrderDailyMetrics {
  id              String   @id @default(uuid())
  date            DateTime @db.Date
  cityCode        String?  @map("city_code")
  
  // 订单量
  orderCount      Int      @default(0) @map("order_count")
  paidCount       Int      @default(0) @map("paid_count")
  completedCount  Int      @default(0) @map("completed_count")
  cancelledCount  Int      @default(0) @map("cancelled_count")
  refundedCount   Int      @default(0) @map("refunded_count")
  
  // 金额
  gmv             Decimal  @default(0) @db.Decimal(12, 2)
  paidAmount      Decimal  @default(0) @db.Decimal(12, 2) @map("paid_amount")
  refundAmount    Decimal  @default(0) @db.Decimal(12, 2) @map("refund_amount")
  
  // 派单
  avgAssignMinutes Int?    @map("avg_assign_minutes")
  grabAssignCount Int      @default(0) @map("grab_assign_count")
  manualAssignCount Int    @default(0) @map("manual_assign_count")
  
  // 服务分布
  serviceDistribution Json? @map("service_distribution")  // {"s1": 10, "s2": 5}
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@unique([date, cityCode])
  @@index([date])
  @@map("order_daily_metrics")
}

// 每日分销指标快照
model DistributionDailyMetrics {
  id              String   @id @default(uuid())
  date            DateTime @db.Date
  
  // 邀请
  newInvitations  Int      @default(0) @map("new_invitations")
  acceptedInvitations Int  @default(0) @map("accepted_invitations")
  
  // 分润
  distributionAmount Decimal @default(0) @db.Decimal(10, 2) @map("distribution_amount")
  l1Amount        Decimal  @default(0) @db.Decimal(10, 2) @map("l1_amount")
  l2Amount        Decimal  @default(0) @db.Decimal(10, 2) @map("l2_amount")
  bonusAmount     Decimal  @default(0) @db.Decimal(10, 2) @map("bonus_amount")
  
  // 晋升
  promotionToL2   Int      @default(0) @map("promotion_to_l2")
  promotionToL1   Int      @default(0) @map("promotion_to_l1")
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@unique([date])
  @@map("distribution_daily_metrics")
}
```

---

## 五、埋点实现

### 5.1 前端埋点 SDK

```typescript
// miniapp/src/utils/tracking.ts

interface TrackingConfig {
  appId: string;
  serverUrl: string;
  batchSize: number;      // 批量上报条数
  batchInterval: number;  // 批量上报间隔（ms）
  enabled: boolean;
}

class TrackingSDK {
  private config: TrackingConfig;
  private eventQueue: TrackingEvent[] = [];
  private sessionId: string;
  private deviceId: string;
  
  constructor(config: TrackingConfig) {
    this.config = config;
    this.sessionId = this.generateSessionId();
    this.deviceId = this.getOrCreateDeviceId();
    
    // 定时批量上报
    setInterval(() => this.flush(), this.config.batchInterval);
    
    // 页面卸载时上报
    Taro.onAppHide(() => this.flush());
  }
  
  // 通用埋点方法
  track(eventName: string, properties: Record<string, any> = {}): void {
    if (!this.config.enabled) return;
    
    const event: TrackingEvent = {
      eventId: this.generateEventId(),
      eventName,
      eventTime: new Date().toISOString(),
      userId: this.getCurrentUserId(),
      escortId: this.getCurrentEscortId(),
      deviceId: this.deviceId,
      sessionId: this.sessionId,
      platform: 'miniapp',
      ...this.getDeviceInfo(),
      ...this.getLocationInfo(),
      properties,
    };
    
    this.eventQueue.push(event);
    
    // 达到批量阈值时上报
    if (this.eventQueue.length >= this.config.batchSize) {
      this.flush();
    }
  }
  
  // 页面浏览埋点
  trackPageView(pagePath: string, pageTitle: string, referrer?: string): void {
    this.track('page_view', {
      pagePath,
      pageTitle,
      referrer: referrer || '',
    });
  }
  
  // 点击事件埋点
  trackClick(elementId: string, elementText: string, extra?: Record<string, any>): void {
    this.track('element_click', {
      elementId,
      elementText,
      ...extra,
    });
  }
  
  // 批量上报
  async flush(): Promise<void> {
    if (this.eventQueue.length === 0) return;
    
    const events = [...this.eventQueue];
    this.eventQueue = [];
    
    try {
      await Taro.request({
        url: `${this.config.serverUrl}/track/batch`,
        method: 'POST',
        data: { events },
        header: {
          'Content-Type': 'application/json',
        },
      });
    } catch (error) {
      // 上报失败，放回队列
      this.eventQueue.unshift(...events);
      console.error('Tracking flush failed:', error);
    }
  }
  
  private getDeviceInfo() {
    const systemInfo = Taro.getSystemInfoSync();
    return {
      deviceType: systemInfo.model,
      osName: systemInfo.platform,
      osVersion: systemInfo.system,
      appVersion: systemInfo.version,
    };
  }
  
  private getLocationInfo() {
    // 从缓存获取位置信息
    const location = Taro.getStorageSync('userLocation');
    return location ? {
      latitude: location.latitude,
      longitude: location.longitude,
      cityCode: location.cityCode,
    } : {};
  }
  
  private getCurrentUserId(): string | undefined {
    return Taro.getStorageSync('userId');
  }
  
  private getCurrentEscortId(): string | undefined {
    return Taro.getStorageSync('escortId');
  }
  
  private generateEventId(): string {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
  
  private generateSessionId(): string {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
  
  private getOrCreateDeviceId(): string {
    let deviceId = Taro.getStorageSync('deviceId');
    if (!deviceId) {
      deviceId = `${Date.now()}-${Math.random().toString(36).substr(2, 16)}`;
      Taro.setStorageSync('deviceId', deviceId);
    }
    return deviceId;
  }
}

// 全局单例
export const tracker = new TrackingSDK({
  appId: process.env.TARO_APP_ID,
  serverUrl: process.env.TARO_APP_API,
  batchSize: 10,
  batchInterval: 5000,
  enabled: process.env.NODE_ENV === 'production',
});
```

### 5.2 埋点使用示例

```tsx
// 页面埋点示例
import { tracker } from '@/utils/tracking';
import { useDidShow, useDidHide } from '@tarojs/taro';

export default function EscortListPage() {
  const pageStartTime = useRef(Date.now());
  
  useDidShow(() => {
    tracker.trackPageView('/pages/escort/list', '陪诊员列表');
    pageStartTime.current = Date.now();
  });
  
  useDidHide(() => {
    tracker.track('page_leave', {
      pagePath: '/pages/escort/list',
      stayDuration: Date.now() - pageStartTime.current,
    });
  });
  
  const handleEscortClick = (escort: Escort) => {
    tracker.track('escort_card_click', {
      escortId: escort.id,
      escortName: escort.name,
      escortLevel: escort.level,
      position: escort.position,  // 列表位置
    });
    
    Taro.navigateTo({ url: `/pages/escort/detail?id=${escort.id}` });
  };
  
  const handleFilter = (filters: any) => {
    tracker.track('escort_filter_use', {
      filterType: Object.keys(filters),
      filterValues: filters,
    });
  };
  
  // ...
}
```

### 5.3 后端埋点服务

```typescript
// server/src/modules/tracking/tracking.service.ts

@Injectable()
export class TrackingService {
  
  // 记录业务事件
  async trackBusinessEvent(
    eventName: string,
    properties: Record<string, any>,
    context?: {
      userId?: string;
      escortId?: string;
      orderId?: string;
    }
  ): Promise<void> {
    const event: TrackingEvent = {
      eventId: this.generateEventId(),
      eventName,
      eventTime: new Date().toISOString(),
      userId: context?.userId,
      escortId: context?.escortId,
      deviceId: 'server',
      sessionId: 'server',
      platform: 'server',
      properties: {
        ...properties,
        orderId: context?.orderId,
      },
    };
    
    await this.saveEvent(event);
    
    // 实时指标更新
    await this.updateRealTimeMetrics(eventName, properties);
  }
  
  // 批量保存事件
  async saveBatchEvents(events: TrackingEvent[]): Promise<void> {
    await this.prisma.trackingEvent.createMany({
      data: events.map(e => ({
        eventName: e.eventName,
        eventTime: new Date(e.eventTime),
        userId: e.userId,
        escortId: e.escortId,
        deviceId: e.deviceId,
        sessionId: e.sessionId,
        platform: e.platform,
        deviceType: e.deviceType,
        osName: e.osName,
        osVersion: e.osVersion,
        appVersion: e.appVersion,
        latitude: e.latitude,
        longitude: e.longitude,
        cityCode: e.cityCode,
        properties: e.properties,
        source: e.source,
        campaign: e.campaign,
        referrer: e.referrer,
      })),
    });
  }
  
  // 实时更新指标
  private async updateRealTimeMetrics(
    eventName: string, 
    properties: Record<string, any>
  ): Promise<void> {
    const today = new Date().toISOString().split('T')[0];
    
    switch (eventName) {
      case 'order_completed':
        await this.redis.hincrby(`metrics:order:${today}`, 'completed', 1);
        await this.redis.hincrbyfloat(
          `metrics:order:${today}`, 
          'gmv', 
          properties.paidAmount
        );
        break;
        
      case 'escort_created':
        await this.redis.hincrby(`metrics:escort:${today}`, 'new', 1);
        break;
        
      // ... 其他事件
    }
  }
}
```

---

## 六、数据看板

### 6.1 实时运营看板

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 陪诊员中心 - 实时运营看板                               2024-12-11 15:30:45 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  今日概览                                                                   │
│  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐  │
│  │ 今日订单      │ │ 今日 GMV      │ │ 活跃陪诊员    │ │ 待派单订单    │  │
│  │     156       │ │   ¥45,680     │ │     89        │ │      12       │  │
│  │   ↑12%       │ │   ↑8%        │ │   ↑5%        │ │              │  │
│  │   较昨日      │ │   较昨日      │ │   较昨日      │ │   需处理     │  │
│  └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘  │
│                                                                             │
│  订单状态分布                          服务类型分布                          │
│  ┌────────────────────────────────┐  ┌────────────────────────────────┐   │
│  │ ▓▓▓▓▓▓▓▓▓▓░░░░░ 待派单 12     │  │ 全程陪诊     ▓▓▓▓▓▓▓▓  65%    │   │
│  │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ 服务中 45     │  │ 检查陪同     ▓▓▓▓░░░░  25%    │   │
│  │ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ 已完成 89 │  │ 手术陪护     ▓▓░░░░░░  10%    │   │
│  │ ▓▓░░░░░░░░░░░░░ 已取消 10     │  └────────────────────────────────┘   │
│  └────────────────────────────────┘                                        │
│                                                                             │
│  实时订单流                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 15:28 | 订单 2024121200156 | 全程陪诊 | 协和医院 | 已派单 → 张护士  │   │
│  │ 15:25 | 订单 2024121200155 | 检查陪同 | 北医三院 | 已完成           │   │
│  │ 15:22 | 订单 2024121200154 | 全程陪诊 | 朝阳医院 | 支付成功         │   │
│  │ 15:20 | 订单 2024121200153 | 手术陪护 | 协和医院 | 用户取消         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  抢单热力图（最近1小时）                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  14:30  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓  23次                                      │   │
│  │  14:45  ▓▓▓▓▓▓▓▓▓▓▓▓  18次                                         │   │
│  │  15:00  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓  28次                                  │   │
│  │  15:15  ▓▓▓▓▓▓▓▓▓▓▓▓▓▓  21次                                       │   │
│  │  15:30  ▓▓▓▓▓▓▓▓  12次（进行中）                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 陪诊员分析看板

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 陪诊员分析看板                                              2024年12月       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  陪诊员规模                                                                  │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐   │
│  │ 总人数    │ │ 本月新增  │ │ 活跃率    │ │ 流失率    │ │ 通过率    │   │
│  │   456     │ │    45     │ │   78%     │ │   5.2%    │ │   82%     │   │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘   │
│                                                                             │
│  等级分布                              工作状态分布                          │
│  ┌────────────────────────────────┐  ┌────────────────────────────────┐   │
│  │ 资深   ▓▓▓▓░░░░░░░░░░  45人    │  │ 接单中   ▓▓▓▓▓▓▓▓▓▓  89人     │   │
│  │ 中级   ▓▓▓▓▓▓▓▓░░░░░░  120人   │  │ 休息中   ▓▓▓▓▓▓▓▓▓▓▓▓  156人  │   │
│  │ 初级   ▓▓▓▓▓▓▓▓▓▓▓▓░░  210人   │  │ 服务中   ▓▓▓▓░░░░░░░░  45人   │   │
│  │ 实习   ▓▓▓▓▓▓░░░░░░░░  81人    │  │ 未激活   ▓▓▓▓▓▓▓▓▓▓▓▓▓  166人 │   │
│  └────────────────────────────────┘  └────────────────────────────────┘   │
│                                                                             │
│  本月 TOP 陪诊员                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 排名 │ 姓名    │ 等级 │ 完成单数 │ 收入    │ 评分 │ 准时率         │   │
│  │──────┼─────────┼──────┼──────────┼─────────┼──────┼────────────────│   │
│  │  1   │ 张护士  │ 资深 │    68    │ ¥18,560 │ 4.98 │ 100%           │   │
│  │  2   │ 李护士  │ 资深 │    52    │ ¥14,230 │ 4.95 │ 98%            │   │
│  │  3   │ 王师傅  │ 中级 │    48    │ ¥12,800 │ 4.92 │ 96%            │   │
│  │  4   │ 陈护士  │ 中级 │    45    │ ¥11,500 │ 4.90 │ 100%           │   │
│  │  5   │ 刘护士  │ 中级 │    42    │ ¥10,800 │ 4.88 │ 95%            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  增长趋势（近30天）                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                           ·                         │   │
│  │                                    ·    ·   ·                       │   │
│  │                              ·   ·                ·                 │   │
│  │                        ·   ·                        ·   ·          │   │
│  │  ·   ·   ·   ·   ·   ·                                    ·   ·   │   │
│  │ ─────────────────────────────────────────────────────────────────── │   │
│  │ 12/1     12/5     12/10    12/15    12/20    12/25    12/30        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、API 设计

### 7.1 埋点上报 API

| 方法 | 端点 | 说明 |
|------|------|------|
| POST | `/track` | 单个事件上报 |
| POST | `/track/batch` | 批量事件上报 |

### 7.2 数据查询 API（管理端）

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/admin/analytics/overview` | 获取概览数据 |
| GET | `/admin/analytics/escorts` | 获取陪诊员分析数据 |
| GET | `/admin/analytics/orders` | 获取订单分析数据 |
| GET | `/admin/analytics/distribution` | 获取分销分析数据 |
| GET | `/admin/analytics/realtime` | 获取实时数据 |
| POST | `/admin/analytics/export` | 导出报表 |

---

## 八、验收标准

### 埋点采集
- [ ] 小程序端埋点正常上报
- [ ] 后端业务事件正常记录
- [ ] 批量上报机制正常

### 数据存储
- [ ] 原始事件正确存储
- [ ] 聚合指标定时更新

### 数据看板
- [ ] 实时看板数据刷新
- [ ] 陪诊员分析看板完整
- [ ] 数据导出功能正常

### 性能要求
- [ ] 埋点不影响页面加载
- [ ] 批量上报不阻塞主流程

---

## 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2024-12-11 | 初始版本 | - |
