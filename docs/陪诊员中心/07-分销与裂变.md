# åˆ†é”€ä¸è£‚å˜è§„åˆ’æ–‡æ¡£

> è¿”å› [é™ªè¯Šå‘˜ä¸­å¿ƒæ€»è§ˆ](./README.md)  
> çŠ¶æ€ï¼šâœ… å·²è§„åˆ’  
> ç‰ˆæœ¬ï¼šv1.1  
> æ›´æ–°æ—¥æœŸï¼š2024-12-11

---

## ä¸€ã€ä¸šåŠ¡èƒŒæ™¯

### 1.1 é™ªè¯Šå‘˜ç”»åƒåˆ†æ

å¹³å°é™ªè¯Šå‘˜ä¸»è¦æ¥æºäº **åŒ»è¯ä»£è¡¨** ç¾¤ä½“ï¼ŒåæœŸæ‰©å±•è‡³åŒ»ç–—å‘¨è¾¹ä»ä¸šè€…ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          é™ªè¯Šå‘˜æ¥æºç”»åƒ                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ç¬¬ä¸€é˜¶æ®µï¼šåŒ»è¯ä»£è¡¨ç¾¤ä½“ï¼ˆæ ¸å¿ƒç§å­ï¼‰                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ä¼˜åŠ¿ç‰¹å¾                                                             â”‚   â”‚
â”‚  â”‚ Â· ç†Ÿæ‚‰åŒ»é™¢ç¯å¢ƒå’Œå°±åŒ»æµç¨‹                                              â”‚   â”‚
â”‚  â”‚ Â· ä¸åŒ»æŠ¤äººå‘˜æœ‰è‰¯å¥½å…³ç³»ç½‘ç»œ                                            â”‚   â”‚
â”‚  â”‚ Â· å…·å¤‡é”€å”®èƒ½åŠ›å’ŒæœåŠ¡æ„è¯†                                              â”‚   â”‚
â”‚  â”‚ Â· æœ‰ä¸°å¯Œçš„ç¤¾äº¤èµ„æºï¼ˆé€‚åˆåˆ†é”€è£‚å˜ï¼‰                                     â”‚   â”‚
â”‚  â”‚ Â· æ—¶é—´ç›¸å¯¹çµæ´»ï¼ˆæ‹œè®¿ç©ºéš™å¯æ¥å•ï¼‰                                       â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚ è¡Œä¸šç°çŠ¶                                                              â”‚   â”‚
â”‚  â”‚ Â· åŒ»è¯æ”¹é©åæ”¶å…¥å—å½±å“ï¼Œéœ€è¦å‰¯ä¸š                                       â”‚   â”‚
â”‚  â”‚ Â· å…·å¤‡åŒ»ç–—ä¸“ä¸šçŸ¥è¯†                                                    â”‚   â”‚
â”‚  â”‚ Â· è¦†ç›–åŸå¸‚å’ŒåŒ»é™¢èµ„æºå¹¿æ³›                                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  ç¬¬äºŒé˜¶æ®µï¼šåŒ»ç–—å‘¨è¾¹ä»ä¸šè€…                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Â· æŠ¤å·¥ã€æŠ¤ç†å‘˜                                                        â”‚   â”‚
â”‚  â”‚ Â· åŒ»é™¢å¿—æ„¿è€…                                                          â”‚   â”‚
â”‚  â”‚ Â· é€€ä¼‘åŒ»æŠ¤äººå‘˜                                                        â”‚   â”‚
â”‚  â”‚ Â· å¥åº·ç®¡ç†å¸ˆ                                                          â”‚   â”‚
â”‚  â”‚ Â· åŒ»å­¦é™¢å­¦ç”Ÿï¼ˆå®ä¹ æ€§è´¨ï¼‰                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  ç¬¬ä¸‰é˜¶æ®µï¼šæ³›æœåŠ¡äººå‘˜                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Â· å®¶æ”¿æœåŠ¡äººå‘˜                                                        â”‚   â”‚
â”‚  â”‚ Â· ç½‘çº¦è½¦å¸æœºï¼ˆåŒ»é™¢å‘¨è¾¹ï¼‰                                               â”‚   â”‚
â”‚  â”‚ Â· æœ‰æœåŠ¡æ„è¯†çš„è‡ªç”±èŒä¸šè€…                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 åˆ†é”€ä½“ç³»è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **åˆè§„æ€§** | ä¸¥æ ¼æ§åˆ¶ä¸‰å±‚ï¼Œé¿å…ä¼ é”€é£é™© |
| **æ¿€åŠ±æ€§** | è®©é‚€è¯·äººæœ‰æŒç»­æ”¶ç›ŠåŠ¨åŠ› |
| **å…¬å¹³æ€§** | æ–°è€é™ªè¯Šå‘˜åˆ©ç›Šå¹³è¡¡ |
| **å¯è¿½æº¯** | å®Œæ•´çš„é‚€è¯·é“¾è·¯è®°å½• |
| **å¯æ§æ€§** | åˆ†é”€è´¹ç”¨åœ¨å¯æ§èŒƒå›´å†… |

---

## äºŒã€ä¸‰å±‚åˆ†é”€æ¶æ„

### 2.1 å±‚çº§å®šä¹‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ä¸‰å±‚åˆ†é”€æ¶æ„                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                         â”‚   å¹³å°/æ€»éƒ¨   â”‚                                   â”‚
â”‚                         â”‚ åˆ¶å®šè§„åˆ™ï¼Œç›‘ç®¡ â”‚                                   â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                 â”‚                                           â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚           â”‚                     â”‚                     â”‚                     â”‚
â”‚           â–¼                     â–¼                     â–¼                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚  åŸå¸‚åˆä¼™äºº    â”‚     â”‚  åŸå¸‚åˆä¼™äºº    â”‚     â”‚  åŸå¸‚åˆä¼™äºº    â”‚           â”‚
â”‚   â”‚   (L1å±‚)      â”‚     â”‚   (L1å±‚)      â”‚     â”‚   (L1å±‚)      â”‚           â”‚
â”‚   â”‚  åŒºåŸŸè´Ÿè´£äºº    â”‚     â”‚  åŒºåŸŸè´Ÿè´£äºº    â”‚     â”‚  åŒºåŸŸè´Ÿè´£äºº    â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                     â”‚                                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                    â”‚
â”‚     â”‚           â”‚         â”‚           â”‚                                    â”‚
â”‚     â–¼           â–¼         â–¼           â–¼                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚ â”‚ å›¢é˜Ÿé•¿  â”‚ â”‚ å›¢é˜Ÿé•¿  â”‚ â”‚ å›¢é˜Ÿé•¿  â”‚ â”‚ å›¢é˜Ÿé•¿  â”‚                               â”‚
â”‚ â”‚(L2å±‚)  â”‚ â”‚(L2å±‚)  â”‚ â”‚(L2å±‚)  â”‚ â”‚(L2å±‚)  â”‚                               â”‚
â”‚ â”‚æ‹›å‹Ÿç®¡ç†â”‚ â”‚æ‹›å‹Ÿç®¡ç†â”‚ â”‚æ‹›å‹Ÿç®¡ç†â”‚ â”‚æ‹›å‹Ÿç®¡ç†â”‚                               â”‚
â”‚ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚     â”‚          â”‚          â”‚                                                â”‚
â”‚   â”Œâ”€â”´â”€â”      â”Œâ”€â”´â”€â”      â”Œâ”€â”´â”€â”                                             â”‚
â”‚   â”‚   â”‚      â”‚   â”‚      â”‚   â”‚                                             â”‚
â”‚   â–¼   â–¼      â–¼   â–¼      â–¼   â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”â”Œâ”€â”€â”  â”Œâ”€â”€â”â”Œâ”€â”€â”  â”Œâ”€â”€â”â”Œâ”€â”€â”                                            â”‚
â”‚  â”‚é™ªâ”‚â”‚é™ªâ”‚  â”‚é™ªâ”‚â”‚é™ªâ”‚  â”‚é™ªâ”‚â”‚é™ªâ”‚  â† L3å±‚ï¼šæ™®é€šé™ªè¯Šå‘˜                         â”‚
â”‚  â”‚è¯Šâ”‚â”‚è¯Šâ”‚  â”‚è¯Šâ”‚â”‚è¯Šâ”‚  â”‚è¯Šâ”‚â”‚è¯Šâ”‚     ä¸€çº¿æœåŠ¡äººå‘˜                            â”‚
â”‚  â”‚å‘˜â”‚â”‚å‘˜â”‚  â”‚å‘˜â”‚â”‚å‘˜â”‚  â”‚å‘˜â”‚â”‚å‘˜â”‚                                            â”‚
â”‚  â””â”€â”€â”˜â””â”€â”€â”˜  â””â”€â”€â”˜â””â”€â”€â”˜  â””â”€â”€â”˜â””â”€â”€â”˜                                            â”‚
â”‚                                                                             â”‚
â”‚  åˆ†æ¶¦ç¤ºä¾‹ï¼ˆä¸€ç¬”è®¢å• Â¥300ï¼ŒæœåŠ¡åˆ†æˆ 70%ï¼‰ï¼š                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ é™ªè¯Šå‘˜(L3) æœåŠ¡æ”¶å…¥ï¼šÂ¥300 Ã— 70% = Â¥210                              â”‚   â”‚
â”‚  â”‚ å›¢é˜Ÿé•¿(L2) ç®¡ç†å¥–åŠ±ï¼šÂ¥300 Ã— 3% = Â¥9                                 â”‚   â”‚
â”‚  â”‚ åˆä¼™äºº(L1) åŒºåŸŸåˆ†æ¶¦ï¼šÂ¥300 Ã— 2% = Â¥6                                 â”‚   â”‚
â”‚  â”‚ å¹³å°æ”¶å…¥ï¼šÂ¥300 Ã— 25% = Â¥75                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å±‚çº§è§’è‰²å®šä¹‰

| å±‚çº§ | è§’è‰² | å®šä½ | æƒé™ | æ”¶ç›Šæ¥æº |
|------|------|------|------|---------|
| **L1** | åŸå¸‚åˆä¼™äºº | åŒºåŸŸè´Ÿè´£äºº | ç®¡ç†åŒºåŸŸã€å®¡æ ¸å›¢é˜Ÿé•¿ | åŒºåŸŸæ‰€æœ‰è®¢å•åˆ†æ¶¦ |
| **L2** | å›¢é˜Ÿé•¿ | æ‹›å‹Ÿç®¡ç†è€… | é‚€è¯·é™ªè¯Šå‘˜ã€åŸ¹è®­ç®¡ç† | å›¢é˜Ÿè®¢å•åˆ†æ¶¦ + ç›´æ¨å¥–åŠ± |
| **L3** | é™ªè¯Šå‘˜ | ä¸€çº¿æœåŠ¡è€… | æ¥å•æœåŠ¡ | æœåŠ¡åˆ†æˆ + æ¨èå¥–åŠ± |

### 2.3 æ™‹å‡è·¯å¾„

```
æ™®é€šé™ªè¯Šå‘˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º å›¢é˜Ÿé•¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º åŸå¸‚åˆä¼™äºº
          â”‚                                              â”‚
          â”‚ æ™‹å‡æ¡ä»¶ï¼š                                    â”‚ æ™‹å‡æ¡ä»¶ï¼š
          â”‚ Â· å®Œæˆ 50 å• ä¸” è¯„åˆ† â‰¥4.5                    â”‚ Â· å›¢é˜Ÿ 10 äººä»¥ä¸Š
          â”‚ Â· ç›´æ¨ 3 ååˆæ ¼é™ªè¯Šå‘˜                        â”‚ Â· å›¢é˜Ÿæœˆè®¢å• 100+
          â”‚ Â· åœ¨çº¿ 3 ä¸ªæœˆä»¥ä¸Š                            â”‚ Â· ä¸ªäººæœˆè®¢å• 30+
          â”‚ Â· æ— æŠ•è¯‰è®°å½•                                 â”‚ Â· åŸ¹è®­è€ƒæ ¸é€šè¿‡
          â”‚                                              â”‚ Â· å¹³å°é‚€è¯·åˆ¶
          â–¼                                              â–¼
     è§£é”å›¢é˜Ÿç®¡ç†æƒé™                              è§£é”åŒºåŸŸç®¡ç†æƒé™
     Â· å¯æŸ¥çœ‹ä¸‹çº§æ•°æ®                             Â· å¯å®¡æ ¸å›¢é˜Ÿé•¿
     Â· å¯è¿›è¡ŒåŸ¹è®­æŒ‡å¯¼                             Â· åŒºåŸŸæ•°æ®çœ‹æ¿
     Â· äº«å—å›¢é˜Ÿåˆ†æ¶¦                               Â· ä¼˜å…ˆè·å–èµ„æº
```

---

## ä¸‰ã€æ•°æ®æ¨¡å‹

### 3.1 é‚€è¯·å…³ç³»

```prisma
model EscortInvitation {
  id           String    @id @default(uuid())
  
  // é‚€è¯·äººï¼ˆä¸Šçº§ï¼‰
  inviterId    String    @map("inviter_id")
  inviterLevel Int       @map("inviter_level")     // é‚€è¯·æ—¶çš„å±‚çº§
  
  // è¢«é‚€è¯·äººï¼ˆä¸‹çº§ï¼‰
  inviteeId    String    @unique @map("invitee_id")
  
  // é‚€è¯·ç 
  inviteCode   String    @map("invite_code")
  
  // çŠ¶æ€
  status       String    @default("pending")
  // pending: å·²é‚€è¯·ï¼Œå¾…å®¡æ ¸
  // active: å·²ç”Ÿæ•ˆ
  // expired: å·²è¿‡æœŸ
  // cancelled: å·²å–æ¶ˆ
  
  // ç”Ÿæ•ˆæ—¶é—´
  activatedAt  DateTime? @map("activated_at")
  
  createdAt    DateTime  @default(now()) @map("created_at")
  
  inviter      Escort    @relation("InviterRelation", fields: [inviterId], references: [id])
  invitee      Escort    @relation("InviteeRelation", fields: [inviteeId], references: [id])
  
  @@index([inviterId])
  @@index([inviteCode])
  @@map("escort_invitations")
}
```

### 3.2 é™ªè¯Šå‘˜å±‚çº§æ‰©å±•

```prisma
model Escort {
  // ... ç°æœ‰å­—æ®µ ...
  
  // åˆ†é”€å±‚çº§
  distributionLevel    Int      @default(3) @map("distribution_level")
  // 1: åŸå¸‚åˆä¼™äºº
  // 2: å›¢é˜Ÿé•¿  
  // 3: æ™®é€šé™ªè¯Šå‘˜
  
  // é‚€è¯·ç ï¼ˆå”¯ä¸€ï¼‰
  inviteCode           String?  @unique @map("invite_code")
  
  // ä¸Šçº§é‚€è¯·äºº IDï¼ˆç›´æ¥ä¸Šçº§ï¼‰
  parentId             String?  @map("parent_id")
  
  // ä¸Šçº§é“¾è·¯ï¼ˆJSON æ•°ç»„ï¼Œæ–¹ä¾¿æŸ¥è¯¢å¤šå±‚å…³ç³»ï¼‰
  // ä¾‹ï¼š["L1çš„id", "L2çš„id"] è¡¨ç¤º L1 -> L2 -> å½“å‰
  ancestorPath         String?  @map("ancestor_path")  // JSON
  
  // å›¢é˜Ÿç»Ÿè®¡ï¼ˆå®šæœŸæ›´æ–°ï¼‰
  teamSize             Int      @default(0) @map("team_size")       // ç›´å±ä¸‹çº§æ•°
  totalTeamSize        Int      @default(0) @map("total_team_size") // æ‰€æœ‰ä¸‹çº§æ•°
  
  // æ™‹å‡ç›¸å…³
  promotedAt           DateTime? @map("promoted_at")   // ä¸Šæ¬¡æ™‹å‡æ—¶é—´
  promotionAppliedAt   DateTime? @map("promotion_applied_at")  // ç”³è¯·æ™‹å‡æ—¶é—´
  
  // å…³è”
  parent               Escort?  @relation("ParentChild", fields: [parentId], references: [id])
  children             Escort[] @relation("ParentChild")
  invitationsSent      EscortInvitation[] @relation("InviterRelation")
  invitationReceived   EscortInvitation?  @relation("InviteeRelation")
  
  // ... ç°æœ‰å…³è” ...
}
```

### 3.3 åˆ†æ¶¦é…ç½®

```prisma
model DistributionConfig {
  id                    String   @id @default(uuid())
  
  // å„å±‚çº§åˆ†æ¶¦æ¯”ä¾‹ï¼ˆåŸºäºè®¢å•å®ä»˜é‡‘é¢ï¼‰
  l1CommissionRate      Int      @default(2) @map("l1_commission_rate")   // åŸå¸‚åˆä¼™äºº 2%
  l2CommissionRate      Int      @default(3) @map("l2_commission_rate")   // å›¢é˜Ÿé•¿ 3%
  l3CommissionRate      Int      @default(1) @map("l3_commission_rate")   // é™ªè¯Šå‘˜æ¨èå¥–åŠ± 1%
  
  // ç›´æ¨å¥–åŠ±ï¼ˆæ–°é™ªè¯Šå‘˜é¦–å•ï¼‰
  directInviteBonus     Decimal  @default(50) @db.Decimal(10, 2) @map("direct_invite_bonus")
  
  // æ™‹å‡æ¡ä»¶é…ç½®
  l2PromotionConfig     Json     @map("l2_promotion_config")
  // {
  //   minOrders: 50,           // æœ€ä½å®Œæˆè®¢å•
  //   minRating: 4.5,          // æœ€ä½è¯„åˆ†
  //   minDirectInvites: 3,     // æœ€ä½ç›´æ¨äººæ•°
  //   minActiveMonths: 3,      // æœ€ä½åœ¨çº¿æœˆæ•°
  // }
  
  l1PromotionConfig     Json     @map("l1_promotion_config")
  // {
  //   minTeamSize: 10,         // æœ€ä½å›¢é˜Ÿäººæ•°
  //   minTeamMonthlyOrders: 100, // å›¢é˜Ÿæœˆè®¢å•
  //   minPersonalMonthlyOrders: 30, // ä¸ªäººæœˆè®¢å•
  //   requireTraining: true,    // éœ€è¦åŸ¹è®­è€ƒæ ¸
  //   byInvitation: true,       // å¹³å°é‚€è¯·åˆ¶
  // }
  
  // åˆ†æ¶¦ä¸Šé™
  maxMonthlyDistribution Decimal? @db.Decimal(10, 2) @map("max_monthly_distribution")
  
  status                String   @default("active")
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  @@map("distribution_config")
}
```

### 3.4 åˆ†æ¶¦è®°å½•

```prisma
model DistributionRecord {
  id              String   @id @default(uuid())
  
  // å…³è”è®¢å•
  orderId         String   @map("order_id")
  orderAmount     Decimal  @db.Decimal(10, 2) @map("order_amount")
  
  // å—ç›Šäºº
  beneficiaryId   String   @map("beneficiary_id")
  beneficiaryLevel Int     @map("beneficiary_level")  // å—ç›Šæ—¶çš„å±‚çº§
  
  // åˆ†æ¶¦æ¥æºï¼ˆå“ªä¸ªé™ªè¯Šå‘˜çš„è®¢å•ï¼‰
  sourceEscortId  String   @map("source_escort_id")
  relationLevel   Int      @map("relation_level")     // ä¸æ¥æºçš„å…³ç³»å±‚çº§ (1=ç›´æ¥, 2=äºŒçº§, 3=ä¸‰çº§)
  
  // åˆ†æ¶¦ä¿¡æ¯
  rate            Int                                 // åˆ†æ¶¦æ¯”ä¾‹
  amount          Decimal  @db.Decimal(10, 2)         // åˆ†æ¶¦é‡‘é¢
  type            String                              // order: è®¢å•åˆ†æ¶¦, bonus: ç›´æ¨å¥–åŠ±
  
  // çŠ¶æ€
  status          String   @default("pending")
  // pending: å¾…ç»“ç®—ï¼ˆè®¢å•å®Œæˆå7å¤©ï¼‰
  // settled: å·²ç»“ç®—
  // cancelled: å·²å–æ¶ˆï¼ˆè®¢å•é€€æ¬¾ï¼‰
  
  settledAt       DateTime? @map("settled_at")
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  order           Order    @relation(fields: [orderId], references: [id])
  beneficiary     Escort   @relation("BeneficiaryRelation", fields: [beneficiaryId], references: [id])
  sourceEscort    Escort   @relation("SourceRelation", fields: [sourceEscortId], references: [id])
  
  @@index([beneficiaryId])
  @@index([orderId])
  @@index([status])
  @@map("distribution_records")
}
```

---

## å››ã€ä¸šåŠ¡é€»è¾‘

### 4.1 ç”Ÿæˆé‚€è¯·ç 

```typescript
async function generateInviteCode(escortId: string): Promise<string> {
  const escort = await prisma.escort.findUnique({
    where: { id: escortId }
  });
  
  if (escort.inviteCode) {
    return escort.inviteCode;
  }
  
  // ç”Ÿæˆå”¯ä¸€é‚€è¯·ç ï¼ˆ6ä½å­—æ¯æ•°å­—ï¼‰
  let code: string;
  let attempts = 0;
  
  do {
    code = generateRandomCode(6);
    const existing = await prisma.escort.findUnique({
      where: { inviteCode: code }
    });
    if (!existing) break;
    attempts++;
  } while (attempts < 10);
  
  if (attempts >= 10) {
    throw new Error('ç”Ÿæˆé‚€è¯·ç å¤±è´¥');
  }
  
  await prisma.escort.update({
    where: { id: escortId },
    data: { inviteCode: code }
  });
  
  return code;
}

function generateRandomCode(length: number): string {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // å»é™¤æ˜“æ··æ·†å­—ç¬¦
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}
```

### 4.2 å¤„ç†é‚€è¯·å…³ç³»

```typescript
async function processInvitation(
  inviteeId: string, 
  inviteCode: string
): Promise<void> {
  // 1. æŸ¥æ‰¾é‚€è¯·äºº
  const inviter = await prisma.escort.findUnique({
    where: { inviteCode }
  });
  
  if (!inviter || inviter.status !== 'active') {
    throw new BadRequestException('é‚€è¯·ç æ— æ•ˆ');
  }
  
  // 2. æ£€æŸ¥è¢«é‚€è¯·äººæ˜¯å¦å·²æœ‰ä¸Šçº§
  const invitee = await prisma.escort.findUnique({
    where: { id: inviteeId }
  });
  
  if (invitee.parentId) {
    throw new BadRequestException('æ‚¨å·²æœ‰é‚€è¯·äºº');
  }
  
  // 3. æ£€æŸ¥æ˜¯å¦å½¢æˆå¾ªç¯ï¼ˆé˜²æ­¢ A é‚€è¯· Bï¼ŒB åˆé‚€è¯· Aï¼‰
  if (isInAncestorChain(inviter, inviteeId)) {
    throw new BadRequestException('é‚€è¯·å…³ç³»å¼‚å¸¸');
  }
  
  // 4. æ„å»ºä¸Šçº§é“¾è·¯
  const ancestorPath = inviter.ancestorPath 
    ? [...JSON.parse(inviter.ancestorPath), inviter.id]
    : [inviter.id];
  
  // åªä¿ç•™æœ€è¿‘3å±‚
  const trimmedPath = ancestorPath.slice(-3);
  
  // 5. å»ºç«‹å…³ç³»
  await prisma.$transaction(async (tx) => {
    // æ›´æ–°è¢«é‚€è¯·äºº
    await tx.escort.update({
      where: { id: inviteeId },
      data: {
        parentId: inviter.id,
        ancestorPath: JSON.stringify(trimmedPath),
      }
    });
    
    // åˆ›å»ºé‚€è¯·è®°å½•
    await tx.escortInvitation.create({
      data: {
        inviterId: inviter.id,
        inviterLevel: inviter.distributionLevel,
        inviteeId,
        inviteCode,
        status: 'active',
        activatedAt: new Date(),
      }
    });
    
    // æ›´æ–°ä¸Šçº§å›¢é˜Ÿç»Ÿè®¡
    await updateTeamStats(tx, inviter.id);
  });
}

async function updateTeamStats(tx: any, escortId: string): Promise<void> {
  // æ›´æ–°ç›´å±å›¢é˜Ÿæ•°
  const directCount = await tx.escort.count({
    where: { parentId: escortId }
  });
  
  await tx.escort.update({
    where: { id: escortId },
    data: { teamSize: directCount }
  });
  
  // é€’å½’æ›´æ–°ä¸Šçº§çš„ totalTeamSize
  const escort = await tx.escort.findUnique({
    where: { id: escortId }
  });
  
  if (escort.parentId) {
    await updateTotalTeamSize(tx, escort.parentId);
  }
}
```

### 4.3 è®¢å•åˆ†æ¶¦è®¡ç®—

```typescript
interface DistributionResult {
  records: Array<{
    beneficiaryId: string;
    beneficiaryLevel: number;
    relationLevel: number;
    rate: number;
    amount: number;
    type: string;
  }>;
  totalDistribution: number;
}

async function calculateDistribution(
  orderId: string,
  escortId: string,
  orderAmount: number
): Promise<DistributionResult> {
  const config = await prisma.distributionConfig.findFirst({
    where: { status: 'active' }
  });
  
  const escort = await prisma.escort.findUnique({
    where: { id: escortId }
  });
  
  const records: DistributionResult['records'] = [];
  let totalDistribution = 0;
  
  // è·å–ä¸Šçº§é“¾è·¯
  const ancestors = escort.ancestorPath 
    ? JSON.parse(escort.ancestorPath) as string[]
    : [];
  
  // ä»ç›´æ¥ä¸Šçº§å¼€å§‹ï¼Œæœ€å¤š3å±‚
  for (let i = 0; i < Math.min(ancestors.length, 3); i++) {
    const ancestorId = ancestors[ancestors.length - 1 - i]; // ä»æœ€è¿‘çš„å¼€å§‹
    const ancestor = await prisma.escort.findUnique({
      where: { id: ancestorId }
    });
    
    if (!ancestor || ancestor.status !== 'active') continue;
    
    // æ ¹æ®å±‚çº§ç¡®å®šåˆ†æ¶¦æ¯”ä¾‹
    let rate: number;
    const relationLevel = i + 1; // 1=ç›´æ¥ä¸Šçº§, 2=äºŒçº§, 3=ä¸‰çº§
    
    switch (ancestor.distributionLevel) {
      case 1: // åŸå¸‚åˆä¼™äºº
        rate = config.l1CommissionRate;
        break;
      case 2: // å›¢é˜Ÿé•¿
        rate = config.l2CommissionRate;
        break;
      case 3: // æ™®é€šé™ªè¯Šå‘˜ï¼ˆåªèƒ½è·å¾—ç›´æ¨å¥–åŠ±ï¼Œä¸å‚ä¸æŒç»­åˆ†æ¶¦ï¼‰
        rate = relationLevel === 1 ? config.l3CommissionRate : 0;
        break;
      default:
        rate = 0;
    }
    
    if (rate > 0) {
      const amount = Math.round(orderAmount * rate) / 100;
      records.push({
        beneficiaryId: ancestorId,
        beneficiaryLevel: ancestor.distributionLevel,
        relationLevel,
        rate,
        amount,
        type: 'order',
      });
      totalDistribution += amount;
    }
  }
  
  return { records, totalDistribution };
}
```

### 4.4 ç›´æ¨å¥–åŠ±

```typescript
async function grantDirectInviteBonus(
  inviterId: string,
  inviteeId: string,
  firstOrderId: string
): Promise<void> {
  const config = await prisma.distributionConfig.findFirst({
    where: { status: 'active' }
  });
  
  // æ£€æŸ¥æ˜¯å¦å·²å‘æ”¾è¿‡
  const existing = await prisma.distributionRecord.findFirst({
    where: {
      beneficiaryId: inviterId,
      sourceEscortId: inviteeId,
      type: 'bonus',
    }
  });
  
  if (existing) return;
  
  // å‘æ”¾å¥–åŠ±
  await prisma.$transaction(async (tx) => {
    await tx.distributionRecord.create({
      data: {
        orderId: firstOrderId,
        orderAmount: 0,
        beneficiaryId: inviterId,
        beneficiaryLevel: (await tx.escort.findUnique({ where: { id: inviterId } })).distributionLevel,
        sourceEscortId: inviteeId,
        relationLevel: 1,
        rate: 0,
        amount: config.directInviteBonus,
        type: 'bonus',
        status: 'settled',
        settledAt: new Date(),
      }
    });
    
    // ç›´æ¥å…¥è´¦
    await tx.escortWallet.update({
      where: { escortId: inviterId },
      data: {
        balance: { increment: config.directInviteBonus },
        totalEarned: { increment: config.directInviteBonus },
      }
    });
    
    await tx.walletTransaction.create({
      data: {
        walletId: (await tx.escortWallet.findUnique({ where: { escortId: inviterId } })).id,
        type: 'distribution',
        amount: config.directInviteBonus,
        balance: 0, // å®é™…ä½™é¢ç”±ä¸Šé¢æ›´æ–°
        title: 'ç›´æ¨å¥–åŠ±',
        description: 'é‚€è¯·æ–°é™ªè¯Šå‘˜é¦–å•å¥–åŠ±',
      }
    });
  });
}
```

### 4.5 æ™‹å‡æ£€æŸ¥

```typescript
async function checkAndPromote(escortId: string): Promise<boolean> {
  const escort = await prisma.escort.findUnique({
    where: { id: escortId },
    include: {
      _count: { select: { children: true } }
    }
  });
  
  if (escort.distributionLevel <= 1) {
    return false; // å·²æ˜¯æœ€é«˜çº§
  }
  
  const config = await prisma.distributionConfig.findFirst({
    where: { status: 'active' }
  });
  
  // æ™‹å‡åˆ°å›¢é˜Ÿé•¿ (L3 -> L2)
  if (escort.distributionLevel === 3) {
    const l2Config = config.l2PromotionConfig as L2PromotionConfig;
    
    const meetsOrders = escort.orderCount >= l2Config.minOrders;
    const meetsRating = escort.rating >= l2Config.minRating;
    const meetsInvites = escort._count.children >= l2Config.minDirectInvites;
    const meetsMonths = monthsSince(escort.createdAt) >= l2Config.minActiveMonths;
    const noComplaints = await hasNoComplaints(escortId);
    
    if (meetsOrders && meetsRating && meetsInvites && meetsMonths && noComplaints) {
      await promoteToLevel(escortId, 2);
      return true;
    }
  }
  
  // æ™‹å‡åˆ°åŸå¸‚åˆä¼™äºº (L2 -> L1) - éœ€è¦å¹³å°å®¡æ ¸
  if (escort.distributionLevel === 2) {
    const l1Config = config.l1PromotionConfig as L1PromotionConfig;
    
    const meetsTeamSize = escort.teamSize >= l1Config.minTeamSize;
    const teamMonthlyOrders = await getTeamMonthlyOrders(escortId);
    const personalMonthlyOrders = await getPersonalMonthlyOrders(escortId);
    
    if (meetsTeamSize && 
        teamMonthlyOrders >= l1Config.minTeamMonthlyOrders &&
        personalMonthlyOrders >= l1Config.minPersonalMonthlyOrders) {
      // æ»¡è¶³æ¡ä»¶ï¼Œåˆ›å»ºæ™‹å‡ç”³è¯·ï¼ˆéœ€è¦å¹³å°å®¡æ ¸ï¼‰
      await createPromotionApplication(escortId, 1);
      return false; // éœ€è¦ç­‰å¾…å®¡æ ¸
    }
  }
  
  return false;
}

async function promoteToLevel(escortId: string, newLevel: number): Promise<void> {
  await prisma.escort.update({
    where: { id: escortId },
    data: {
      distributionLevel: newLevel,
      promotedAt: new Date(),
    }
  });
  
  // å‘é€æ™‹å‡é€šçŸ¥
  await sendPromotionNotification(escortId, newLevel);
}
```

---

## äº”ã€API è®¾è®¡

### 5.1 é™ªè¯Šå‘˜ç«¯ API

| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| GET | `/escort/invite-code` | è·å–/ç”Ÿæˆé‚€è¯·ç  |
| GET | `/escort/team` | è·å–å›¢é˜Ÿæˆå‘˜åˆ—è¡¨ |
| GET | `/escort/team/stats` | è·å–å›¢é˜Ÿç»Ÿè®¡æ•°æ® |
| GET | `/escort/distribution/records` | è·å–åˆ†æ¶¦è®°å½• |
| GET | `/escort/promotion/status` | è·å–æ™‹å‡çŠ¶æ€ |
| POST | `/escort/promotion/apply` | ç”³è¯·æ™‹å‡ |

### 5.2 ç®¡ç†ç«¯ API

| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| GET | `/admin/distribution/config` | è·å–åˆ†æ¶¦é…ç½® |
| PUT | `/admin/distribution/config` | æ›´æ–°åˆ†æ¶¦é…ç½® |
| GET | `/admin/distribution/records` | è·å–æ‰€æœ‰åˆ†æ¶¦è®°å½• |
| GET | `/admin/promotion/applications` | è·å–æ™‹å‡ç”³è¯· |
| PUT | `/admin/promotion/applications/:id` | å®¡æ ¸æ™‹å‡ç”³è¯· |
| GET | `/admin/partners` | è·å–åŸå¸‚åˆä¼™äººåˆ—è¡¨ |
| GET | `/admin/team-leaders` | è·å–å›¢é˜Ÿé•¿åˆ—è¡¨ |

---

## å…­ã€ç•Œé¢è®¾è®¡

### 6.1 é‚€è¯·é¡µé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† é‚€è¯·é™ªè¯Šå‘˜                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     ğŸ‰ é‚€è¯·å¥½å‹ èµšå–å¥–åŠ±         â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚  é‚€è¯·å¥½å‹æˆä¸ºé™ªè¯Šå‘˜ï¼Œå¥½å‹é¦–å•    â”‚   â”‚
â”‚  â”‚  å®Œæˆåï¼Œæ‚¨å¯è·å¾— Â¥50 å¥–åŠ±       â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚  æŒç»­æ”¶ç›Šï¼šå¥½å‹æ¯å®Œæˆä¸€å•        â”‚   â”‚
â”‚  â”‚  æ‚¨å¯è·å¾—è®¢å•é‡‘é¢ 1~3% çš„åˆ†æ¶¦    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  æˆ‘çš„é‚€è¯·ç                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚        [  A B 3 K 9 F  ]        â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ [å¤åˆ¶é‚€è¯·ç ]     [ç”Ÿæˆé‚€è¯·æµ·æŠ¥]   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        [åˆ†äº«ç»™å¥½å‹]              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  é‚€è¯·è®°å½•                    æŸ¥çœ‹å…¨éƒ¨ â–¶ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å¼ ** 138****1234      å·²åŠ å…¥    â”‚   â”‚
â”‚  â”‚ é‚€è¯·æ—¶é—´ï¼š2024-12-15            â”‚   â”‚
â”‚  â”‚ ç´¯è®¡è´¡çŒ®åˆ†æ¶¦ï¼šÂ¥156              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ æ** 139****5678      å®¡æ ¸ä¸­    â”‚   â”‚
â”‚  â”‚ é‚€è¯·æ—¶é—´ï¼š2024-12-18            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å›¢é˜Ÿç®¡ç†é¡µé¢ï¼ˆå›¢é˜Ÿé•¿è§†è§’ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æˆ‘çš„å›¢é˜Ÿ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ğŸ‘‘ å›¢é˜Ÿé•¿                       â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚  å›¢é˜Ÿäººæ•°        æœ¬æœˆå›¢é˜Ÿä¸šç»©     â”‚   â”‚
â”‚  â”‚    12äºº            Â¥8,560       â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚  æœ¬æœˆåˆ†æ¶¦æ”¶ç›Š                     â”‚   â”‚
â”‚  â”‚    Â¥356.80                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  å›¢é˜Ÿæˆå‘˜                    ç­›é€‰ â–¼     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ğŸ‘¤ å¼ æŠ¤å£«                 æ´»è·ƒ  â”‚   â”‚
â”‚  â”‚    æœ¬æœˆå®Œæˆ 15 å• | æ”¶å…¥ Â¥1,890 â”‚   â”‚
â”‚  â”‚    æ‚¨çš„åˆ†æ¶¦ Â¥56.70              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ ğŸ‘¤ ææŠ¤å£«                 æ´»è·ƒ  â”‚   â”‚
â”‚  â”‚    æœ¬æœˆå®Œæˆ 12 å• | æ”¶å…¥ Â¥1,520 â”‚   â”‚
â”‚  â”‚    æ‚¨çš„åˆ†æ¶¦ Â¥45.60              â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ ğŸ‘¤ ç‹å¸ˆå‚…                 ä¼‘çœ   â”‚   â”‚
â”‚  â”‚    æœ¬æœˆå®Œæˆ 0 å•                 â”‚   â”‚
â”‚  â”‚    è¶…è¿‡7å¤©æœªæ¥å•ï¼Œå¯è”ç³»æ¿€æ´»     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        [é‚€è¯·æ–°æˆå‘˜]              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 æ™‹å‡ä¸­å¿ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æ™‹å‡ä¸­å¿ƒ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å½“å‰ç­‰çº§                         â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”                         â”‚   â”‚
â”‚  â”‚ â”‚ L3  â”‚  æ™®é€šé™ªè¯Šå‘˜              â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜                         â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚       â–¼  æ™‹å‡åˆ°  â–¼               â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”                         â”‚   â”‚
â”‚  â”‚ â”‚ L2  â”‚  å›¢é˜Ÿé•¿                  â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”˜  è§£é”å›¢é˜Ÿç®¡ç†ã€æ›´é«˜åˆ†æ¶¦   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  æ™‹å‡æ¡ä»¶                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ âœ… å®Œæˆ 50 å•          48/50    â”‚   â”‚
â”‚  â”‚    â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  96%      â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ âœ… è¯„åˆ† â‰¥4.5           4.8      â”‚   â”‚
â”‚  â”‚    â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ 100%      â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ â³ ç›´æ¨ 3 äºº            2/3     â”‚   â”‚
â”‚  â”‚    â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘  67%      â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ âœ… åœ¨çº¿ 3 ä¸ªæœˆ          5 ä¸ªæœˆ  â”‚   â”‚
â”‚  â”‚    â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“ 100%      â”‚   â”‚
â”‚  â”‚                                  â”‚   â”‚
â”‚  â”‚ âœ… æ— æŠ•è¯‰è®°å½•           âœ“       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  âš ï¸ è¿˜å·® 2 å•è®¢å•ã€1 äººç›´æ¨å³å¯æ™‹å‡    â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   [é‚€è¯·å¥½å‹ï¼ŒåŠ é€Ÿæ™‹å‡]            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸ƒã€é£é™©æ§åˆ¶

### 7.1 åˆè§„é£é™©

| é£é™© | æ§åˆ¶æªæ–½ |
|------|---------|
| ä¼ é”€å«Œç–‘ | ä¸¥æ ¼ä¸‰å±‚ï¼ŒåŸºäºå®é™…æœåŠ¡åˆ†æ¶¦ |
| ç©ºå•åˆ·å• | è®¢å•å®¡æ ¸ + å¼‚å¸¸æ£€æµ‹ |
| è™šå‡é‚€è¯· | æ‰‹æœºå·éªŒè¯ + å®¡æ ¸æœºåˆ¶ |
| æ¶æ„å¥—åˆ© | åˆ†æ¶¦å»¶è¿Ÿç»“ç®— + é€€æ¬¾æ‰£å› |

### 7.2 åˆ†æ¶¦ä¸Šé™

```typescript
// æ¯æœˆåˆ†æ¶¦æ”¶å…¥ä¸Šé™æ£€æŸ¥
async function checkDistributionLimit(
  beneficiaryId: string,
  newAmount: number
): Promise<boolean> {
  const config = await prisma.distributionConfig.findFirst();
  
  if (!config.maxMonthlyDistribution) {
    return true; // æ— ä¸Šé™
  }
  
  const thisMonth = await prisma.distributionRecord.aggregate({
    where: {
      beneficiaryId,
      status: 'settled',
      settledAt: { gte: startOfMonth(new Date()) },
    },
    _sum: { amount: true },
  });
  
  const currentTotal = Number(thisMonth._sum.amount || 0);
  return (currentTotal + newAmount) <= Number(config.maxMonthlyDistribution);
}
```

---

## å…«ã€éªŒæ”¶æ ‡å‡†

### é‚€è¯·åŠŸèƒ½
- [ ] å¯ç”Ÿæˆå”¯ä¸€é‚€è¯·ç 
- [ ] å¯é€šè¿‡é‚€è¯·ç å»ºç«‹ä¸Šä¸‹çº§å…³ç³»
- [ ] é‚€è¯·å…³ç³»æ­£ç¡®è®°å½•
- [ ] é˜²æ­¢å¾ªç¯é‚€è¯·

### åˆ†æ¶¦åŠŸèƒ½
- [ ] è®¢å•å®Œæˆåæ­£ç¡®è®¡ç®—å„å±‚åˆ†æ¶¦
- [ ] åˆ†æ¶¦é‡‘é¢æ­£ç¡®å…¥è´¦
- [ ] ç›´æ¨å¥–åŠ±æ­£ç¡®å‘æ”¾
- [ ] é€€æ¬¾æ—¶åˆ†æ¶¦æ­£ç¡®æ‰£å›

### æ™‹å‡åŠŸèƒ½
- [ ] æ™‹å‡æ¡ä»¶æ­£ç¡®æ£€æµ‹
- [ ] æ»¡è¶³æ¡ä»¶è‡ªåŠ¨æ™‹å‡ï¼ˆL3â†’L2ï¼‰
- [ ] é«˜çº§æ™‹å‡éœ€è¦å®¡æ ¸ï¼ˆL2â†’L1ï¼‰
- [ ] æ™‹å‡åæƒé™æ­£ç¡®æ›´æ–°

### å›¢é˜Ÿç®¡ç†
- [ ] å›¢é˜Ÿé•¿å¯æŸ¥çœ‹å›¢é˜Ÿæˆå‘˜
- [ ] å›¢é˜Ÿç»Ÿè®¡æ•°æ®å‡†ç¡®
- [ ] åŸå¸‚åˆä¼™äººå¯ç®¡ç†å›¢é˜Ÿé•¿
- [ ] ä¸Šçº§ç¦»çº¿åä¸‹çº§åˆ†æ¶¦é“¾è·¯æ­£å¸¸
- [ ] åˆ†é”€è®°å½•å¯è¿½æº¯

---

## ä¹ã€æ³•å¾‹åˆè§„è¯´æ˜

### 9.1 ä¸ä¼ é”€çš„æœ¬è´¨åŒºåˆ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åˆ†é”€ç³»ç»Ÿ vs ä¼ é”€ å¯¹æ¯”åˆ†æ                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  åˆ¤æ–­è¦ç´            æœ¬ç³»ç»Ÿ                      ä¼ é”€ç‰¹å¾                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                             â”‚
â”‚  æ”¶å…¥æ¥æº           åŸºäºå®é™…æœåŠ¡è®¢å•åˆ†æ¶¦        å…¥ä¼šè´¹ã€æ‹‰äººå¤´               â”‚
â”‚                     é™ªè¯Šå‘˜éœ€å®ŒæˆæœåŠ¡æ‰æœ‰åˆ†æˆ    æ— å®é™…å•†å“æˆ–æœåŠ¡              â”‚
â”‚                                                                             â”‚
â”‚  å±‚çº§å…³ç³»           ä¸¥æ ¼ä¸‰å±‚é™åˆ¶                æ— é™å±‚çº§                     â”‚
â”‚                     L1â†’L2â†’L3 åˆ°åº•               å±‚å±‚åµŒå¥—æ— ä¸Šé™               â”‚
â”‚                                                                             â”‚
â”‚  å…¥é—¨é—¨æ§›           é›¶è´¹ç”¨åŠ å…¥                  éœ€ç¼´çº³å…¥ä¼šè´¹                 â”‚
â”‚                     å®¡æ ¸åˆ¶ï¼ˆçœ‹èµ„è´¨éæ”¶è´¹ï¼‰      é«˜é¢é—¨æ§›è´¹                   â”‚
â”‚                                                                             â”‚
â”‚  å•†å“/æœåŠ¡          çœŸå®çš„é™ªè¯ŠæœåŠ¡              è™šå‡æˆ–æ— å®é™…ä»·å€¼             â”‚
â”‚                     æ˜ç æ ‡ä»·ï¼Œç”¨æˆ·è‡ªæ„¿è´­ä¹°      ä¸»è¦é å‘å±•ä¸‹çº¿               â”‚
â”‚                                                                             â”‚
â”‚  åˆ†æ¶¦æœºåˆ¶           åŸºäºè®¢å•å®ä»˜é‡‘é¢æ¯”ä¾‹        åŸºäºäººå¤´æ•°é‡                 â”‚
â”‚                     è®¢å•é€€æ¬¾åˆ™åˆ†æ¶¦æ‰£å›          äº¤è´¹å³è®¡ç®—                   â”‚
â”‚                                                                             â”‚
â”‚  æ”¶å…¥ä¸Šé™           æœ‰æœˆåº¦åˆ†æ¶¦ä¸Šé™              æ— ä¸Šé™æˆ–è™šå‡æ‰¿è¯º             â”‚
â”‚                     åˆ†æ¶¦æ¯”ä¾‹é€æ˜å¯æŸ¥            å¤¸å¤§æ”¶ç›Š                     â”‚
â”‚                                                                             â”‚
â”‚  åˆè§„å®¡è®¡           å®šæœŸå®¡è®¡ã€æ¥å—ç›‘ç®¡          è§„é¿ç›‘ç®¡                     â”‚
â”‚                     å®Œæ•´åˆ†æ¶¦è®°å½•ç•™å­˜            éšè—çœŸå®æ•°æ®                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 æ³•å¾‹ä¾æ®

æ ¹æ®ã€Šç¦æ­¢ä¼ é”€æ¡ä¾‹ã€‹ï¼ˆå›½åŠ¡é™¢ä»¤ç¬¬444å·ï¼‰ç¬¬ä¸ƒæ¡ï¼Œä¼ é”€è¡Œä¸ºçš„è®¤å®šæ ‡å‡†ï¼š

1. **ç»„ç»‡è€…æˆ–è€…ç»è¥è€…é€šè¿‡å‘å±•äººå‘˜ï¼Œè¦æ±‚è¢«å‘å±•äººå‘˜å‘å±•å…¶ä»–äººå‘˜åŠ å…¥**
   - âœ… æœ¬ç³»ç»Ÿï¼šé‚€è¯·æ˜¯å¯é€‰è¡Œä¸ºï¼Œéå¼ºåˆ¶ï¼Œä¸é‚€è¯·ä¹Ÿå¯æ­£å¸¸æ¥å•æœåŠ¡
   
2. **å¯¹è¢«å‘å±•äººå‘˜ä»¥å…¶ç›´æ¥æˆ–é—´æ¥å‘å±•çš„äººå‘˜æ•°é‡ä¸ºä¾æ®è®¡ç®—å’Œç»™ä»˜æŠ¥é…¬**
   - âœ… æœ¬ç³»ç»Ÿï¼šåˆ†æ¶¦åŸºäºå®é™…å®Œæˆçš„è®¢å•é‡‘é¢ï¼Œéäººå¤´æ•°é‡
   
3. **è¦æ±‚è¢«å‘å±•äººå‘˜äº¤çº³è´¹ç”¨æˆ–è€…ä»¥è®¤è´­å•†å“ç­‰æ–¹å¼å˜ç›¸äº¤çº³è´¹ç”¨**
   - âœ… æœ¬ç³»ç»Ÿï¼šåŠ å…¥é›¶è´¹ç”¨ï¼Œåªéœ€é€šè¿‡èµ„è´¨å®¡æ ¸

### 9.3 åˆè§„æªæ–½

```typescript
// 1. åˆ†æ¶¦ä¸Šé™æ§åˆ¶
const COMPLIANCE_CONFIG = {
  // æ¯æœˆæœ€å¤§åˆ†æ¶¦é‡‘é¢
  maxMonthlyDistribution: 50000,
  
  // å•ç¬”è®¢å•æœ€å¤§åˆ†æ¶¦æ¯”ä¾‹
  maxSingleOrderRate: 10,  // ä¸è¶…è¿‡è®¢å•é‡‘é¢çš„10%
  
  // åˆ†æ¶¦å»¶è¿Ÿç»“ç®—ï¼ˆç”¨äºé€€æ¬¾æ‰£å›ï¼‰
  settlementDelayDays: 7,
  
  // åˆ†æ¶¦è®°å½•ä¿ç•™å¹´é™
  recordRetentionYears: 5,
};

// 2. å¼‚å¸¸è¡Œä¸ºç›‘æ§
interface ComplianceAlert {
  type: 'abnormal_orders' | 'rapid_growth' | 'high_refund' | 'circular_invite';
  escortId: string;
  description: string;
  severity: 'low' | 'medium' | 'high';
  data: Record<string, any>;
}

async function detectComplianceRisks(): Promise<ComplianceAlert[]> {
  const alerts: ComplianceAlert[] = [];
  
  // æ£€æµ‹å¼‚å¸¸è®¢å•ï¼ˆåŒä¸€ç”¨æˆ·é‡å¤ä¸‹å•ç»™åŒä¸€é™ªè¯Šå‘˜å›¢é˜Ÿï¼‰
  // æ£€æµ‹å¿«é€Ÿå¢é•¿ï¼ˆçŸ­æœŸå†…å¤§é‡é‚€è¯·ï¼‰
  // æ£€æµ‹é«˜é€€æ¬¾ç‡ï¼ˆåˆ·å•å«Œç–‘ï¼‰
  // æ£€æµ‹å¾ªç¯é‚€è¯·ï¼ˆAé‚€Bï¼ŒBé‚€Cï¼ŒCé‚€Aï¼‰
  
  return alerts;
}

// 3. å®šæœŸåˆè§„æŠ¥å‘Š
interface ComplianceReport {
  period: string;
  totalDistribution: number;
  escortCount: number;
  orderCount: number;
  refundRate: number;
  avgDistributionPerOrder: number;
  alerts: ComplianceAlert[];
  auditStatus: 'pending' | 'passed' | 'flagged';
}
```

### 9.4 ç”¨æˆ·åè®®æ¡æ¬¾

```markdown
## åˆ†é”€æœåŠ¡æ¡æ¬¾ï¼ˆéœ€åœ¨é™ªè¯Šå‘˜æ³¨å†Œæ—¶ç¡®è®¤ï¼‰

1. æœ¬å¹³å°åˆ†é”€ä½“ç³»åŸºäºå®é™…æœåŠ¡è®¢å•åˆ†æ¶¦ï¼ŒéåŸºäºå‘å±•äººå‘˜æ•°é‡
2. åˆ†é”€å±‚çº§ä¸¥æ ¼é™åˆ¶ä¸ºä¸‰å±‚ï¼Œè¶…å‡ºå±‚çº§ä¸è®¡ç®—åˆ†æ¶¦
3. åŠ å…¥å¹³å°æ— éœ€ç¼´çº³ä»»ä½•è´¹ç”¨
4. æ‰€æœ‰åˆ†æ¶¦æ”¶å…¥éœ€ä¾æ³•çº³ç¨
5. è®¢å•é€€æ¬¾æ—¶ï¼Œç›¸å…³åˆ†æ¶¦å°†è¢«æ‰£å›
6. å¹³å°ä¿ç•™å¯¹å¼‚å¸¸è¡Œä¸ºè¿›è¡Œè°ƒæŸ¥å’Œå¤„ç†çš„æƒåˆ©
7. è¿åå¹³å°è§„åˆ™å¯èƒ½å¯¼è‡´åˆ†æ¶¦å†»ç»“æˆ–è´¦å·å°ç¦
```

---

## åã€åˆ†é”€é“¾è·¯æ–­è£‚å¤„ç†

### 10.1 æ–­è£‚åœºæ™¯

| åœºæ™¯ | è§¦å‘æ¡ä»¶ | å½±å“ |
|------|---------|------|
| ä¸Šçº§è¢«å°ç¦ | è¿è§„è¢« suspended | ä¸‹çº§åˆ†æ¶¦é“¾è·¯ä¸­æ–­ |
| ä¸Šçº§ä¸»åŠ¨é€€å‡º | æ³¨é”€è´¦å·æˆ–è½¬ä¸º inactive | åŒä¸Š |
| ä¸Šçº§é™çº§ | L2é™ä¸ºL3ï¼Œå¤±å»å›¢é˜Ÿåˆ†æ¶¦èµ„æ ¼ | åˆ†æ¶¦æ¯”ä¾‹å˜åŒ– |
| åŸå¸‚åˆä¼™äººç¦»èŒ | L1ç¦»å¼€å¹³å° | æ•´ä¸ªåŒºåŸŸéœ€é‡æ–°åˆ†é… |

### 10.2 æ•°æ®æ¨¡å‹æ‰©å±•

```prisma
model Escort {
  // ... ç°æœ‰å­—æ®µ ...
  
  // ä¸Šçº§å…³ç³»è¿½è¸ªï¼ˆç”¨äºå¤„ç†é“¾è·¯æ–­è£‚ï¼‰
  originalParentId    String?   @map("original_parent_id")   // åŸå§‹ä¸Šçº§ï¼ˆè®°å½•å†å²ï¼‰
  parentChangedAt     DateTime? @map("parent_changed_at")    // ä¸Šçº§å˜æ›´æ—¶é—´
  parentChangeReason  String?   @map("parent_change_reason") // å˜æ›´åŸå› 
  
  // åˆ†æ¶¦é“¾è·¯çŠ¶æ€
  distributionActive  Boolean   @default(true) @map("distribution_active") // åˆ†æ¶¦æ˜¯å¦æ¿€æ´»
}

// ä¸Šçº§å˜æ›´å†å²è®°å½•
model ParentChangeLog {
  id              String   @id @default(uuid())
  escortId        String   @map("escort_id")
  
  // å˜æ›´å‰
  oldParentId     String?  @map("old_parent_id")
  oldAncestorPath String?  @map("old_ancestor_path")
  
  // å˜æ›´å
  newParentId     String?  @map("new_parent_id")
  newAncestorPath String?  @map("new_ancestor_path")
  
  // å˜æ›´ä¿¡æ¯
  reason          String                              // å˜æ›´åŸå› 
  operatorType    String   @map("operator_type")      // system, admin
  operatorId      String?  @map("operator_id")
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([escortId])
  @@map("parent_change_logs")
}
```

### 10.3 é“¾è·¯æ–­è£‚å¤„ç†é€»è¾‘

```typescript
// ä¸Šçº§è¢«å°ç¦æ—¶çš„å¤„ç†
async function handleParentSuspended(suspendedEscortId: string): Promise<void> {
  const suspendedEscort = await prisma.escort.findUnique({
    where: { id: suspendedEscortId }
  });
  
  // æŸ¥æ‰¾æ‰€æœ‰ç›´æ¥ä¸‹çº§
  const directChildren = await prisma.escort.findMany({
    where: { parentId: suspendedEscortId }
  });
  
  if (directChildren.length === 0) return;
  
  // è·å–è¢«å°ç¦è€…çš„ä¸Šçº§ï¼ˆå¦‚æœæœ‰ï¼‰
  const grandParentId = suspendedEscort?.parentId;
  
  await prisma.$transaction(async (tx) => {
    for (const child of directChildren) {
      // è®°å½•å˜æ›´æ—¥å¿—
      await tx.parentChangeLog.create({
        data: {
          escortId: child.id,
          oldParentId: suspendedEscortId,
          oldAncestorPath: child.ancestorPath,
          newParentId: grandParentId,
          newAncestorPath: grandParentId 
            ? await buildAncestorPath(tx, grandParentId)
            : null,
          reason: `ä¸Šçº§ ${suspendedEscortId} è¢«å°ç¦`,
          operatorType: 'system',
        }
      });
      
      // æ›´æ–°ä¸‹çº§çš„ä¸Šçº§æŒ‡å‘ï¼ˆè·³è¿‡è¢«å°ç¦è€…ï¼ŒæŒ‡å‘ç¥–çˆ¶çº§ï¼‰
      await tx.escort.update({
        where: { id: child.id },
        data: {
          originalParentId: child.parentId, // ä¿ç•™åŸå§‹è®°å½•
          parentId: grandParentId,
          ancestorPath: grandParentId 
            ? JSON.stringify(await buildAncestorPathArray(tx, grandParentId))
            : null,
          parentChangedAt: new Date(),
          parentChangeReason: 'ä¸Šçº§è´¦å·è¢«å°ç¦ï¼Œè‡ªåŠ¨é‡æ–°åˆ†é…',
        }
      });
    }
    
    // æ›´æ–°è¢«å°ç¦è€…çš„å›¢é˜Ÿç»Ÿè®¡ï¼ˆæ¸…é›¶ï¼‰
    await tx.escort.update({
      where: { id: suspendedEscortId },
      data: {
        teamSize: 0,
        totalTeamSize: 0,
        distributionActive: false,
      }
    });
    
    // æ›´æ–°ç¥–çˆ¶çº§çš„å›¢é˜Ÿç»Ÿè®¡
    if (grandParentId) {
      await updateTeamStats(tx, grandParentId);
    }
  });
  
  // é€šçŸ¥å—å½±å“çš„ä¸‹çº§
  for (const child of directChildren) {
    await notificationService.send({
      event: 'parent_changed',
      recipientId: child.id,
      recipientType: 'escort',
      data: {
        reason: 'æ‚¨çš„ä¸Šçº§è´¦å·å·²è¢«å¹³å°å¤„ç†ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨ä¸ºæ‚¨é‡æ–°åˆ†é…ä¸Šçº§å…³ç³»',
        newParentId: grandParentId,
      }
    });
  }
}

// æ„å»ºç¥–å…ˆè·¯å¾„æ•°ç»„
async function buildAncestorPathArray(tx: any, escortId: string): Promise<string[]> {
  const escort = await tx.escort.findUnique({ where: { id: escortId } });
  
  if (!escort) return [];
  
  const parentPath = escort.ancestorPath 
    ? JSON.parse(escort.ancestorPath) 
    : [];
  
  return [...parentPath, escortId].slice(-3); // ä¿ç•™æœ€è¿‘3å±‚
}

// åŸå¸‚åˆä¼™äººç¦»èŒå¤„ç†
async function handleL1Leave(l1EscortId: string): Promise<void> {
  // è·å–è¯¥åˆä¼™äººä¸‹çš„æ‰€æœ‰å›¢é˜Ÿé•¿
  const teamLeaders = await prisma.escort.findMany({
    where: {
      parentId: l1EscortId,
      distributionLevel: 2,
    }
  });
  
  // æ–¹æ¡ˆ1ï¼šå¹³å°ç›´ç®¡ï¼ˆå›¢é˜Ÿé•¿ç›´æ¥å‘å¹³å°æ±‡æŠ¥ï¼‰
  // æ–¹æ¡ˆ2ï¼šé‡æ–°åˆ†é…ç»™å…¶ä»–åŸå¸‚åˆä¼™äºº
  
  await prisma.$transaction(async (tx) => {
    for (const leader of teamLeaders) {
      await tx.parentChangeLog.create({
        data: {
          escortId: leader.id,
          oldParentId: l1EscortId,
          oldAncestorPath: leader.ancestorPath,
          newParentId: null,  // æš‚æ—¶æ— ä¸Šçº§
          newAncestorPath: null,
          reason: `åŸå¸‚åˆä¼™äºº ${l1EscortId} ç¦»èŒ`,
          operatorType: 'admin',
        }
      });
      
      await tx.escort.update({
        where: { id: leader.id },
        data: {
          originalParentId: leader.parentId,
          parentId: null,
          ancestorPath: null,
          parentChangedAt: new Date(),
          parentChangeReason: 'åŸå¸‚åˆä¼™äººç¦»èŒï¼Œç­‰å¾…é‡æ–°åˆ†é…',
        }
      });
    }
    
    // æ ‡è®°åŸ L1 åˆ†é”€ä¸æ´»è·ƒ
    await tx.escort.update({
      where: { id: l1EscortId },
      data: { distributionActive: false }
    });
  });
  
  // åˆ›å»ºç®¡ç†å‘˜å¾…åŠï¼šé‡æ–°åˆ†é…å›¢é˜Ÿé•¿
  await createAdminTask({
    type: 'reassign_team_leaders',
    data: {
      originalL1Id: l1EscortId,
      teamLeaderIds: teamLeaders.map(l => l.id),
    },
    priority: 'high',
  });
}
```

### 10.4 åˆ†æ¶¦è®¡ç®—æ—¶çš„é“¾è·¯æ£€æŸ¥

```typescript
// ä¿®æ”¹åˆ†æ¶¦è®¡ç®—ï¼Œå¢åŠ é“¾è·¯æœ‰æ•ˆæ€§æ£€æŸ¥
async function calculateDistributionWithValidation(
  orderId: string,
  escortId: string,
  orderAmount: number
): Promise<DistributionResult> {
  const config = await prisma.distributionConfig.findFirst({
    where: { status: 'active' }
  });
  
  const escort = await prisma.escort.findUnique({
    where: { id: escortId }
  });
  
  const records: DistributionResult['records'] = [];
  let totalDistribution = 0;
  
  const ancestors = escort.ancestorPath 
    ? JSON.parse(escort.ancestorPath) as string[]
    : [];
  
  for (let i = 0; i < Math.min(ancestors.length, 3); i++) {
    const ancestorId = ancestors[ancestors.length - 1 - i];
    const ancestor = await prisma.escort.findUnique({
      where: { id: ancestorId }
    });
    
    // æ£€æŸ¥ä¸Šçº§æ˜¯å¦æœ‰æ•ˆ
    if (!ancestor) continue;
    if (ancestor.status !== 'active') continue;
    if (!ancestor.distributionActive) continue;  // åˆ†é”€å·²ç¦ç”¨
    
    // ... å…¶ä½™åˆ†æ¶¦è®¡ç®—é€»è¾‘
  }
  
  return { records, totalDistribution };
}
```

---

## åä¸€ã€å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| v1.0 | 2024-12-11 | åˆå§‹ç‰ˆæœ¬ | - |
| v1.1 | 2024-12-11 | æ–°å¢æ³•å¾‹åˆè§„è¯´æ˜ã€åˆ†é”€é“¾è·¯æ–­è£‚å¤„ç†æœºåˆ¶ | - |
