# 消息通知系统规划文档

> 返回 [陪诊员中心总览](./README.md)  
> 状态：✅ 已规划  
> 版本：v1.0  
> 创建日期：2024-12-11

---

## 一、概述

### 1.1 系统定位

消息通知系统是连接用户、陪诊员、平台的信息枢纽，确保关键业务节点的信息及时触达。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          消息通知系统架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  业务事件源                                                                  │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐          │
│  │订单服务 │  │陪诊员   │  │分销系统 │  │结算系统 │  │系统运维 │          │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘          │
│       │            │            │            │            │                 │
│       └────────────┴────────────┴────────────┴────────────┘                 │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       消息中心 (MessageCenter)                       │   │
│  │                                                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │   │
│  │  │ 事件接收    │  │ 模板渲染    │  │ 路由分发    │                 │   │
│  │  │             │  │             │  │             │                 │   │
│  │  │ · 事件校验  │  │ · 变量替换  │  │ · 渠道选择  │                 │   │
│  │  │ · 去重过滤  │  │ · 格式化    │  │ · 频控检查  │                 │   │
│  │  │ · 队列处理  │  │ · 多语言    │  │ · 优先级    │                 │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                    ┌───────────────┼───────────────┐                       │
│                    │               │               │                        │
│                    ▼               ▼               ▼                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│  │   站内消息      │  │  微信订阅消息   │  │     短信        │            │
│  │                 │  │                 │  │                 │            │
│  │ · 消息列表     │  │ · 模板消息     │  │ · 验证码       │            │
│  │ · 已读未读     │  │ · 小程序跳转   │  │ · 紧急通知     │            │
│  │ · 消息中心     │  │ · 触达统计     │  │ · 营销（谨慎） │            │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 设计原则

| 原则 | 说明 |
|------|------|
| **及时性** | 关键业务节点消息实时触达 |
| **准确性** | 消息内容准确，避免误导 |
| **不打扰** | 合理频控，避免消息轰炸 |
| **可追溯** | 完整的发送记录和送达状态 |
| **可配置** | 模板可管理，渠道可配置 |

---

## 二、通知类型定义

### 2.1 通知事件枚举

```typescript
// 订单相关事件
enum OrderNotificationEvent {
  // 用户端
  ORDER_CREATED = 'order_created',           // 订单创建
  ORDER_PAID = 'order_paid',                 // 支付成功
  ORDER_ASSIGNED = 'order_assigned',         // 已派单（告知用户陪诊员信息）
  ORDER_ESCORT_ARRIVED = 'order_escort_arrived', // 陪诊员已到达
  ORDER_SERVICE_STARTED = 'order_service_started', // 服务开始
  ORDER_COMPLETED = 'order_completed',       // 服务完成
  ORDER_CANCELLED = 'order_cancelled',       // 订单取消
  ORDER_REFUND_SUCCESS = 'order_refund_success', // 退款成功
  
  // 陪诊员端
  NEW_ORDER_AVAILABLE = 'new_order_available', // 新订单可抢
  ORDER_GRABBED_SUCCESS = 'order_grabbed_success', // 抢单成功
  ORDER_GRABBED_FAIL = 'order_grabbed_fail',   // 抢单失败
  ORDER_MANUAL_ASSIGNED = 'order_manual_assigned', // 管理员派单
  ORDER_USER_CANCELLED = 'order_user_cancelled', // 用户取消订单
  ORDER_REMINDER = 'order_reminder',         // 服务提醒（提前30分钟）
}

// 陪诊员账号相关事件
enum EscortNotificationEvent {
  ESCORT_REVIEW_APPROVED = 'escort_review_approved', // 审核通过
  ESCORT_REVIEW_REJECTED = 'escort_review_rejected', // 审核拒绝
  ESCORT_LEVEL_UPGRADED = 'escort_level_upgraded',   // 等级提升
  ESCORT_LEVEL_DOWNGRADED = 'escort_level_downgraded', // 等级降级
  ESCORT_SUSPENDED = 'escort_suspended',     // 账号封禁
  ESCORT_REACTIVATED = 'escort_reactivated', // 账号恢复
  ESCORT_CERT_EXPIRING = 'escort_cert_expiring', // 证书即将过期
  ESCORT_NEW_REVIEW = 'escort_new_review',   // 收到新评价
}

// 结算相关事件
enum SettlementNotificationEvent {
  INCOME_SETTLED = 'income_settled',         // 收入入账
  WITHDRAWAL_SUBMITTED = 'withdrawal_submitted', // 提现申请提交
  WITHDRAWAL_APPROVED = 'withdrawal_approved', // 提现审核通过
  WITHDRAWAL_REJECTED = 'withdrawal_rejected', // 提现审核拒绝
  WITHDRAWAL_COMPLETED = 'withdrawal_completed', // 提现到账
  DISTRIBUTION_INCOME = 'distribution_income', // 分销分润入账
}

// 分销相关事件
enum DistributionNotificationEvent {
  NEW_TEAM_MEMBER = 'new_team_member',       // 新成员加入团队
  MEMBER_FIRST_ORDER = 'member_first_order', // 团队成员首单完成
  PROMOTION_ELIGIBLE = 'promotion_eligible', // 满足晋升条件
  PROMOTION_SUCCESS = 'promotion_success',   // 晋升成功
  DIRECT_INVITE_BONUS = 'direct_invite_bonus', // 直推奖励发放
}

// 系统相关事件
enum SystemNotificationEvent {
  SYSTEM_ANNOUNCEMENT = 'system_announcement', // 系统公告
  MAINTENANCE_NOTICE = 'maintenance_notice', // 维护通知
  POLICY_UPDATE = 'policy_update',           // 政策更新
  FEATURE_UPDATE = 'feature_update',         // 功能更新
}
```

### 2.2 通知渠道

| 渠道 | 适用场景 | 优先级 | 限制 |
|------|---------|--------|------|
| **站内消息** | 所有通知 | 低 | 需用户打开 App |
| **微信订阅消息** | 订单状态、收入入账 | 中 | 需用户订阅 |
| **短信** | 验证码、紧急通知 | 高 | 成本高，慎用 |
| **WebSocket** | 实时推送（抢单） | 高 | 需在线 |

### 2.3 通知优先级

```typescript
enum NotificationPriority {
  LOW = 0,      // 运营活动、功能更新
  NORMAL = 1,   // 普通业务通知
  HIGH = 2,     // 订单状态变更
  URGENT = 3,   // 紧急通知（账号异常等）
}
```

---

## 三、数据模型

### 3.1 消息模板

```prisma
model MessageTemplate {
  id              String   @id @default(uuid())
  
  // 基本信息
  code            String   @unique                  // 模板代码：order_paid
  name            String                            // 模板名称：支付成功通知
  category        String                            // 类别：order, escort, settlement, distribution, system
  description     String?                           // 模板说明
  
  // 模板内容
  title           String                            // 消息标题
  content         String   @db.Text                 // 消息内容模板
  variables       Json                              // 变量定义：[{name: "orderNo", type: "string", required: true}]
  
  // 渠道配置
  channels        Json                              // 启用渠道：["in_app", "wechat", "sms"]
  wechatTemplateId String? @map("wechat_template_id") // 微信模板 ID
  smsTemplateCode String?  @map("sms_template_code")  // 短信模板 Code
  
  // 接收对象
  recipientType   String   @map("recipient_type")   // user, escort, admin
  
  // 跳转配置
  actionType      String?  @map("action_type")      // page, url, none
  actionTarget    String?  @map("action_target")    // 跳转目标
  
  // 状态
  status          String   @default("active")       // active, disabled
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("message_templates")
}
```

### 3.2 站内消息

```prisma
model Message {
  id              String    @id @default(uuid())
  
  // 接收者
  userId          String    @map("user_id")
  userType        String    @map("user_type")       // user, escort
  
  // 消息内容
  templateCode    String    @map("template_code")
  title           String
  content         String    @db.Text
  category        String                            // 消息类别
  
  // 关联数据
  relatedType     String?   @map("related_type")    // order, escort, withdrawal
  relatedId       String?   @map("related_id")
  
  // 跳转
  actionType      String?   @map("action_type")
  actionTarget    String?   @map("action_target")
  
  // 状态
  isRead          Boolean   @default(false) @map("is_read")
  readAt          DateTime? @map("read_at")
  
  // 元数据
  extra           Json?                             // 额外数据
  
  createdAt       DateTime  @default(now()) @map("created_at")
  
  @@index([userId, userType])
  @@index([isRead])
  @@index([category])
  @@map("messages")
}
```

### 3.3 通知发送记录

```prisma
model NotificationLog {
  id              String    @id @default(uuid())
  
  // 通知信息
  templateCode    String    @map("template_code")
  channel         String                            // in_app, wechat, sms
  
  // 接收者
  recipientId     String    @map("recipient_id")
  recipientType   String    @map("recipient_type")  // user, escort
  recipientPhone  String?   @map("recipient_phone")
  recipientOpenId String?   @map("recipient_open_id")
  
  // 内容快照
  title           String?
  content         String?   @db.Text
  
  // 发送状态
  status          String    @default("pending")
  // pending: 待发送
  // sent: 已发送
  // delivered: 已送达
  // failed: 发送失败
  // read: 已读（站内消息）
  
  // 发送结果
  sentAt          DateTime? @map("sent_at")
  deliveredAt     DateTime? @map("delivered_at")
  errorCode       String?   @map("error_code")
  errorMessage    String?   @map("error_message")
  
  // 第三方响应
  thirdPartyId    String?   @map("third_party_id")  // 微信/短信平台返回的 ID
  thirdPartyResponse Json?  @map("third_party_response")
  
  createdAt       DateTime  @default(now()) @map("created_at")
  
  @@index([recipientId, recipientType])
  @@index([templateCode])
  @@index([status])
  @@index([createdAt])
  @@map("notification_logs")
}
```

### 3.4 用户通知配置

```prisma
model UserNotificationSetting {
  id              String   @id @default(uuid())
  
  userId          String   @unique @map("user_id")
  userType        String   @map("user_type")        // user, escort
  
  // 渠道开关
  inAppEnabled    Boolean  @default(true) @map("in_app_enabled")
  wechatEnabled   Boolean  @default(true) @map("wechat_enabled")
  smsEnabled      Boolean  @default(false) @map("sms_enabled")
  
  // 分类开关
  orderEnabled    Boolean  @default(true) @map("order_enabled")
  incomeEnabled   Boolean  @default(true) @map("income_enabled")
  promotionEnabled Boolean @default(true) @map("promotion_enabled")
  systemEnabled   Boolean  @default(true) @map("system_enabled")
  
  // 免打扰时段
  dndEnabled      Boolean  @default(false) @map("dnd_enabled")
  dndStartTime    String?  @map("dnd_start_time")   // "22:00"
  dndEndTime      String?  @map("dnd_end_time")     // "08:00"
  
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("user_notification_settings")
}
```

### 3.5 频控规则

```prisma
model NotificationRateLimit {
  id              String   @id @default(uuid())
  
  templateCode    String   @map("template_code")
  
  // 频控规则
  maxPerHour      Int?     @map("max_per_hour")     // 每小时最大发送次数
  maxPerDay       Int?     @map("max_per_day")      // 每天最大发送次数
  minInterval     Int?     @map("min_interval")     // 最小间隔（秒）
  
  // 聚合规则
  aggregateWindow Int?     @map("aggregate_window") // 聚合窗口（秒）
  aggregateMax    Int?     @map("aggregate_max")    // 聚合条数
  
  status          String   @default("active")
  
  @@unique([templateCode])
  @@map("notification_rate_limits")
}
```

---

## 四、业务逻辑

### 4.1 消息发送服务

```typescript
// notification.service.ts

interface SendNotificationParams {
  event: string;                    // 事件类型
  recipientId: string;              // 接收者 ID
  recipientType: 'user' | 'escort'; // 接收者类型
  data: Record<string, any>;        // 模板变量数据
  channels?: string[];              // 指定渠道（可选）
  priority?: NotificationPriority;  // 优先级
}

@Injectable()
export class NotificationService {
  
  async send(params: SendNotificationParams): Promise<void> {
    const { event, recipientId, recipientType, data, channels, priority } = params;
    
    // 1. 获取模板
    const template = await this.getTemplate(event);
    if (!template || template.status !== 'active') {
      this.logger.warn(`Template not found or disabled: ${event}`);
      return;
    }
    
    // 2. 检查用户通知配置
    const userSettings = await this.getUserSettings(recipientId, recipientType);
    if (!this.shouldSend(template, userSettings)) {
      this.logger.debug(`Notification blocked by user settings: ${event}`);
      return;
    }
    
    // 3. 检查频控
    const rateLimitPassed = await this.checkRateLimit(template.code, recipientId);
    if (!rateLimitPassed) {
      this.logger.debug(`Notification blocked by rate limit: ${event}`);
      return;
    }
    
    // 4. 渲染消息内容
    const { title, content } = this.renderTemplate(template, data);
    
    // 5. 确定发送渠道
    const targetChannels = channels || this.determineChannels(template, userSettings, priority);
    
    // 6. 分渠道发送
    for (const channel of targetChannels) {
      await this.sendToChannel(channel, {
        template,
        recipientId,
        recipientType,
        title,
        content,
        data,
      });
    }
  }
  
  private renderTemplate(template: MessageTemplate, data: Record<string, any>): { title: string; content: string } {
    let title = template.title;
    let content = template.content;
    
    // 变量替换
    for (const [key, value] of Object.entries(data)) {
      const placeholder = `{{${key}}}`;
      title = title.replace(new RegExp(placeholder, 'g'), String(value));
      content = content.replace(new RegExp(placeholder, 'g'), String(value));
    }
    
    return { title, content };
  }
  
  private async sendToChannel(channel: string, params: ChannelSendParams): Promise<void> {
    switch (channel) {
      case 'in_app':
        await this.sendInAppMessage(params);
        break;
      case 'wechat':
        await this.sendWechatMessage(params);
        break;
      case 'sms':
        await this.sendSmsMessage(params);
        break;
      case 'websocket':
        await this.sendWebSocketMessage(params);
        break;
    }
  }
  
  // 站内消息
  private async sendInAppMessage(params: ChannelSendParams): Promise<void> {
    const { template, recipientId, recipientType, title, content, data } = params;
    
    await this.prisma.message.create({
      data: {
        userId: recipientId,
        userType: recipientType,
        templateCode: template.code,
        title,
        content,
        category: template.category,
        relatedType: data.relatedType,
        relatedId: data.relatedId,
        actionType: template.actionType,
        actionTarget: this.renderActionTarget(template.actionTarget, data),
        extra: data,
      }
    });
    
    await this.logNotification(template.code, 'in_app', recipientId, recipientType, 'sent');
  }
  
  // 微信订阅消息
  private async sendWechatMessage(params: ChannelSendParams): Promise<void> {
    const { template, recipientId, recipientType, data } = params;
    
    // 获取用户 openId
    const user = recipientType === 'user' 
      ? await this.prisma.user.findUnique({ where: { id: recipientId } })
      : await this.prisma.escort.findUnique({ 
          where: { id: recipientId },
          include: { user: true }
        }).then(e => e?.user);
    
    if (!user?.openId) {
      this.logger.warn(`User has no openId: ${recipientId}`);
      return;
    }
    
    try {
      const result = await this.wechatService.sendSubscribeMessage({
        touser: user.openId,
        template_id: template.wechatTemplateId,
        page: this.renderActionTarget(template.actionTarget, data),
        data: this.formatWechatData(template, data),
      });
      
      await this.logNotification(
        template.code, 
        'wechat', 
        recipientId, 
        recipientType, 
        result.errcode === 0 ? 'sent' : 'failed',
        result
      );
    } catch (error) {
      await this.logNotification(
        template.code, 
        'wechat', 
        recipientId, 
        recipientType, 
        'failed',
        { error: error.message }
      );
    }
  }
  
  // 短信通知
  private async sendSmsMessage(params: ChannelSendParams): Promise<void> {
    const { template, recipientId, recipientType, data } = params;
    
    // 获取手机号
    const phone = recipientType === 'user'
      ? (await this.prisma.user.findUnique({ where: { id: recipientId } }))?.phone
      : (await this.prisma.escort.findUnique({ where: { id: recipientId } }))?.phone;
    
    if (!phone) {
      this.logger.warn(`Recipient has no phone: ${recipientId}`);
      return;
    }
    
    try {
      const result = await this.smsService.send({
        phone,
        templateCode: template.smsTemplateCode,
        params: data,
      });
      
      await this.logNotification(
        template.code, 
        'sms', 
        recipientId, 
        recipientType, 
        result.success ? 'sent' : 'failed',
        result
      );
    } catch (error) {
      await this.logNotification(
        template.code, 
        'sms', 
        recipientId, 
        recipientType, 
        'failed',
        { error: error.message }
      );
    }
  }
  
  // WebSocket 实时推送
  private async sendWebSocketMessage(params: ChannelSendParams): Promise<void> {
    const { recipientId, recipientType, title, content, data } = params;
    
    await this.wsGateway.sendToUser(recipientId, recipientType, {
      type: 'notification',
      title,
      content,
      data,
      timestamp: new Date().toISOString(),
    });
  }
}
```

### 4.2 频控检查

```typescript
async checkRateLimit(templateCode: string, recipientId: string): Promise<boolean> {
  const rule = await this.prisma.notificationRateLimit.findUnique({
    where: { templateCode }
  });
  
  if (!rule) return true;
  
  const cacheKey = `notification:rate:${templateCode}:${recipientId}`;
  
  // 检查最小间隔
  if (rule.minInterval) {
    const lastSent = await this.redis.get(`${cacheKey}:last`);
    if (lastSent) {
      const elapsed = Date.now() - parseInt(lastSent);
      if (elapsed < rule.minInterval * 1000) {
        return false;
      }
    }
  }
  
  // 检查每小时限制
  if (rule.maxPerHour) {
    const hourCount = await this.redis.get(`${cacheKey}:hour`);
    if (hourCount && parseInt(hourCount) >= rule.maxPerHour) {
      return false;
    }
  }
  
  // 检查每天限制
  if (rule.maxPerDay) {
    const dayCount = await this.redis.get(`${cacheKey}:day`);
    if (dayCount && parseInt(dayCount) >= rule.maxPerDay) {
      return false;
    }
  }
  
  // 更新计数
  await this.redis.set(`${cacheKey}:last`, Date.now().toString(), 'EX', 86400);
  await this.redis.incr(`${cacheKey}:hour`);
  await this.redis.expire(`${cacheKey}:hour`, 3600);
  await this.redis.incr(`${cacheKey}:day`);
  await this.redis.expire(`${cacheKey}:day`, 86400);
  
  return true;
}
```

### 4.3 业务事件触发点

```typescript
// 订单相关触发点

// 订单支付成功
async function onOrderPaid(order: Order): Promise<void> {
  // 通知用户
  await notificationService.send({
    event: OrderNotificationEvent.ORDER_PAID,
    recipientId: order.userId,
    recipientType: 'user',
    data: {
      orderNo: order.orderNo,
      serviceName: order.service.name,
      amount: order.paidAmount,
      relatedType: 'order',
      relatedId: order.id,
    },
    priority: NotificationPriority.HIGH,
  });
  
  // 通知可接单的陪诊员（WebSocket）
  const availableEscorts = await getAvailableEscortsForOrder(order);
  for (const escort of availableEscorts) {
    await notificationService.send({
      event: OrderNotificationEvent.NEW_ORDER_AVAILABLE,
      recipientId: escort.id,
      recipientType: 'escort',
      data: {
        orderId: order.id,
        serviceName: order.service.name,
        hospitalName: order.hospital?.name,
        appointmentDate: order.appointmentDate,
        appointmentTime: order.appointmentTime,
        estimatedIncome: calculateEstimatedIncome(order, escort),
      },
      channels: ['websocket', 'wechat'],
      priority: NotificationPriority.HIGH,
    });
  }
}

// 抢单成功
async function onOrderGrabbed(order: Order, escort: Escort): Promise<void> {
  // 通知陪诊员
  await notificationService.send({
    event: OrderNotificationEvent.ORDER_GRABBED_SUCCESS,
    recipientId: escort.id,
    recipientType: 'escort',
    data: {
      orderNo: order.orderNo,
      serviceName: order.service.name,
      hospitalName: order.hospital?.name,
      appointmentDate: order.appointmentDate,
      appointmentTime: order.appointmentTime,
      patientName: order.patient?.name,
      relatedType: 'order',
      relatedId: order.id,
    },
    priority: NotificationPriority.HIGH,
  });
  
  // 通知用户
  await notificationService.send({
    event: OrderNotificationEvent.ORDER_ASSIGNED,
    recipientId: order.userId,
    recipientType: 'user',
    data: {
      orderNo: order.orderNo,
      escortName: escort.name,
      escortPhone: maskPhone(escort.phone),
      escortLevel: escort.level,
      relatedType: 'order',
      relatedId: order.id,
    },
    priority: NotificationPriority.HIGH,
  });
}

// 服务完成
async function onOrderCompleted(order: Order): Promise<void> {
  // 通知用户评价
  await notificationService.send({
    event: OrderNotificationEvent.ORDER_COMPLETED,
    recipientId: order.userId,
    recipientType: 'user',
    data: {
      orderNo: order.orderNo,
      serviceName: order.service.name,
      escortName: order.escort?.name,
      relatedType: 'order',
      relatedId: order.id,
    },
    priority: NotificationPriority.NORMAL,
  });
  
  // 通知陪诊员收入入账
  await notificationService.send({
    event: SettlementNotificationEvent.INCOME_SETTLED,
    recipientId: order.escortId,
    recipientType: 'escort',
    data: {
      orderNo: order.orderNo,
      amount: order.commissionAmount,
      relatedType: 'order',
      relatedId: order.id,
    },
    priority: NotificationPriority.NORMAL,
  });
}
```

---

## 五、消息模板示例

### 5.1 订单类模板

```json
{
  "code": "order_paid",
  "name": "支付成功通知",
  "category": "order",
  "title": "订单支付成功",
  "content": "您的订单 {{orderNo}} 已支付成功，金额 ¥{{amount}}。{{serviceName}}服务已开始匹配陪诊员，请耐心等待。",
  "variables": [
    {"name": "orderNo", "type": "string", "required": true},
    {"name": "amount", "type": "number", "required": true},
    {"name": "serviceName", "type": "string", "required": true}
  ],
  "channels": ["in_app", "wechat"],
  "recipientType": "user",
  "actionType": "page",
  "actionTarget": "/pages/orders/detail?id={{orderId}}"
}
```

```json
{
  "code": "order_assigned",
  "name": "陪诊员已接单",
  "category": "order",
  "title": "陪诊员已接单",
  "content": "您的订单已有陪诊员接单！{{escortName}}（{{escortLevel}}）将为您服务，如有疑问可通过订单详情联系陪诊员。",
  "variables": [
    {"name": "orderNo", "type": "string", "required": true},
    {"name": "escortName", "type": "string", "required": true},
    {"name": "escortLevel", "type": "string", "required": true}
  ],
  "channels": ["in_app", "wechat"],
  "recipientType": "user",
  "actionType": "page",
  "actionTarget": "/pages/orders/detail?id={{orderId}}"
}
```

### 5.2 陪诊员类模板

```json
{
  "code": "new_order_available",
  "name": "新订单可抢",
  "category": "order",
  "title": "有新订单可抢",
  "content": "{{hospitalName}} · {{serviceName}}，预约时间 {{appointmentDate}} {{appointmentTime}}，预计收入 ¥{{estimatedIncome}}，快去抢单！",
  "variables": [
    {"name": "hospitalName", "type": "string", "required": true},
    {"name": "serviceName", "type": "string", "required": true},
    {"name": "appointmentDate", "type": "string", "required": true},
    {"name": "appointmentTime", "type": "string", "required": true},
    {"name": "estimatedIncome", "type": "number", "required": true}
  ],
  "channels": ["websocket", "wechat"],
  "recipientType": "escort",
  "actionType": "page",
  "actionTarget": "/pages/workbench/orders/pool"
}
```

### 5.3 结算类模板

```json
{
  "code": "income_settled",
  "name": "收入入账通知",
  "category": "settlement",
  "title": "收入已入账",
  "content": "订单 {{orderNo}} 服务费 ¥{{amount}} 已入账，当前可提现余额 ¥{{balance}}。",
  "variables": [
    {"name": "orderNo", "type": "string", "required": true},
    {"name": "amount", "type": "number", "required": true},
    {"name": "balance", "type": "number", "required": true}
  ],
  "channels": ["in_app", "wechat"],
  "recipientType": "escort",
  "actionType": "page",
  "actionTarget": "/pages/workbench/earnings"
}
```

---

## 六、API 设计

### 6.1 用户端 API

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/messages` | 获取消息列表 |
| GET | `/messages/:id` | 获取消息详情 |
| PUT | `/messages/:id/read` | 标记已读 |
| PUT | `/messages/read-all` | 全部已读 |
| GET | `/messages/unread-count` | 获取未读数量 |
| DELETE | `/messages/:id` | 删除消息 |
| GET | `/notification/settings` | 获取通知设置 |
| PUT | `/notification/settings` | 更新通知设置 |

### 6.2 管理端 API

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/admin/message-templates` | 获取模板列表 |
| POST | `/admin/message-templates` | 创建模板 |
| PUT | `/admin/message-templates/:id` | 更新模板 |
| DELETE | `/admin/message-templates/:id` | 删除模板 |
| POST | `/admin/notifications/send` | 手动发送通知 |
| GET | `/admin/notification-logs` | 获取发送记录 |

---

## 七、验收标准

### 基础功能
- [ ] 站内消息发送和展示正常
- [ ] 消息已读/未读状态正确
- [ ] 未读消息数量实时更新

### 微信通知
- [ ] 微信订阅消息正常发送
- [ ] 点击消息可跳转小程序对应页面

### 模板管理
- [ ] 可创建/编辑消息模板
- [ ] 模板变量正确渲染

### 频控功能
- [ ] 频控规则生效
- [ ] 不会重复发送

### 用户配置
- [ ] 用户可配置通知开关
- [ ] 免打扰时段生效

---

## 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2024-12-11 | 初始版本 | - |
