# 性能测试脚本

## 一、使用 k6 进行压力测试

### 1.1 安装 k6

```bash
# macOS
brew install k6

# Linux
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6

# Windows
# 下载安装包：https://github.com/grafana/k6/releases
```

### 1.2 测试脚本

创建 `server/test/performance/k6-tests.js`:

```javascript
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '30s', target: 50 },   // 30秒内增加到50个用户
    { duration: '1m', target: 50 },     // 保持50个用户1分钟
    { duration: '30s', target: 100 },   // 30秒内增加到100个用户
    { duration: '1m', target: 100 },    // 保持100个用户1分钟
    { duration: '30s', target: 0 },     // 30秒内减少到0个用户
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],   // 95%的请求在500ms内完成
    http_req_failed: ['rate<0.01'],     // 错误率小于1%
  },
};

const BASE_URL = __ENV.BASE_URL || 'http://localhost:3000/api';

export default function () {
  // 测试医院关联陪诊员 API
  const hospitalId = 'test-hospital-id';
  const res = http.get(`${BASE_URL}/hospitals/${hospitalId}/escorts`, {
    headers: {
      'Authorization': `Bearer ${__ENV.TOKEN || 'test-token'}`,
    },
  });

  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
    'has data': (r) => {
      const body = JSON.parse(r.body);
      return body.data !== undefined;
    },
  });

  sleep(1);
}
```

### 1.3 运行测试

```bash
# 基础测试
k6 run server/test/performance/k6-tests.js

# 指定环境变量
BASE_URL=http://your-api.com/api TOKEN=your-token k6 run server/test/performance/k6-tests.js

# 生成HTML报告
k6 run --out json=results.json server/test/performance/k6-tests.js
k6 report results.json
```

---

## 二、使用 Apache Bench (ab) 进行简单压力测试

### 2.1 安装 ab

```bash
# macOS (已包含)
# Linux
sudo apt-get install apache2-utils

# Windows
# 下载 Apache HTTP Server
```

### 2.2 测试命令

```bash
# 测试医院关联陪诊员 API
ab -n 1000 -c 50 -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:3000/api/hospitals/test-id/escorts

# 参数说明：
# -n: 总请求数
# -c: 并发数
# -H: 请求头
```

---

## 三、使用 Postman Runner 进行API测试

### 3.1 创建测试集合

1. 在 Postman 中创建 Collection
2. 添加以下请求：
   - GET /hospitals/:id/escorts
   - POST /escort/settings/service
   - GET /membership/levels
   - GET /coupons/my

### 3.2 添加测试脚本

在每个请求的 Tests 标签中添加：

```javascript
// 检查响应时间
pm.test("Response time is less than 500ms", function () {
    pm.expect(pm.response.responseTime).to.be.below(500);
});

// 检查状态码
pm.test("Status code is 200", function () {
    pm.response.to.have.status(200);
});

// 检查响应格式
pm.test("Response has correct structure", function () {
    const jsonData = pm.response.json();
    pm.expect(jsonData).to.have.property('data');
});
```

### 3.3 运行测试

1. 点击 Collection 右侧的 "..." 菜单
2. 选择 "Run collection"
3. 设置迭代次数和延迟
4. 点击 "Run" 执行

---

## 四、数据库查询性能测试

### 4.1 使用 EXPLAIN ANALYZE

```sql
-- 测试医院关联陪诊员查询
EXPLAIN ANALYZE
SELECT e.*, l.code, l.name, l.badge
FROM escorts e
LEFT JOIN escort_levels l ON e.level_code = l.code
INNER JOIN escort_hospitals eh ON e.id = eh.escort_id
WHERE eh.hospital_id = 'test-id'
  AND e.status = 'active'
  AND e.deleted_at IS NULL
ORDER BY e.rating DESC
LIMIT 10;

-- 检查是否使用了索引
-- 应该看到 "Index Scan" 或 "Index Only Scan"
```

### 4.2 监控慢查询

```sql
-- PostgreSQL 启用慢查询日志
-- 在 postgresql.conf 中设置：
-- log_min_duration_statement = 500  -- 记录超过500ms的查询

-- 查看慢查询
SELECT query, calls, total_time, mean_time, max_time
FROM pg_stat_statements
WHERE mean_time > 100
ORDER BY mean_time DESC
LIMIT 20;
```

---

## 五、性能基准

### 5.1 API 响应时间目标

| API | 目标响应时间 | 最大响应时间 |
|-----|------------|------------|
| GET /hospitals/:id/escorts | < 300ms | < 500ms |
| POST /escort/settings/service | < 200ms | < 300ms |
| GET /membership/levels | < 200ms | < 300ms |
| GET /coupons/my | < 300ms | < 500ms |
| GET /points/my | < 200ms | < 300ms |

### 5.2 并发性能目标

- 支持 100 并发用户
- 错误率 < 1%
- 95% 的请求在目标响应时间内完成

---

## 六、持续监控

### 6.1 使用 PM2 监控

```bash
# 安装 PM2
npm install -g pm2

# 启动应用并监控
pm2 start dist/main.js --name api-server

# 查看监控
pm2 monit

# 查看性能指标
pm2 describe api-server
```

### 6.2 使用 New Relic 或 DataDog

- 配置 APM (Application Performance Monitoring)
- 设置告警规则
- 定期查看性能报告

---

## 七、优化建议

### 7.1 查询优化

1. **使用索引**：确保所有常用查询字段都有索引
2. **避免 N+1 查询**：使用 Prisma 的 `include` 或 `select`
3. **分页查询**：始终使用分页，避免一次性加载大量数据
4. **缓存热点数据**：使用 Redis 缓存频繁查询的数据

### 7.2 代码优化

1. **异步处理**：耗时操作使用队列异步处理
2. **批量操作**：合并多个数据库操作
3. **连接池**：合理配置数据库连接池大小

### 7.3 基础设施优化

1. **CDN**：静态资源使用 CDN
2. **负载均衡**：多实例部署
3. **数据库读写分离**：读写分离提升性能

---

> 定期执行性能测试，确保系统性能符合预期。
