# 测试执行指南

> 快速开始执行测试的步骤指南

---

## 一、准备工作

### 1.1 检查环境

```bash
# 检查 Node.js 版本
node -v  # 需要 >= 16.0.0

# 检查依赖是否安装
cd server
npm install
```

### 1.2 修复编译错误（如需要）

当前存在 `pricing.service.ts` 的类型错误，需要先修复：

```bash
# 检查编译错误
npm run build
```

---

## 二、执行单元测试

### 2.1 运行所有测试

```bash
cd server
npm test
```

### 2.2 运行特定测试

```bash
# 威尔逊评分算法测试
npm test -- test/escort/wilson-rating.test.ts

# 医院关联陪诊员API测试
npm test -- test/escort/hospital-escorts.test.ts

# 服务设置API测试
npm test -- test/escort/service-settings.test.ts

# 性能测试
npm test -- test/performance/api-performance.test.ts
```

### 2.3 生成覆盖率报告

```bash
npm test -- --coverage
```

---

## 三、应用数据库索引

### 3.1 备份数据库（重要！）

```bash
# 使用 pg_dump 备份
pg_dump -d your_database > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 3.2 执行索引脚本

```bash
cd server

# 方法1：使用 Prisma
npx prisma db execute --file prisma/migrations/add-escort-indexes.sql

# 方法2：使用 psql
psql -d your_database -f prisma/migrations/add-escort-indexes.sql
```

### 3.3 验证索引创建

```bash
# 查看索引
psql -d your_database -c "\d+ escorts"
psql -d your_database -c "\d+ escort_hospitals"
psql -d your_database -c "\d+ escort_reviews"

# 或使用 Prisma Studio
npx prisma studio
```

---

## 四、功能测试（手动）

### 4.1 启动开发环境

```bash
# 启动后端服务
cd server
npm run dev

# 启动小程序（另一个终端）
cd miniapp
npm run dev:weapp
```

### 4.2 测试营销中心页面

1. **会员中心** (`/pages/marketing/membership/index`)
   - [ ] 打开页面，检查会员等级列表
   - [ ] 点击"立即开通"，检查跳转
   - [ ] 选择套餐，检查订单创建

2. **优惠券** (`/pages/marketing/coupons/index`)
   - [ ] 打开页面，检查优惠券列表
   - [ ] 点击"兑换码"，输入兑换码测试
   - [ ] 切换标签页（未使用/已使用/已过期）

3. **积分** (`/pages/marketing/points/index`)
   - [ ] 打开页面，检查积分概览
   - [ ] 点击"立即签到"，测试签到功能
   - [ ] 点击"积分明细"，检查跳转

4. **邀请好友** (`/pages/marketing/referrals/index`)
   - [ ] 打开页面，检查邀请码显示
   - [ ] 点击邀请码，测试复制功能
   - [ ] 点击"分享邀请"，测试分享功能

5. **优惠活动** (`/pages/marketing/campaigns/index`)
   - [ ] 打开页面，检查活动列表
   - [ ] 点击活动，检查详情页
   - [ ] 测试秒杀功能（如有）

### 4.3 测试服务设置页面

1. **访问服务设置** (`/pages/workbench/settings/index`)
   - [ ] 从工作台进入服务设置
   - [ ] 检查当前设置显示

2. **配置服务时段**
   - [ ] 切换周几开关
   - [ ] 设置时间段
   - [ ] 添加多个时段
   - [ ] 删除时段

3. **配置服务半径**
   - [ ] 输入有效值（5-50）
   - [ ] 输入无效值，检查验证
   - [ ] 保存设置

4. **配置接单限制**
   - [ ] 输入有效值（1-20）
   - [ ] 输入无效值，检查验证
   - [ ] 保存设置

---

## 五、性能测试

### 5.1 安装 k6

```bash
# macOS
brew install k6

# Linux
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

### 5.2 创建测试脚本

参考：`docs/陪诊员中心/性能测试脚本.md`

### 5.3 运行性能测试

```bash
# 基础测试
k6 run test/performance/k6-tests.js

# 指定环境变量
BASE_URL=http://localhost:3000/api TOKEN=your-token k6 run test/performance/k6-tests.js
```

---

## 六、测试结果记录

### 6.1 记录测试结果

在 `docs/陪诊员中心/测试执行报告-2024-12-11.md` 中更新：

- 测试通过/失败情况
- 发现的问题
- 性能测试结果
- 优化建议

### 6.2 问题跟踪

| 问题 | 严重程度 | 状态 | 负责人 | 预计修复时间 |
|------|---------|------|--------|------------|
| pricing.service.ts 类型错误 | 中 | 待修复 | - | - |

---

## 七、快速检查清单

### ✅ 测试前检查

- [ ] Node.js 版本 >= 16.0.0
- [ ] 依赖已安装 (`npm install`)
- [ ] 数据库连接正常
- [ ] 编译无错误 (`npm run build`)

### ✅ 测试执行

- [ ] 单元测试通过
- [ ] 数据库索引已应用
- [ ] 功能测试完成
- [ ] 性能测试完成

### ✅ 测试后

- [ ] 测试结果已记录
- [ ] 问题已记录并跟踪
- [ ] 优化建议已提出

---

## 八、常见问题

### Q1: 测试找不到文件？

**A**: 检查 Jest 配置，确保 `testMatch` 包含 `**/test/**/*.test.ts`

### Q2: 数据库索引创建失败？

**A**: 
1. 检查数据库连接
2. 检查表名是否正确（注意大小写）
3. 检查是否有权限创建索引

### Q3: 性能测试结果不理想？

**A**:
1. 检查数据库索引是否已应用
2. 检查查询是否使用了索引（使用 EXPLAIN ANALYZE）
3. 考虑添加缓存

---

> **提示**：执行测试时，建议按照单元测试 → 数据库索引 → 功能测试 → 性能测试的顺序进行。
