# 收入与结算规划文档

> 返回 [陪诊员中心总览](./README.md)  
> 状态：✅ 已规划  
> 版本：v1.1  
> 更新日期：2024-12-11

---

## 一、核心概念

### 1.1 分成模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            分成计算模型                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   订单实付金额                                                               │
│   ┌──────────────────────────────────────────────────────────────────────┐ │
│   │ ¥299 （原价 ¥398 - 活动优惠 ¥50 - 会员折扣 ¥29 - 优惠券 ¥20）        │ │
│   └────────────────────────────────┬─────────────────────────────────────┘ │
│                                    │                                        │
│                                    ▼                                        │
│   ┌──────────────────────────────────────────────────────────────────────┐ │
│   │                      分成计算引擎                                     │ │
│   │                                                                      │ │
│   │  输入：订单金额、服务类型、陪诊员等级、特殊规则                        │ │
│   │  规则优先级：服务级设置 > 陪诊员等级 > 全局默认                        │ │
│   │                                                                      │ │
│   └────────────────────────────────┬─────────────────────────────────────┘ │
│                                    │                                        │
│                    ┌───────────────┴───────────────┐                       │
│                    │                               │                        │
│                    ▼                               ▼                        │
│   ┌────────────────────────────┐   ┌────────────────────────────┐         │
│   │     陪诊员分成 70%         │   │     平台收入 30%           │         │
│   │        ¥209.30            │   │        ¥89.70             │         │
│   └────────────────────────────┘   └────────────────────────────┘         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 分成规则优先级

```
1. 服务级设置 (Service.commissionRate)
   └── 特定服务可设置独立分成比例
   
2. 陪诊员等级 (EscortLevel.commissionRate)
   └── 资深 80%、中级 70%、初级 60%、实习 50%
   
3. 全局默认 (PricingConfig.defaultCommissionRate)
   └── 默认 70%
```

### 1.3 结算周期

| 类型 | 说明 | 适用场景 |
|------|------|---------|
| **实时结算** | 订单完成即入账（推荐） | 提升陪诊员积极性 |
| **T+1结算** | 次日统一结算 | 便于对账 |
| **周结** | 每周固定时间结算 | 大规模运营 |
| **月结** | 每月固定时间结算 | 企业合作 |

---

## 二、数据模型

### 2.1 陪诊员钱包

```prisma
model EscortWallet {
  id             String   @id @default(uuid())
  escortId       String   @unique @map("escort_id")
  
  // 余额
  balance        Decimal  @default(0) @db.Decimal(10, 2)   // 可用余额
  frozenBalance  Decimal  @default(0) @db.Decimal(10, 2) @map("frozen_balance")  // 冻结余额
  
  // 统计
  totalEarned    Decimal  @default(0) @db.Decimal(10, 2) @map("total_earned")    // 累计收入
  totalWithdrawn Decimal  @default(0) @db.Decimal(10, 2) @map("total_withdrawn") // 累计提现
  
  // 提现配置
  withdrawMethod String?  @map("withdraw_method")    // wechat, alipay, bank
  withdrawAccount String? @map("withdraw_account")   // 提现账号（加密存储）
  
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  escort         Escort   @relation(fields: [escortId], references: [id])
  transactions   WalletTransaction[]
  withdrawals    Withdrawal[]
  
  @@map("escort_wallets")
}
```

### 2.2 钱包流水

```prisma
model WalletTransaction {
  id          String   @id @default(uuid())
  walletId    String   @map("wallet_id")
  
  // 交易信息
  type        String                            // income: 收入, withdraw: 提现, refund: 退款扣除
  amount      Decimal  @db.Decimal(10, 2)       // 金额（正数为收入，负数为支出）
  balance     Decimal  @db.Decimal(10, 2)       // 交易后余额
  
  // 关联
  orderId     String?  @map("order_id")         // 关联订单
  withdrawalId String? @map("withdrawal_id")    // 关联提现记录
  
  // 详情
  title       String                            // 显示标题
  description String?                           // 描述
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  wallet      EscortWallet @relation(fields: [walletId], references: [id])
  
  @@index([walletId])
  @@index([orderId])
  @@map("wallet_transactions")
}
```

### 2.3 提现记录

```prisma
model Withdrawal {
  id            String    @id @default(uuid())
  walletId      String    @map("wallet_id")
  
  // 提现信息
  amount        Decimal   @db.Decimal(10, 2)     // 提现金额
  fee           Decimal   @default(0) @db.Decimal(10, 2)  // 手续费
  actualAmount  Decimal   @db.Decimal(10, 2) @map("actual_amount")  // 实际到账
  
  // 提现方式
  method        String                           // wechat, alipay, bank
  account       String                           // 提现账号（脱敏显示）
  
  // 状态
  status        String    @default("pending")
  // pending: 待审核
  // approved: 审核通过（处理中）
  // completed: 已完成
  // rejected: 已拒绝
  
  // 审核
  reviewedAt    DateTime? @map("reviewed_at")
  reviewedBy    String?   @map("reviewed_by")
  reviewNote    String?   @map("review_note")
  
  // 完成
  completedAt   DateTime? @map("completed_at")
  transactionNo String?   @map("transaction_no")  // 转账流水号
  
  // 拒绝
  rejectReason  String?   @map("reject_reason")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  
  wallet        EscortWallet @relation(fields: [walletId], references: [id])
  
  @@index([walletId])
  @@index([status])
  @@map("withdrawals")
}
```

### 2.4 分成规则配置

```prisma
model CommissionConfig {
  id                    String   @id @default(uuid())
  
  // 默认分成
  defaultRate           Int      @default(70) @map("default_rate")  // 默认分成比例
  
  // 提现配置
  minWithdrawAmount     Decimal  @default(100) @db.Decimal(10, 2) @map("min_withdraw_amount")
  withdrawFeeRate       Int      @default(0) @map("withdraw_fee_rate")  // 提现手续费率 (0-100)
  withdrawFeeFixed      Decimal  @default(0) @db.Decimal(10, 2) @map("withdraw_fee_fixed")  // 固定手续费
  
  // 结算配置
  settlementMode        String   @default("realtime") @map("settlement_mode")
  // realtime: 实时结算
  // daily: T+1
  // weekly: 周结
  // monthly: 月结
  
  // 提现周期限制
  withdrawDaysOfWeek    String?  @map("withdraw_days_of_week")  // JSON: [1,2,3,4,5] 周几可提现
  withdrawTimeRange     String?  @map("withdraw_time_range")    // JSON: {start: "09:00", end: "18:00"}
  
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  @@map("commission_config")
}
```

---

## 三、业务逻辑

### 3.1 分成计算

```typescript
interface CommissionResult {
  commissionRate: number;       // 分成比例
  commissionAmount: number;     // 陪诊员收入
  platformAmount: number;       // 平台收入
  ruleSource: string;           // 规则来源: service, level, default
}

async function calculateCommission(
  order: Order & { service: Service },
  escort: Escort
): Promise<CommissionResult> {
  // 1. 获取配置
  const config = await prisma.commissionConfig.findFirst();
  const level = await prisma.escortLevel.findFirst({
    where: { code: escort.level }
  });
  
  // 2. 确定分成比例（按优先级）
  let commissionRate: number;
  let ruleSource: string;
  
  if (order.service.commissionRate !== null) {
    // 服务级设置
    commissionRate = order.service.commissionRate;
    ruleSource = 'service';
  } else if (level?.commissionRate) {
    // 陪诊员等级
    commissionRate = level.commissionRate;
    ruleSource = 'level';
  } else {
    // 全局默认
    commissionRate = config?.defaultRate ?? 70;
    ruleSource = 'default';
  }
  
  // 3. 计算金额
  const paidAmount = Number(order.paidAmount);
  const commissionAmount = Math.round(paidAmount * commissionRate) / 100;
  const platformAmount = paidAmount - commissionAmount;
  
  return {
    commissionRate,
    commissionAmount: Math.round(commissionAmount * 100) / 100,
    platformAmount: Math.round(platformAmount * 100) / 100,
    ruleSource,
  };
}
```

### 3.2 收入入账

```typescript
async function settleOrderCommission(orderId: string): Promise<void> {
  await prisma.$transaction(async (tx) => {
    const order = await tx.order.findUnique({
      where: { id: orderId },
      include: { escort: true }
    });
    
    if (!order || order.status !== 'completed' || !order.escortId) {
      return;
    }
    
    // 检查是否已结算
    const existingTransaction = await tx.walletTransaction.findFirst({
      where: { orderId, type: 'income' }
    });
    if (existingTransaction) return;
    
    // 获取钱包
    const wallet = await tx.escortWallet.findUnique({
      where: { escortId: order.escortId }
    });
    
    const amount = Number(order.commissionAmount);
    const newBalance = Number(wallet.balance) + amount;
    
    // 更新钱包
    await tx.escortWallet.update({
      where: { id: wallet.id },
      data: {
        balance: newBalance,
        totalEarned: { increment: amount },
      }
    });
    
    // 创建流水
    await tx.walletTransaction.create({
      data: {
        walletId: wallet.id,
        type: 'income',
        amount,
        balance: newBalance,
        orderId,
        title: '订单收入',
        description: `订单 ${order.orderNo} 服务费分成`,
      }
    });
  });
}
```

### 3.3 申请提现

```typescript
async function requestWithdrawal(
  userId: string,
  amount: number,
  method: string
): Promise<Withdrawal> {
  const escort = await getEscortByUserId(userId);
  const wallet = await prisma.escortWallet.findUnique({
    where: { escortId: escort.id }
  });
  
  const config = await prisma.commissionConfig.findFirst();
  
  // 1. 校验金额
  if (amount < Number(config.minWithdrawAmount)) {
    throw new BadRequestException(`最低提现金额为 ¥${config.minWithdrawAmount}`);
  }
  
  if (amount > Number(wallet.balance)) {
    throw new BadRequestException('余额不足');
  }
  
  // 2. 校验提现时间
  const now = new Date();
  if (config.withdrawDaysOfWeek) {
    const allowedDays = JSON.parse(config.withdrawDaysOfWeek);
    if (!allowedDays.includes(now.getDay())) {
      throw new BadRequestException('当前不在提现时间范围内');
    }
  }
  
  // 3. 计算手续费
  let fee = 0;
  if (config.withdrawFeeRate > 0) {
    fee += amount * config.withdrawFeeRate / 100;
  }
  if (config.withdrawFeeFixed > 0) {
    fee += Number(config.withdrawFeeFixed);
  }
  fee = Math.round(fee * 100) / 100;
  
  const actualAmount = amount - fee;
  
  // 4. 创建提现记录
  return prisma.$transaction(async (tx) => {
    // 冻结余额
    await tx.escortWallet.update({
      where: { id: wallet.id },
      data: {
        balance: { decrement: amount },
        frozenBalance: { increment: amount },
      }
    });
    
    // 创建提现记录
    const withdrawal = await tx.withdrawal.create({
      data: {
        walletId: wallet.id,
        amount,
        fee,
        actualAmount,
        method,
        account: getDesensitizedAccount(wallet.withdrawAccount),
        status: 'pending',
      }
    });
    
    return withdrawal;
  });
}
```

### 3.4 提现审核

```typescript
async function reviewWithdrawal(
  id: string,
  action: 'approve' | 'reject',
  adminId: string,
  note?: string
): Promise<Withdrawal> {
  const withdrawal = await prisma.withdrawal.findUnique({
    where: { id },
    include: { wallet: true }
  });
  
  if (withdrawal.status !== 'pending') {
    throw new BadRequestException('提现状态不允许操作');
  }
  
  if (action === 'approve') {
    // 审核通过
    return prisma.$transaction(async (tx) => {
      // 更新提现状态
      const updated = await tx.withdrawal.update({
        where: { id },
        data: {
          status: 'approved',
          reviewedAt: new Date(),
          reviewedBy: adminId,
          reviewNote: note,
        }
      });
      
      // TODO: 调用支付接口进行转账
      // 转账成功后调用 completeWithdrawal
      
      return updated;
    });
  } else {
    // 审核拒绝
    return prisma.$transaction(async (tx) => {
      // 解冻余额
      await tx.escortWallet.update({
        where: { id: withdrawal.walletId },
        data: {
          balance: { increment: withdrawal.amount },
          frozenBalance: { decrement: withdrawal.amount },
        }
      });
      
      // 更新提现状态
      return tx.withdrawal.update({
        where: { id },
        data: {
          status: 'rejected',
          reviewedAt: new Date(),
          reviewedBy: adminId,
          rejectReason: note,
        }
      });
    });
  }
}

async function completeWithdrawal(
  id: string,
  transactionNo: string
): Promise<void> {
  await prisma.$transaction(async (tx) => {
    const withdrawal = await tx.withdrawal.findUnique({
      where: { id },
      include: { wallet: true }
    });
    
    // 解冻并扣除
    await tx.escortWallet.update({
      where: { id: withdrawal.walletId },
      data: {
        frozenBalance: { decrement: withdrawal.amount },
        totalWithdrawn: { increment: withdrawal.amount },
      }
    });
    
    // 更新提现状态
    await tx.withdrawal.update({
      where: { id },
      data: {
        status: 'completed',
        completedAt: new Date(),
        transactionNo,
      }
    });
    
    // 创建流水
    await tx.walletTransaction.create({
      data: {
        walletId: withdrawal.walletId,
        type: 'withdraw',
        amount: -withdrawal.amount,
        balance: Number(withdrawal.wallet.balance) - Number(withdrawal.amount),
        withdrawalId: id,
        title: '提现',
        description: `提现 ¥${withdrawal.actualAmount} 到 ${withdrawal.method}`,
      }
    });
  });
}
```

---

## 四、API 设计

### 4.1 陪诊员端 API

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/escort/wallet` | 获取钱包信息 |
| GET | `/escort/wallet/transactions` | 获取收支明细 |
| GET | `/escort/wallet/earnings` | 获取收入统计 |
| POST | `/escort/wallet/withdraw` | 申请提现 |
| GET | `/escort/wallet/withdrawals` | 获取提现记录 |
| PUT | `/escort/wallet/withdraw-account` | 设置提现账号 |

### 4.2 管理端 API

| 方法 | 端点 | 说明 |
|------|------|------|
| GET | `/admin/withdrawals` | 获取提现列表 |
| PUT | `/admin/withdrawals/:id/review` | 审核提现 |
| GET | `/admin/commission/config` | 获取分成配置 |
| PUT | `/admin/commission/config` | 更新分成配置 |
| GET | `/admin/settlements` | 获取结算报表 |

---

## 五、界面设计

### 5.1 收入明细页

```
┌─────────────────────────────────────────┐
│ ← 收入明细                              │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────────────────────────┐   │
│  │     可用余额                     │   │
│  │     ¥8,560.00                   │   │
│  │                                  │   │
│  │  [提现]                          │   │
│  └─────────────────────────────────┘   │
│                                         │
│  收入概览                               │
│  ┌───────────┐  ┌───────────┐         │
│  │ 本月收入   │  │ 累计收入   │         │
│  │ ¥3,280    │  │ ¥45,600   │         │
│  └───────────┘  └───────────┘         │
│                                         │
│  收支记录                    [全部▼]    │
│  ┌─────────────────────────────────┐   │
│  │ 订单收入                 +¥209.30│   │
│  │ 订单 202412200001              │   │
│  │ 2024-12-20 18:30               │   │
│  ├─────────────────────────────────┤   │
│  │ 提现                     -¥1000 │   │
│  │ 提现到微信                       │   │
│  │ 2024-12-19 10:00      已完成   │   │
│  ├─────────────────────────────────┤   │
│  │ 订单收入                 +¥139.30│   │
│  │ 订单 202412190003              │   │
│  │ 2024-12-19 16:00               │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

### 5.2 提现页

```
┌─────────────────────────────────────────┐
│ ← 提现                                  │
├─────────────────────────────────────────┤
│                                         │
│  可提现金额                              │
│  ┌─────────────────────────────────┐   │
│  │         ¥8,560.00               │   │
│  └─────────────────────────────────┘   │
│                                         │
│  提现金额                               │
│  ┌─────────────────────────────────┐   │
│  │  ¥  │ 1000                      │   │
│  └─────────────────────────────────┘   │
│  最低提现金额 ¥100                      │
│                                         │
│  提现到                                 │
│  ┌─────────────────────────────────┐   │
│  │ ● 微信零钱                       │   │
│  │ ○ 银行卡 尾号 1234              │   │
│  └─────────────────────────────────┘   │
│                                         │
│  手续费：¥0.00                          │
│  预计到账：¥1000.00                     │
│  预计到账时间：1-3个工作日              │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │          [确认提现]              │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘
```

---

## 六、验收标准

### 分成计算
- [ ] 订单完成后正确计算分成
- [ ] 服务级分成配置生效
- [ ] 陪诊员等级分成配置生效
- [ ] 分成金额记录到订单

### 收入入账
- [ ] 订单完成后收入实时入账
- [ ] 钱包余额正确更新
- [ ] 交易流水正确记录

### 提现功能
- [ ] 可申请提现
- [ ] 最低提现金额限制生效
- [ ] 余额不足时无法提现
- [ ] 提现后余额正确扣除

### 提现审核
- [ ] 管理员可审核提现
- [ ] 审核通过后进入处理流程
- [ ] 审核拒绝后余额恢复

### 数据展示
- [ ] 收入明细页数据正确
- [ ] 提现记录正确显示
- [ ] 统计数据准确
- [ ] 退款扣回逻辑正确
- [ ] 负债记录和抵扣正常

---

## 七、退款扣回机制

### 7.1 扣回场景

| 场景 | 说明 | 扣回方式 |
|------|------|---------|
| 订单完成后退款 | 用户投诉、服务问题导致退款 | 从余额扣回 |
| 分销分润退款 | 下级订单退款，上级分润需扣回 | 从余额扣回 |
| 余额不足 | 扣回时余额不足 | 记录负债，后续抵扣 |
| 已提现 | 分润已提现无法直接扣回 | 记录负债，后续抵扣 |

### 7.2 数据模型扩展

```prisma
// 负债记录
model WalletDebt {
  id              String    @id @default(uuid())
  walletId        String    @map("wallet_id")
  
  // 负债信息
  amount          Decimal   @db.Decimal(10, 2)           // 负债金额
  originalAmount  Decimal   @db.Decimal(10, 2) @map("original_amount") // 原始金额
  remainingAmount Decimal   @db.Decimal(10, 2) @map("remaining_amount") // 剩余待扣金额
  
  // 来源
  orderId         String    @map("order_id")             // 关联订单
  reason          String                                 // 扣回原因
  type            String                                 // commission: 分成扣回, distribution: 分销扣回
  
  // 状态
  status          String    @default("pending")
  // pending: 待扣回
  // partial: 部分扣回
  // completed: 已完成扣回
  // cancelled: 已取消
  
  // 扣回记录
  deductions      Json?                                  // [{amount, date, transactionId}]
  
  createdAt       DateTime  @default(now()) @map("created_at")
  completedAt     DateTime? @map("completed_at")
  
  wallet          EscortWallet @relation(fields: [walletId], references: [id])
  
  @@index([walletId])
  @@index([status])
  @@map("wallet_debts")
}
```

### 7.3 退款扣回逻辑

```typescript
interface ClawbackResult {
  success: boolean;
  clawedBackAmount: number;     // 实际扣回金额
  debtCreated: boolean;         // 是否创建负债
  debtAmount: number;           // 负债金额
}

async function handleOrderRefund(orderId: string): Promise<void> {
  const order = await prisma.order.findUnique({
    where: { id: orderId },
    include: { escort: true }
  });
  
  if (!order || !order.escortId) {
    return;
  }
  
  await prisma.$transaction(async (tx) => {
    // 1. 扣回陪诊员分成
    if (order.commissionAmount && Number(order.commissionAmount) > 0) {
      await clawbackCommission(tx, order);
    }
    
    // 2. 扣回分销分润
    await clawbackDistribution(tx, order);
    
    // 3. 更新订单状态
    await tx.order.update({
      where: { id: orderId },
      data: {
        status: 'refunded',
        refundedAt: new Date(),
      }
    });
  });
}

async function clawbackCommission(tx: any, order: Order): Promise<ClawbackResult> {
  const wallet = await tx.escortWallet.findUnique({
    where: { escortId: order.escortId }
  });
  
  const clawbackAmount = Number(order.commissionAmount);
  const currentBalance = Number(wallet.balance);
  
  if (currentBalance >= clawbackAmount) {
    // 余额充足，直接扣回
    await tx.escortWallet.update({
      where: { id: wallet.id },
      data: {
        balance: { decrement: clawbackAmount },
        totalEarned: { decrement: clawbackAmount },
      }
    });
    
    await tx.walletTransaction.create({
      data: {
        walletId: wallet.id,
        type: 'refund_clawback',
        amount: -clawbackAmount,
        balance: currentBalance - clawbackAmount,
        orderId: order.id,
        title: '退款扣回',
        description: `订单 ${order.orderNo} 退款，分成扣回`,
      }
    });
    
    return {
      success: true,
      clawedBackAmount: clawbackAmount,
      debtCreated: false,
      debtAmount: 0,
    };
  } else {
    // 余额不足，扣回部分 + 记录负债
    const actualClawback = currentBalance;
    const debtAmount = clawbackAmount - currentBalance;
    
    // 扣回余额部分
    if (actualClawback > 0) {
      await tx.escortWallet.update({
        where: { id: wallet.id },
        data: {
          balance: 0,
          totalEarned: { decrement: actualClawback },
        }
      });
      
      await tx.walletTransaction.create({
        data: {
          walletId: wallet.id,
          type: 'refund_clawback',
          amount: -actualClawback,
          balance: 0,
          orderId: order.id,
          title: '退款扣回（部分）',
          description: `订单 ${order.orderNo} 退款，余额不足，已扣回 ¥${actualClawback}`,
        }
      });
    }
    
    // 创建负债记录
    await tx.walletDebt.create({
      data: {
        walletId: wallet.id,
        amount: debtAmount,
        originalAmount: debtAmount,
        remainingAmount: debtAmount,
        orderId: order.id,
        reason: `订单 ${order.orderNo} 退款扣回`,
        type: 'commission',
        status: 'pending',
      }
    });
    
    // 通知陪诊员
    await notificationService.send({
      event: 'clawback_debt_created',
      recipientId: order.escortId!,
      recipientType: 'escort',
      data: {
        orderNo: order.orderNo,
        debtAmount,
        reason: '订单退款，余额不足以扣回全部分成',
      }
    });
    
    return {
      success: true,
      clawedBackAmount: actualClawback,
      debtCreated: true,
      debtAmount,
    };
  }
}

async function clawbackDistribution(tx: any, order: Order): Promise<void> {
  // 查找该订单的所有分销分润记录
  const distributionRecords = await tx.distributionRecord.findMany({
    where: {
      orderId: order.id,
      status: 'settled',
    }
  });
  
  for (const record of distributionRecords) {
    const wallet = await tx.escortWallet.findUnique({
      where: { escortId: record.beneficiaryId }
    });
    
    const clawbackAmount = Number(record.amount);
    const currentBalance = Number(wallet.balance);
    
    if (currentBalance >= clawbackAmount) {
      // 直接扣回
      await tx.escortWallet.update({
        where: { id: wallet.id },
        data: {
          balance: { decrement: clawbackAmount },
          totalEarned: { decrement: clawbackAmount },
        }
      });
      
      await tx.walletTransaction.create({
        data: {
          walletId: wallet.id,
          type: 'distribution_clawback',
          amount: -clawbackAmount,
          balance: currentBalance - clawbackAmount,
          orderId: order.id,
          title: '分润扣回',
          description: `下级订单 ${order.orderNo} 退款，分润扣回`,
        }
      });
    } else {
      // 记录负债
      const debtAmount = clawbackAmount - currentBalance;
      
      if (currentBalance > 0) {
        await tx.escortWallet.update({
          where: { id: wallet.id },
          data: { balance: 0 }
        });
      }
      
      await tx.walletDebt.create({
        data: {
          walletId: wallet.id,
          amount: debtAmount,
          originalAmount: debtAmount,
          remainingAmount: debtAmount,
          orderId: order.id,
          reason: `下级订单 ${order.orderNo} 退款，分润扣回`,
          type: 'distribution',
          status: 'pending',
        }
      });
    }
    
    // 更新分润记录状态
    await tx.distributionRecord.update({
      where: { id: record.id },
      data: { status: 'cancelled' }
    });
  }
}
```

### 7.4 负债自动抵扣

```typescript
// 在收入入账时自动抵扣负债
async function settleOrderCommissionWithDebt(orderId: string): Promise<void> {
  await prisma.$transaction(async (tx) => {
    const order = await tx.order.findUnique({
      where: { id: orderId },
      include: { escort: true }
    });
    
    if (!order || order.status !== 'completed' || !order.escortId) {
      return;
    }
    
    const wallet = await tx.escortWallet.findUnique({
      where: { escortId: order.escortId }
    });
    
    let incomeAmount = Number(order.commissionAmount);
    
    // 检查是否有待扣回的负债
    const pendingDebts = await tx.walletDebt.findMany({
      where: {
        walletId: wallet.id,
        status: { in: ['pending', 'partial'] },
      },
      orderBy: { createdAt: 'asc' }  // 先进先出
    });
    
    let totalDeducted = 0;
    const deductionLogs: Array<{ debtId: string; amount: number }> = [];
    
    for (const debt of pendingDebts) {
      if (incomeAmount <= 0) break;
      
      const remaining = Number(debt.remainingAmount);
      const deductAmount = Math.min(incomeAmount, remaining);
      
      // 更新负债记录
      const newRemaining = remaining - deductAmount;
      await tx.walletDebt.update({
        where: { id: debt.id },
        data: {
          remainingAmount: newRemaining,
          status: newRemaining === 0 ? 'completed' : 'partial',
          completedAt: newRemaining === 0 ? new Date() : undefined,
          deductions: [
            ...((debt.deductions as any[]) || []),
            {
              amount: deductAmount,
              date: new Date().toISOString(),
              orderId: order.id,
            }
          ],
        }
      });
      
      incomeAmount -= deductAmount;
      totalDeducted += deductAmount;
      deductionLogs.push({ debtId: debt.id, amount: deductAmount });
    }
    
    // 剩余金额入账
    if (incomeAmount > 0) {
      const newBalance = Number(wallet.balance) + incomeAmount;
      
      await tx.escortWallet.update({
        where: { id: wallet.id },
        data: {
          balance: newBalance,
          totalEarned: { increment: incomeAmount },
        }
      });
      
      await tx.walletTransaction.create({
        data: {
          walletId: wallet.id,
          type: 'income',
          amount: incomeAmount,
          balance: newBalance,
          orderId,
          title: totalDeducted > 0 ? '订单收入（扣除负债后）' : '订单收入',
          description: totalDeducted > 0 
            ? `订单 ${order.orderNo} 分成 ¥${order.commissionAmount}，扣除负债 ¥${totalDeducted}，实际入账 ¥${incomeAmount}`
            : `订单 ${order.orderNo} 服务费分成`,
        }
      });
    }
    
    // 记录抵扣流水
    if (totalDeducted > 0) {
      await tx.walletTransaction.create({
        data: {
          walletId: wallet.id,
          type: 'debt_deduction',
          amount: -totalDeducted,
          balance: Number(wallet.balance) + incomeAmount,
          orderId,
          title: '负债抵扣',
          description: `从订单 ${order.orderNo} 收入中抵扣历史负债`,
          extra: { deductions: deductionLogs },
        }
      });
      
      // 通知陪诊员
      if (incomeAmount < Number(order.commissionAmount)) {
        await notificationService.send({
          event: 'income_debt_deducted',
          recipientId: order.escortId!,
          recipientType: 'escort',
          data: {
            orderNo: order.orderNo,
            originalAmount: order.commissionAmount,
            deductedAmount: totalDeducted,
            actualAmount: incomeAmount,
          }
        });
      }
    }
  });
}
```

---

## 八、变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2024-12-11 | 初始版本 | - |
| v1.1 | 2024-12-11 | 新增退款扣回机制、负债记录、自动抵扣逻辑 | - |
