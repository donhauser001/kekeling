# 微信订阅消息配置指南

> 返回 [陪诊员中心总览](./README.md)  
> 状态：✅ 已实现  
> 版本：v1.0  
> 创建日期：2024-12-11

---

## 一、概述

微信订阅消息用于向用户和陪诊员发送重要通知，如订单分配、审核结果、等级升级等。本文档说明如何申请和配置微信订阅消息模板。

---

## 二、申请订阅消息模板

### 2.1 登录微信公众平台

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 使用小程序管理员账号登录
3. 进入小程序管理后台

### 2.2 申请订阅消息模板

1. 在左侧菜单找到 **功能** → **订阅消息**
2. 点击 **公共模板库** 或 **我的模板**
3. 选择合适的模板或创建自定义模板

### 2.3 需要的模板类型

系统需要以下类型的订阅消息模板：

| 模板代码 | 模板名称 | 用途 | 必需字段 |
|---------|---------|------|---------|
| `order_assigned` | 订单分配通知 | 订单被分配或抢单成功 | 订单号、陪诊员、时间 |
| `escort_review_approved` | 审核通过通知 | 陪诊员审核通过 | 审核结果、说明 |
| `escort_review_rejected` | 审核拒绝通知 | 陪诊员审核被拒 | 审核结果、拒绝原因 |
| `escort_level_upgraded` | 等级升级通知 | 陪诊员等级提升 | 等级名称 |
| `escort_cert_expiring` | 证书过期提醒 | 健康证即将过期 | 证书名称、剩余天数、过期日期 |

---

## 三、配置环境变量

### 3.1 获取模板ID

申请模板后，在模板详情页面可以找到 **模板ID**，格式类似：`xxxxxxxxxxxxxxxxxxxxxxxxxxxxx`

### 3.2 配置环境变量

在 `.env` 文件中添加以下配置：

```bash
# 微信订阅消息模板ID配置
WECHAT_TEMPLATE_ORDER_ASSIGNED=your-template-id-here
WECHAT_TEMPLATE_ESCORT_REVIEW_APPROVED=your-template-id-here
WECHAT_TEMPLATE_ESCORT_REVIEW_REJECTED=your-template-id-here
WECHAT_TEMPLATE_ESCORT_LEVEL_UPGRADED=your-template-id-here
WECHAT_TEMPLATE_ESCORT_CERT_EXPIRING=your-template-id-here
```

### 3.3 变量名规则

环境变量名格式：`WECHAT_TEMPLATE_{TEMPLATE_CODE}`

- 模板代码中的 `-` 会被替换为 `_`
- 全部转换为大写

例如：
- `order_assigned` → `WECHAT_TEMPLATE_ORDER_ASSIGNED`
- `escort_review_approved` → `WECHAT_TEMPLATE_ESCORT_REVIEW_APPROVED`

---

## 四、模板字段配置

### 4.1 订单分配通知 (order_assigned)

**模板字段示例**：
```
{{thing1.DATA}} - 订单号
{{name2.DATA}} - 陪诊员姓名
{{time3.DATA}} - 预约时间
```

**数据格式**：
```json
{
  "thing1": { "value": "订单号" },
  "name2": { "value": "陪诊员姓名" },
  "time3": { "value": "2024-12-11 09:00" }
}
```

### 4.2 审核通过通知 (escort_review_approved)

**模板字段示例**：
```
{{thing1.DATA}} - 审核结果
{{thing2.DATA}} - 审核说明
```

**数据格式**：
```json
{
  "thing1": { "value": "审核通过" },
  "thing2": { "value": "您的陪诊员申请已通过审核" }
}
```

### 4.3 审核拒绝通知 (escort_review_rejected)

**模板字段示例**：
```
{{thing1.DATA}} - 审核结果
{{thing2.DATA}} - 拒绝原因
```

**数据格式**：
```json
{
  "thing1": { "value": "审核未通过" },
  "thing2": { "value": "拒绝原因说明" }
}
```

### 4.4 等级升级通知 (escort_level_upgraded)

**模板字段示例**：
```
{{thing1.DATA}} - 升级提示
{{name2.DATA}} - 新等级名称
```

**数据格式**：
```json
{
  "thing1": { "value": "等级提升" },
  "name2": { "value": "中级陪诊员" }
}
```

### 4.5 证书过期提醒 (escort_cert_expiring)

**模板字段示例**：
```
{{thing1.DATA}} - 证书名称
{{number2.DATA}} - 剩余天数
{{date3.DATA}} - 过期日期
```

**数据格式**：
```json
{
  "thing1": { "value": "健康证" },
  "number2": { "value": "15" },
  "date3": { "value": "2024-12-26" }
}
```

---

## 五、测试验证

### 5.1 检查配置

1. 确认环境变量已正确配置
2. 重启后端服务使配置生效
3. 查看日志确认模板ID已加载

### 5.2 测试发送

1. 触发相应的业务操作（如审核通过、订单分配等）
2. 检查用户是否收到订阅消息
3. 查看后端日志确认发送状态

### 5.3 常见问题

**问题1：未收到订阅消息**
- 检查用户是否已授权订阅消息
- 检查模板ID是否正确配置
- 查看后端日志确认是否有错误

**问题2：模板ID未找到**
- 确认环境变量名格式正确
- 确认环境变量已加载（重启服务）
- 查看日志中的警告信息

**问题3：字段不匹配**
- 确认模板字段类型与代码中的字段类型一致
- 检查字段名称是否正确

---

## 六、注意事项

1. **用户授权**：用户需要主动授权才能接收订阅消息
2. **发送频率**：避免频繁发送，遵守微信平台规则
3. **模板审核**：自定义模板需要审核通过后才能使用
4. **字段限制**：字段内容长度有限制，注意截断处理
5. **测试环境**：在测试环境先验证模板配置

---

## 七、相关文档

- [微信订阅消息官方文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)
- [陪诊员中心代码审计报告](./代码审计报告-2024-12-11.md)
- [消息通知系统文档](./09-消息通知系统.md)

---

**最后更新**：2024-12-11
