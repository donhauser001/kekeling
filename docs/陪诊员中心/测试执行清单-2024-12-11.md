# 陪诊员中心测试执行清单

> 制定日期：2024-12-11  
> 测试范围：已完成功能（营销中心、威尔逊评分、医院API、服务设置）

---

## 一、功能测试清单

### 1.1 营销中心页面测试

#### ✅ 会员中心页面 (`/pages/marketing/membership/index`)
- [ ] **页面加载**
  - [ ] 页面正常加载，无报错
  - [ ] 会员等级列表正确显示
  - [ ] 当前会员状态正确显示（如有）
  - [ ] 会员权益说明正确展示

- [ ] **会员购买流程**
  - [ ] 点击"立即开通"跳转到套餐选择页
  - [ ] 套餐选择页显示所有可用套餐
  - [ ] 选择套餐后创建订单
  - [ ] 支付流程正常
  - [ ] 购买成功后会员状态更新

- [ ] **会员权益展示**
  - [ ] 折扣信息正确显示
  - [ ] 超时减免信息正确显示
  - [ ] 其他权益列表正确展示

#### ✅ 优惠券页面 (`/pages/marketing/coupons/index`)
- [ ] **页面加载**
  - [ ] 页面正常加载
  - [ ] 标签页切换正常（未使用/已使用/已过期）
  - [ ] 优惠券列表正确显示

- [ ] **优惠券功能**
  - [ ] 点击"领取优惠券"跳转到领取页
  - [ ] 点击"兑换码"弹出输入框
  - [ ] 输入有效兑换码成功兑换
  - [ ] 输入无效兑换码提示错误
  - [ ] 优惠券详情正确显示（金额、有效期、使用条件）

#### ✅ 积分页面 (`/pages/marketing/points/index`)
- [ ] **页面加载**
  - [ ] 积分概览正确显示（总积分、可用积分、已用积分、已过期积分）
  - [ ] 每日签到功能正常
  - [ ] 积分明细入口正常跳转

- [ ] **积分明细页面** (`/pages/marketing/points/records`)
  - [ ] 积分记录列表正确显示
  - [ ] 记录类型正确标识（获得/使用/过期/退回）
  - [ ] 时间排序正确
  - [ ] 分页加载正常

#### ✅ 邀请好友页面 (`/pages/marketing/referrals/index`)
- [ ] **页面加载**
  - [ ] 邀请码正确显示
  - [ ] 邀请统计正确显示（总邀请数、已注册、已奖励）
  - [ ] 邀请记录列表正确显示

- [ ] **邀请功能**
  - [ ] 点击邀请码可复制
  - [ ] 点击"分享邀请"弹出分享选项
  - [ ] 分享功能正常（微信分享/复制链接）

#### ✅ 优惠活动页面 (`/pages/marketing/campaigns/index`)
- [ ] **页面加载**
  - [ ] 活动列表正确显示
  - [ ] 活动类型正确标识
  - [ ] 活动倒计时正确显示
  - [ ] 空状态正确显示

- [ ] **活动详情** (`/pages/marketing/campaigns/detail`)
  - [ ] 活动详情正确显示
  - [ ] 秒杀商品列表正确显示（如适用）
  - [ ] 秒杀抢购功能正常
  - [ ] 活动规则正确展示

---

### 1.2 威尔逊评分算法测试

#### ✅ 评分计算逻辑
- [ ] **新陪诊员评分**
  - [ ] 无评价时默认评分为 5.0
  - [ ] 1-5条评价时评分向4.8倾斜
  - [ ] 评价数越多，实际评分权重越高

- [ ] **评分准确性**
  - [ ] 5星和4星视为好评
  - [ ] 威尔逊得分计算正确
  - [ ] 评分映射到5分制正确（3.0-5.0）
  - [ ] 平滑处理正确（20条评价后完全使用实际分数）

- [ ] **边界情况**
  - [ ] 全部5星评价 → 评分接近5.0
  - [ ] 全部1星评价 → 评分接近3.0
  - [ ] 混合评价 → 评分合理
  - [ ] 评价数从0到1的变化
  - [ ] 评价数从19到20的变化（平滑因子变化）

#### ✅ 评分更新流程
- [ ] **评价提交**
  - [ ] 提交评价后评分立即更新
  - [ ] 评分保留2位小数
  - [ ] 评价数正确递增

- [ ] **数据一致性**
  - [ ] 评分与评价记录一致
  - [ ] 评分更新使用事务保证一致性

---

### 1.3 医院关联陪诊员 API 测试

#### ✅ API 端点 (`GET /hospitals/:id/escorts`)
- [ ] **基础功能**
  - [ ] API 正常响应
  - [ ] 返回指定医院关联的活跃陪诊员
  - [ ] 返回数据格式正确

- [ ] **查询参数**
  - [ ] `levelCode` 筛选正常（按等级筛选）
  - [ ] `sortBy` 排序正常（rating/orderCount/experience）
  - [ ] `page` 和 `pageSize` 分页正常

- [ ] **返回数据**
  - [ ] 陪诊员基本信息完整（id、name、avatar、level）
  - [ ] 评分信息正确（rating、ratingCount）
  - [ ] 熟悉科室信息正确（familiarDepts）
  - [ ] 是否主医院标识正确（isPrimary）

- [ ] **边界情况**
  - [ ] 医院不存在 → 返回空列表或404
  - [ ] 医院无关联陪诊员 → 返回空列表
  - [ ] 无效的查询参数 → 使用默认值

---

### 1.4 服务设置页面测试

#### ✅ 页面功能 (`/pages/workbench/settings/index`)
- [ ] **页面加载**
  - [ ] 页面正常加载
  - [ ] 当前设置正确显示（服务时段、半径、接单限制）
  - [ ] 数据格式正确解析（JSON格式的serviceHours）

- [ ] **服务时段配置**
  - [ ] 周几开关正常切换
  - [ ] 时间段选择器正常（开始时间、结束时间）
  - [ ] 添加多个时段正常
  - [ ] 删除时段正常
  - [ ] 保存后数据格式正确

- [ ] **服务半径配置**
  - [ ] 输入框正常
  - [ ] 范围验证正确（5-50km）
  - [ ] 超出范围提示错误
  - [ ] 保存后生效

- [ ] **接单数量限制配置**
  - [ ] 输入框正常
  - [ ] 范围验证正确（1-20单）
  - [ ] 超出范围提示错误
  - [ ] 保存后生效

- [ ] **保存功能**
  - [ ] 点击保存按钮正常提交
  - [ ] 保存成功提示
  - [ ] 保存失败提示错误信息
  - [ ] 保存后返回工作台

#### ✅ 后端 API (`POST /escort/settings/service`)
- [ ] **请求处理**
  - [ ] 需要登录认证
  - [ ] 参数验证正确
  - [ ] 数据保存成功

- [ ] **数据验证**
  - [ ] serviceRadius 范围验证（5-50）
  - [ ] maxDailyOrders 范围验证（1-20）
  - [ ] serviceHours JSON格式验证

- [ ] **数据持久化**
  - [ ] 数据正确保存到数据库
  - [ ] 更新后立即生效

---

## 二、集成测试清单

### 2.1 数据流测试
- [ ] **营销中心数据流**
  - [ ] 会员购买 → 会员状态更新 → 价格折扣生效
  - [ ] 优惠券领取 → 优惠券列表更新 → 下单可用
  - [ ] 积分获得 → 积分明细记录 → 积分余额更新
  - [ ] 邀请注册 → 邀请记录更新 → 奖励发放

- [ ] **评分数据流**
  - [ ] 订单完成 → 评价提交 → 评分更新 → 陪诊员列表显示新评分

- [ ] **服务设置数据流**
  - [ ] 设置保存 → 数据库更新 → 派单时生效 → 订单分配正确

---

## 三、性能测试清单

### 3.1 API 响应时间
- [ ] **营销中心 API**
  - [ ] `GET /membership/levels` < 300ms
  - [ ] `GET /membership/my` < 200ms
  - [ ] `GET /coupons/my` < 300ms
  - [ ] `GET /points/my` < 200ms
  - [ ] `GET /referrals/stats` < 200ms
  - [ ] `GET /campaigns/active` < 300ms

- [ ] **医院 API**
  - [ ] `GET /hospitals/:id/escorts` < 500ms（含关联查询）

- [ ] **服务设置 API**
  - [ ] `POST /escort/settings/service` < 300ms

- [ ] **评分更新**
  - [ ] 评价提交后评分更新 < 500ms

### 3.2 数据库查询性能
- [ ] **索引验证**
  - [ ] 医院关联陪诊员查询使用索引
  - [ ] 评分查询使用索引
  - [ ] 会员查询使用索引

- [ ] **查询优化**
  - [ ] 避免N+1查询问题
  - [ ] 使用适当的关联查询
  - [ ] 分页查询性能良好

---

## 四、数据库索引优化清单

### 4.1 现有索引检查
- [ ] **Escort 表索引**
  - [ ] `status` 字段索引（用于筛选活跃陪诊员）
  - [ ] `rating` 字段索引（用于排序）
  - [ ] `cityCode` 字段索引（用于地区筛选）
  - [ ] `levelCode` 字段索引（用于等级筛选）

- [ ] **EscortHospital 表索引**
  - [ ] `hospitalId` 字段索引（用于医院关联查询）
  - [ ] `escortId` 字段索引（用于陪诊员关联查询）
  - [ ] 复合索引 `(hospitalId, escortId)`

- [ ] **EscortReview 表索引**
  - [ ] `escortId` 字段索引（用于评分计算）
  - [ ] `rating` 字段索引（用于统计）
  - [ ] `createdAt` 字段索引（用于时间排序）

- [ ] **UserMembership 表索引**
  - [ ] `userId` 字段索引
  - [ ] `status` 字段索引
  - [ ] `expireAt` 字段索引（用于过期检查）
  - [ ] 复合索引 `(userId, status)`

### 4.2 新增索引建议
- [ ] **服务设置相关**
  - [ ] `Escort.serviceRadius` 索引（如需要范围查询）
  - [ ] `Escort.maxDailyOrders` 索引（如需要筛选）

---

## 五、边界情况测试清单

### 5.1 数据边界
- [ ] **评分边界**
  - [ ] 0条评价
  - [ ] 1条评价
  - [ ] 20条评价（平滑因子变化点）
  - [ ] 100+条评价
  - [ ] 全部5星
  - [ ] 全部1星
  - [ ] 极端混合（1个5星+99个1星）

- [ ] **服务设置边界**
  - [ ] serviceRadius = 5（最小值）
  - [ ] serviceRadius = 50（最大值）
  - [ ] serviceRadius = 4（小于最小值）
  - [ ] serviceRadius = 51（大于最大值）
  - [ ] maxDailyOrders = 1（最小值）
  - [ ] maxDailyOrders = 20（最大值）
  - [ ] serviceHours 为空对象
  - [ ] serviceHours 格式错误

### 5.2 并发测试
- [ ] **评分更新并发**
  - [ ] 同时提交多条评价
  - [ ] 评分计算结果一致

- [ ] **服务设置并发**
  - [ ] 同时修改服务设置
  - [ ] 最后一次修改生效

---

## 六、安全测试清单

### 6.1 权限验证
- [ ] **API 权限**
  - [ ] 未登录用户无法访问陪诊员API
  - [ ] 非陪诊员用户无法访问服务设置API
  - [ ] 用户只能修改自己的服务设置

### 6.2 数据验证
- [ ] **输入验证**
  - [ ] 服务半径范围验证
  - [ ] 接单数量范围验证
  - [ ] JSON格式验证
  - [ ] SQL注入防护

---

## 七、测试执行记录

### 7.1 测试环境
- 测试日期：___________
- 测试人员：___________
- 测试环境：开发/测试/生产
- 数据库版本：___________
- Node.js 版本：___________

### 7.2 测试结果
- 通过：___ / ___
- 失败：___ / ___
- 阻塞：___ / ___

### 7.3 问题记录
| 序号 | 问题描述 | 严重程度 | 状态 | 备注 |
|------|---------|---------|------|------|
| 1 | | | | |
| 2 | | | | |

---

## 八、测试工具

### 8.1 单元测试
- Jest
- Supertest（API测试）

### 8.2 性能测试
- Apache Bench (ab)
- k6
- Postman Runner

### 8.3 数据库测试
- Prisma Studio（数据验证）
- EXPLAIN ANALYZE（查询计划分析）

---

> 本测试清单将根据实际测试情况持续更新。
