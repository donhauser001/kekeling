# 陪诊员中心架构规划

> 文档版本：v1.1  
> 创建日期：2024-12-11  
> 更新日期：2024-12-11  
> 状态：规划中

---

## 一、概述

陪诊员中心是连接平台运营、服务交付、收入结算的核心系统。陪诊员作为服务提供者，是平台价值创造的关键角色。

### 1.1 架构分层

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            陪诊员中心架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  展示层（多端入口）                                                          │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐           │
│  │   用户端入口     │   │  陪诊员端入口   │   │   管理后台入口   │           │
│  │ · 陪诊员列表    │   │ · 工作台首页    │   │ · 陪诊员管理    │           │
│  │ · 陪诊员详情    │   │ · 抢单大厅      │   │ · 订单派单      │           │
│  │ · 选择陪诊员    │   │ · 订单服务      │   │ · 数据统计      │           │
│  │ · 评价陪诊员    │   │ · 收入管理      │   │ · 结算管理      │           │
│  └────────┬────────┘   └────────┬────────┘   └────────┬────────┘           │
│           │                     │                     │                     │
│  ─────────┴─────────────────────┴─────────────────────┴──────────────────── │
│                                                                             │
│  业务层（核心功能）                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │ 账号管理    │  │ 订单服务    │  │ 收入结算    │  │ 评价体系    │       │
│  │ · 身份绑定  │  │ · 抢单机制  │  │ · 分成计算  │  │ · 用户评价  │       │
│  │ · 资质审核  │  │ · 派单算法  │  │ · 收入明细  │  │ · 评分排名  │       │
│  │ · 等级管理  │  │ · 服务流程  │  │ · 提现管理  │  │ · 标签体系  │       │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘       │
│         │                │                │                │               │
│  ───────┴────────────────┴────────────────┴────────────────┴────────────── │
│                                                                             │
│  引擎层（统一计算）                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      分成计算引擎 (CommissionEngine)                  │   │
│  │  输入：订单金额、服务类型、陪诊员等级、特殊规则                         │   │
│  │  输出：陪诊员分成、平台收入、奖励金额                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  数据层（存储管理）                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │  Escort     │  │EscortHospital│ │ EscortWallet │ │EscortReview │       │
│  │  陪诊员表   │  │ 医院关联表  │  │  钱包表      │  │  评价表     │       │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 陪诊员来源画像

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          陪诊员发展阶段                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  第一阶段（核心种子）：医药代表群体                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 优势：熟悉医院环境、有医护关系网络、具备销售能力、社交资源丰富           │   │
│  │ 背景：医药改革后需要副业收入，时间相对灵活（拜访空隙可接单）            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  第二阶段：医疗周边从业者                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 护工、护理员、医院志愿者、退休医护人员、健康管理师、医学院学生          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  第三阶段：泛服务人员                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 家政服务人员、网约车司机（医院周边）、有服务意识的自由职业者            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 核心设计原则

| 原则 | 说明 |
|------|------|
| **身份统一** | 陪诊员与普通用户共用账号体系，通过手机号自动绑定 |
| **状态分离** | 审核状态（status）与工作状态（workStatus）独立管理 |
| **分成透明** | 分成规则可配置，订单记录完整分成快照 |
| **流程闭环** | 从接单到完成的完整服务流程状态管理 |
| **体验一致** | 用户端和陪诊员端共用同一小程序，按身份切换入口 |
| **分销合规** | 三层分销架构，避免传销风险，基于实际服务分润 |

---

## 二、模块文档索引

| 模块 | 文档 | 优先级 | 状态 |
|------|------|--------|------|
| 陪诊员管理 | [01-陪诊员管理.md](./01-陪诊员管理.md) | P0 | ✅ 已规划 |
| 账号与身份 | [02-账号与身份.md](./02-账号与身份.md) | P0 | ✅ 已规划 |
| 工作台系统 | [03-工作台系统.md](./03-工作台系统.md) | P0 | ✅ 已规划 |
| 订单服务流程 | [04-订单服务流程.md](./04-订单服务流程.md) | P0 | ✅ 已规划 |
| 收入与结算 | [05-收入与结算.md](./05-收入与结算.md) | P1 | ✅ 已规划 |
| 用户端入口 | [06-用户端入口.md](./06-用户端入口.md) | P1 | ✅ 已规划 |
| 分销与裂变 | [07-分销与裂变.md](./07-分销与裂变.md) | P1 | ✅ 已规划 |
| UI设计规范 | [08-UI设计与交互规范.md](./08-UI设计与交互规范.md) | P0 | ✅ 已规划 |
| 消息通知系统 | [09-消息通知系统.md](./09-消息通知系统.md) | P1 | ✅ 已规划 |
| 数据埋点与分析 | [10-数据埋点与分析.md](./10-数据埋点与分析.md) | P2 | ✅ 已规划 |

---

## 三、后台管理导航

```
陪诊员中心
├── 陪诊员管理
│   ├── 陪诊员列表      /escorts
│   ├── 资质审核        /escorts?status=pending
│   ├── 等级管理        /escort-levels
│   └── 标签管理        /escort-tags
│
├── 订单管理
│   ├── 订单列表        /orders
│   ├── 待派单          /orders?status=paid
│   └── 服务中          /orders?status=in_progress
│
├── 结算管理
│   ├── 分成规则        /commission-rules
│   ├── 结算记录        /settlements
│   └── 提现审核        /withdrawals
│
├── 分销管理
│   ├── 城市合伙人      /partners
│   ├── 团队长管理      /team-leaders
│   ├── 邀请关系        /invitations
│   ├── 分润配置        /distribution-config
│   ├── 分润记录        /distribution-records
│   └── 晋升审核        /promotion-applications
│
└── 数据统计
    ├── 陪诊员排行      /escort-rankings
    ├── 团队业绩        /team-performance
    └── 服务报表        /service-reports
```

---

## 四、终端入口分布

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          终端入口分布                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户端入口                                                                  │
│  ├── 首页                                                                   │
│  │   ├── 快捷入口（金刚区）→「陪诊员」图标                                   │
│  │   └── 推荐陪诊员卡片区                                                   │
│  │                                                                          │
│  ├── 服务详情页                                                             │
│  │   └── 陪诊员选择（系统分配/指定陪诊员）                                   │
│  │                                                                          │
│  ├── 医院详情页                                                             │
│  │   └──「熟悉本院的陪诊员」区块                                            │
│  │                                                                          │
│  ├── 预约下单页                                                             │
│  │   └── 已选陪诊员确认/更换                                                │
│  │                                                                          │
│  └── 订单详情页                                                             │
│      ├── 陪诊员信息展示                                                     │
│      └── 评价陪诊员入口                                                     │
│                                                                             │
│  陪诊员端入口                                                                │
│  ├── 个人中心                                                               │
│  │   └──「工作台」入口（仅陪诊员可见）                                       │
│  │                                                                          │
│  ├── 工作台首页                                                             │
│  │   ├── 统计看板（今日订单/待服务/本月收入）                                │
│  │   ├── 快捷入口（抢单大厅/我的订单）                                       │
│  │   └── 今日任务列表                                                       │
│  │                                                                          │
│  ├── 抢单大厅                                                               │
│  │   └── 可抢订单池（已支付/未分配）                                        │
│  │                                                                          │
│  └── 个人设置                                                               │
│      ├── 服务医院管理                                                       │
│      ├── 服务时段设置                                                       │
│      └── 收入明细/提现                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、实施计划

### 5.1 阶段规划

| 阶段 | 内容 | 工期 | 依赖 |
|------|------|------|------|
| Phase 0 | UI 组件库开发（终端预览扩展） | 2-3天 | 无 |
| Phase 1 | 陪诊员管理完善（CRUD、审核） | 2-3天 | Phase 0 |
| Phase 2 | 账号绑定机制优化 | 1-2天 | Phase 1 |
| Phase 3 | 工作台核心功能（已完成，需优化） | 2天 | Phase 0, Phase 2 |
| Phase 4 | 订单服务流程完善 | 2-3天 | Phase 3 |
| Phase 5 | 用户端入口完善 | 2天 | Phase 0, Phase 1 |
| Phase 6 | 收入与结算系统 | 3-4天 | Phase 4 |
| Phase 7 | 评价体系 | 2天 | Phase 4 |
| Phase 8 | 分销裂变系统 | 4-5天 | Phase 6 |
| Phase 9 | 联调测试 | 2-3天 | 全部 |

**预计总工期：22-30天**

### 5.2 各阶段产出物

| 阶段 | 后端 | 前端 | 测试 |
|------|------|------|------|
| Phase 0 | - | terminal-preview 组件扩展、UI 组件库 | 组件样式/交互测试 |
| Phase 1 | 陪诊员 CRUD API | 管理后台列表/表单 | 增删改查测试 |
| Phase 2 | 自动绑定逻辑 | - | 绑定流程测试 |
| Phase 3 | 工作台 API 优化 | 工作台界面优化 | 工作流测试 |
| Phase 4 | 订单状态流转 | 服务流程界面 | 状态流转测试 |
| Phase 5 | 推荐 API | 首页/详情页入口 | 展示逻辑测试 |
| Phase 6 | 分成/结算 API | 收入明细页 | 分成计算测试 |
| Phase 8 | 分销/晋升 API | 邀请/团队管理页 | 分润链路测试 |

---

## 六、数据模型总览

### 6.1 核心表结构

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│     User        │       │     Escort      │       │     Order       │
│  (用户账号)      │       │   (陪诊员)       │       │    (订单)       │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id              │◄──────│ userId          │──────►│ escortId        │
│ phone           │       │ phone           │       │ status          │
│ openId          │       │ name            │       │ paidAmount      │
│ ...             │       │ level           │       │ commissionRate  │
└─────────────────┘       │ status          │       │ commissionAmount│
                          │ workStatus      │       │ ...             │
                          │ distributionLevel│      └─────────────────┘
                          │ parentId ───────┼──┐
                          │ inviteCode      │  │ 自引用
                          │ ancestorPath    │◄─┘ (上下级关系)
                          └────────┬────────┘
                                   │
          ┌────────────────────────┼────────────────────────┐
          │              │              │                    │
          ▼              ▼              ▼                    ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────────────┐
│EscortHospital│ │EscortWallet │  │EscortReview │  │DistributionRecord│
│ (医院关联)   │  │  (钱包)     │  │  (评价)     │  │   (分润记录)      │
├─────────────┤  ├─────────────┤  ├─────────────┤  ├──────────────────┤
│ escortId    │  │ escortId    │  │ escortId    │  │ orderId          │
│ hospitalId  │  │ balance     │  │ orderId     │  │ beneficiaryId    │
│ familiarDepts│ │ totalEarned │  │ userId      │  │ sourceEscortId   │
└─────────────┘  │ withdrawable│  │ rating      │  │ amount           │
                 └─────────────┘  │ content     │  │ relationLevel    │
                                  └─────────────┘  └──────────────────┘
```

### 6.2 状态枚举

**陪诊员审核状态 (status)**：
| 状态 | 说明 | 允许操作 |
|------|------|---------|
| pending | 待审核 | 编辑资料 |
| active | 已激活 | 接单、服务 |
| inactive | 已停用 | 无 |
| suspended | 已封禁 | 无 |

**陪诊员工作状态 (workStatus)**：
| 状态 | 说明 | 允许操作 |
|------|------|---------|
| resting | 休息中 | 查看订单、切换状态 |
| working | 接单中 | 抢单、查看订单 |
| busy | 服务中 | 完成当前服务 |

**订单状态 (Order.status)**：
```
pending → paid → assigned → arrived → in_progress → completed
   │        │                                            │
   ▼        ▼                                            ▼
cancelled  cancelled/refunding                       评价流程
```

---

## 七、与其他系统的关系

### 7.1 与营销中心的关系

```
营销中心                           陪诊员中心
┌─────────────────┐               ┌─────────────────┐
│  会员系统       │               │  陪诊员管理     │
│  · 会员折扣     │───── 影响 ────►│  · 分成比例     │
│  · 超时减免     │               │    （会员订单） │
├─────────────────┤               ├─────────────────┤
│  优惠券系统     │               │  收入结算       │
│  · 优惠金额     │───── 影响 ────►│  · 分成基数     │
│                │               │    （优惠后金额）│
└─────────────────┘               └─────────────────┘
```

**规则**：
- 陪诊员分成基于订单**实付金额**计算（优惠后）
- 会员订单可配置额外分成奖励

### 7.2 与服务配置的关系

```
业务中心 - 服务管理
┌─────────────────────────────────────────┐
│  Service                                │
│  ├── commissionRate (服务级分成比例)    │
│  ├── commissionNote (分成说明)          │
│  └── operationGuides (关联操作规范)     │
└─────────────────────────────────────────┘
           │
           │ 继承/覆盖
           ▼
┌─────────────────────────────────────────┐
│  订单分成计算                            │
│  优先级: 服务级设置 > 陪诊员等级 > 全局默认│
└─────────────────────────────────────────┘
```

---

## 八、API 概览

### 8.1 管理端 API

| 模块 | 端点 | 说明 |
|------|------|------|
| 陪诊员管理 | `GET/POST/PUT/DELETE /admin/escorts` | CRUD |
| 审核管理 | `PUT /admin/escorts/:id/status` | 状态变更 |
| 结算管理 | `GET /admin/settlements` | 结算列表 |
| 提现审核 | `PUT /admin/withdrawals/:id/approve` | 审核提现 |

### 8.2 陪诊员端 API

| 模块 | 端点 | 说明 |
|------|------|------|
| 身份验证 | `GET /escort/profile` | 获取陪诊员信息 |
| 工作台 | `GET /escort/stats` | 统计数据 |
| 订单管理 | `GET /escort/orders` | 订单列表 |
| 抢单 | `POST /escort/orders/:id/grab` | 抢单 |
| 服务流程 | `POST /escort/orders/:id/arrive\|start\|complete` | 状态流转 |
| 收入管理 | `GET /escort/wallet` | 钱包余额 |
| 提现 | `POST /escort/withdraw` | 申请提现 |
| 邀请码 | `GET /escort/invite-code` | 获取邀请码 |
| 团队管理 | `GET /escort/team` | 团队成员列表 |
| 分润记录 | `GET /escort/distribution/records` | 分润明细 |
| 晋升状态 | `GET /escort/promotion/status` | 晋升进度 |

### 8.3 用户端 API

| 模块 | 端点 | 说明 |
|------|------|------|
| 陪诊员列表 | `GET /escorts` | 获取陪诊员列表 |
| 陪诊员详情 | `GET /escorts/:id` | 获取陪诊员详情 |
| 推荐陪诊员 | `GET /escorts/recommended` | 获取推荐陪诊员 |
| 评价 | `POST /orders/:id/review` | 评价陪诊员 |

---

## 九、风险与注意事项

| 风险 | 应对措施 |
|------|---------|
| 抢单并发冲突 | 使用数据库事务 + 条件更新保证原子性 |
| 分成计算精度 | 使用 Decimal 类型，保留2位小数 |
| 账号绑定冲突 | phone 唯一索引，手动解绑机制 |
| 提现安全 | 多级审核、限额控制、异常监控 |
| 服务超时 | 超时提醒、自动标记、申诉机制 |
| **分销传销风险** | 严格三层限制，基于实际服务分润，非拉人头 |
| **空单刷分润** | 订单审核 + 异常检测 + 分润延迟结算（7天） |
| **虚假邀请** | 手机号验证 + 审核机制 + 异常行为监控 |
| **恶意套利** | 分润上限控制 + 退款扣回机制 |

---

## 十、验收标准

### 核心功能验收清单

**陪诊员管理**：
- [ ] 可创建、编辑、删除陪诊员
- [ ] 可进行资质审核（通过/拒绝）
- [ ] 可管理陪诊员等级和标签

**账号绑定**：
- [ ] 用户绑定手机号后自动匹配陪诊员身份
- [ ] 陪诊员登录后显示工作台入口

**工作台**：
- [ ] 统计数据准确（今日订单、待服务、收入）
- [ ] 可切换接单状态（休息中/接单中）
- [ ] 今日任务列表正确显示

**订单服务**：
- [ ] 可在抢单大厅抢单
- [ ] 订单状态流转正确（到达→开始→完成）
- [ ] 并发抢单时只有一人成功

**收入结算**：
- [ ] 分成计算准确
- [ ] 收入明细清晰
- [ ] 提现流程完整

**用户端入口**：
- [ ] 首页显示推荐陪诊员
- [ ] 服务详情页可选择陪诊员
- [ ] 订单完成后可评价陪诊员

**分销裂变**：
- [ ] 可生成唯一邀请码
- [ ] 通过邀请码正确建立上下级关系
- [ ] 订单完成后各层分润正确计算
- [ ] 直推奖励正确发放
- [ ] 晋升条件检测准确
- [ ] 团队长可查看团队数据
- [ ] 城市合伙人可管理团队长

---

---

## 十一、变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2024-12-11 | 初始版本，包含核心8个模块 | - |
| v1.1 | 2024-12-11 | 新增消息通知系统、数据埋点与分析模块；补充各文档缺失内容 | - |

---

**文档完成，等待实施** 📝
