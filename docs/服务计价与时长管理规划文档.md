# 服务计价与时长管理规划文档

## 一、背景与问题

### 1.1 当前问题

在陪诊服务场景中，存在以下业务痛点：

1. **计价方式与实际服务时长脱节**
   - 用户购买「¥299/次」的服务，但不清楚「次」包含多长时间
   - 陪诊员服务超时后，无法合理收费
   - 容易产生用户投诉和纠纷

2. **服务边界模糊**
   - 用户认为「按次」就是无限时服务
   - 陪诊员因超时产生额外成本无法转嫁
   - 平台难以进行服务质量管控

3. **结算逻辑不清晰**
   - 超时费用如何计算？
   - 何时触发超时提醒？
   - 用户如何选择加时或终止？

### 1.2 设计目标

1. **用户友好**：定价展示简洁易懂，服务内容透明
2. **运营可控**：服务有明确边界，超时有处理机制
3. **灵活配置**：支持多种计价模式和超时策略
4. **自动化**：系统自动跟踪、提醒、结算

---

## 二、核心概念定义

### 2.1 计价单位（Pricing Unit）

用于**定价展示**和**基础订单金额计算**。

| 单位 | 说明 | 适用场景 |
|------|------|----------|
| **次** | 一口价，包含基础服务时长 | 门诊陪诊、检查陪诊 |
| **天** | 按天计费，默认工作时长 | 住院陪护、全天陪诊 |
| **小时** | 按小时计费 | 灵活服务、加时费用 |
| **份** | 按套餐/份数 | 代办服务、资料整理 |

### 2.2 基础服务时长（Base Duration）

**每个服务流程规定的基础服务时间**，超出此时间视为超时。

- 设置在「流程管理」中
- 服务关联流程后自动继承
- 不同流程可设置不同时长

### 2.3 超时策略（Overtime Policy）

当服务时间超过基础时长后的处理机制。

```typescript
interface OvertimePolicy {
  enabled: boolean          // 是否启用超时计价
  price: number             // 超时单价
  unit: '小时' | '30分钟' | '15分钟'  // 计价单位
  maxDuration?: number      // 最大加时时长（小时）
  graceMinutes?: number     // 宽限时间（分钟）
}
```

---

## 三、数据模型设计

### 3.1 流程模型扩展（Workflow）

```prisma
model Workflow {
  // ... 现有字段 ...
  
  // 时长配置
  baseDuration      Int       @default(240) @map("base_duration")       // 基础服务时长（分钟）
  
  // 超时策略
  overtimeEnabled   Boolean   @default(true) @map("overtime_enabled")   // 是否允许超时加时
  overtimePrice     Decimal?  @map("overtime_price")                    // 超时单价
  overtimeUnit      String    @default("小时") @map("overtime_unit")    // 超时计价单位
  overtimeMax       Int?      @map("overtime_max")                      // 最大加时时长（分钟）
  overtimeGrace     Int       @default(15) @map("overtime_grace")       // 宽限时间（分钟）
}
```

### 3.2 服务模型调整（Service）

```prisma
model Service {
  // ... 现有字段 ...
  
  price             Decimal                   // 基础价格
  unit              String    @default("次")  // 计价单位
  
  // 移除 duration 字段，由关联流程决定
  // duration       String?   // [已移除]
  
  // 可选：服务级别的超时价格覆盖
  overtimePriceOverride  Decimal?  @map("overtime_price_override")
}
```

### 3.3 订单模型扩展（Order）

```prisma
model Order {
  // ... 现有字段 ...
  
  // 时长追踪
  serviceStartTime   DateTime?  @map("service_start_time")    // 服务开始时间
  serviceEndTime     DateTime?  @map("service_end_time")      // 服务结束时间
  actualDuration     Int?       @map("actual_duration")       // 实际服务时长（分钟）
  
  // 费用明细
  baseAmount         Decimal    @map("base_amount")           // 基础费用
  overtimeAmount     Decimal    @default(0) @map("overtime_amount")  // 超时费用
  totalAmount        Decimal    @map("total_amount")          // 总费用
  
  // 超时记录
  overtimeRecords    Json?      @map("overtime_records")      // 超时加时记录
}
```

---

## 四、业务流程设计

### 4.1 服务配置流程

```
管理员配置流程
      │
      ▼
┌─────────────────────────────────────┐
│           流程管理页面               │
├─────────────────────────────────────┤
│  流程名称：门诊陪诊流程              │
│  基础时长：4小时                     │
│  ─────────────────────────────────  │
│  超时策略：                          │
│  ☑ 启用超时加时                      │
│  超时单价：¥50/小时                  │
│  宽限时间：15分钟                    │
│  最大加时：4小时                     │
└─────────────────────────────────────┘
      │
      ▼
管理员配置服务
      │
      ▼
┌─────────────────────────────────────┐
│           服务编辑页面               │
├─────────────────────────────────────┤
│  服务名称：专业门诊陪诊              │
│  基础价格：¥299                      │
│  计价单位：次                        │
│  关联流程：门诊陪诊流程 ────────────│──→ 自动继承时长配置
│  ─────────────────────────────────  │
│  💡 提示：此服务包含4小时基础时长    │
│     超时将按¥50/小时加收            │
└─────────────────────────────────────┘
```

### 4.2 用户下单流程

```
用户浏览服务详情
      │
      ▼
┌─────────────────────────────────────────────────────┐
│                  服务详情页                          │
├─────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────┐  │
│  │  专业门诊陪诊                                  │  │
│  │  ¥299/次                                      │  │
│  │                                               │  │
│  │  📋 服务说明                                  │  │
│  │  ├─ 包含4小时基础服务时长                     │  │
│  │  ├─ 超出部分按¥50/小时加收                    │  │
│  │  └─ 首15分钟超时免费                          │  │
│  │                                               │  │
│  │  ⏱️ 计时说明                                  │  │
│  │  服务开始后系统自动计时，到达基础时长后       │  │
│  │  将通知您选择「加时继续」或「结束服务」       │  │
│  └───────────────────────────────────────────────┘  │
│                                                     │
│              [ 立即预约 ¥299 ]                      │
└─────────────────────────────────────────────────────┘
```

### 4.3 服务执行流程

```
订单确认，等待服务
      │
      ▼
陪诊员到达，开始服务
      │
      ├─── 系统开始计时
      │
      ▼
┌─────────────────────────────────────┐
│  服务进行中...                       │
│  已服务：2小时15分钟                 │
│  剩余时长：1小时45分钟               │
│  ████████████░░░░░░░░ 56%           │
└─────────────────────────────────────┘
      │
      ▼
临近基础时长上限（提前30分钟提醒）
      │
      ├─── 推送通知给用户和陪诊员
      │
      ▼
┌─────────────────────────────────────┐
│  ⚠️ 服务时长提醒                     │
│                                     │
│  您的服务即将到达基础时长（4小时）   │
│  剩余：30分钟                        │
│                                     │
│  超时后将按 ¥50/小时 计费            │
│                                     │
│  [ 我知道了 ]                        │
└─────────────────────────────────────┘
      │
      ▼
到达基础时长上限
      │
      ├─── 进入宽限期（15分钟）
      │
      ▼
宽限期结束
      │
      ├─── 弹出选择界面
      │
      ▼
┌─────────────────────────────────────┐
│  ⏰ 基础服务时长已用完               │
│                                     │
│  已服务：4小时15分钟                 │
│  基础时长：4小时                     │
│                                     │
│  请选择后续操作：                    │
│                                     │
│  ┌─────────────────────────────────┐│
│  │  🕐 加时继续                     ││
│  │  ¥50/小时，最多可加4小时        ││
│  └─────────────────────────────────┘│
│                                     │
│  ┌─────────────────────────────────┐│
│  │  ✅ 结束服务                     ││
│  │  当前无需额外付费                ││
│  └─────────────────────────────────┘│
└─────────────────────────────────────┘
      │
      ├─── 用户选择「加时继续」
      │         │
      │         ▼
      │    继续服务，每小时计费
      │         │
      │         ▼
      │    到达最大加时时长或用户结束
      │
      └─── 用户选择「结束服务」
                │
                ▼
           服务结束，进入结算
```

### 4.4 订单结算流程

```
服务结束
      │
      ▼
┌─────────────────────────────────────┐
│           系统自动计算               │
├─────────────────────────────────────┤
│  基础服务：4小时 → ¥299             │
│  超时服务：1.5小时 → ¥75            │
│  ─────────────────────────────────  │
│  订单总额：¥374                      │
│  已支付：¥299                        │
│  待支付：¥75                         │
└─────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────┐
│           用户收到账单               │
├─────────────────────────────────────┤
│  📋 服务已完成                       │
│                                     │
│  服务时长：5小时30分钟               │
│  ├─ 基础时长：4小时     ¥299        │
│  └─ 超时时长：1.5小时   ¥75         │
│                                     │
│  ─────────────────────────────────  │
│  总计：¥374                          │
│  已付：¥299                          │
│  待付：¥75                           │
│                                     │
│  [ 支付 ¥75 ]    [ 查看明细 ]       │
└─────────────────────────────────────┘
```

---

## 五、用户端展示规范

### 5.1 服务列表页

```
┌─────────────────────────────────────┐
│  [图片]                              │
│  专业门诊陪诊                        │
│  ¥299/次                             │
│  ⏱️ 含4小时 · 超时¥50/时            │  ← 简短说明
│  ⭐ 4.9  |  已服务 1234次            │
└─────────────────────────────────────┘
```

### 5.2 服务详情页

#### 价格区域
```
┌─────────────────────────────────────┐
│  ¥299                                │
│  /次                                 │
│                                     │
│  💡 包含4小时基础服务时长            │  ← 显著提示
│     超出按¥50/小时加收              │
└─────────────────────────────────────┘
```

#### 服务说明卡片
```
┌─────────────────────────────────────┐
│  📋 费用说明                         │
├─────────────────────────────────────┤
│                                     │
│  基础服务                            │
│  ├─ 价格：¥299/次                   │
│  ├─ 时长：4小时                      │
│  └─ 宽限：首15分钟超时免费           │
│                                     │
│  超时服务                            │
│  ├─ 价格：¥50/小时                  │
│  ├─ 计费：按实际超时时长             │
│  └─ 上限：最多加时4小时              │
│                                     │
│  计费示例                            │
│  ├─ 服务3小时 → 支付¥299            │
│  ├─ 服务5小时 → 支付¥349            │
│  └─ 服务6小时 → 支付¥399            │
│                                     │
└─────────────────────────────────────┘
```

#### 服务须知卡片
```
┌─────────────────────────────────────┐
│  ⚠️ 服务须知                         │
├─────────────────────────────────────┤
│                                     │
│  1. 服务开始后系统自动计时           │
│  2. 临近基础时长会提前30分钟通知     │
│  3. 超时后您可选择加时或结束服务     │
│  4. 超时费用在服务结束后支付         │
│  5. 如有异议请在24小时内申诉         │
│                                     │
└─────────────────────────────────────┘
```

### 5.3 订单详情页

```
┌─────────────────────────────────────┐
│  订单详情                            │
├─────────────────────────────────────┤
│                                     │
│  服务信息                            │
│  ├─ 服务名称：专业门诊陪诊           │
│  ├─ 陪诊师：张三                     │
│  └─ 服务医院：北京协和医院           │
│                                     │
│  时间信息                            │
│  ├─ 预约时间：2024-01-15 09:00      │
│  ├─ 开始时间：2024-01-15 09:05      │
│  ├─ 结束时间：2024-01-15 14:35      │
│  └─ 服务时长：5小时30分钟            │
│                                     │
│  费用明细                            │
│  ├─ 基础服务（4小时）    ¥299       │
│  ├─ 超时服务（1.5小时）  ¥75        │
│  ├─ 优惠折扣             -¥0        │
│  └─ ─────────────────────────────   │
│      订单总额             ¥374       │
│                                     │
└─────────────────────────────────────┘
```

---

## 六、异常处理

### 6.1 争议场景

| 场景 | 处理方式 |
|------|----------|
| 用户认为计时不准确 | 提供详细时间日志，支持申诉 |
| 陪诊员提前结束服务 | 按实际时长计费，不足基础时长可申请部分退款 |
| 服务中断后继续 | 暂停计时，重新开始后继续累计 |
| 用户拒绝支付超时费 | 影响信用分，限制后续下单 |
| 陪诊员迟到 | 从实际开始时间计时 |

### 6.2 特殊情况

1. **医院排队时间长**
   - 可设置「等待期」不计入服务时长
   - 或设置较低的「等待费」

2. **服务中断**
   - 陪诊员可申请「暂停计时」
   - 需用户确认后生效

3. **提前结束**
   - 用户可随时结束服务
   - 不足基础时长不退费（除非服务质量问题）

---

## 七、实施计划

### 7.1 第一阶段：基础能力（当前）

- [x] 移除服务编辑页的「服务时长」字段
- [ ] 流程管理添加「基础时长」配置
- [ ] 流程管理添加「超时策略」配置
- [ ] 服务详情页展示时长说明

### 7.2 第二阶段：服务追踪

- [ ] 订单增加时间追踪字段
- [ ] 陪诊员端「开始服务」「结束服务」功能
- [ ] 服务计时器功能
- [ ] 超时提醒推送

### 7.3 第三阶段：结算闭环

- [ ] 超时选择弹窗（加时/结束）
- [ ] 超时费用自动计算
- [ ] 超时费用支付流程
- [ ] 订单费用明细展示

### 7.4 第四阶段：高级功能

- [ ] 等待期设置
- [ ] 暂停计时功能
- [ ] 争议处理流程
- [ ] 数据统计分析

---

## 八、总结

### 核心设计原则

1. **透明定价**：用户在下单前完全了解计费规则
2. **公平合理**：保护用户和陪诊员双方利益
3. **系统自动化**：减少人工干预，避免纠纷
4. **灵活配置**：支持不同服务类型的差异化设置

### 预期效果

1. **减少投诉**：计费规则清晰，用户预期明确
2. **提升收入**：合理的超时计费增加平台收入
3. **优化体验**：自动化流程减少沟通成本
4. **运营可控**：服务时长有边界，成本可预估

---

*文档版本：v1.0*
*创建时间：2024-12-11*
*作者：系统架构师*
