# 常见问题与反模式

## Do's and Don'ts

| ✅ 推荐做法 | ❌ 避免做法 |
|:---|:---|
| 使用 **Tabs 分组**长表单 | 在一个长页面中无限滚动查找字段 |
| 关闭前检查 **isDirty** | 用户误触关闭导致辛苦填写的数据丢失 |
| 使用 **vh** 控制滚动高度 | 使用固定 **px** 导致小屏显示不全 |
| 详情页提供 **"去编辑"** 入口 | 详情页强行塞入 Input 变为"混合模式" |
| 弹窗组件**独立文件**封装 | 所有逻辑挤在主页面，单文件 1000+ 行 |
| API 错误用 **Toast** 提示 | 错误信息无处展示，用户一脸懵 |
| 加载时显示 **Skeleton** | 空白等待，用户以为卡住了 |
| 移动端 Sheet 从**底部**弹出 | 强制侧边弹出，拇指够不到 |
| 使用 **SelectDropdown** 组件 | 原生 select 样式不统一 |
| 使用 **ConfirmDialog** 确认 | `window.confirm` 丑陋且无法自定义 |

---

## 常见 Bug 避免

### 1. 编辑弹窗数据没有回填

```tsx
// ❌ 错误：defaultValues 只在组件挂载时生效
const form = useForm({
  defaultValues: currentRow || { name: '' }
})

// ✅ 正确：使用 useEffect 监听 currentRow 变化
useEffect(() => {
  if (open && currentRow) {
    form.reset(currentRow)
  }
}, [open, currentRow, form])
```

### 2. 关闭弹窗后再打开，显示上次数据

```tsx
// ❌ 错误：没有在关闭时重置
<Dialog open={open} onOpenChange={setOpen}>

// ✅ 正确：关闭时重置表单
<Dialog 
  open={open} 
  onOpenChange={(state) => {
    if (!state) form.reset()
    setOpen(state)
  }}
>
```

### 3. 提交时弹窗被意外关闭

```tsx
// ❌ 错误：提交过程中可以关闭弹窗
<Dialog open={open} onOpenChange={setOpen}>

// ✅ 正确：提交过程中禁止关闭
<Dialog 
  open={open} 
  onOpenChange={(state) => {
    if (!isPending) {
      setOpen(state)
    }
  }}
>
```

### 4. Switch 组件表单提交问题

```tsx
// ❌ 错误：直接使用 FormData，Switch 不会正确提交
const formData = new FormData(e.currentTarget)
const isActive = formData.get('isActive') // 可能是 null 或 'on'

// ✅ 正确：使用 react-hook-form 管理 Switch 状态
<FormField
  control={form.control}
  name='isActive'
  render={({ field }) => (
    <Switch checked={field.value} onCheckedChange={field.onChange} />
  )}
/>
```

### 5. 嵌套弹窗焦点问题

```tsx
// ❌ 错误：DropdownMenu 在 Dialog 中不能正常工作
<Dialog>
  <DropdownMenu>...</DropdownMenu>
</Dialog>

// ✅ 正确：给 DropdownMenu 添加 modal={false}
<Dialog>
  <DropdownMenu modal={false}>...</DropdownMenu>
</Dialog>
```

### 6. Focus Ring 被裁切

```tsx
// ❌ 错误：只有右侧 padding，左侧 focus ring 被 overflow 裁切
<div className='overflow-y-auto pe-2'>
  <Input /> {/* 聚焦时左侧描边被裁切 */}
</div>

// ✅ 正确：左右都有 padding，给 focus ring 留出空间
<div className='overflow-y-auto px-1'>
  <Input /> {/* 聚焦时描边完整显示 */}
</div>
```

> ⚠️ **重要**：任何带有 `overflow-y-auto` 或 `overflow-hidden` 的容器，如果内部有可聚焦元素（Input、Select 等），都需要添加 `px-1` 或更大的水平 padding，否则 focus ring 会被裁切。

### 7. 多列布局字段错位

```tsx
// ❌ 错误：默认垂直居中，有 FormDescription 的字段会导致其他字段错位
<div className='grid grid-cols-2 gap-4'>
  <FormItem>
    <FormLabel>类型</FormLabel>
    <SelectDropdown />
    {/* 没有 FormDescription */}
  </FormItem>
  <FormItem>
    <FormLabel>积分数</FormLabel>
    <Input />
    <FormDescription>获取为正，消耗为负</FormDescription>
  </FormItem>
</div>

// ✅ 正确：添加 items-start 确保顶部对齐
<div className='grid grid-cols-2 items-start gap-4'>
  {/* 字段内容 */}
</div>
```

> ⚠️ **重要**：所有多列 Grid 布局（`grid-cols-2`、`grid-cols-3` 等）必须添加 `items-start`，确保字段顶部对齐。
