# 表单验证

## Zod Schema 定义

```tsx
const formSchema = z
  .object({
    name: z.string().min(1, '请输入名称'),
    email: z.email({ error: (iss) => (iss.input === '' ? '请输入邮箱' : undefined) }),
    phone: z.string().min(1, '请输入电话'),
    role: z.string().min(1, '请选择角色'),
    password: z.string().transform((pwd) => pwd.trim()),
    confirmPassword: z.string().transform((pwd) => pwd.trim()),
    isEdit: z.boolean(),
  })
  // 条件验证：编辑时密码可选
  .refine(
    (data) => {
      if (data.isEdit && !data.password) return true
      return data.password.length > 0
    },
    { message: '请输入密码', path: ['password'] }
  )
  // 密码长度验证
  .refine(
    ({ isEdit, password }) => {
      if (isEdit && !password) return true
      return password.length >= 8
    },
    { message: '密码至少需要8个字符', path: ['password'] }
  )
  // 密码确认验证
  .refine(
    ({ isEdit, password, confirmPassword }) => {
      if (isEdit && !password) return true
      return password === confirmPassword
    },
    { message: '两次输入的密码不一致', path: ['confirmPassword'] }
  )

type FormValues = z.infer<typeof formSchema>
```

---

## useForm 配置

```tsx
const form = useForm<FormValues>({
  resolver: zodResolver(formSchema),
  defaultValues: isEdit
    ? {
        ...currentRow,
        password: '',
        confirmPassword: '',
        isEdit: true,
      }
    : {
        name: '',
        email: '',
        phone: '',
        role: '',
        password: '',
        confirmPassword: '',
        isEdit: false,
      },
})
```

---

## 常用验证规则

### 必填字段

```tsx
name: z.string().min(1, '请输入名称')
```

### 数字类型

```tsx
// 整数
points: z.coerce.number().int('必须是整数')

// 非负数
price: z.coerce.number().min(0, '价格不能为负')

// 范围限制
discount: z.coerce.number().min(0).max(100, '折扣不能超过100%')

// 可选数字
maxLimit: z.coerce.number().min(0).optional()
```

### 选择类型

```tsx
type: z.string().min(1, '请选择类型')
status: z.string().default('active')
```

### 布尔类型

```tsx
isActive: z.boolean().default(true)
```

### 日期时间

```tsx
startAt: z.string().min(1, '请选择开始时间')
endAt: z.string().min(1, '请选择结束时间')
```

### 可选字段

```tsx
description: z.string().optional()
code: z.string().optional()
```

---

## 动态表单重置

编辑模式下，需要使用 `useEffect` 监听数据变化并重置表单：

```tsx
useEffect(() => {
  if (open && currentRow) {
    // 编辑模式：回填数据
    form.reset({
      name: currentRow.name,
      status: currentRow.status,
      // ... 其他字段
    })
  } else if (open) {
    // 新建模式：重置为默认值
    form.reset({
      name: '',
      status: 'active',
      // ... 其他默认值
    })
  }
}, [open, currentRow, form])
```

---

## 提交处理

```tsx
const onSubmit = (values: FormValues) => {
  // 处理数据转换
  const payload = {
    ...values,
    // 日期转换
    startAt: new Date(values.startAt).toISOString(),
    // 数组处理
    applicableIds: values.applicableIds
      ? values.applicableIds.split(',').map((s) => s.trim()).filter(Boolean)
      : [],
    // 可选字段清理
    description: values.description || undefined,
  }

  if (isEdit && currentRow) {
    updateMutation.mutate({ id: currentRow.id, payload })
  } else {
    createMutation.mutate(payload)
  }
}
```
