# åŒèº«ä»½ä¼šè¯ä¸è§†è§’åˆ‡æ¢è§„æ ¼

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.2  
> **åˆ›å»ºæ—¥æœŸ**: 2024-12-12  
> **çŠ¶æ€**: ğŸ“‹ è§„åˆ’ä¸­  
> **è¿”å›**: [æ€»è§ˆ](./README.md)

---

## ä¸€ã€èƒŒæ™¯ä¸çº¦æŸ

### 1.1 ç³»ç»Ÿç°çŠ¶

- å½“å‰é™ªè¯Šå‘˜ä¸æ™®é€šç”¨æˆ·ä¸º **ä¸¤å¥—ç”¨æˆ·ç³»ç»Ÿ**ï¼ˆä¸¤å¥—è´¦å·ä½“ç³»ã€ä¸¤å¥—é‰´æƒï¼‰
- æ™®é€šç”¨æˆ·ä¸é™ªè¯Šå‘˜å…±ç”¨åŒä¸€ç»ˆç«¯ï¼ˆå°ç¨‹åº/App/H5 ä»ä¸ºä¸€å¥—ï¼‰
- ä¸åŒè§’è‰²æ‹¥æœ‰ä¸åŒç•Œé¢è§†è§’ï¼ˆå­—æ®µã€å…¥å£ã€TabBarã€å¯è®¿é—®é¡µé¢ä¸åŒï¼‰

### 1.2 è®¾è®¡ç›®æ ‡

- ä¸å¼€å‘é¢å¤–ç»ˆç«¯
- åœ¨"æˆ‘çš„"é¡µé¢æä¾›ã€Œé™ªè¯Šå‘˜å…¥å£ã€ï¼Œå¯¹æ™®é€šç”¨æˆ·éšè—
- é™ªè¯Šå‘˜å¯åœ¨åŒä¸€ç»ˆç«¯å†…è‡ªç”±åˆ‡æ¢è§†è§’ï¼š
  - é€€å‡ºé™ªè¯Šå‘˜è§†è§’ = å›åˆ°æ™®é€šç”¨æˆ·è§†è§’
  - è¿›å…¥é™ªè¯Šå‘˜è§†è§’ = è¿›è¡Œé™ªè¯Šå‘˜ç™»å½•éªŒè¯

### 1.3 å®‰å…¨çº¦æŸ

> âš ï¸ **å¼ºåˆ¶è§„åˆ™**ï¼šä»…é å‰ç«¯éšè—å…¥å£ä¸æ„æˆå®‰å…¨è¾¹ç•Œï¼Œ**å¿…é¡»ç”±åç«¯é‰´æƒå…œåº•**

---

## äºŒã€åŒä¼šè¯ï¼ˆDual-Sessionï¼‰æ¨¡å‹

### 2.1 ä¼šè¯å®šä¹‰

ç”±äºé™ªè¯Šå‘˜ä¸æ™®é€šç”¨æˆ·ä¸ºä¸¤å¥—ç”¨æˆ·ç³»ç»Ÿï¼Œç»ˆç«¯éœ€è¦åŒæ—¶æ”¯æŒä¸¤ç§ç‹¬ç«‹é‰´æƒæ€ï¼š

| ä¼šè¯ç±»å‹ | Token | ç”¨é€” |
|---------|-------|------|
| **UserSession** | `userToken` | ç”¨æˆ·ç«¯åŠŸèƒ½ï¼šæœåŠ¡ã€ç—…å†ã€è¥é”€ä¸­å¿ƒã€ä¸ªäººä¸­å¿ƒç­‰ |
| **EscortSession** | `escortToken` | é™ªè¯Šå‘˜ç«¯åŠŸèƒ½ï¼šå·¥ä½œå°ã€è®¢å•æ± ã€æ”¶å…¥æç°ã€é™ªè¯Šå‘˜èµ„æ–™ç­‰ |

### 2.2 è§†è§’åˆ‡æ¢ä¾æ®

```
viewerRole = escort  å½“ä¸”ä»…å½“ escortToken å­˜åœ¨ä¸”æœ‰æ•ˆ
viewerRole = user    å…¶ä»–æƒ…å†µ
```

> âœ… **å¼ºåˆ¶è§„åˆ™**ï¼šé™ªè¯Šå‘˜è§†è§’ä¸æ˜¯ä¸€ä¸ªå‰ç«¯å¸ƒå°”å­—æ®µï¼Œè€Œæ˜¯ä¸€ä»½ç‹¬ç«‹å¯æ ¡éªŒçš„é™ªè¯Šå‘˜ä¼šè¯ï¼ˆescortTokenï¼‰

### 2.3 ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¼šè¯ç”Ÿå‘½å‘¨æœŸ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  UserSession                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åˆ›å»ºï¼šç”¨æˆ·ç™»å½•ï¼ˆå¾®ä¿¡æˆæƒ/æ‰‹æœºå·ç™»å½•ï¼‰                      â”‚   â”‚
â”‚  â”‚ ç»­æœŸï¼šè‡ªåŠ¨åˆ·æ–° / ç”¨æˆ·æ“ä½œæ—¶                               â”‚   â”‚
â”‚  â”‚ å¤±æ•ˆï¼šç”¨æˆ·é€€å‡ºç™»å½• / Token è¿‡æœŸ                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  EscortSession                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åˆ›å»ºï¼šé™ªè¯Šå‘˜äºŒæ¬¡ç™»å½•éªŒè¯æˆåŠŸ                              â”‚   â”‚
â”‚  â”‚ ç»­æœŸï¼šè‡ªåŠ¨åˆ·æ–° / é™ªè¯Šå‘˜æ“ä½œæ—¶                             â”‚   â”‚
â”‚  â”‚ å¤±æ•ˆï¼šä¸»åŠ¨é€€å‡ºé™ªè¯Šå‘˜ / Token è¿‡æœŸ                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  âš ï¸ ä¸¤ä¸ªä¼šè¯ç›¸äº’ç‹¬ç«‹ï¼š                                         â”‚
â”‚     - EscortSession å¤±æ•ˆä¸å½±å“ UserSession                     â”‚
â”‚     - UserSession å¤±æ•ˆå¯èƒ½éœ€è¦é‡æ–°ç™»å½•ï¼ˆå½±å“ EscortSessionï¼‰    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€åç«¯é‰´æƒç¡¬çº¦æŸï¼ˆå®‰å…¨è¾¹ç•Œï¼‰

### 3.1 API è®¿é—®æ§åˆ¶

| API è·¯å¾„ | æ‰€éœ€ Token | è¯´æ˜ |
|---------|-----------|------|
| `/api/*`ï¼ˆé€šç”¨ï¼‰ | `userToken` | æ™®é€šç”¨æˆ·æ¥å£ |
| `/api/escort-app/**` | `escortToken` | é™ªè¯Šå‘˜å·¥ä½œå°æ¥å£ |
| `/api/escorts/**`ï¼ˆç®¡ç†ï¼‰ | `escortToken` | é™ªè¯Šå‘˜èµ„æ–™ç®¡ç† |
| `/api/escorts`ï¼ˆå…¬å¼€åˆ—è¡¨ï¼‰ | `userToken` | ç”¨æˆ·ç«¯æŸ¥çœ‹é™ªè¯Šå‘˜åˆ—è¡¨ |

### 3.2 å¼ºåˆ¶è§„åˆ™

1. **æ‰€æœ‰é™ªè¯Šå‘˜ç›¸å…³ API å¿…é¡»æ ¡éªŒ escortToken**
   - `/escort-app/**`
   - `/escorts/**`ï¼ˆé™¤å…¬å¼€åˆ—è¡¨å¤–ï¼‰

2. **æ™®é€šç”¨æˆ· token ä¸å¯è®¿é—®é™ªè¯Šå‘˜æ¥å£**
   - è¿”å› 401/403

3. **æ™®é€šç”¨æˆ·æ¥å£ä¸åº”è¿”å›é™ªè¯Šå‘˜ä¸“å±å­—æ®µ**
   - é¿å…"UI éšè—ä½†æ•°æ®æ³„éœ²"

### 3.3 åç«¯å®ç°å»ºè®®

```typescript
// NestJS Guard ç¤ºä¾‹
@Injectable()
export class EscortAuthGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest()
    const escortToken = request.headers['x-escort-token'] 
      || request.headers['authorization']?.replace('Bearer ', '')
    
    if (!escortToken) {
      throw new UnauthorizedException('éœ€è¦é™ªè¯Šå‘˜ç™»å½•')
    }
    
    const escort = this.validateEscortToken(escortToken)
    if (!escort) {
      throw new UnauthorizedException('é™ªè¯Šå‘˜ç™»å½•å·²è¿‡æœŸ')
    }
    
    request.escort = escort
    return true
  }
}

// æ§åˆ¶å™¨ä½¿ç”¨
@Controller('escort-app')
@UseGuards(EscortAuthGuard)
export class EscortAppController {
  @Get('workbench/stats')
  getWorkbenchStats(@Req() req) {
    return this.service.getStats(req.escort.id)
  }
}
```

---

## å››ã€è¯·æ±‚å±‚åŒé€šé“å°è£…

### 4.1 å°è£…åŸåˆ™

ä¸ºé¿å… token ä¸²ç”¨å¯¼è‡´æ•°æ®é”™ä¹±ï¼Œåœ¨è¯·æ±‚å±‚åšå¼ºåˆ¶åˆ†æµï¼š

- `userRequest()` è‡ªåŠ¨æºå¸¦ `userToken`
- `escortRequest()` è‡ªåŠ¨æºå¸¦ `escortToken`

> âœ… **å¼ºåˆ¶è§„åˆ™**ï¼šé™ªè¯Šå‘˜ API ä¸å…è®¸èµ° `userRequest`ï¼›ç”¨æˆ· API ä¸å…è®¸èµ° `escortRequest`ï¼ˆé™¤éæ˜ç¡®å…è®¸ï¼‰

### 4.2 Token å­˜å‚¨ä¸è¯»å–è§„èŒƒï¼ˆå¿…é¡»ç»Ÿä¸€ï¼‰

| ç¯å¢ƒ | userToken å­˜å‚¨ | escortToken å­˜å‚¨ |
|------|---------------|-----------------|
| **å°ç¨‹åº** | `wx.setStorageSync('userToken', token)` | `wx.setStorageSync('escortToken', token)` |
| **H5 ç»ˆç«¯** | `localStorage.setItem('userToken', token)` | `localStorage.setItem('escortToken', token)` |
| **ç®¡ç†åå°é¢„è§ˆå™¨** | é€šè¿‡ Props æ³¨å…¥ mock tokenï¼Œ**ä¸è½åœ°å­˜å‚¨** | é€šè¿‡ Props æ³¨å…¥ mock tokenï¼Œ**ä¸è½åœ°å­˜å‚¨** |

> âš ï¸ **å¼ºåˆ¶è§„èŒƒ**ï¼šå…¨ç«¯ç»Ÿä¸€ key åç§°ï¼š`userToken` / `escortToken`ï¼Œç¦æ­¢è‡ªå®šä¹‰å‘½åã€‚

### 4.3 ç»Ÿä¸€é”™è¯¯ç å¤„ç†

| é”™è¯¯ç  | åœºæ™¯ | å¤„ç†ç­–ç•¥ |
|--------|------|---------|
| **401** | `escortRequest` æ”¶åˆ° | 1. æ¸…ç©º `escortToken`<br>2. å¼ºåˆ¶åˆ‡å› user è§†è§’<br>3. Toast: "é™ªè¯Šå‘˜ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•" |
| **401** | `userRequest` æ”¶åˆ° | 1. æ¸…ç©º `userToken`<br>2. è·³è½¬ç™»å½•é¡µ |
| **403** | æƒé™ä¸è¶³ | æç¤ºæ— æƒé™ï¼Œä¸æ¸… token |

### 4.4 å®ç°ä»£ç 

```typescript
// api.ts

const USER_TOKEN_KEY = 'userToken'
const ESCORT_TOKEN_KEY = 'escortToken'

// å°ç¨‹åºç¯å¢ƒåˆ¤æ–­
const isWeapp = typeof wx !== 'undefined' && wx.getStorageSync

// è·å–ç”¨æˆ· Token
function getUserToken(): string | null {
  if (isWeapp) {
    return wx.getStorageSync(USER_TOKEN_KEY) || null
  }
  return localStorage.getItem(USER_TOKEN_KEY)
}

// è·å–é™ªè¯Šå‘˜ Token
function getEscortToken(): string | null {
  if (isWeapp) {
    return wx.getStorageSync(ESCORT_TOKEN_KEY) || null
  }
  return localStorage.getItem(ESCORT_TOKEN_KEY)
}

// æ¸…é™¤é™ªè¯Šå‘˜ Token
function clearEscortToken(): void {
  if (isWeapp) {
    wx.removeStorageSync(ESCORT_TOKEN_KEY)
  } else {
    localStorage.removeItem(ESCORT_TOKEN_KEY)
  }
}

// ç”¨æˆ·é€šé“è¯·æ±‚
async function userRequest<T>(endpoint: string, options?: RequestInit): Promise<T> {
  const headers = new Headers(options?.headers)
  const userToken = getUserToken()
  if (userToken) {
    headers.set('Authorization', `Bearer ${userToken}`)
  }
  
  const response = await fetch(`/api${endpoint}`, {
    ...options,
    headers,
  })
  
  if (!response.ok) {
    if (response.status === 401) {
      // ç”¨æˆ·ç™»å½•å¤±æ•ˆï¼Œè·³è½¬ç™»å½•
      throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
    }
    throw new Error(`HTTP ${response.status}`)
  }
  
  const result = await response.json()
  return result.data
}

// é™ªè¯Šå‘˜é€šé“è¯·æ±‚
async function escortRequest<T>(endpoint: string, options?: RequestInit): Promise<T> {
  const headers = new Headers(options?.headers)
  const escortToken = getEscortToken()
  
  if (!escortToken) {
    throw new Error('éœ€è¦é™ªè¯Šå‘˜ç™»å½•')
  }
  
  headers.set('Authorization', `Bearer ${escortToken}`)
  
  const response = await fetch(`/api${endpoint}`, {
    ...options,
    headers,
  })
  
  if (!response.ok) {
    if (response.status === 401) {
      // æ¸…é™¤æ— æ•ˆçš„ escortToken
      clearEscortToken()
      // è§¦å‘è§†è§’åˆ‡æ¢ï¼ˆéœ€è¦é…åˆçŠ¶æ€ç®¡ç†ï¼‰
      window.dispatchEvent(new CustomEvent('escort-session-expired'))
      throw new Error('é™ªè¯Šå‘˜ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•')
    }
    throw new Error(`HTTP ${response.status}`)
  }
  
  const result = await response.json()
  return result.data
}
```

### 4.5 API åˆ†ç±»ä¸æ¥å£å±æ€§

#### æ¥å£å±æ€§å®šä¹‰

| æ¥å£è·¯å¾„ | æ¥å£å±æ€§ | æ‰€éœ€ Token | è¯´æ˜ |
|---------|---------|-----------|------|
| `/escorts` | **å…¬å¼€ä¿¡æ¯** | `userToken` æˆ–åŒ¿å | ç”¨æˆ·ç«¯æµè§ˆé™ªè¯Šå‘˜åˆ—è¡¨ |
| `/escorts/:id` | **å…¬å¼€ä¿¡æ¯** | `userToken` æˆ–åŒ¿å | ç”¨æˆ·ç«¯æŸ¥çœ‹é™ªè¯Šå‘˜è¯¦æƒ… |
| `/escort-app/**` | **é™ªè¯Šå‘˜å·¥ä½œå°** | `escortToken` **å¿…é¡»** | é™ªè¯Šå‘˜ä¸“å±åŠŸèƒ½ |

> âš ï¸ **åç«¯åŒäº‹æ³¨æ„**ï¼š`/escorts` å’Œ `/escorts/:id` æ˜¯å…¬å¼€æ¥å£ï¼Œç”¨æˆ·ç«¯éœ€è¦è®¿é—®ï¼Œ**ä¸è¦å¼ºåˆ¶ escortToken**ï¼Œå¦åˆ™ç”¨æˆ·ç«¯é™ªè¯Šå‘˜åˆ—è¡¨ä¼šæŒ‚æ‰ã€‚

#### API åˆ†ç±»ä»£ç 

```typescript
export const previewApi = {
  // ========== User Channel ==========
  
  // ä¸»é¢˜ä¸é¦–é¡µ
  getThemeSettings: () => userRequest<ThemeSettings>('/config/theme/settings'),
  getHomePageSettings: () => userRequest<HomePageSettings>('/home/page-settings'),
  
  // è¥é”€ä¸­å¿ƒ
  getMembershipLevels: () => userRequest<MembershipLevel[]>('/marketing/membership/levels'),
  getMyMembership: () => userRequest<MembershipInfo | null>('/marketing/membership/my'),
  getMembershipPlans: () => userRequest<MembershipPlan[]>('/marketing/membership/plans'),
  getMyCoupons: () => userRequest<CouponListResponse>('/marketing/coupons/my'),
  getAvailableCoupons: () => userRequest<Coupon[]>('/marketing/coupons/available'),
  getMyPoints: () => userRequest<PointsInfo>('/marketing/points/my'),
  getPointsRecords: () => userRequest<PointsRecord[]>('/marketing/points/records'),
  getReferralInfo: () => userRequest<ReferralInfo>('/marketing/referrals/info'),
  getCampaigns: () => userRequest<Campaign[]>('/marketing/campaigns'),
  getCampaignDetail: (id: string) => userRequest<CampaignDetail>(`/marketing/campaigns/${id}`),
  
  // é™ªè¯Šå‘˜å…¬å¼€ä¿¡æ¯ï¼ˆç”¨æˆ·ç«¯å¯æŸ¥çœ‹ï¼Œå±äºå…¬å¼€æ¥å£ï¼‰
  // âš ï¸ è¿™ä¸¤ä¸ªæ¥å£èµ° userRequestï¼Œåç«¯ä¸è¦å¼ºåˆ¶ escortToken
  getEscorts: (params?: EscortQueryParams) => userRequest<EscortListResponse>('/escorts'),
  getEscortDetail: (id: string) => userRequest<EscortDetail>(`/escorts/${id}`),
  
  // ========== Escort Channel ==========
  // âš ï¸ ä»¥ä¸‹æ¥å£å¿…é¡» escortTokenï¼Œåç«¯å¼ºæ ¡éªŒ
  
  // å·¥ä½œå°
  getWorkbenchStats: () => escortRequest<WorkbenchStats>('/escort-app/workbench/stats'),
  getOrderPool: () => escortRequest<OrderPoolResponse>('/escort-app/orders/pool'),
  getWorkbenchOrderDetail: (id: string) => escortRequest<WorkbenchOrderDetail>(`/escort-app/orders/${id}`),
  
  // æ”¶å…¥ä¸æç°
  getEarningsStats: () => escortRequest<EarningsStats>('/escort-app/earnings/stats'),
  getWithdrawInfo: () => escortRequest<WithdrawInfo>('/escort-app/withdraw/info'),
  
  // é™ªè¯Šå‘˜èµ„æ–™ï¼ˆéœ€ç™»å½•ï¼‰
  getMyEscortProfile: () => escortRequest<EscortProfile>('/escort-app/profile'),
  updateMyEscortProfile: (data: Partial<EscortProfile>) => 
    escortRequest<EscortProfile>('/escort-app/profile', {
      method: 'PATCH',
      body: JSON.stringify(data),
    }),
}
```

---

## äº”ã€ç»ˆç«¯è§†è§’åˆ‡æ¢ä¸å…¥å£ç­–ç•¥

### 5.1 "æˆ‘çš„"é¡µé™ªè¯Šå‘˜å…¥å£ç­–ç•¥

#### å…¥å£æ˜¾ç¤ºæ¡ä»¶

æ™®é€šç”¨æˆ·é»˜è®¤ä¸å±•ç¤ºé™ªè¯Šå‘˜å…¥å£ï¼Œæ»¡è¶³ä»»ä¸€æ¡ä»¶æ—¶æ˜¾ç¤ºï¼š

1. **æ¨èæ–¹æ¡ˆ**ï¼š`userProfile.hasEscortAccount === true`ï¼ˆåç«¯è¿”å›æç¤ºå­—æ®µï¼‰
2. **å¤‡é€‰æ–¹æ¡ˆ**ï¼šç”¨æˆ·ç‚¹å‡»"é™ªè¯Šå‘˜å…¥å£"åå†éªŒè¯ï¼ŒéªŒè¯å¤±è´¥åˆ™ä¸è¿›å…¥

#### å…¥å£äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     é™ªè¯Šå‘˜å…¥å£äº¤äº’æµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ç”¨æˆ·ç‚¹å‡»ã€Œé™ªè¯Šå‘˜å…¥å£ã€                                          â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ å¼¹å‡ºç™»å½•éªŒè¯æ¡†   â”‚                                           â”‚
â”‚  â”‚ Â· è´¦å·å¯†ç        â”‚                                           â”‚
â”‚  â”‚ Â· éªŒè¯ç          â”‚                                           â”‚
â”‚  â”‚ Â· å·¥å·ç™»å½•       â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                              â”‚
â”‚     â”‚           â”‚                                               â”‚
â”‚  éªŒè¯æˆåŠŸ    éªŒè¯å¤±è´¥                                            â”‚
â”‚     â”‚           â”‚                                               â”‚
â”‚     â–¼           â–¼                                               â”‚
â”‚  å†™å…¥ escortToken    æç¤ºé”™è¯¯                                    â”‚
â”‚  åˆ‡æ¢åˆ°é™ªè¯Šå‘˜è§†è§’    ä¿æŒç”¨æˆ·è§†è§’                                 â”‚
â”‚  è·³è½¬å·¥ä½œå°                                                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 é€€å‡ºé™ªè¯Šå‘˜è§†è§’

- é™ªè¯Šå‘˜è§†è§’ä¸‹æä¾›ã€Œé€€å‡ºé™ªè¯Šå‘˜ã€æŒ‰é’®ï¼ˆå»ºè®®åœ¨é™ªè¯Šå‘˜ç«¯"æˆ‘çš„/è®¾ç½®"ï¼‰
- é€€å‡ºå³æ¸…é™¤ `escortToken`ï¼Œå›åˆ°ç”¨æˆ·è§†è§’
- **ä¸å½±å“ userToken**ï¼Œç”¨æˆ·ä»ä¿æŒç™»å½•çŠ¶æ€

### 5.3 ViewerRole æŒä¹…åŒ–ç­–ç•¥

- `viewerRole` **ä¸å»ºè®®å•ç‹¬æŒä¹…åŒ–**
- ä»¥ `escortToken` æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆä½œä¸ºåˆ¤å®š
- åˆ·æ–°é¡µé¢åï¼š
  - è‹¥ `escortToken` ä»æœ‰æ•ˆ â†’ è‡ªåŠ¨ä¿æŒé™ªè¯Šå‘˜è§†è§’
  - å¦åˆ™å›åˆ°ç”¨æˆ·è§†è§’

### 5.4 å®ç°ä»£ç ç¤ºä¾‹

```typescript
// hooks/useViewerRole.ts
import { useState, useEffect, useCallback } from 'react'

const ESCORT_TOKEN_KEY = 'escort_token'

export function useViewerRole() {
  const [viewerRole, setViewerRole] = useState<'user' | 'escort'>('user')
  
  // åˆå§‹åŒ–æ—¶æ£€æŸ¥ escortToken
  useEffect(() => {
    const escortToken = localStorage.getItem(ESCORT_TOKEN_KEY)
    if (escortToken) {
      // å¯é€‰ï¼šéªŒè¯ token æœ‰æ•ˆæ€§
      setViewerRole('escort')
    }
  }, [])
  
  // é™ªè¯Šå‘˜ç™»å½•
  const loginAsEscort = useCallback(async (credentials: EscortCredentials) => {
    const response = await fetch('/api/escort-app/login', {
      method: 'POST',
      body: JSON.stringify(credentials),
    })
    
    if (!response.ok) {
      throw new Error('ç™»å½•å¤±è´¥')
    }
    
    const { token, escort } = await response.json()
    localStorage.setItem(ESCORT_TOKEN_KEY, token)
    setViewerRole('escort')
    
    return escort
  }, [])
  
  // é€€å‡ºé™ªè¯Šå‘˜
  const logoutEscort = useCallback(() => {
    localStorage.removeItem(ESCORT_TOKEN_KEY)
    setViewerRole('user')
  }, [])
  
  return {
    viewerRole,
    isEscort: viewerRole === 'escort',
    isUser: viewerRole === 'user',
    loginAsEscort,
    logoutEscort,
  }
}
```

---

## å…­ã€é¢„è§ˆå™¨è§†è§’æ¨¡æ‹Ÿ

### 6.1 Props æ‰©å±•

```typescript
export interface TerminalPreviewProps {
  // ... å…¶ä»–å±æ€§
  
  // è§†è§’æ§åˆ¶ï¼ˆç”¨äºé¢„è§ˆå™¨æ¨¡æ‹Ÿï¼‰
  viewerRole?: 'user' | 'escort'
  
  // åŒä¼šè¯æ¨¡æ‹Ÿ
  userSession?: { token?: string; userId?: string }
  escortSession?: { token?: string; escortId?: string }
}
```

### 6.2 é¢„è§ˆå™¨è°ƒè¯•é¢æ¿

åœ¨é¢„è§ˆå™¨é¡¶éƒ¨å¢åŠ è°ƒè¯•é¢æ¿ï¼š

```typescript
function PreviewerDebugPanel({
  viewerRole,
  onViewerRoleChange,
  escortSession,
  onEscortSessionChange,
}: DebugPanelProps) {
  return (
    <div className="flex items-center gap-2 px-2 py-1 bg-gray-100 text-xs">
      {/* è§†è§’åˆ‡æ¢ */}
      <div className="flex items-center gap-1">
        <span>è§†è§’:</span>
        <button 
          className={viewerRole === 'user' ? 'font-bold' : ''}
          onClick={() => onViewerRoleChange('user')}
        >
          ç”¨æˆ·
        </button>
        <span>/</span>
        <button 
          className={viewerRole === 'escort' ? 'font-bold' : ''}
          onClick={() => onViewerRoleChange('escort')}
        >
          é™ªè¯Šå‘˜
        </button>
      </div>
      
      {/* é™ªè¯Šå‘˜ä¼šè¯æ¨¡æ‹Ÿ */}
      {viewerRole === 'escort' && (
        <div className="flex items-center gap-1 ml-2">
          <span>ä¼šè¯:</span>
          <select 
            value={escortSession ? 'mock' : 'none'}
            onChange={(e) => onEscortSessionChange(
              e.target.value === 'mock' 
                ? { token: 'mock-token', escortId: 'mock-id' }
                : null
            )}
          >
            <option value="none">æ— </option>
            <option value="mock">æ¨¡æ‹Ÿ</option>
          </select>
        </div>
      )}
      
      {/* API é€šé“æŒ‡ç¤º */}
      <div className="ml-auto text-gray-500">
        {viewerRole === 'escort' ? 'ğŸ” Escort API' : 'ğŸ‘¤ User API'}
      </div>
    </div>
  )
}
```

---

## ä¸ƒã€é£é™©è¯„ä¼°

### 7.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| ä»…å‰ç«¯å­—æ®µæ§åˆ¶å¯¼è‡´è¶Šæƒ | é«˜ | ä¸­ | ä»¥ `escortToken` ä¸ºå”¯ä¸€å‡­è¯ï¼Œåç«¯å¼ºæ ¡éªŒ |
| token ä¸²ç”¨å¯¼è‡´æ¥å£å¼‚å¸¸/æ•°æ®é”™ä¹± | ä¸­ | ä¸­ | `userRequest`/`escortRequest` åŒé€šé“å°è£… |
| ä¸¤å¥—è´¦å·ç¼ºå°‘å…³è”å¯¼è‡´å…¥å£ä½“éªŒå·® | ä¸­ | ä¸­ | åç«¯è¿”å› `hasEscortAccount` æˆ–æä¾›ç»‘å®šæµç¨‹ |

### 7.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| é™ªè¯Šå‘˜è¯¯å…¥ç”¨æˆ·æ€é¡µé¢é€ æˆå›°æƒ‘ | ä½ | ä¸­ | é™ªè¯Šå‘˜è§†è§’ä¸‹æä¾›æ˜æ˜¾çš„"å½“å‰è§†è§’"æ ‡è¯†ä¸é€€å‡ºå…¥å£ |
| è´¦å·é£æ§ï¼ˆé™ªè¯Šå‘˜ç™»å½•è¢«ç›—ç”¨ï¼‰ | é«˜ | ä½ | äºŒæ¬¡éªŒè¯ã€è®¾å¤‡ç»‘å®šã€å¼‚å¸¸ç™»å½•æé†’ï¼ˆå¯åç»­ï¼‰ |

---

## å…«ã€æˆåŠŸæ ‡å‡†

- âœ… åŒä¸€ç»ˆç«¯æ”¯æŒ UserSession ä¸ EscortSession å¹¶å­˜ä¸”äº’ä¸å½±å“
- âœ… EscortSession æœ‰æ•ˆæ—¶å±•ç¤ºé™ªè¯Šå‘˜è§†è§’ï¼ˆå…¥å£ã€å­—æ®µã€TabBarã€é¡µé¢æƒé™ï¼‰
- âœ… EscortSession å¤±æ•ˆæˆ–é€€å‡ºåè‡ªåŠ¨å›åˆ°ç”¨æˆ·è§†è§’
- âœ… é™ªè¯Šå‘˜æ¥å£å¿…é¡»å¼ºæ ¡éªŒ `escortToken`ï¼Œæ™®é€šç”¨æˆ·ä¸å¯è¶Šæƒè°ƒç”¨
- âœ… é¢„è§ˆå™¨æ”¯æŒè§†è§’æ¨¡æ‹Ÿå’Œä¼šè¯æ¨¡æ‹Ÿ

