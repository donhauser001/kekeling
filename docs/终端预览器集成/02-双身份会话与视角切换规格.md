# åŒèº«ä»½ä¼šè¯ä¸è§†è§’åˆ‡æ¢è§„æ ¼

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.5  
> **åˆ›å»ºæ—¥æœŸ**: 2024-12-12  
> **æœ€åæ›´æ–°**: 2024-12-12ï¼ˆé™ªè¯Šå‘˜çŸ­ä¿¡ç™»å½• API å·²å®ç°ï¼‰  
> **çŠ¶æ€**: âœ… åç«¯ API å·²å°±ç»ª  
> **è¿”å›**: [æ€»è§ˆ](./README.md)

---

## ä¸€ã€èƒŒæ™¯ä¸çº¦æŸ

### 1.1 ç³»ç»Ÿç°çŠ¶

- å½“å‰é™ªè¯Šå‘˜ä¸æ™®é€šç”¨æˆ·ä¸º **ä¸¤å¥—ç”¨æˆ·ç³»ç»Ÿ**ï¼ˆä¸¤å¥—è´¦å·ä½“ç³»ã€ä¸¤å¥—é‰´æƒï¼‰
- æ™®é€šç”¨æˆ·ä¸é™ªè¯Šå‘˜å…±ç”¨åŒä¸€ç»ˆç«¯ï¼ˆå°ç¨‹åº/App/H5 ä»ä¸ºä¸€å¥—ï¼‰
- ä¸åŒè§’è‰²æ‹¥æœ‰ä¸åŒç•Œé¢è§†è§’ï¼ˆå­—æ®µã€å…¥å£ã€TabBarã€å¯è®¿é—®é¡µé¢ä¸åŒï¼‰

### 1.2 è®¾è®¡ç›®æ ‡

- ä¸å¼€å‘é¢å¤–ç»ˆç«¯
- åœ¨"æˆ‘çš„"é¡µé¢æä¾›ã€Œé™ªè¯Šå‘˜å…¥å£ã€ï¼Œå¯¹æ™®é€šç”¨æˆ·éšè—
- é™ªè¯Šå‘˜å¯åœ¨åŒä¸€ç»ˆç«¯å†…è‡ªç”±åˆ‡æ¢è§†è§’ï¼š
  - é€€å‡ºé™ªè¯Šå‘˜è§†è§’ = å›åˆ°æ™®é€šç”¨æˆ·è§†è§’
  - è¿›å…¥é™ªè¯Šå‘˜è§†è§’ = è¿›è¡Œé™ªè¯Šå‘˜ç™»å½•éªŒè¯

### 1.3 å®‰å…¨çº¦æŸ

> âš ï¸ **å¼ºåˆ¶è§„åˆ™**ï¼šä»…é å‰ç«¯éšè—å…¥å£ä¸æ„æˆå®‰å…¨è¾¹ç•Œï¼Œ**å¿…é¡»ç”±åç«¯é‰´æƒå…œåº•**

---

## äºŒã€åŒä¼šè¯ï¼ˆDual-Sessionï¼‰æ¨¡å‹

### 2.1 ä¼šè¯å®šä¹‰

ç”±äºé™ªè¯Šå‘˜ä¸æ™®é€šç”¨æˆ·ä¸ºä¸¤å¥—ç”¨æˆ·ç³»ç»Ÿï¼Œç»ˆç«¯éœ€è¦åŒæ—¶æ”¯æŒä¸¤ç§ç‹¬ç«‹é‰´æƒæ€ï¼š

| ä¼šè¯ç±»å‹ | Token | ç”¨é€” |
|---------|-------|------|
| **UserSession** | `userToken` | ç”¨æˆ·ç«¯åŠŸèƒ½ï¼šæœåŠ¡ã€ç—…å†ã€è¥é”€ä¸­å¿ƒã€ä¸ªäººä¸­å¿ƒç­‰ |
| **EscortSession** | `escortToken` | é™ªè¯Šå‘˜ç«¯åŠŸèƒ½ï¼šå·¥ä½œå°ã€è®¢å•æ± ã€æ”¶å…¥æç°ã€é™ªè¯Šå‘˜èµ„æ–™ç­‰ |

### 2.2 è§†è§’åˆ‡æ¢ä¾æ®

```
viewerRole = escort  å½“ä¸”ä»…å½“ escortToken å­˜åœ¨ä¸”åç«¯éªŒè¯æœ‰æ•ˆ
viewerRole = user    å…¶ä»–æƒ…å†µ
```

> âœ… **å¼ºåˆ¶è§„åˆ™**ï¼šé™ªè¯Šå‘˜è§†è§’ä¸æ˜¯ä¸€ä¸ªå‰ç«¯å¸ƒå°”å­—æ®µï¼Œè€Œæ˜¯ä¸€ä»½ç‹¬ç«‹å¯æ ¡éªŒçš„é™ªè¯Šå‘˜ä¼šè¯ï¼ˆescortTokenï¼‰

### 2.3 Token æœ‰æ•ˆæ€§åˆ¤å®šè§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰

> âš ï¸ **è¿™æ˜¯å¼ºåˆ¶è§„èŒƒï¼Œä¸æ˜¯å¯é€‰é¡¹**

#### åˆ¤å®šæ—¶æœº

| åœºæ™¯ | åˆ¤å®šæ–¹å¼ | å¤±è´¥å¤„ç† |
|------|---------|---------|
| **è¿›å…¥ escort è§†è§’** | å¿…é¡»è°ƒç”¨ `/escort-app/session/validate` æˆåŠŸ | æ¸…ç©º escortTokenï¼Œå›é€€ user è§†è§’ |
| **é¡µé¢åˆ·æ–°/åº”ç”¨å¯åŠ¨** | è‹¥ localStorage æœ‰ escortTokenï¼Œå…ˆè°ƒç”¨ validate | å¤±è´¥åˆ™æ¸… tokenï¼Œé™é»˜å›é€€ user |
| **è¯·æ±‚ escort API** | åç«¯ 401 å“åº” | æ¸… token + åˆ‡å› user + Toast æç¤º |

#### éªŒè¯æ¥å£å®šä¹‰

```typescript
// è½»é‡é‰´æƒæ¥å£ï¼ˆå»ºè®® < 100ms å“åº”ï¼‰
GET /escort-app/session/validate

// æˆåŠŸå“åº”
{ "valid": true, "escortId": "xxx", "expiresAt": "2024-12-13T00:00:00Z" }

// å¤±è´¥å“åº”
401 Unauthorized
```

#### å®ç°ä»£ç 

```typescript
// éªŒè¯ escortToken æœ‰æ•ˆæ€§ï¼ˆå¼ºåˆ¶ï¼Œéå¯é€‰ï¼‰
async function validateEscortSession(): Promise<boolean> {
  const escortToken = getEscortToken()
  if (!escortToken) return false
  
  try {
    const response = await fetch('/api/escort-app/session/validate', {
      headers: { 'Authorization': `Bearer ${escortToken}` }
    })
    return response.ok
  } catch {
    return false
  }
}

// è¿›å…¥ escort è§†è§’æ—¶å¿…é¡»è°ƒç”¨
async function enterEscortMode(): Promise<boolean> {
  const isValid = await validateEscortSession()
  if (!isValid) {
    clearEscortToken()
    return false  // å›é€€ user è§†è§’
  }
  return true  // å…è®¸è¿›å…¥ escort è§†è§’
}
```

### 2.4 ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¼šè¯ç”Ÿå‘½å‘¨æœŸ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  UserSession                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åˆ›å»ºï¼šç”¨æˆ·ç™»å½•ï¼ˆå¾®ä¿¡æˆæƒ/æ‰‹æœºå·ç™»å½•ï¼‰                      â”‚   â”‚
â”‚  â”‚ ç»­æœŸï¼šè‡ªåŠ¨åˆ·æ–° / ç”¨æˆ·æ“ä½œæ—¶                               â”‚   â”‚
â”‚  â”‚ å¤±æ•ˆï¼šç”¨æˆ·é€€å‡ºç™»å½• / Token è¿‡æœŸ                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  EscortSession                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ åˆ›å»ºï¼šé™ªè¯Šå‘˜äºŒæ¬¡ç™»å½•éªŒè¯æˆåŠŸ                              â”‚   â”‚
â”‚  â”‚ ç»­æœŸï¼šè‡ªåŠ¨åˆ·æ–° / é™ªè¯Šå‘˜æ“ä½œæ—¶                             â”‚   â”‚
â”‚  â”‚ å¤±æ•ˆï¼šä¸»åŠ¨é€€å‡ºé™ªè¯Šå‘˜ / Token è¿‡æœŸ                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  âš ï¸ ä¼šè¯è”åŠ¨è§„åˆ™ï¼ˆå¼ºåˆ¶ï¼‰ï¼š                                      â”‚
â”‚     - EscortSession å¤±æ•ˆ â†’ ä¸å½±å“ UserSession                  â”‚
â”‚     - UserSession å¤±æ•ˆ â†’ å¼ºåˆ¶åŒæ—¶æ¸…é™¤ EscortSession            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5 UserSession å¤±æ•ˆè”åŠ¨ç­–ç•¥ï¼ˆå¼ºåˆ¶ï¼‰

> âš ï¸ **è¿™æ˜¯å¼ºåˆ¶è§„èŒƒï¼Œå¿…é¡»ç»Ÿä¸€å®ç°**

**é€‰å®šç­–ç•¥ï¼šA) UserSession å¤±æ•ˆå¼ºåˆ¶åŒæ—¶æ¸…é™¤ EscortSession**

| åœºæ™¯ | å¤„ç†é€»è¾‘ | åŸå›  |
|------|---------|------|
| userToken è¿‡æœŸ/å¤±æ•ˆ | æ¸…é™¤ userToken + escortTokenï¼Œè·³è½¬ç™»å½•é¡µ | å®‰å…¨ä¼˜å…ˆï¼šé¿å…"ç”¨æˆ·å·²é€€å‡ºä½†é™ªè¯Šå‘˜ä»åœ¨çº¿"çš„é£é™© |
| ç”¨æˆ·ä¸»åŠ¨é€€å‡ºç™»å½• | åŒä¸Š | ç»Ÿä¸€è¡Œä¸º |
| userRequest æ”¶åˆ° 401 | åŒä¸Š | åç«¯å·²åˆ¤å®šç”¨æˆ·æ— æ•ˆ |

**å®ç°ä»£ç ï¼š**

```typescript
// ç”¨æˆ·ç™»å‡ºï¼ˆåŒ…å«è”åŠ¨æ¸…é™¤ï¼‰
function logoutUser(): void {
  // æ¸…é™¤åŒ token
  clearUserToken()
  clearEscortToken()
  
  // è·³è½¬ç™»å½•é¡µ
  navigateTo('/pages/login/index')
}

// userRequest æ”¶åˆ° 401 æ—¶
if (response.status === 401) {
  logoutUser()  // å¼ºåˆ¶æ¸…é™¤åŒ token
  throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
}
```

**ä¸ºä»€ä¹ˆé€‰ A è€Œä¸æ˜¯ Bï¼ˆç‹¬ç«‹å­˜åœ¨ï¼‰ï¼š**
1. å®‰å…¨è¾¹ç•Œæ›´æ¸…æ™°ï¼šç”¨æˆ·èº«ä»½æ˜¯åŸºç¡€ï¼Œé™ªè¯Šå‘˜æ˜¯é™„åŠ èº«ä»½
2. é¿å…"å¹½çµä¼šè¯"ï¼šç”¨æˆ·å·²é€€å‡ºä½†é™ªè¯Šå‘˜ token ä»å¯å‘èµ·è¯·æ±‚
3. åç«¯é€šå¸¸ä¹Ÿä¼šè”åŠ¨å¤±æ•ˆï¼ˆuserToken å¤±æ•ˆæ—¶ escortToken çš„æˆæƒåŸºç¡€ä¹Ÿä¸å­˜åœ¨äº†ï¼‰

---

## ä¸‰ã€åç«¯é‰´æƒç¡¬çº¦æŸï¼ˆå®‰å…¨è¾¹ç•Œï¼‰

### 3.1 API è®¿é—®æ§åˆ¶

| API è·¯å¾„ | æ‰€éœ€ Token | è¯´æ˜ |
|---------|-----------|------|
| `/api/*`ï¼ˆé€šç”¨ï¼‰ | `userToken` | æ™®é€šç”¨æˆ·æ¥å£ |
| `/api/escort-app/**` | `escortToken` | é™ªè¯Šå‘˜å·¥ä½œå°æ¥å£ |
| `/api/escorts/**`ï¼ˆç®¡ç†ï¼‰ | `escortToken` | é™ªè¯Šå‘˜èµ„æ–™ç®¡ç† |
| `/api/escorts`ï¼ˆå…¬å¼€åˆ—è¡¨ï¼‰ | `userToken` | ç”¨æˆ·ç«¯æŸ¥çœ‹é™ªè¯Šå‘˜åˆ—è¡¨ |

### 3.2 å¼ºåˆ¶è§„åˆ™

1. **æ‰€æœ‰é™ªè¯Šå‘˜ç›¸å…³ API å¿…é¡»æ ¡éªŒ escortToken**
   - `/escort-app/**`
   - `/escorts/**`ï¼ˆé™¤å…¬å¼€åˆ—è¡¨å¤–ï¼‰

2. **æ™®é€šç”¨æˆ· token ä¸å¯è®¿é—®é™ªè¯Šå‘˜æ¥å£**
   - è¿”å› 401/403

3. **æ™®é€šç”¨æˆ·æ¥å£ä¸åº”è¿”å›é™ªè¯Šå‘˜ä¸“å±å­—æ®µ**
   - é¿å…"UI éšè—ä½†æ•°æ®æ³„éœ²"

### 3.3 åç«¯å®ç°å»ºè®®

```typescript
// NestJS Guard ç¤ºä¾‹
@Injectable()
export class EscortAuthGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest()
    const escortToken = request.headers['x-escort-token'] 
      || request.headers['authorization']?.replace('Bearer ', '')
    
    if (!escortToken) {
      throw new UnauthorizedException('éœ€è¦é™ªè¯Šå‘˜ç™»å½•')
    }
    
    const escort = this.validateEscortToken(escortToken)
    if (!escort) {
      throw new UnauthorizedException('é™ªè¯Šå‘˜ç™»å½•å·²è¿‡æœŸ')
    }
    
    request.escort = escort
    return true
  }
}

// æ§åˆ¶å™¨ä½¿ç”¨
@Controller('escort-app')
@UseGuards(EscortAuthGuard)
export class EscortAppController {
  @Get('workbench/stats')
  getWorkbenchStats(@Req() req) {
    return this.service.getStats(req.escort.id)
  }
}
```

---

## å››ã€è¯·æ±‚å±‚åŒé€šé“å°è£…

### 4.1 å°è£…åŸåˆ™

ä¸ºé¿å… token ä¸²ç”¨å¯¼è‡´æ•°æ®é”™ä¹±ï¼Œåœ¨è¯·æ±‚å±‚åšå¼ºåˆ¶åˆ†æµï¼š

- `userRequest()` è‡ªåŠ¨æºå¸¦ `userToken`
- `escortRequest()` è‡ªåŠ¨æºå¸¦ `escortToken`

> âœ… **å¼ºåˆ¶è§„åˆ™**ï¼šé™ªè¯Šå‘˜ API ä¸å…è®¸èµ° `userRequest`ï¼›ç”¨æˆ· API ä¸å…è®¸èµ° `escortRequest`ï¼ˆé™¤éæ˜ç¡®å…è®¸ï¼‰

> ğŸš¨ **å¼ºåˆ¶è§„èŒƒ**ï¼šä¸šåŠ¡é¡µé¢**ä¸å¾—ç›´æ¥ä½¿ç”¨ fetch/axios**ï¼Œå¿…é¡»èµ° `request` / `userRequest` / `escortRequest` å°è£…ã€‚è¿åæ­¤è§„åˆ™çš„ä»£ç åœ¨ Code Review æ—¶å¿…é¡»æ‰“å›ã€‚

### 4.2 Token å­˜å‚¨ä¸è¯»å–è§„èŒƒï¼ˆå¿…é¡»ç»Ÿä¸€ï¼‰

| ç¯å¢ƒ | userToken å­˜å‚¨ | escortToken å­˜å‚¨ | å®‰å…¨å»ºè®® |
|------|---------------|-----------------|---------|
| **å°ç¨‹åº** | `wx.setStorageSync('userToken', token)` | `wx.setStorageSync('escortToken', token)` | å¾®ä¿¡æ²™ç®±éš”ç¦» |
| **H5 ç»ˆç«¯** | `localStorage.setItem('kekeling_userToken', token)` | `localStorage.setItem('kekeling_escortToken', token)` | åŠ å‘½åç©ºé—´é˜²å†²çª |
| **ç®¡ç†åå°é¢„è§ˆå™¨** | é€šè¿‡ Props æ³¨å…¥ mock tokenï¼Œ**ä¸è½åœ°å­˜å‚¨** | é€šè¿‡ Props æ³¨å…¥ mock tokenï¼Œ**ä¸è½åœ°å­˜å‚¨** | mock æ•°æ®ä¸è§¦ç¢°çœŸå®å­˜å‚¨ |

#### å­˜å‚¨å®‰å…¨çº¦æŸ

| çº¦æŸé¡¹ | è§„èŒƒ |
|--------|------|
| **Key éš”ç¦»** | `userToken` ä¸ `escortToken` å¿…é¡»åˆ†ç¦»ï¼Œç¦æ­¢å¤ç”¨åŒä¸€ key |
| **å‘½åç©ºé—´** | H5 ç¯å¢ƒå¿…é¡»åŠ  `kekeling_` å‰ç¼€ï¼Œé¿å…ä¸å…¶ä»–åº”ç”¨å†²çª |
| **XSS é˜²æŠ¤** | ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨ httpOnly cookieï¼ˆéœ€åç«¯é…åˆï¼‰ï¼ŒlocalStorage ä½œä¸ºé™çº§æ–¹æ¡ˆ |
| **ç¦æ­¢æ˜æ–‡æ—¥å¿—** | ç¦æ­¢åœ¨ console.log ä¸­æ‰“å°å®Œæ•´ token |

> âš ï¸ **å¼ºåˆ¶è§„èŒƒ**ï¼šå…¨ç«¯ç»Ÿä¸€ key å‘½åè§„åˆ™ï¼Œç¦æ­¢è‡ªå®šä¹‰ã€‚å°ç¨‹åºç”¨ `userToken`/`escortToken`ï¼ŒH5 ç”¨ `kekeling_userToken`/`kekeling_escortToken`ã€‚

### 4.3 ç»Ÿä¸€é”™è¯¯ç å¤„ç†

| é”™è¯¯ç  | åœºæ™¯ | å¤„ç†ç­–ç•¥ |
|--------|------|---------|
| **401** | `escortRequest` æ”¶åˆ° | 1. æ¸…ç©º `escortToken`<br>2. å¼ºåˆ¶åˆ‡å› user è§†è§’<br>3. Toast: "é™ªè¯Šå‘˜ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•" |
| **401** | `userRequest` æ”¶åˆ° | 1. æ¸…ç©º `userToken`<br>2. è·³è½¬ç™»å½•é¡µ |
| **403** | æƒé™ä¸è¶³ | æç¤ºæ— æƒé™ï¼Œä¸æ¸… token |

### 4.4 å®ç°ä»£ç 

```typescript
// api.ts

const USER_TOKEN_KEY = 'userToken'
const ESCORT_TOKEN_KEY = 'escortToken'

// å°ç¨‹åºç¯å¢ƒåˆ¤æ–­
const isWeapp = typeof wx !== 'undefined' && wx.getStorageSync

// è·å–ç”¨æˆ· Token
function getUserToken(): string | null {
  if (isWeapp) {
    return wx.getStorageSync(USER_TOKEN_KEY) || null
  }
  return localStorage.getItem(USER_TOKEN_KEY)
}

// è·å–é™ªè¯Šå‘˜ Token
function getEscortToken(): string | null {
  if (isWeapp) {
    return wx.getStorageSync(ESCORT_TOKEN_KEY) || null
  }
  return localStorage.getItem(ESCORT_TOKEN_KEY)
}

// æ¸…é™¤é™ªè¯Šå‘˜ Token
function clearEscortToken(): void {
  if (isWeapp) {
    wx.removeStorageSync(ESCORT_TOKEN_KEY)
  } else {
    localStorage.removeItem(ESCORT_TOKEN_KEY)
  }
}

// ç”¨æˆ·é€šé“è¯·æ±‚
async function userRequest<T>(endpoint: string, options?: RequestInit): Promise<T> {
  const headers = new Headers(options?.headers)
  const userToken = getUserToken()
  if (userToken) {
    headers.set('Authorization', `Bearer ${userToken}`)
  }
  
  const response = await fetch(`/api${endpoint}`, {
    ...options,
    headers,
  })
  
  if (!response.ok) {
    if (response.status === 401) {
      // ç”¨æˆ·ç™»å½•å¤±æ•ˆï¼Œè·³è½¬ç™»å½•
      throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•')
    }
    throw new Error(`HTTP ${response.status}`)
  }
  
  const result = await response.json()
  return result.data
}

// é™ªè¯Šå‘˜é€šé“è¯·æ±‚
async function escortRequest<T>(endpoint: string, options?: RequestInit): Promise<T> {
  const headers = new Headers(options?.headers)
  const escortToken = getEscortToken()
  
  if (!escortToken) {
    throw new Error('éœ€è¦é™ªè¯Šå‘˜ç™»å½•')
  }
  
  headers.set('Authorization', `Bearer ${escortToken}`)
  
  const response = await fetch(`/api${endpoint}`, {
    ...options,
    headers,
  })
  
  if (!response.ok) {
    if (response.status === 401) {
      // æ¸…é™¤æ— æ•ˆçš„ escortToken
      clearEscortToken()
      // è§¦å‘è§†è§’åˆ‡æ¢ï¼ˆéœ€è¦é…åˆçŠ¶æ€ç®¡ç†ï¼‰
      window.dispatchEvent(new CustomEvent('escort-session-expired'))
      throw new Error('é™ªè¯Šå‘˜ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•')
    }
    throw new Error(`HTTP ${response.status}`)
  }
  
  const result = await response.json()
  return result.data
}
```

### 4.5 è¯·æ±‚é€šé“é€‰æ‹©æœºåˆ¶ï¼ˆæ‹¦æˆªå™¨ç¡¬è§„åˆ™ï¼‰

> âš ï¸ **è¿™æ˜¯å¼ºåˆ¶è§„èŒƒï¼Œé¿å…"è¯·æ±‚æˆåŠŸä½†æ•°æ®é”™ä½"**

#### é€šé“é€‰æ‹©è§„åˆ™

```typescript
// è¯·æ±‚é€šé“é€‰æ‹©å™¨ï¼ˆåœ¨æ‹¦æˆªå™¨å±‚å®ç°ï¼‰
function selectRequestChannel(endpoint: string, viewerRole: ViewerRole): 'user' | 'escort' {
  // è§„åˆ™ 1ï¼šescort åŸŸæ¥å£å¿…é¡»èµ° escortRequest
  const isEscortApi = endpoint.startsWith('/escort-app/')
  
  if (isEscortApi) {
    if (viewerRole !== 'escort') {
      // è§„åˆ™ 2ï¼šå½“å‰é escort è§†è§’å´è¯·æ±‚ escort API â†’ æŠ›é”™
      throw new ChannelMismatchError(
        `æ¥å£ ${endpoint} éœ€è¦é™ªè¯Šå‘˜èº«ä»½ï¼Œå½“å‰è§†è§’ä¸ºç”¨æˆ·`
      )
    }
    return 'escort'
  }
  
  // è§„åˆ™ 3ï¼šå…¶ä»–æ¥å£ä¸€å¾‹èµ° userRequest
  return 'user'
}
```

#### æ··ç”¨æ£€æµ‹ä¸è°ƒè¯•é¢æ¿æç¤º

```typescript
class ChannelMismatchError extends Error {
  constructor(message: string) {
    super(message)
    this.name = 'ChannelMismatchError'
    
    // åœ¨è°ƒè¯•é¢æ¿å±•ç¤ºé”™è¯¯
    if (process.env.NODE_ENV === 'development') {
      console.error(`ğŸš¨ [Channel Mismatch] ${message}`)
      // è§¦å‘è°ƒè¯•é¢æ¿è­¦å‘Š
      window.dispatchEvent(new CustomEvent('channel-mismatch', { 
        detail: { message } 
      }))
    }
  }
}
```

#### ç»Ÿä¸€è¯·æ±‚å…¥å£

```typescript
// ç»Ÿä¸€è¯·æ±‚å…¥å£ï¼ˆæ¨èä½¿ç”¨ï¼‰
async function request<T>(endpoint: string, options?: RequestInit): Promise<T> {
  const viewerRole = getCurrentViewerRole()
  const channel = selectRequestChannel(endpoint, viewerRole)
  
  if (channel === 'escort') {
    return escortRequest<T>(endpoint, options)
  }
  return userRequest<T>(endpoint, options)
}
```

### 4.6 API åˆ†ç±»ä¸æ¥å£å±æ€§

#### æ¥å£å±æ€§å®šä¹‰

| æ¥å£è·¯å¾„ | æ¥å£å±æ€§ | æ‰€éœ€ Token | è¯´æ˜ |
|---------|---------|-----------|------|
| `/escorts` | **å…¬å¼€ä¿¡æ¯** | `userToken` æˆ–åŒ¿å | ç”¨æˆ·ç«¯æµè§ˆé™ªè¯Šå‘˜åˆ—è¡¨ |
| `/escorts/:id` | **å…¬å¼€ä¿¡æ¯** | `userToken` æˆ–åŒ¿å | ç”¨æˆ·ç«¯æŸ¥çœ‹é™ªè¯Šå‘˜è¯¦æƒ… |
| `/escort-app/**` | **é™ªè¯Šå‘˜å·¥ä½œå°** | `escortToken` **å¿…é¡»** | é™ªè¯Šå‘˜ä¸“å±åŠŸèƒ½ |

> âš ï¸ **åç«¯åŒäº‹æ³¨æ„**ï¼š`/escorts` å’Œ `/escorts/:id` æ˜¯å…¬å¼€æ¥å£ï¼Œç”¨æˆ·ç«¯éœ€è¦è®¿é—®ï¼Œ**ä¸è¦å¼ºåˆ¶ escortToken**ï¼Œå¦åˆ™ç”¨æˆ·ç«¯é™ªè¯Šå‘˜åˆ—è¡¨ä¼šæŒ‚æ‰ã€‚

#### API åˆ†ç±»ä»£ç 

```typescript
export const previewApi = {
  // ========== User Channel ==========
  
  // ä¸»é¢˜ä¸é¦–é¡µ
  getThemeSettings: () => userRequest<ThemeSettings>('/config/theme/settings'),
  getHomePageSettings: () => userRequest<HomePageSettings>('/home/page-settings'),
  
  // è¥é”€ä¸­å¿ƒ
  getMembershipLevels: () => userRequest<MembershipLevel[]>('/marketing/membership/levels'),
  getMyMembership: () => userRequest<MembershipInfo | null>('/marketing/membership/my'),
  getMembershipPlans: () => userRequest<MembershipPlan[]>('/marketing/membership/plans'),
  getMyCoupons: () => userRequest<CouponListResponse>('/marketing/coupons/my'),
  getAvailableCoupons: () => userRequest<Coupon[]>('/marketing/coupons/available'),
  getMyPoints: () => userRequest<PointsInfo>('/marketing/points/my'),
  getPointsRecords: () => userRequest<PointsRecord[]>('/marketing/points/records'),
  getReferralInfo: () => userRequest<ReferralInfo>('/marketing/referrals/info'),
  getCampaigns: () => userRequest<Campaign[]>('/marketing/campaigns'),
  getCampaignDetail: (id: string) => userRequest<CampaignDetail>(`/marketing/campaigns/${id}`),
  
  // é™ªè¯Šå‘˜å…¬å¼€ä¿¡æ¯ï¼ˆç”¨æˆ·ç«¯å¯æŸ¥çœ‹ï¼Œå±äºå…¬å¼€æ¥å£ï¼‰
  // âš ï¸ è¿™ä¸¤ä¸ªæ¥å£èµ° userRequestï¼Œåç«¯ä¸è¦å¼ºåˆ¶ escortToken
  getEscorts: (params?: EscortQueryParams) => userRequest<EscortListResponse>('/escorts'),
  getEscortDetail: (id: string) => userRequest<EscortDetail>(`/escorts/${id}`),
  
  // ========== Escort Channel ==========
  // âš ï¸ ä»¥ä¸‹æ¥å£å¿…é¡» escortTokenï¼Œåç«¯å¼ºæ ¡éªŒ
  
  // å·¥ä½œå°
  getWorkbenchStats: () => escortRequest<WorkbenchStats>('/escort-app/workbench/stats'),
  getOrderPool: () => escortRequest<OrderPoolResponse>('/escort-app/orders/pool'),
  getWorkbenchOrderDetail: (id: string) => escortRequest<WorkbenchOrderDetail>(`/escort-app/orders/${id}`),
  
  // æ”¶å…¥ä¸æç°
  getEarningsStats: () => escortRequest<EarningsStats>('/escort-app/earnings/stats'),
  getWithdrawInfo: () => escortRequest<WithdrawInfo>('/escort-app/withdraw/info'),
  
  // é™ªè¯Šå‘˜èµ„æ–™ï¼ˆéœ€ç™»å½•ï¼‰
  getMyEscortProfile: () => escortRequest<EscortProfile>('/escort-app/profile'),
  updateMyEscortProfile: (data: Partial<EscortProfile>) => 
    escortRequest<EscortProfile>('/escort-app/profile', {
      method: 'PATCH',
      body: JSON.stringify(data),
    }),
}
```

---

## äº”ã€ç»ˆç«¯è§†è§’åˆ‡æ¢ä¸å…¥å£ç­–ç•¥

### 5.1 "æˆ‘çš„"é¡µé™ªè¯Šå‘˜å…¥å£ç­–ç•¥

#### å…¥å£æ˜¾ç¤ºæ¡ä»¶

æ™®é€šç”¨æˆ·é»˜è®¤ä¸å±•ç¤ºé™ªè¯Šå‘˜å…¥å£ï¼Œæ»¡è¶³ä»»ä¸€æ¡ä»¶æ—¶æ˜¾ç¤ºï¼š

1. **æ¨èæ–¹æ¡ˆ**ï¼š`userProfile.hasEscortAccount === true`ï¼ˆåç«¯è¿”å›æç¤ºå­—æ®µï¼‰
2. **å¤‡é€‰æ–¹æ¡ˆ**ï¼šç”¨æˆ·ç‚¹å‡»"é™ªè¯Šå‘˜å…¥å£"åå†éªŒè¯ï¼ŒéªŒè¯å¤±è´¥åˆ™ä¸è¿›å…¥

#### å…¥å£äº¤äº’æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     é™ªè¯Šå‘˜å…¥å£äº¤äº’æµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ç”¨æˆ·ç‚¹å‡»ã€Œé™ªè¯Šå‘˜å…¥å£ã€                                          â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ å¼¹å‡ºç™»å½•éªŒè¯æ¡†   â”‚                                           â”‚
â”‚  â”‚ Â· è´¦å·å¯†ç        â”‚                                           â”‚
â”‚  â”‚ Â· éªŒè¯ç          â”‚                                           â”‚
â”‚  â”‚ Â· å·¥å·ç™»å½•       â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                              â”‚
â”‚     â”‚           â”‚                                               â”‚
â”‚  éªŒè¯æˆåŠŸ    éªŒè¯å¤±è´¥                                            â”‚
â”‚     â”‚           â”‚                                               â”‚
â”‚     â–¼           â–¼                                               â”‚
â”‚  å†™å…¥ escortToken    æç¤ºé”™è¯¯                                    â”‚
â”‚  åˆ‡æ¢åˆ°é™ªè¯Šå‘˜è§†è§’    ä¿æŒç”¨æˆ·è§†è§’                                 â”‚
â”‚  è·³è½¬å·¥ä½œå°                                                      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 é€€å‡ºé™ªè¯Šå‘˜è§†è§’

- é™ªè¯Šå‘˜è§†è§’ä¸‹æä¾›ã€Œé€€å‡ºé™ªè¯Šå‘˜ã€æŒ‰é’®ï¼ˆå»ºè®®åœ¨é™ªè¯Šå‘˜ç«¯"æˆ‘çš„/è®¾ç½®"ï¼‰
- é€€å‡ºå³æ¸…é™¤ `escortToken`ï¼Œå›åˆ°ç”¨æˆ·è§†è§’
- **ä¸å½±å“ userToken**ï¼Œç”¨æˆ·ä»ä¿æŒç™»å½•çŠ¶æ€

### 5.3 ViewerRole æŒä¹…åŒ–ç­–ç•¥

- `viewerRole` **ä¸å»ºè®®å•ç‹¬æŒä¹…åŒ–**
- ä»¥ `escortToken` æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆä½œä¸ºåˆ¤å®š
- åˆ·æ–°é¡µé¢åï¼š
  - è‹¥ `escortToken` ä»æœ‰æ•ˆ â†’ è‡ªåŠ¨ä¿æŒé™ªè¯Šå‘˜è§†è§’
  - å¦åˆ™å›åˆ°ç”¨æˆ·è§†è§’

### 5.4 å®ç°ä»£ç ç¤ºä¾‹

```typescript
// hooks/useViewerRole.ts
import { useState, useEffect, useCallback } from 'react'

const ESCORT_TOKEN_KEY = 'escortToken'

export function useViewerRole() {
  const [viewerRole, setViewerRole] = useState<'user' | 'escort'>('user')
  const [isValidating, setIsValidating] = useState(false)
  
  // åˆå§‹åŒ–æ—¶æ£€æŸ¥ escortTokenï¼ˆå¼ºåˆ¶éªŒè¯ï¼Œéå¯é€‰ï¼‰
  useEffect(() => {
    const escortToken = localStorage.getItem(ESCORT_TOKEN_KEY)
    if (escortToken) {
      // å¼ºåˆ¶éªŒè¯ token æœ‰æ•ˆæ€§
      setIsValidating(true)
      validateEscortSession()
        .then(isValid => {
          if (isValid) {
            setViewerRole('escort')
          } else {
            // éªŒè¯å¤±è´¥ï¼Œæ¸…é™¤æ— æ•ˆ token
            localStorage.removeItem(ESCORT_TOKEN_KEY)
            setViewerRole('user')
          }
        })
        .finally(() => setIsValidating(false))
    }
  }, [])
  
  // é™ªè¯Šå‘˜ç™»å½•
  const loginAsEscort = useCallback(async (credentials: EscortCredentials) => {
    const response = await fetch('/api/escort-app/login', {
      method: 'POST',
      body: JSON.stringify(credentials),
    })
    
    if (!response.ok) {
      throw new Error('ç™»å½•å¤±è´¥')
    }
    
    const { token, escort } = await response.json()
    localStorage.setItem(ESCORT_TOKEN_KEY, token)
    setViewerRole('escort')
    
    return escort
  }, [])
  
  // é€€å‡ºé™ªè¯Šå‘˜
  const logoutEscort = useCallback(() => {
    localStorage.removeItem(ESCORT_TOKEN_KEY)
    setViewerRole('user')
  }, [])
  
  return {
    viewerRole,
    isEscort: viewerRole === 'escort',
    isUser: viewerRole === 'user',
    loginAsEscort,
    logoutEscort,
  }
}
```

---

## å…­ã€é¢„è§ˆå™¨è§†è§’æ¨¡æ‹Ÿ

### 6.1 Props æ‰©å±•

```typescript
export interface TerminalPreviewProps {
  // ... å…¶ä»–å±æ€§
  
  // è§†è§’æ§åˆ¶ï¼ˆç”¨äºé¢„è§ˆå™¨æ¨¡æ‹Ÿï¼‰
  viewerRole?: 'user' | 'escort'
  
  // åŒä¼šè¯æ¨¡æ‹Ÿ
  userSession?: { token?: string; userId?: string }
  escortSession?: { token?: string; escortId?: string }
}
```

### 6.2 é¢„è§ˆå™¨è°ƒè¯•é¢æ¿

åœ¨é¢„è§ˆå™¨é¡¶éƒ¨å¢åŠ è°ƒè¯•é¢æ¿ï¼š

```typescript
function PreviewerDebugPanel({
  viewerRole,
  onViewerRoleChange,
  escortSession,
  onEscortSessionChange,
}: DebugPanelProps) {
  return (
    <div className="flex items-center gap-2 px-2 py-1 bg-gray-100 text-xs">
      {/* è§†è§’åˆ‡æ¢ */}
      <div className="flex items-center gap-1">
        <span>è§†è§’:</span>
        <button 
          className={viewerRole === 'user' ? 'font-bold' : ''}
          onClick={() => onViewerRoleChange('user')}
        >
          ç”¨æˆ·
        </button>
        <span>/</span>
        <button 
          className={viewerRole === 'escort' ? 'font-bold' : ''}
          onClick={() => onViewerRoleChange('escort')}
        >
          é™ªè¯Šå‘˜
        </button>
      </div>
      
      {/* é™ªè¯Šå‘˜ä¼šè¯æ¨¡æ‹Ÿ */}
      {viewerRole === 'escort' && (
        <div className="flex items-center gap-1 ml-2">
          <span>ä¼šè¯:</span>
          <select 
            value={escortSession ? 'mock' : 'none'}
            onChange={(e) => onEscortSessionChange(
              e.target.value === 'mock' 
                ? { token: 'mock-token', escortId: 'mock-id' }
                : null
            )}
          >
            <option value="none">æ— </option>
            <option value="mock">æ¨¡æ‹Ÿ</option>
          </select>
        </div>
      )}
      
      {/* API é€šé“æŒ‡ç¤º */}
      <div className="ml-auto text-gray-500">
        {viewerRole === 'escort' ? 'ğŸ” Escort API' : 'ğŸ‘¤ User API'}
      </div>
    </div>
  )
}
```

---

## ä¸ƒã€é£é™©è¯„ä¼°

### 7.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| ä»…å‰ç«¯å­—æ®µæ§åˆ¶å¯¼è‡´è¶Šæƒ | é«˜ | ä¸­ | ä»¥ `escortToken` ä¸ºå”¯ä¸€å‡­è¯ï¼Œåç«¯å¼ºæ ¡éªŒ |
| token ä¸²ç”¨å¯¼è‡´æ¥å£å¼‚å¸¸/æ•°æ®é”™ä¹± | ä¸­ | ä¸­ | `userRequest`/`escortRequest` åŒé€šé“å°è£… |
| ä¸¤å¥—è´¦å·ç¼ºå°‘å…³è”å¯¼è‡´å…¥å£ä½“éªŒå·® | ä¸­ | ä¸­ | åç«¯è¿”å› `hasEscortAccount` æˆ–æä¾›ç»‘å®šæµç¨‹ |

### 7.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| é™ªè¯Šå‘˜è¯¯å…¥ç”¨æˆ·æ€é¡µé¢é€ æˆå›°æƒ‘ | ä½ | ä¸­ | é™ªè¯Šå‘˜è§†è§’ä¸‹æä¾›æ˜æ˜¾çš„"å½“å‰è§†è§’"æ ‡è¯†ä¸é€€å‡ºå…¥å£ |
| è´¦å·é£æ§ï¼ˆé™ªè¯Šå‘˜ç™»å½•è¢«ç›—ç”¨ï¼‰ | é«˜ | ä½ | äºŒæ¬¡éªŒè¯ã€è®¾å¤‡ç»‘å®šã€å¼‚å¸¸ç™»å½•æé†’ï¼ˆå¯åç»­ï¼‰ |

---

## å…«ã€æˆåŠŸæ ‡å‡†

- âœ… åŒä¸€ç»ˆç«¯æ”¯æŒ UserSession ä¸ EscortSession å¹¶å­˜ä¸”äº’ä¸å½±å“
- âœ… EscortSession æœ‰æ•ˆæ—¶å±•ç¤ºé™ªè¯Šå‘˜è§†è§’ï¼ˆå…¥å£ã€å­—æ®µã€TabBarã€é¡µé¢æƒé™ï¼‰
- âœ… EscortSession å¤±æ•ˆæˆ–é€€å‡ºåè‡ªåŠ¨å›åˆ°ç”¨æˆ·è§†è§’
- âœ… é™ªè¯Šå‘˜æ¥å£å¿…é¡»å¼ºæ ¡éªŒ `escortToken`ï¼Œæ™®é€šç”¨æˆ·ä¸å¯è¶Šæƒè°ƒç”¨
- âœ… é¢„è§ˆå™¨æ”¯æŒè§†è§’æ¨¡æ‹Ÿå’Œä¼šè¯æ¨¡æ‹Ÿ

