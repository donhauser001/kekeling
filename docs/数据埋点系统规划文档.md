# æ•°æ®åŸ‹ç‚¹ç³»ç»Ÿè§„åˆ’æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv1.0  
> åˆ›å»ºæ—¥æœŸï¼š2024-12-11  
> çŠ¶æ€ï¼šğŸ“‹ è§„åˆ’ä¸­

---

## ä¸€ã€æ¦‚è¿°

### 1.1 ç³»ç»Ÿå®šä½

æ•°æ®åŸ‹ç‚¹ç³»ç»Ÿæ˜¯ç§‘ç§‘çµé™ªè¯Šå¹³å°çš„æ•°æ®åŸºç¡€è®¾æ–½ï¼Œç”¨äºå…¨é¢æ”¶é›†ç”¨æˆ·è¡Œä¸ºæ•°æ®ã€ä¸šåŠ¡äº‹ä»¶æ•°æ®å’Œç³»ç»Ÿæ€§èƒ½æ•°æ®ï¼Œä¸ºäº§å“ä¼˜åŒ–ã€è¿è¥å†³ç­–ã€é£æ§ç›‘æµ‹å’Œæ™ºèƒ½æ¨èæä¾›æ•°æ®æ”¯æ’‘ã€‚

### 1.2 æ ¸å¿ƒç›®æ ‡

| ç›®æ ‡ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|------|------|--------|
| **ä¸šåŠ¡åˆ†æ** | æ”¯æŒè®¢å•è½¬åŒ–ç‡ã€ç”¨æˆ·ç•™å­˜ã€é™ªè¯Šå‘˜æ´»è·ƒåº¦ç­‰æ ¸å¿ƒæŒ‡æ ‡åˆ†æ | P0 |
| **äº§å“ä¼˜åŒ–** | é€šè¿‡ç”¨æˆ·è¡Œä¸ºæ•°æ®ä¼˜åŒ–äº§å“åŠŸèƒ½å’Œç”¨æˆ·ä½“éªŒ | P0 |
| **è¿è¥å†³ç­–** | ä¸ºè¿è¥æ´»åŠ¨ã€å®šä»·ç­–ç•¥ã€æ¨å¹¿æ¸ é“æä¾›æ•°æ®æ”¯æŒ | P1 |
| **é£æ§ç›‘æµ‹** | å®æ—¶ç›‘æµ‹å¼‚å¸¸è¡Œä¸ºï¼Œä¿éšœå¹³å°å®‰å…¨ | P1 |
| **æ™ºèƒ½æ¨è** | åŸºäºç”¨æˆ·è¡Œä¸ºæ•°æ®ä¼˜åŒ–æ¨èç®—æ³• | P2 |

### 1.3 è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **æœ€å°å¿…è¦** | åªé‡‡é›†ä¸šåŠ¡å¿…éœ€çš„æ•°æ®ï¼Œä¸è¿‡åº¦æ”¶é›†ç”¨æˆ·éšç§ä¿¡æ¯ |
| **å‡†ç¡®å¯é ** | ç¡®ä¿æ•°æ®å‡†ç¡®æ€§ï¼Œæœ‰å®Œå–„çš„æ ¡éªŒå’Œè¡¥å¿æœºåˆ¶ |
| **æ€§èƒ½ä¼˜å…ˆ** | åŸ‹ç‚¹ä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹ï¼Œé‡‡ç”¨å¼‚æ­¥ã€æ‰¹é‡ä¸ŠæŠ¥ |
| **éšç§åˆè§„** | éµå®ˆã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ï¼Œæ•æ„Ÿæ•°æ®è„±æ•å¤„ç† |
| **å¯æ‰©å±•æ€§** | æ”¯æŒçµæ´»çš„äº‹ä»¶å®šä¹‰å’Œå±æ€§æ‰©å±• |

---

## äºŒã€ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æ•°æ®åŸ‹ç‚¹ç³»ç»Ÿæ¶æ„                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  æ•°æ®é‡‡é›†å±‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ å°ç¨‹åºç«¯    â”‚  â”‚ H5ç«¯        â”‚  â”‚ ç®¡ç†åå°    â”‚  â”‚ åç«¯æœåŠ¡    â”‚       â”‚
â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚       â”‚
â”‚  â”‚ Â· é¡µé¢æµè§ˆ  â”‚  â”‚ Â· é¡µé¢æµè§ˆ  â”‚  â”‚ Â· æ“ä½œæ—¥å¿—  â”‚  â”‚ Â· ä¸šåŠ¡äº‹ä»¶  â”‚       â”‚
â”‚  â”‚ Â· ç”¨æˆ·è¡Œä¸º  â”‚  â”‚ Â· ç”¨æˆ·è¡Œä¸º  â”‚  â”‚ Â· å®¡æ‰¹æµç¨‹  â”‚  â”‚ Â· çŠ¶æ€å˜æ›´  â”‚       â”‚
â”‚  â”‚ Â· æ€§èƒ½æ•°æ®  â”‚  â”‚ Â· æ€§èƒ½æ•°æ®  â”‚  â”‚ Â· é…ç½®å˜æ›´  â”‚  â”‚ Â· æ¥å£è°ƒç”¨  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                â”‚                â”‚                â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  æ•°æ®æ”¶é›†å±‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Tracking API Gateway                           â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚ æ•°æ®æ ¡éªŒ  â”‚â†’ â”‚ æ•°æ®æ¸…æ´—  â”‚â†’ â”‚ æ•°æ®è½¬æ¢  â”‚â†’ â”‚ é™æµæ§åˆ¶  â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  æ•°æ®å¤„ç†å±‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Event Processing Service                       â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚ å®æ—¶å¤„ç†  â”‚  â”‚ æ‰¹é‡å¤„ç†  â”‚  â”‚ æ•°æ®èšåˆ  â”‚  â”‚ æŒ‡æ ‡è®¡ç®—  â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                        â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚               â”‚               â”‚                        â”‚
â”‚                    â–¼               â–¼               â–¼                        â”‚
â”‚  æ•°æ®å­˜å‚¨å±‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ PostgreSQL    â”‚  â”‚ Redis         â”‚  â”‚ ClickHouse    â”‚                  â”‚
â”‚  â”‚ (åŸå§‹äº‹ä»¶)    â”‚  â”‚ (å®æ—¶æŒ‡æ ‡)    â”‚  â”‚ (OLAPåˆ†æ)    â”‚                  â”‚
â”‚  â”‚ ä¿ç•™30å¤©      â”‚  â”‚ å®æ—¶ç¼“å­˜      â”‚  â”‚ é•¿æœŸå­˜å‚¨      â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  æ•°æ®åº”ç”¨å±‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ å®æ—¶çœ‹æ¿    â”‚  â”‚ æ•°æ®æŠ¥è¡¨    â”‚  â”‚ é£æ§ç›‘æµ‹    â”‚  â”‚ æ™ºèƒ½æ¨è    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯é€‰å‹

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|---------|------|
| **å‰ç«¯SDK** | TypeScript + Taro | æ”¯æŒå°ç¨‹åºå’ŒH5ï¼Œç»Ÿä¸€API |
| **åç«¯æœåŠ¡** | NestJS + Prisma | ä¸ç°æœ‰æŠ€æœ¯æ ˆä¸€è‡´ |
| **æ•°æ®å­˜å‚¨** | PostgreSQL + Redis + ClickHouse | åˆ†å±‚å­˜å‚¨ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ |
| **æ¶ˆæ¯é˜Ÿåˆ—** | Redis Stream / BullMQ | å¼‚æ­¥å¤„ç†ï¼Œå‰Šå³°å¡«è°· |
| **å®æ—¶è®¡ç®—** | Redis + å®šæ—¶ä»»åŠ¡ | å®æ—¶æŒ‡æ ‡è®¡ç®— |
| **æ•°æ®å¯è§†åŒ–** | ECharts / Chart.js | æ•°æ®çœ‹æ¿å±•ç¤º |

---

## ä¸‰ã€æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ ¸å¿ƒäº‹ä»¶æ¨¡å‹

```typescript
/**
 * åŸ‹ç‚¹äº‹ä»¶åŸºç¡€æ¥å£
 */
interface TrackingEvent {
  // äº‹ä»¶æ ‡è¯†
  eventId: string;                   // äº‹ä»¶å”¯ä¸€IDï¼ˆUUIDï¼‰
  eventName: string;                 // äº‹ä»¶åç§°ï¼ˆå¦‚ï¼špage_view, order_createdï¼‰
  eventTime: string;                 // äº‹ä»¶æ—¶é—´ï¼ˆISO8601æ ¼å¼ï¼‰
  
  // ç”¨æˆ·æ ‡è¯†
  userId?: string;                   // ç”¨æˆ·IDï¼ˆç™»å½•ç”¨æˆ·ï¼‰
  escortId?: string;                 // é™ªè¯Šå‘˜IDï¼ˆé™ªè¯Šå‘˜ç”¨æˆ·ï¼‰
  deviceId: string;                  // è®¾å¤‡IDï¼ˆè®¾å¤‡å”¯ä¸€æ ‡è¯†ï¼‰
  sessionId: string;                 // ä¼šè¯IDï¼ˆå•æ¬¡ä¼šè¯ï¼‰
  
  // è®¾å¤‡ä¿¡æ¯
  platform: 'miniapp' | 'h5' | 'admin' | 'server';
  deviceType?: string;               // è®¾å¤‡ç±»å‹ï¼ˆiPhone, Androidç­‰ï¼‰
  osName?: string;                   // æ“ä½œç³»ç»Ÿï¼ˆiOS, Android, Windowsç­‰ï¼‰
  osVersion?: string;                // ç³»ç»Ÿç‰ˆæœ¬
  appVersion?: string;               // åº”ç”¨ç‰ˆæœ¬
  
  // ä½ç½®ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œéœ€ç”¨æˆ·æˆæƒï¼‰
  latitude?: number;
  longitude?: number;
  cityCode?: string;
  
  // ä¸šåŠ¡å±æ€§ï¼ˆäº‹ä»¶ç›¸å…³çš„ä¸šåŠ¡æ•°æ®ï¼‰
  properties: Record<string, any>;
  
  // æ¥æºä¿¡æ¯
  source?: string;                   // æ¥æºæ¸ é“ï¼ˆwechat, alipayç­‰ï¼‰
  campaign?: string;                 // æ´»åŠ¨æ ‡è¯†
  referrer?: string;                 // å¼•èæ¥æº
  utmSource?: string;                // UTMæ¥æº
  utmMedium?: string;                // UTMåª’ä»‹
  utmCampaign?: string;              // UTMæ´»åŠ¨
}
```

### 3.2 æ•°æ®åº“æ¨¡å‹

```prisma
// åŸå§‹äº‹ä»¶è¡¨ï¼ˆPostgreSQLï¼‰
model TrackingEvent {
  id              String   @id @default(uuid())
  
  // äº‹ä»¶ä¿¡æ¯
  eventName       String   @map("event_name")
  eventTime       DateTime @map("event_time")
  
  // ç”¨æˆ·æ ‡è¯†
  userId          String?  @map("user_id")
  escortId        String?  @map("escort_id")
  deviceId        String   @map("device_id")
  sessionId       String   @map("session_id")
  
  // è®¾å¤‡ä¿¡æ¯
  platform        String
  deviceType      String?  @map("device_type")
  osName          String?  @map("os_name")
  osVersion       String?  @map("os_version")
  appVersion      String?  @map("app_version")
  
  // ä½ç½®ä¿¡æ¯
  latitude        Float?
  longitude       Float?
  cityCode        String?  @map("city_code")
  
  // ä¸šåŠ¡å±æ€§ï¼ˆJSONæ ¼å¼ï¼‰
  properties      Json
  
  // æ¥æºä¿¡æ¯
  source          String?
  campaign        String?
  referrer        String?
  utmSource       String?  @map("utm_source")
  utmMedium       String?  @map("utm_medium")
  utmCampaign     String?  @map("utm_campaign")
  
  createdAt       DateTime @default(now()) @map("created_at")
  
  // ç´¢å¼•
  @@index([eventName])
  @@index([userId])
  @@index([escortId])
  @@index([eventTime])
  @@index([platform, eventTime])
  @@index([cityCode, eventTime])
  @@map("tracking_events")
}

// æ¯æ—¥æŒ‡æ ‡å¿«ç…§è¡¨ï¼ˆPostgreSQLï¼‰
model DailyMetrics {
  id              String   @id @default(uuid())
  date            DateTime @unique @map("date")
  
  // ç”¨æˆ·æŒ‡æ ‡
  newUsers        Int      @default(0) @map("new_users")
  activeUsers     Int      @default(0) @map("active_users")
  totalUsers      Int      @default(0) @map("total_users")
  
  // è®¢å•æŒ‡æ ‡
  newOrders       Int      @default(0) @map("new_orders")
  completedOrders Int      @default(0) @map("completed_orders")
  cancelledOrders Int      @default(0) @map("cancelled_orders")
  totalRevenue    Decimal  @db.Decimal(10, 2) @default(0) @map("total_revenue")
  
  // é™ªè¯Šå‘˜æŒ‡æ ‡
  activeEscorts   Int      @default(0) @map("active_escorts")
  newEscorts      Int      @default(0) @map("new_escorts")
  totalEscorts    Int      @default(0) @map("total_escorts")
  
  // è½¬åŒ–ç‡
  orderConversionRate Float? @map("order_conversion_rate")
  escortActivationRate Float? @map("escort_activation_rate")
  
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("daily_metrics")
}

// å®æ—¶æŒ‡æ ‡ç¼“å­˜ï¼ˆRedisï¼‰
// Key: tracking:metrics:{date}:{metric}
// Value: number
// TTL: 7å¤©
```

---

## å››ã€åŸ‹ç‚¹äº‹ä»¶å®šä¹‰

### 4.1 äº‹ä»¶åˆ†ç±»

#### 4.1.1 é¡µé¢æµè§ˆäº‹ä»¶

| äº‹ä»¶å | è¯´æ˜ | è§¦å‘æ—¶æœº | å…³é”®å±æ€§ |
|--------|------|---------|---------|
| `page_view` | é¡µé¢æµè§ˆ | é¡µé¢åŠ è½½å®Œæˆ | `pagePath`, `pageTitle`, `referrer` |
| `page_leave` | é¡µé¢ç¦»å¼€ | é¡µé¢å¸è½½ | `pagePath`, `duration` |

#### 4.1.2 ç”¨æˆ·è¡Œä¸ºäº‹ä»¶

| äº‹ä»¶å | è¯´æ˜ | è§¦å‘æ—¶æœº | å…³é”®å±æ€§ |
|--------|------|---------|---------|
| `button_click` | æŒ‰é’®ç‚¹å‡» | ç”¨æˆ·ç‚¹å‡»æŒ‰é’® | `buttonId`, `buttonText`, `pagePath` |
| `form_submit` | è¡¨å•æäº¤ | è¡¨å•æäº¤ | `formId`, `formName`, `success` |
| `search` | æœç´¢ | ç”¨æˆ·æœç´¢ | `keyword`, `resultCount` |
| `filter_change` | ç­›é€‰å˜æ›´ | ç­›é€‰æ¡ä»¶å˜åŒ– | `filterType`, `filterValue` |

#### 4.1.3 è®¢å•ç›¸å…³äº‹ä»¶

| äº‹ä»¶å | è¯´æ˜ | è§¦å‘æ—¶æœº | å…³é”®å±æ€§ |
|--------|------|---------|---------|
| `order_created` | è®¢å•åˆ›å»º | ç”¨æˆ·åˆ›å»ºè®¢å• | `orderId`, `orderNo`, `amount`, `serviceId` |
| `order_paid` | è®¢å•æ”¯ä»˜ | æ”¯ä»˜æˆåŠŸ | `orderId`, `paymentMethod`, `amount` |
| `order_cancelled` | è®¢å•å–æ¶ˆ | è®¢å•å–æ¶ˆ | `orderId`, `cancelReason` |
| `order_completed` | è®¢å•å®Œæˆ | æœåŠ¡å®Œæˆ | `orderId`, `duration`, `rating` |

#### 4.1.4 é™ªè¯Šå‘˜ç›¸å…³äº‹ä»¶

| äº‹ä»¶å | è¯´æ˜ | è§¦å‘æ—¶æœº | å…³é”®å±æ€§ |
|--------|------|---------|---------|
| `escort_register` | é™ªè¯Šå‘˜æ³¨å†Œ | æäº¤æ³¨å†Œç”³è¯· | `escortId`, `phone` |
| `escort_reviewed` | å®¡æ ¸å®Œæˆ | å®¡æ ¸é€šè¿‡/æ‹’ç» | `escortId`, `result`, `reviewTime` |
| `escort_work_status_change` | å·¥ä½œçŠ¶æ€å˜æ›´ | åˆ‡æ¢å·¥ä½œçŠ¶æ€ | `escortId`, `fromStatus`, `toStatus` |
| `order_grab` | æŠ¢å• | é™ªè¯Šå‘˜æŠ¢å• | `orderId`, `escortId`, `success` |
| `order_arrive` | åˆ°è¾¾ | é™ªè¯Šå‘˜åˆ°è¾¾ | `orderId`, `escortId`, `arriveTime` |

#### 4.1.5 ä¸šåŠ¡äº‹ä»¶

| äº‹ä»¶å | è¯´æ˜ | è§¦å‘æ—¶æœº | å…³é”®å±æ€§ |
|--------|------|---------|---------|
| `coupon_claimed` | ä¼˜æƒ åˆ¸é¢†å– | ç”¨æˆ·é¢†å–ä¼˜æƒ åˆ¸ | `couponId`, `couponType`, `source` |
| `coupon_used` | ä¼˜æƒ åˆ¸ä½¿ç”¨ | è®¢å•ä½¿ç”¨ä¼˜æƒ åˆ¸ | `couponId`, `orderId`, `discount` |
| `points_earned` | ç§¯åˆ†è·å– | è·å¾—ç§¯åˆ† | `userId`, `points`, `source` |
| `points_used` | ç§¯åˆ†ä½¿ç”¨ | ä½¿ç”¨ç§¯åˆ† | `userId`, `points`, `orderId` |
| `membership_upgraded` | ä¼šå‘˜å‡çº§ | ä¼šå‘˜ç­‰çº§æå‡ | `userId`, `fromLevel`, `toLevel` |

#### 4.1.6 æ€§èƒ½äº‹ä»¶

| äº‹ä»¶å | è¯´æ˜ | è§¦å‘æ—¶æœº | å…³é”®å±æ€§ |
|--------|------|---------|---------|
| `api_call` | APIè°ƒç”¨ | æ¥å£è¯·æ±‚ | `apiPath`, `method`, `duration`, `status` |
| `page_load` | é¡µé¢åŠ è½½ | é¡µé¢åŠ è½½å®Œæˆ | `pagePath`, `loadTime`, `resourceCount` |
| `error_occurred` | é”™è¯¯å‘ç”Ÿ | å‘ç”Ÿé”™è¯¯ | `errorType`, `errorMessage`, `pagePath` |

### 4.2 äº‹ä»¶å±æ€§è§„èŒƒ

```typescript
// é¡µé¢æµè§ˆäº‹ä»¶å±æ€§
interface PageViewProperties {
  pagePath: string;        // é¡µé¢è·¯å¾„
  pageTitle: string;       // é¡µé¢æ ‡é¢˜
  referrer?: string;       // æ¥æºé¡µé¢
  duration?: number;       // é¡µé¢åœç•™æ—¶é•¿ï¼ˆç§’ï¼‰
}

// è®¢å•äº‹ä»¶å±æ€§
interface OrderEventProperties {
  orderId: string;         // è®¢å•ID
  orderNo: string;         // è®¢å•å·
  amount: number;          // è®¢å•é‡‘é¢
  serviceId?: string;      // æœåŠ¡ID
  hospitalId?: string;     // åŒ»é™¢ID
  escortId?: string;       // é™ªè¯Šå‘˜ID
}

// ç‚¹å‡»äº‹ä»¶å±æ€§
interface ClickEventProperties {
  elementId: string;       // å…ƒç´ ID
  elementText: string;     // å…ƒç´ æ–‡æœ¬
  elementType: string;     // å…ƒç´ ç±»å‹ï¼ˆbutton, linkç­‰ï¼‰
  pagePath: string;        // æ‰€åœ¨é¡µé¢
}
```

---

## äº”ã€å®ç°æ–¹æ¡ˆ

### 5.1 å‰ç«¯SDKè®¾è®¡

#### 5.1.1 SDKåˆå§‹åŒ–

```typescript
// miniapp/src/utils/tracking.ts
import Taro from '@tarojs/taro';

interface TrackingConfig {
  enabled: boolean;              // æ˜¯å¦å¯ç”¨åŸ‹ç‚¹
  apiUrl: string;                // ä¸ŠæŠ¥APIåœ°å€
  batchSize: number;              // æ‰¹é‡ä¸ŠæŠ¥å¤§å°
  batchInterval: number;          // æ‰¹é‡ä¸ŠæŠ¥é—´éš”ï¼ˆæ¯«ç§’ï¼‰
  maxRetries: number;             // æœ€å¤§é‡è¯•æ¬¡æ•°
}

class TrackingSDK {
  private config: TrackingConfig;
  private eventQueue: TrackingEvent[] = [];
  private sessionId: string;
  private deviceId: string;
  private userId?: string;
  private escortId?: string;

  constructor(config: TrackingConfig) {
    this.config = config;
    this.sessionId = this.generateSessionId();
    this.deviceId = this.getOrCreateDeviceId();
    
    // å®šæ—¶æ‰¹é‡ä¸ŠæŠ¥
    if (this.config.enabled) {
      setInterval(() => this.flush(), this.config.batchInterval);
      
      // é¡µé¢å¸è½½æ—¶ä¸ŠæŠ¥
      Taro.onAppHide(() => this.flush());
    }
  }

  // é€šç”¨åŸ‹ç‚¹æ–¹æ³•
  track(eventName: string, properties: Record<string, any> = {}): void {
    if (!this.config.enabled) return;
    
    const event: TrackingEvent = {
      eventId: this.generateEventId(),
      eventName,
      eventTime: new Date().toISOString(),
      userId: this.userId,
      escortId: this.escortId,
      deviceId: this.deviceId,
      sessionId: this.sessionId,
      platform: 'miniapp',
      ...this.getDeviceInfo(),
      ...this.getLocationInfo(),
      properties,
    };
    
    this.eventQueue.push(event);
    
    // è¾¾åˆ°æ‰¹é‡é˜ˆå€¼æ—¶ä¸ŠæŠ¥
    if (this.eventQueue.length >= this.config.batchSize) {
      this.flush();
    }
  }

  // é¡µé¢æµè§ˆåŸ‹ç‚¹
  trackPageView(pagePath: string, pageTitle: string, referrer?: string): void {
    this.track('page_view', {
      pagePath,
      pageTitle,
      referrer: referrer || '',
    });
  }

  // ç‚¹å‡»äº‹ä»¶åŸ‹ç‚¹
  trackClick(elementId: string, elementText: string, extra?: Record<string, any>): void {
    this.track('button_click', {
      elementId,
      elementText,
      ...extra,
    });
  }

  // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
  setUser(userId: string, escortId?: string): void {
    this.userId = userId;
    this.escortId = escortId;
  }

  // æ‰¹é‡ä¸ŠæŠ¥
  async flush(): Promise<void> {
    if (this.eventQueue.length === 0) return;
    
    const events = [...this.eventQueue];
    this.eventQueue = [];
    
    try {
      await Taro.request({
        url: `${this.config.apiUrl}/tracking/events/batch`,
        method: 'POST',
        data: { events },
        header: { 'Content-Type': 'application/json' },
      });
    } catch (error) {
      // ä¸ŠæŠ¥å¤±è´¥ï¼Œé‡æ–°åŠ å…¥é˜Ÿåˆ—
      this.eventQueue.unshift(...events);
      console.error('åŸ‹ç‚¹ä¸ŠæŠ¥å¤±è´¥:', error);
    }
  }

  private generateEventId(): string {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }

  private generateSessionId(): string {
    return `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }

  private getOrCreateDeviceId(): string {
    let deviceId = Taro.getStorageSync('device_id');
    if (!deviceId) {
      deviceId = `device-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      Taro.setStorageSync('device_id', deviceId);
    }
    return deviceId;
  }

  private getDeviceInfo() {
    const systemInfo = Taro.getSystemInfoSync();
    return {
      deviceType: systemInfo.model || '',
      osName: systemInfo.platform || '',
      osVersion: systemInfo.system || '',
      appVersion: systemInfo.version || '',
    };
  }

  private getLocationInfo() {
    // éœ€è¦ç”¨æˆ·æˆæƒï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
    return {
      cityCode: Taro.getStorageSync('city_code') || undefined,
    };
  }
}

// å¯¼å‡ºå•ä¾‹
export const tracking = new TrackingSDK({
  enabled: process.env.NODE_ENV === 'production',
  apiUrl: process.env.API_BASE_URL || '',
  batchSize: 10,
  batchInterval: 5000,
  maxRetries: 3,
});
```

#### 5.1.2 é¡µé¢è‡ªåŠ¨åŸ‹ç‚¹

```typescript
// miniapp/src/utils/page-tracking.ts
import Taro from '@tarojs/taro';
import { tracking } from './tracking';

// é¡µé¢æµè§ˆè‡ªåŠ¨åŸ‹ç‚¹
export function trackPageView(pagePath: string, pageTitle: string) {
  const pages = Taro.getCurrentPages();
  const currentPage = pages[pages.length - 1];
  const referrer = pages.length > 1 ? pages[pages.length - 2].route : undefined;
  
  tracking.trackPageView(pagePath, pageTitle, referrer);
}

// åœ¨é¡µé¢onShowæ—¶è°ƒç”¨
// pages/index/index.tsx
export default function Index() {
  useEffect(() => {
    trackPageView('/pages/index/index', 'é¦–é¡µ');
  }, []);
  
  // ...
}
```

### 5.2 åç«¯æœåŠ¡è®¾è®¡

#### 5.2.1 Tracking Service

```typescript
// server/src/modules/tracking/tracking.service.ts
import { Injectable, Logger } from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';
import { RedisService } from '../redis/redis.service';

@Injectable()
export class TrackingService {
  private readonly logger = new Logger(TrackingService.name);

  constructor(
    private prisma: PrismaService,
    private redis: RedisService,
  ) {}

  // æ‰¹é‡ä¿å­˜äº‹ä»¶
  async saveBatchEvents(events: TrackingEvent[]): Promise<void> {
    try {
      // æ•°æ®æ ¡éªŒ
      const validEvents = events.filter(e => this.validateEvent(e));
      
      if (validEvents.length === 0) {
        return;
      }

      // æ‰¹é‡æ’å…¥æ•°æ®åº“
      await this.prisma.trackingEvent.createMany({
        data: validEvents.map(e => ({
          eventName: e.eventName,
          eventTime: new Date(e.eventTime),
          userId: e.userId,
          escortId: e.escortId,
          deviceId: e.deviceId,
          sessionId: e.sessionId,
          platform: e.platform,
          deviceType: e.deviceType,
          osName: e.osName,
          osVersion: e.osVersion,
          appVersion: e.appVersion,
          latitude: e.latitude,
          longitude: e.longitude,
          cityCode: e.cityCode,
          properties: e.properties,
          source: e.source,
          campaign: e.campaign,
          referrer: e.referrer,
          utmSource: e.utmSource,
          utmMedium: e.utmMedium,
          utmCampaign: e.utmCampaign,
        })),
      });

      // å®æ—¶æ›´æ–°æŒ‡æ ‡
      await this.updateRealTimeMetrics(validEvents);
    } catch (error) {
      this.logger.error('ä¿å­˜åŸ‹ç‚¹äº‹ä»¶å¤±è´¥:', error);
      throw error;
    }
  }

  // è®°å½•ä¸šåŠ¡äº‹ä»¶ï¼ˆåç«¯è°ƒç”¨ï¼‰
  async trackBusinessEvent(
    eventName: string,
    properties: Record<string, any>,
    context?: {
      userId?: string;
      escortId?: string;
      orderId?: string;
    }
  ): Promise<void> {
    const event: TrackingEvent = {
      eventId: this.generateEventId(),
      eventName,
      eventTime: new Date().toISOString(),
      userId: context?.userId,
      escortId: context?.escortId,
      deviceId: 'server',
      sessionId: 'server',
      platform: 'server',
      properties: {
        ...properties,
        orderId: context?.orderId,
      },
    };

    await this.saveBatchEvents([event]);
  }

  // å®æ—¶æ›´æ–°æŒ‡æ ‡
  private async updateRealTimeMetrics(events: TrackingEvent[]): Promise<void> {
    const today = new Date().toISOString().split('T')[0];
    
    for (const event of events) {
      const key = `tracking:metrics:${today}:${event.eventName}`;
      await this.redis.incr(key);
      await this.redis.expire(key, 7 * 24 * 60 * 60); // 7å¤©è¿‡æœŸ
    }
  }

  // äº‹ä»¶æ ¡éªŒ
  private validateEvent(event: TrackingEvent): boolean {
    if (!event.eventName || !event.eventTime || !event.deviceId) {
      return false;
    }
    return true;
  }

  private generateEventId(): string {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
}
```

#### 5.2.2 Tracking Controller

```typescript
// server/src/modules/tracking/tracking.controller.ts
import { Controller, Post, Body, UseGuards } from '@nestjs/common';
import { TrackingService } from './tracking.service';
import { ApiTags, ApiOperation } from '@nestjs/swagger';

@ApiTags('æ•°æ®åŸ‹ç‚¹')
@Controller('tracking')
export class TrackingController {
  constructor(private trackingService: TrackingService) {}

  @Post('events/batch')
  @ApiOperation({ summary: 'æ‰¹é‡ä¸ŠæŠ¥äº‹ä»¶' })
  async batchEvents(@Body() body: { events: TrackingEvent[] }) {
    await this.trackingService.saveBatchEvents(body.events);
    return { success: true };
  }

  @Post('events')
  @ApiOperation({ summary: 'å•äº‹ä»¶ä¸ŠæŠ¥' })
  async singleEvent(@Body() event: TrackingEvent) {
    await this.trackingService.saveBatchEvents([event]);
    return { success: true };
  }
}
```

### 5.3 æ•°æ®èšåˆä¸è®¡ç®—

#### 5.3.1 æ¯æ—¥æŒ‡æ ‡è®¡ç®—

```typescript
// server/src/modules/tracking/metrics.service.ts
@Injectable()
export class MetricsService {
  // è®¡ç®—æ¯æ—¥æŒ‡æ ‡
  async calculateDailyMetrics(date: Date): Promise<void> {
    const startOfDay = new Date(date);
    startOfDay.setHours(0, 0, 0, 0);
    const endOfDay = new Date(date);
    endOfDay.setHours(23, 59, 59, 999);

    // æŸ¥è¯¢å½“æ—¥äº‹ä»¶
    const events = await this.prisma.trackingEvent.findMany({
      where: {
        eventTime: {
          gte: startOfDay,
          lte: endOfDay,
        },
      },
    });

    // è®¡ç®—æŒ‡æ ‡
    const metrics = {
      date: startOfDay,
      newUsers: this.countUniqueUsers(events, 'user_register'),
      activeUsers: this.countUniqueUsers(events, 'page_view'),
      newOrders: this.countEvents(events, 'order_created'),
      completedOrders: this.countEvents(events, 'order_completed'),
      // ... æ›´å¤šæŒ‡æ ‡
    };

    // ä¿å­˜æˆ–æ›´æ–°
    await this.prisma.dailyMetrics.upsert({
      where: { date: startOfDay },
      update: metrics,
      create: metrics,
    });
  }
}
```

---

## å…­ã€æ•°æ®åº”ç”¨åœºæ™¯

### 6.1 å®æ—¶çœ‹æ¿

**æ ¸å¿ƒæŒ‡æ ‡**ï¼š
- ä»Šæ—¥è®¢å•æ•°ã€è®¢å•é‡‘é¢
- ä»Šæ—¥æ–°å¢ç”¨æˆ·æ•°ã€æ´»è·ƒç”¨æˆ·æ•°
- ä»Šæ—¥æ–°å¢é™ªè¯Šå‘˜æ•°ã€æ´»è·ƒé™ªè¯Šå‘˜æ•°
- å®æ—¶è®¢å•è½¬åŒ–ç‡

**æŠ€æœ¯å®ç°**ï¼š
- Rediså­˜å‚¨å®æ—¶æŒ‡æ ‡
- WebSocketæ¨é€æ›´æ–°
- å‰ç«¯å®šæ—¶åˆ·æ–°

### 6.2 æ•°æ®æŠ¥è¡¨

**æŠ¥è¡¨ç±»å‹**ï¼š
- ç”¨æˆ·è¡Œä¸ºåˆ†ææŠ¥è¡¨
- è®¢å•è½¬åŒ–æ¼æ–—åˆ†æ
- é™ªè¯Šå‘˜æ´»è·ƒåº¦åˆ†æ
- æ¸ é“æ•ˆæœåˆ†æ

**æŠ€æœ¯å®ç°**ï¼š
- åŸºäºDailyMetricsè¡¨èšåˆè®¡ç®—
- æ”¯æŒæ—¶é—´èŒƒå›´ç­›é€‰
- å¯¼å‡ºExcel/PDF

### 6.3 é£æ§ç›‘æµ‹

**ç›‘æµ‹æŒ‡æ ‡**ï¼š
- å¼‚å¸¸è®¢å•è¡Œä¸ºï¼ˆé¢‘ç¹å–æ¶ˆã€å¼‚å¸¸é‡‘é¢ï¼‰
- å¼‚å¸¸ç”¨æˆ·è¡Œä¸ºï¼ˆåˆ·å•ã€æ¶æ„æ“ä½œï¼‰
- å¼‚å¸¸é™ªè¯Šå‘˜è¡Œä¸ºï¼ˆåˆ·å•ã€è™šå‡æœåŠ¡ï¼‰

**æŠ€æœ¯å®ç°**ï¼š
- å®æ—¶äº‹ä»¶æµå¤„ç†
- è§„åˆ™å¼•æ“åŒ¹é…
- å‘Šè­¦é€šçŸ¥

### 6.4 æ™ºèƒ½æ¨è

**åº”ç”¨åœºæ™¯**ï¼š
- åŸºäºç”¨æˆ·æµè§ˆå†å²æ¨èæœåŠ¡
- åŸºäºè®¢å•å†å²æ¨èåŒ»é™¢
- åŸºäºé™ªè¯Šå‘˜å†å²æ¨èè®¢å•

**æŠ€æœ¯å®ç°**ï¼š
- ç”¨æˆ·è¡Œä¸ºç‰¹å¾æå–
- ååŒè¿‡æ»¤ç®—æ³•
- å®æ—¶æ¨èæœåŠ¡

---

## ä¸ƒã€å¼€å‘è®¡åˆ’

### 7.1 ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰

**ç›®æ ‡**ï¼šå®ç°åŸºç¡€åŸ‹ç‚¹åŠŸèƒ½ï¼Œæ”¯æŒæ ¸å¿ƒäº‹ä»¶é‡‡é›†

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] åˆ›å»ºTrackingEventæ•°æ®æ¨¡å‹
- [ ] å®ç°TrackingServiceåŸºç¡€åŠŸèƒ½
- [ ] å®ç°TrackingController API
- [ ] å¼€å‘å‰ç«¯TrackingSDK
- [ ] å®ç°é¡µé¢æµè§ˆè‡ªåŠ¨åŸ‹ç‚¹
- [ ] å®ç°è®¢å•ç›¸å…³äº‹ä»¶åŸ‹ç‚¹

**éªŒæ”¶æ ‡å‡†**ï¼š
- èƒ½å¤ŸæˆåŠŸé‡‡é›†é¡µé¢æµè§ˆäº‹ä»¶
- èƒ½å¤ŸæˆåŠŸé‡‡é›†è®¢å•åˆ›å»ºã€æ”¯ä»˜ã€å®Œæˆäº‹ä»¶
- æ•°æ®èƒ½å¤Ÿæ­£ç¡®å­˜å‚¨åˆ°æ•°æ®åº“

### 7.2 ç¬¬äºŒé˜¶æ®µï¼šå®Œå–„åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰

**ç›®æ ‡**ï¼šå®Œå–„åŸ‹ç‚¹åŠŸèƒ½ï¼Œæ”¯æŒæ›´å¤šäº‹ä»¶ç±»å‹

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®ç°ç”¨æˆ·è¡Œä¸ºäº‹ä»¶åŸ‹ç‚¹ï¼ˆç‚¹å‡»ã€æœç´¢ç­‰ï¼‰
- [ ] å®ç°é™ªè¯Šå‘˜ç›¸å…³äº‹ä»¶åŸ‹ç‚¹
- [ ] å®ç°ä¸šåŠ¡äº‹ä»¶åŸ‹ç‚¹ï¼ˆä¼˜æƒ åˆ¸ã€ç§¯åˆ†ç­‰ï¼‰
- [ ] å®ç°æ€§èƒ½äº‹ä»¶åŸ‹ç‚¹
- [ ] å®ç°æ•°æ®æ ¡éªŒå’Œæ¸…æ´—
- [ ] å®ç°æ‰¹é‡ä¸ŠæŠ¥ä¼˜åŒ–

**éªŒæ”¶æ ‡å‡†**ï¼š
- æ‰€æœ‰å®šä¹‰çš„äº‹ä»¶ç±»å‹éƒ½èƒ½æ­£å¸¸é‡‡é›†
- æ•°æ®æ ¡éªŒæœºåˆ¶æ­£å¸¸å·¥ä½œ
- æ‰¹é‡ä¸ŠæŠ¥æ€§èƒ½æ»¡è¶³è¦æ±‚

### 7.3 ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®åˆ†æï¼ˆ2å‘¨ï¼‰

**ç›®æ ‡**ï¼šå®ç°æ•°æ®èšåˆå’ŒæŒ‡æ ‡è®¡ç®—

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®ç°DailyMetricsæ•°æ®æ¨¡å‹
- [ ] å®ç°æ¯æ—¥æŒ‡æ ‡è®¡ç®—å®šæ—¶ä»»åŠ¡
- [ ] å®ç°å®æ—¶æŒ‡æ ‡è®¡ç®—
- [ ] å®ç°æ•°æ®æŸ¥è¯¢API
- [ ] å¼€å‘æ•°æ®çœ‹æ¿å‰ç«¯é¡µé¢

**éªŒæ”¶æ ‡å‡†**ï¼š
- æ¯æ—¥æŒ‡æ ‡èƒ½å¤Ÿæ­£ç¡®è®¡ç®—
- å®æ—¶æŒ‡æ ‡èƒ½å¤Ÿæ­£ç¡®æ›´æ–°
- æ•°æ®çœ‹æ¿èƒ½å¤Ÿæ­£å¸¸å±•ç¤º

### 7.4 ç¬¬å››é˜¶æ®µï¼šé«˜çº§åŠŸèƒ½ï¼ˆ3å‘¨ï¼‰

**ç›®æ ‡**ï¼šå®ç°é«˜çº§åˆ†æåŠŸèƒ½

**ä»»åŠ¡æ¸…å•**ï¼š
- [ ] å®ç°ç”¨æˆ·è¡Œä¸ºåˆ†æ
- [ ] å®ç°è½¬åŒ–æ¼æ–—åˆ†æ
- [ ] å®ç°æ¸ é“æ•ˆæœåˆ†æ
- [ ] å®ç°é£æ§ç›‘æµ‹åŠŸèƒ½
- [ ] å®ç°æ•°æ®å¯¼å‡ºåŠŸèƒ½

**éªŒæ”¶æ ‡å‡†**ï¼š
- å„ç±»åˆ†æåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- é£æ§ç›‘æµ‹èƒ½å¤ŸåŠæ—¶å‘Šè­¦
- æ•°æ®å¯¼å‡ºåŠŸèƒ½æ­£å¸¸

---

## å…«ã€æ€§èƒ½ä¼˜åŒ–

### 8.1 æ•°æ®é‡‡é›†ä¼˜åŒ–

- **æ‰¹é‡ä¸ŠæŠ¥**ï¼šå‰ç«¯äº‹ä»¶å…ˆç¼“å­˜ï¼Œæ‰¹é‡ä¸ŠæŠ¥å‡å°‘è¯·æ±‚
- **å¼‚æ­¥å¤„ç†**ï¼šåç«¯å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ä¸»æµç¨‹
- **æ•°æ®å‹ç¼©**ï¼šä¸ŠæŠ¥æ•°æ®å‹ç¼©ï¼Œå‡å°‘ä¼ è¾“é‡

### 8.2 æ•°æ®å­˜å‚¨ä¼˜åŒ–

- **åˆ†å±‚å­˜å‚¨**ï¼šåŸå§‹æ•°æ®å­˜PostgreSQLï¼Œèšåˆæ•°æ®å­˜ClickHouse
- **æ•°æ®å½’æ¡£**ï¼šå®šæœŸå½’æ¡£å†å²æ•°æ®ï¼Œä¿ç•™æœ€è¿‘30å¤©
- **ç´¢å¼•ä¼˜åŒ–**ï¼šåˆç†åˆ›å»ºç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### 8.3 æŸ¥è¯¢ä¼˜åŒ–

- **ç¼“å­˜ç­–ç•¥**ï¼šå¸¸ç”¨æŒ‡æ ‡ç¼“å­˜åˆ°Redis
- **é¢„èšåˆ**ï¼šæå‰è®¡ç®—å¸¸ç”¨æŒ‡æ ‡ï¼Œé¿å…å®æ—¶è®¡ç®—
- **åˆ†é¡µæŸ¥è¯¢**ï¼šå¤§æ•°æ®é‡æŸ¥è¯¢ä½¿ç”¨åˆ†é¡µ

---

## ä¹ã€éšç§ä¸åˆè§„

### 9.1 æ•°æ®è„±æ•

- æ‰‹æœºå·è„±æ•ï¼šåªå­˜å‚¨å4ä½
- èº«ä»½è¯è„±æ•ï¼šåªå­˜å‚¨å‰6ä½å’Œå4ä½
- åœ°å€è„±æ•ï¼šåªå­˜å‚¨åˆ°åŸå¸‚çº§åˆ«

### 9.2 ç”¨æˆ·æˆæƒ

- ä½ç½®ä¿¡æ¯éœ€è¦ç”¨æˆ·æ˜ç¡®æˆæƒ
- æä¾›éšç§è®¾ç½®é¡µé¢ï¼Œç”¨æˆ·å¯å…³é—­åŸ‹ç‚¹
- éµå®ˆã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ç›¸å…³è§„å®š

### 9.3 æ•°æ®å®‰å…¨

- æ•°æ®ä¼ è¾“ä½¿ç”¨HTTPSåŠ å¯†
- æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- å®šæœŸå®‰å…¨å®¡è®¡

---

## åã€ç›‘æ§ä¸è¿ç»´

### 10.1 ç³»ç»Ÿç›‘æ§

- **åŸ‹ç‚¹æˆåŠŸç‡**ï¼šç›‘æ§åŸ‹ç‚¹ä¸ŠæŠ¥æˆåŠŸç‡
- **æ•°æ®å»¶è¿Ÿ**ï¼šç›‘æ§æ•°æ®å¤„ç†å»¶è¿Ÿ
- **å­˜å‚¨å®¹é‡**ï¼šç›‘æ§æ•°æ®åº“å­˜å‚¨ä½¿ç”¨æƒ…å†µ

### 10.2 å‘Šè­¦æœºåˆ¶

- åŸ‹ç‚¹å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼å‘Šè­¦
- æ•°æ®å»¶è¿Ÿè¶…è¿‡é˜ˆå€¼å‘Šè­¦
- å­˜å‚¨å®¹é‡è¶…è¿‡é˜ˆå€¼å‘Šè­¦

### 10.3 è¿ç»´å·¥å…·

- æ•°æ®æ¸…ç†å·¥å…·
- æ•°æ®è¿ç§»å·¥å…·
- æ€§èƒ½åˆ†æå·¥å…·

---

## åä¸€ã€æ€»ç»“

æ•°æ®åŸ‹ç‚¹ç³»ç»Ÿæ˜¯å¹³å°æ•°æ®é©±åŠ¨çš„åŸºç¡€è®¾æ–½ï¼Œé€šè¿‡ç³»ç»ŸåŒ–çš„æ•°æ®é‡‡é›†ã€å­˜å‚¨å’Œåˆ†æï¼Œä¸ºäº§å“ä¼˜åŒ–ã€è¿è¥å†³ç­–å’Œä¸šåŠ¡å¢é•¿æä¾›æ•°æ®æ”¯æ’‘ã€‚

**å…³é”®æˆåŠŸå› ç´ **ï¼š
1. **æ•°æ®è´¨é‡**ï¼šç¡®ä¿æ•°æ®å‡†ç¡®æ€§å’Œå®Œæ•´æ€§
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹
3. **éšç§åˆè§„**ï¼šéµå®ˆç›¸å…³æ³•å¾‹æ³•è§„
4. **æŒç»­è¿­ä»£**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚ä¸æ–­å®Œå–„

**é¢„æœŸæ”¶ç›Š**ï¼š
- æå‡äº§å“ä¼˜åŒ–æ•ˆç‡
- æ”¯æŒæ•°æ®é©±åŠ¨å†³ç­–
- æå‡ç”¨æˆ·ä½“éªŒ
- é™ä½è¿è¥æˆæœ¬

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2024-12-11  
**ç»´æŠ¤äºº**ï¼šå¼€å‘å›¢é˜Ÿ
