# å¼¹çª—æ–‡ä»¶åˆ†ç¦»è§„èŒƒ

## æ ¸å¿ƒåŸåˆ™ï¼šå½»åº•çš„å°è£…

åˆ†ç¦»ä¸ä»…ä»…æ˜¯æŠŠ JSX æ¬è¿åˆ°å¦ä¸€ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯è¦å®ç°**é€»è¾‘çš„å†…èš**ã€‚

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **Schema å†…èš** | Zod å®šä¹‰ (`formSchema`) å¿…é¡»æ”¾åœ¨å­æ–‡ä»¶å†…ï¼Œçˆ¶ç»„ä»¶ä¸éœ€è¦çŸ¥é“è¡¨å•çš„éªŒè¯è§„åˆ™ |
| **é€»è¾‘å†…èš** | `useForm`ã€æäº¤é€»è¾‘ (`onSubmit`)ã€API è°ƒç”¨å‡å°è£…åœ¨å­æ–‡ä»¶å†… |
| **æ¥å£ç²¾ç®€** | çˆ¶ç»„ä»¶åªè´Ÿè´£æ§åˆ¶"å¼€å…³"å’Œ"ä¼ é€’åˆå§‹æ•°æ®"ï¼Œå­ç»„ä»¶åªè´Ÿè´£"å¤„ç†ä¸šåŠ¡"å’Œ"é€šçŸ¥ç»“æœ" |

---

## æ–‡ä»¶ç›®å½•ç»“æ„

é‡‡ç”¨ **Feature-based** ç»“æ„ï¼Œå°†å¼¹çª—ç»„ä»¶å½’æ¡£åœ¨å½“å‰ä¸šåŠ¡æ¨¡å—çš„ `components` ç›®å½•ä¸‹ã€‚

```text
src/features/{module}/              # ä¸šåŠ¡æ¨¡å—
â”œâ”€â”€ index.tsx                       # ä¸»é¡µé¢ï¼ˆåˆ—è¡¨é¡µï¼‰
â””â”€â”€ components/                     # æ¨¡å—ç‹¬äº«ç»„ä»¶
    â”œâ”€â”€ {module}-action-dialog.tsx  # [æ ¸å¿ƒ] æ–°å»º/ç¼–è¾‘å¼¹çª—
    â”œâ”€â”€ {module}-delete-dialog.tsx  # [æ ¸å¿ƒ] åˆ é™¤ç¡®è®¤å¼¹çª—
    â”œâ”€â”€ {module}-detail-sheet.tsx   # [å¯é€‰] è¯¦æƒ…æŠ½å±‰
    â”œâ”€â”€ {module}-invite-dialog.tsx  # [å¯é€‰] é‚€è¯·å¼¹çª—
    â””â”€â”€ {module}-dialogs.tsx        # [å¯é€‰] å¼¹çª—èšåˆå…¥å£
```

---

## å­æ–‡ä»¶ä»£ç æ¨¡æ¿ (The Child)

è¿™æ˜¯åˆ†ç¦»åçš„æ ‡å‡†å¼¹çª—ç»„ä»¶ç»“æ„ï¼š

```tsx
// src/features/{module}/components/{module}-action-dialog.tsx

import { useEffect, useState } from 'react'
import { z } from 'zod'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { useMutation, useQueryClient } from '@tanstack/react-query'
import { toast } from 'sonner'
import { Loader2 } from 'lucide-react'
import { ConfirmDialog } from '@/components/confirm-dialog'
// ... å…¶ä»– import

// 1. Zod Schema å®šä¹‰åœ¨æ–‡ä»¶å†…éƒ¨ï¼Œä¸æš´éœ²ç»™å¤–éƒ¨
const formSchema = z.object({
  name: z.string().min(1, 'è¯·è¾“å…¥åç§°'),
  // ... å…¶ä»–å­—æ®µ
})

type FormValues = z.infer<typeof formSchema>

// 2. å®šä¹‰æ¸…æ™°çš„ Props æ¥å£
interface ModuleActionDialogProps {
  open: boolean
  onOpenChange: (open: boolean) => void
  currentRow?: ItemType     // å¦‚æœæœ‰å€¼åˆ™æ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œå¦åˆ™æ˜¯æ–°å»º
  onSuccess?: () => void    // æˆåŠŸåçš„å›è°ƒï¼ˆé€šå¸¸ç”¨äºåˆ·æ–°åˆ—è¡¨ï¼‰
}

export function ModuleActionDialog({
  open,
  onOpenChange,
  currentRow,
  onSuccess,
}: ModuleActionDialogProps) {
  const isEdit = !!currentRow
  const queryClient = useQueryClient()
  const [confirmCloseOpen, setConfirmCloseOpen] = useState(false)

  // è¡¨å•é€»è¾‘å®Œå…¨å°é—­åœ¨ç»„ä»¶å†…
  const form = useForm<FormValues>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      name: '',
      // ... å…¶ä»–é»˜è®¤å€¼
    },
  })

  // ç›‘å¬ open å˜åŒ–ä»¥é‡ç½®/å›å¡«è¡¨å•
  useEffect(() => {
    if (open && currentRow) {
      form.reset({
        name: currentRow.name,
        // ... å…¶ä»–å­—æ®µ
      })
    } else if (open) {
      form.reset({
        name: '',
        // ... å…¶ä»–é»˜è®¤å€¼
      })
    }
  }, [open, currentRow, form])

  // API è°ƒç”¨
  const createMutation = useMutation({
    mutationFn: (payload: any) => api.create(payload),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['items'] })
      onOpenChange(false)
      toast.success('åˆ›å»ºæˆåŠŸ')
      onSuccess?.() // é€šçŸ¥çˆ¶ç»„ä»¶
    },
    onError: (error: Error) => {
      toast.error(error.message || 'åˆ›å»ºå¤±è´¥')
    },
  })

  const updateMutation = useMutation({
    mutationFn: ({ id, payload }: { id: string; payload: any }) =>
      api.update(id, payload),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['items'] })
      onOpenChange(false)
      toast.success('æ›´æ–°æˆåŠŸ')
      onSuccess?.() // é€šçŸ¥çˆ¶ç»„ä»¶
    },
    onError: (error: Error) => {
      toast.error(error.message || 'æ›´æ–°å¤±è´¥')
    },
  })

  const onSubmit = (values: FormValues) => {
    if (isEdit && currentRow) {
      updateMutation.mutate({ id: currentRow.id, payload: values })
    } else {
      createMutation.mutate(values)
    }
  }

  const isPending = createMutation.isPending || updateMutation.isPending

  // è„è¡¨å•å…³é—­æ‹¦æˆª
  const onOpenChangeWrapper = (open: boolean) => {
    if (!open && form.formState.isDirty && !isPending) {
      setConfirmCloseOpen(true)
      return
    }
    if (!isPending) {
      onOpenChange(open)
    }
  }

  return (
    <>
      <Dialog open={open} onOpenChange={onOpenChangeWrapper}>
        <DialogContent className='sm:max-w-lg'>
          {/* å®Œæ•´çš„ Dialog å†…å®¹ */}
        </DialogContent>
      </Dialog>

      <ConfirmDialog
        open={confirmCloseOpen}
        onOpenChange={setConfirmCloseOpen}
        handleConfirm={() => {
          setConfirmCloseOpen(false)
          onOpenChange(false)
        }}
        title='æ”¾å¼ƒä¿®æ”¹ï¼Ÿ'
        desc='æ‚¨æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ'
        confirmText='æ”¾å¼ƒ'
        destructive
      />
    </>
  )
}
```

---

## ä¸»æ–‡ä»¶è°ƒç”¨æ–¹å¼ (The Parent)

ä¸»æ–‡ä»¶ï¼ˆ`index.tsx`ï¼‰ç°åœ¨å˜å¾—éå¸¸æ¸…çˆ½ï¼š

```tsx
// src/features/{module}/index.tsx

import { useState } from 'react'
import { useQuery } from '@tanstack/react-query'
import { ModuleActionDialog } from './components/module-action-dialog'
import { ModuleDeleteDialog } from './components/module-delete-dialog'

export default function ModulePage() {
  // å¼¹çª—çŠ¶æ€
  const [actionOpen, setActionOpen] = useState(false)
  const [deleteOpen, setDeleteOpen] = useState(false)
  const [currentRow, setCurrentRow] = useState<ItemType | null>(null)

  // åˆ—è¡¨æ•°æ®
  const { data, refetch } = useQuery({
    queryKey: ['items'],
    queryFn: () => api.getList(),
  })

  const handleCreate = () => {
    setCurrentRow(null)
    setActionOpen(true)
  }

  const handleEdit = (row: ItemType) => {
    setCurrentRow(row)
    setActionOpen(true)
  }

  const handleDelete = (row: ItemType) => {
    setCurrentRow(row)
    setDeleteOpen(true)
  }

  return (
    <>
      {/* é¡µé¢ä¸»å†…å®¹ï¼šåªè´Ÿè´£å¸ƒå±€å’Œè¡¨æ ¼ */}
      <DataTable
        data={data}
        onEdit={handleEdit}
        onDelete={handleDelete}
      />
      <Button onClick={handleCreate}>æ–°å»º</Button>

      {/* å¼¹çª—åŒºåŸŸï¼šä»£ç æåº¦ç®€æ´ */}
      <ModuleActionDialog
        key={currentRow ? `edit-${currentRow.id}` : 'create'}
        open={actionOpen}
        onOpenChange={(open) => {
          setActionOpen(open)
          if (!open) {
            setTimeout(() => setCurrentRow(null), 300)
          }
        }}
        currentRow={currentRow ?? undefined}
        onSuccess={refetch}
      />

      <ModuleDeleteDialog
        open={deleteOpen}
        onOpenChange={setDeleteOpen}
        currentRow={currentRow}
        onSuccess={refetch}
      />
    </>
  )
}
```

---

## è¿›é˜¶ä¼˜åŒ–ï¼šæ€§èƒ½æå‡ (Lazy Loading)

æ—¢ç„¶æ–‡ä»¶å·²ç»åˆ†ç¦»ï¼Œå¯ä»¥åˆ©ç”¨åŠ¨æ€å¯¼å…¥ç‰¹æ€§ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ**  
å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ã€å¤æ‚çš„é…ç½®è¡¨å•å¾€å¾€ä½“ç§¯å¾ˆå¤§ã€‚å¦‚æœç”¨æˆ·åªæ˜¯è¿›æ¥çœ‹çœ‹åˆ—è¡¨ï¼Œæ²¡å¿…è¦åŠ è½½è¿™äº›æ²‰é‡çš„ JS ä»£ç ã€‚

```tsx
// src/features/{module}/index.tsx

import dynamic from 'next/dynamic'

// åŠ¨æ€å¯¼å…¥ï¼Œä¸å ç”¨é¦–å±åŠ è½½ä½“ç§¯
const ModuleActionDialog = dynamic(
  () => import('./components/module-action-dialog').then((mod) => mod.ModuleActionDialog),
  {
    loading: () => null,  // æˆ–è€…è¿”å›ä¸€ä¸ª Skeleton
    ssr: false            // å¼¹çª—é€šå¸¸ä¸éœ€è¦æœåŠ¡ç«¯æ¸²æŸ“
  }
)

export default function ModulePage() {
  // ... é€»è¾‘ä¸å˜
}
```

---

## åˆ†ç¦»çš„å¥½å¤„

| å¥½å¤„ | è¯´æ˜ |
|------|------|
| **ä»£ç è¡Œæ•°éª¤å‡** | ä¸»é¡µé¢é€»è¾‘èšç„¦äºåˆ—è¡¨å±•ç¤ºå’ŒçŠ¶æ€åˆ†å‘ï¼Œé€šå¸¸èƒ½æ§åˆ¶åœ¨ 200 è¡Œä»¥å†… |
| **Git å†²çªå‡å°‘** | å¤šäººå¼€å‘æ—¶ï¼Œä¸€ä¸ªäººæ”¹åˆ—è¡¨ï¼Œä¸€ä¸ªäººæ”¹è¡¨å•ï¼Œäº’ä¸å¹²æ‰° |
| **å¤ç”¨æ€§å¢å¼º** | å¦‚æœå…¶ä»–é¡µé¢ä¹Ÿéœ€è¦ç”¨åˆ°åŒæ ·çš„å¼¹çª—ï¼Œå¯ä»¥ç›´æ¥å¼•å…¥ |
| **æŒ‰éœ€åŠ è½½** | å¤©ç„¶æ”¯æŒ Code Splittingï¼Œä¼˜åŒ–é¦–å±æ€§èƒ½ |

---

## çŠ¶æ€ç®¡ç† Providerï¼ˆå¯é€‰è¿›é˜¶ï¼‰

å½“å¼¹çª—çŠ¶æ€éœ€è¦åœ¨å¤šä¸ªç»„ä»¶é—´å…±äº«æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Context Providerï¼š

```tsx
// {module}-provider.tsx
import { createContext, useContext, useState } from 'react'

type DialogType = 'add' | 'edit' | 'delete' | 'detail' | null

type ModuleContextType = {
  open: DialogType
  setOpen: (type: DialogType) => void
  currentRow: ItemType | null
  setCurrentRow: (row: ItemType | null) => void
}

const ModuleContext = createContext<ModuleContextType | null>(null)

export function ModuleProvider({ children }: { children: React.ReactNode }) {
  const [open, setOpen] = useState<DialogType>(null)
  const [currentRow, setCurrentRow] = useState<ItemType | null>(null)

  return (
    <ModuleContext.Provider value={{ open, setOpen, currentRow, setCurrentRow }}>
      {children}
    </ModuleContext.Provider>
  )
}

export function useModule() {
  const context = useContext(ModuleContext)
  if (!context) throw new Error('useModule must be used within ModuleProvider')
  return context
}
```

> ğŸ’¡ **æç¤º**ï¼šå¯¹äºç®€å•åœºæ™¯ï¼Œç›´æ¥åœ¨ä¸»é¡µé¢ä½¿ç”¨ `useState` ç®¡ç†å¼¹çª—çŠ¶æ€å³å¯ï¼Œä¸éœ€è¦ Providerã€‚
