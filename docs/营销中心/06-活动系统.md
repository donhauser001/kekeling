# æ´»åŠ¨ç³»ç»Ÿè§„åˆ’æ–‡æ¡£

> è¿”å› [è¥é”€ä¸­å¿ƒæ€»è§ˆ](./README.md)  
> çŠ¶æ€ï¼šğŸ“ æ¡†æ¶è§„åˆ’

---

## ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ

### 1.1 æ´»åŠ¨ç±»å‹

| ç±»å‹ | ä»£ç  | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| é™æ—¶ç‰¹æƒ  | `flash_sale` | æŒ‡å®šæ—¶é—´æ®µæŠ˜æ‰£ | åŒåä¸€å…¨åœº8æŠ˜ |
| ç§’æ€æŠ¢è´­ | `seckill` | é™é‡é™æ—¶è¶…ä½ä»· | Â¥99ç§’æ€åŸä»·598 |
| æ»¡å‡ä¿ƒé”€ | `threshold` | æ»¡è¶³é‡‘é¢å‡å… | æ»¡300å‡50 |
| æ–°äººä¸“äº« | `newcomer` | ä»…é™æ–°ç”¨æˆ· | é¦–å•ç«‹å‡30 |

### 1.2 æ´»åŠ¨çŠ¶æ€

```
æœªå¼€å§‹ (pending) â†’ è¿›è¡Œä¸­ (active) â†’ å·²ç»“æŸ (ended)
                                    â†˜ å·²å–æ¶ˆ (cancelled)
```

### 1.3 ä¸ä»·æ ¼å¼•æ“çš„å…³ç³»

æ´»åŠ¨ä¼˜æƒ ä½œä¸º**ç¬¬ä¸€å±‚æŠ˜æ‰£**è¿›å…¥ä»·æ ¼å¼•æ“ï¼š

```
åŸä»· â†’ [æ´»åŠ¨ä»·] â†’ ä¼šå‘˜ä»· â†’ ä¼˜æƒ åˆ¸ â†’ ç§¯åˆ† â†’ å®ä»˜
        â†‘
      æœ¬æ¨¡å—
```

---

## äºŒã€æ•°æ®æ¨¡å‹

### 2.1 æ´»åŠ¨ä¸»è¡¨

```prisma
model Campaign {
  id              String    @id @default(uuid())
  name            String                              // æ´»åŠ¨åç§°
  code            String?   @unique                   // æ´»åŠ¨ä»£ç 
  type            String                              // flash_sale/seckill/threshold/newcomer
  
  // æ—¶é—´
  startAt         DateTime  @map("start_at")
  endAt           DateTime  @map("end_at")
  
  // ä¼˜æƒ é…ç½®
  discountType    String    @map("discount_type")     // amount/percent
  discountValue   Decimal   @db.Decimal(10, 2) @map("discount_value")
  maxDiscount     Decimal?  @db.Decimal(10, 2) @map("max_discount")  // æŠ˜æ‰£ä¸Šé™
  minAmount       Decimal   @default(0) @db.Decimal(10, 2) @map("min_amount")
  
  // é€‚ç”¨èŒƒå›´
  applicableScope String    @default("all") @map("applicable_scope")
  // all: å…¨åœº
  // category: æŒ‡å®šåˆ†ç±»
  // service: æŒ‡å®šæœåŠ¡
  applicableIds   String[]  @map("applicable_ids")
  
  // é™åˆ¶
  totalQuantity   Int?      @map("total_quantity")    // æ€»å‚ä¸æ¬¡æ•°
  perUserLimit    Int       @default(1) @map("per_user_limit")
  
  // å±•ç¤º
  description     String?
  bannerUrl       String?   @map("banner_url")
  detailUrl       String?   @map("detail_url")
  sort            Int       @default(0)
  
  // å åŠ è§„åˆ™
  stackWithMember Boolean   @default(true) @map("stack_with_member")
  
  status          String    @default("pending")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  participations  CampaignParticipation[]
  
  @@index([status, startAt, endAt])
  @@map("campaigns")
}
```

### 2.2 æ´»åŠ¨å‚ä¸è®°å½•

```prisma
model CampaignParticipation {
  id           String   @id @default(uuid())
  campaignId   String   @map("campaign_id")
  userId       String   @map("user_id")
  orderId      String?  @map("order_id")
  
  // å¿«ç…§
  discountAmount Decimal @db.Decimal(10, 2) @map("discount_amount")
  
  createdAt    DateTime @default(now())
  
  campaign     Campaign @relation(fields: [campaignId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
  
  @@index([campaignId])
  @@index([userId])
  @@map("campaign_participations")
}
```

### 2.3 ç§’æ€å•†å“ï¼ˆç§’æ€æ´»åŠ¨ä¸“ç”¨ï¼‰

```prisma
model SeckillItem {
  id           String   @id @default(uuid())
  campaignId   String   @map("campaign_id")
  serviceId    String   @map("service_id")
  
  seckillPrice Decimal  @db.Decimal(10, 2) @map("seckill_price")
  stockTotal   Int      @map("stock_total")
  stockSold    Int      @default(0) @map("stock_sold")
  
  // æ¯äººé™è´­
  perUserLimit Int      @default(1) @map("per_user_limit")
  
  sort         Int      @default(0)
  status       String   @default("active")
  
  campaign     Campaign @relation(fields: [campaignId], references: [id])
  service      Service  @relation(fields: [serviceId], references: [id])
  
  @@unique([campaignId, serviceId])
  @@map("seckill_items")
}
```

---

## ä¸‰ã€ä¸šåŠ¡é€»è¾‘

### 3.1 æ´»åŠ¨ç”Ÿæ•ˆæ£€æŸ¥

```typescript
async function getActiveForService(serviceId: string, userId?: string): Promise<Campaign | null> {
  const service = await getService(serviceId);
  const now = new Date();
  
  // 1. æŸ¥è¯¢è¿›è¡Œä¸­çš„æ´»åŠ¨
  const campaigns = await getCampaigns({
    status: 'active',
    startAt: { lte: now },
    endAt: { gt: now },
  });
  
  // 2. ç­›é€‰é€‚ç”¨çš„æ´»åŠ¨
  for (const campaign of campaigns) {
    // æ£€æŸ¥é€‚ç”¨èŒƒå›´
    if (campaign.applicableScope === 'service') {
      if (!campaign.applicableIds.includes(serviceId)) continue;
    } else if (campaign.applicableScope === 'category') {
      if (!campaign.applicableIds.includes(service.categoryId)) continue;
    }
    
    // æ£€æŸ¥æ–°äººä¸“äº«
    if (campaign.type === 'newcomer' && userId) {
      const orderCount = await getUserOrderCount(userId);
      if (orderCount > 0) continue;
    }
    
    // æ£€æŸ¥å‚ä¸æ¬¡æ•°
    if (campaign.totalQuantity !== null) {
      const participated = await getParticipationCount(campaign.id);
      if (participated >= campaign.totalQuantity) continue;
    }
    
    // æ£€æŸ¥æ¯äººé™åˆ¶
    if (userId && campaign.perUserLimit > 0) {
      const userParticipated = await getUserParticipationCount(campaign.id, userId);
      if (userParticipated >= campaign.perUserLimit) continue;
    }
    
    return campaign;
  }
  
  return null;
}
```

### 3.2 è®¡ç®—æ´»åŠ¨ä¼˜æƒ 

```typescript
function calculateCampaignDiscount(campaign: Campaign, originalPrice: number): number {
  // æ£€æŸ¥æœ€ä½æ¶ˆè´¹
  if (originalPrice < Number(campaign.minAmount)) {
    return 0;
  }
  
  let discount: number;
  
  if (campaign.discountType === 'amount') {
    // æ»¡å‡ï¼šç›´æ¥å‡å›ºå®šé‡‘é¢
    discount = Number(campaign.discountValue);
  } else {
    // æŠ˜æ‰£ï¼šè®¡ç®—æŠ˜æ‰£é‡‘é¢
    discount = originalPrice * (1 - Number(campaign.discountValue) / 100);
    
    // åº”ç”¨æŠ˜æ‰£ä¸Šé™
    if (campaign.maxDiscount) {
      discount = Math.min(discount, Number(campaign.maxDiscount));
    }
  }
  
  // ä¸èƒ½è¶…è¿‡åŸä»·
  return Math.min(discount, originalPrice);
}
```

### 3.3 ç§’æ€åº“å­˜å¤„ç†

```typescript
async function tryAcquireSeckillStock(
  campaignId: string, 
  serviceId: string, 
  userId: string,
): Promise<boolean> {
  const lockKey = `seckill:${campaignId}:${serviceId}`;
  
  // 1. è·å–åˆ†å¸ƒå¼é”
  const lock = await acquireLock(lockKey, 5000);
  if (!lock) {
    throw new Error('ç³»ç»Ÿç¹å¿™ï¼Œè¯·é‡è¯•');
  }
  
  try {
    const item = await getSeckillItem(campaignId, serviceId);
    
    // 2. æ£€æŸ¥åº“å­˜
    if (item.stockSold >= item.stockTotal) {
      throw new Error('å·²æŠ¢å…‰');
    }
    
    // 3. æ£€æŸ¥ç”¨æˆ·é™è´­
    const userPurchased = await getUserSeckillCount(campaignId, serviceId, userId);
    if (userPurchased >= item.perUserLimit) {
      throw new Error('å·²è¾¾é™è´­æ•°é‡');
    }
    
    // 4. é¢„å åº“å­˜
    await incrementSeckillStock(item.id);
    
    return true;
  } finally {
    await releaseLock(lock);
  }
}

// è®¢å•å–æ¶ˆæ—¶é‡Šæ”¾åº“å­˜
async function releaseSeckillStock(campaignId: string, serviceId: string) {
  await decrementSeckillStock(campaignId, serviceId);
}
```

### 3.4 æ´»åŠ¨çŠ¶æ€ç®¡ç†

```typescript
// å®šæ—¶ä»»åŠ¡ï¼šæ¯åˆ†é’Ÿæ‰§è¡Œ
async function updateCampaignStatus() {
  const now = new Date();
  
  // 1. å¼€å§‹æ´»åŠ¨
  await updateMany({
    where: { status: 'pending', startAt: { lte: now } },
    data: { status: 'active' },
  });
  
  // 2. ç»“æŸæ´»åŠ¨
  await updateMany({
    where: { status: 'active', endAt: { lte: now } },
    data: { status: 'ended' },
  });
}
```

---

## å››ã€é˜²åˆ·æœºåˆ¶

### 4.1 ç§’æ€é˜²åˆ·

```typescript
interface SeckillLimits {
  // è¯·æ±‚é™æµ
  requestLimit: number;         // æ¯ç§’è¯·æ±‚æ•°
  
  // éªŒè¯è¦æ±‚
  requireCaptcha: boolean;      // éœ€è¦éªŒè¯ç 
  requireSmsCode: boolean;      // éœ€è¦çŸ­ä¿¡éªŒè¯
  
  // IP é™åˆ¶
  ipLimit: number;              // åŒ IP å‚ä¸ä¸Šé™
}
```

### 4.2 å¼‚å¸¸æ£€æµ‹

- åŒ IP é«˜é¢‘è¯·æ±‚
- åŒè®¾å¤‡å¤šè´¦å·å‚ä¸
- æœºå™¨äººè¡Œä¸ºè¯†åˆ«

---

## äº”ã€API è®¾è®¡

### 5.1 ç”¨æˆ·ç«¯

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/campaigns | æ´»åŠ¨åˆ—è¡¨ |
| GET | /api/campaigns/:id | æ´»åŠ¨è¯¦æƒ… |
| GET | /api/campaigns/active | å½“å‰è¿›è¡Œä¸­çš„æ´»åŠ¨ |
| GET | /api/services/:id/campaign | æœåŠ¡é€‚ç”¨çš„æ´»åŠ¨ |
| POST | /api/seckill/:campaignId/:serviceId/reserve | ç§’æ€é¢„å åº“å­˜ |

### 5.2 åå°ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/admin/campaigns | æ´»åŠ¨åˆ—è¡¨ |
| POST | /api/admin/campaigns | åˆ›å»ºæ´»åŠ¨ |
| PUT | /api/admin/campaigns/:id | æ›´æ–°æ´»åŠ¨ |
| DELETE | /api/admin/campaigns/:id | åˆ é™¤æ´»åŠ¨ |
| GET | /api/admin/campaigns/:id/stats | æ´»åŠ¨æ•°æ® |
| POST | /api/admin/campaigns/:id/cancel | å–æ¶ˆæ´»åŠ¨ |
| GET | /api/admin/seckill/:campaignId/items | ç§’æ€å•†å“åˆ—è¡¨ |
| POST | /api/admin/seckill/:campaignId/items | æ·»åŠ ç§’æ€å•†å“ |

---

## å…­ã€ç”¨æˆ·ç•Œé¢

### 6.1 æ´»åŠ¨åˆ—è¡¨é¡µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â†  ä¼˜æƒ æ´»åŠ¨                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ”¥ å¹´ç»ˆç‰¹æƒ                          â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ å…¨åœºæœåŠ¡ 8 æŠ˜                       â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ 12.20 - 12.31                       â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ [æŸ¥çœ‹è¯¦æƒ… â†’]                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âš¡ é™æ—¶ç§’æ€                         â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ é—¨è¯Šé™ªè¯Š Â¥99 (åŸä»·Â¥298)            â”‚ â”‚
â”‚ â”‚ ä»…å‰© 5 ä»¶                           â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ è·ç»“æŸ 02:34:56                     â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ [ç«‹å³æŠ¢è´­]                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ’° æ»¡å‡æ´»åŠ¨                         â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ æ»¡ 300 å‡ 50                        â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ é•¿æœŸæœ‰æ•ˆ                            â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ [å»å‡‘å• â†’]                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 æœåŠ¡è¯¦æƒ…é¡µæ´»åŠ¨å±•ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         â”‚
â”‚ é—¨è¯Šé™ªè¯ŠæœåŠ¡                             â”‚
â”‚                                         â”‚
â”‚ Â¥238.4  æ´»åŠ¨ä»·                          â”‚
â”‚ Â¥298    åŸä»·                            â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ”¥ å¹´ç»ˆç‰¹æƒ  8æŠ˜                      â”‚ â”‚
â”‚ â”‚ æ´»åŠ¨å‰©ä½™ï¼š5å¤©12å°æ—¶                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ‘‘ ä¼šå‘˜å†äº«9æŠ˜ â†’ Â¥214.56            â”‚ â”‚
â”‚ â”‚ [å¼€é€šä¼šå‘˜]                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸ƒã€å¾…ç»†åŒ–å†…å®¹

- [ ] æ´»åŠ¨è§„åˆ™å¼•æ“ï¼ˆå¤æ‚æ¡ä»¶ç»„åˆï¼‰
- [ ] æ´»åŠ¨é¢„çƒ­åŠŸèƒ½
- [ ] æ´»åŠ¨æé†’è®¢é˜…
- [ ] ç§’æ€å€’è®¡æ—¶ç»„ä»¶
- [ ] æ´»åŠ¨æ•ˆæœæ•°æ®åˆ†æ
- [ ] æ´»åŠ¨æ¨¡æ¿ï¼ˆå¿«é€Ÿåˆ›å»ºå¸¸è§æ´»åŠ¨ï¼‰
- [ ] é˜¶æ¢¯æ»¡å‡ï¼ˆæ»¡100å‡10ï¼Œæ»¡200å‡25ï¼Œæ»¡300å‡50ï¼‰
