# 营销中心全链路测试计划

## 测试目标

确保营销中心所有功能正常运行，包括：
- 功能完整性测试
- 退款流程测试
- 防刷机制测试
- 性能优化验证

## 一、功能测试

### 1.1 会员系统测试

#### 测试用例 1.1.1：会员购买流程
- [ ] 用户查看会员等级列表
- [ ] 用户选择会员方案
- [ ] 用户购买会员（创建订单）
- [ ] 用户支付会员订单
- [ ] 验证会员状态更新为 `active`
- [ ] 验证会员到期时间正确设置
- [ ] 验证会员权益生效（价格折扣）

#### 测试用例 1.1.2：会员到期处理
- [ ] 定时任务正确识别即将到期会员（7天内）
- [ ] 定时任务正确更新过期会员状态为 `expired`
- [ ] 过期会员无法享受会员折扣

#### 测试用例 1.1.3：消费升级
- [ ] 用户完成订单后触发消费升级检查
- [ ] 累计消费达到阈值时自动升级会员
- [ ] 升级后会员权益立即生效

### 1.2 价格引擎测试

#### 测试用例 1.2.1：价格计算逻辑
- [ ] 原价计算正确
- [ ] 活动折扣正确应用
- [ ] 会员折扣正确应用
- [ ] 优惠券折扣正确应用
- [ ] 积分抵扣正确应用
- [ ] 折扣叠加顺序正确（活动 → 会员 → 优惠券 → 积分）
- [ ] 最低支付金额限制生效
- [ ] 价格快照正确保存

#### 测试用例 1.2.2：价格计算边界情况
- [ ] 无会员、无优惠券、无积分时的价格
- [ ] 优惠券金额超过订单金额时的处理
- [ ] 积分超过最大抵扣比例时的处理
- [ ] 多个活动同时存在时的处理

### 1.3 优惠券系统测试

#### 测试用例 1.3.1：优惠券领取
- [ ] 用户查看可领取优惠券列表
- [ ] 用户领取优惠券成功
- [ ] 验证每人限领数量限制
- [ ] 验证每日限领数量限制
- [ ] 验证总库存限制
- [ ] 验证领取时间限制（开始/结束时间）

#### 测试用例 1.3.2：优惠券使用
- [ ] 下单时选择可用优惠券
- [ ] 优惠券使用后状态变为 `used`
- [ ] 优惠券使用后不可再次使用
- [ ] 验证优惠券适用范围（全部/分类/服务）
- [ ] 验证最低消费金额限制

#### 测试用例 1.3.3：优惠券自动发放
- [ ] 新用户注册自动发放新人券
- [ ] 订单完成自动发放完成券
- [ ] 验证发放规则配置正确

#### 测试用例 1.3.4：优惠券退款
- [ ] 订单取消时优惠券自动退回
- [ ] 订单退款时优惠券自动退回
- [ ] 退回后优惠券状态变为 `unused`
- [ ] 退回后优惠券可再次使用

### 1.4 积分系统测试

#### 测试用例 1.4.1：积分获得
- [ ] 订单完成获得积分（消费1元=1积分）
- [ ] 每日签到获得积分
- [ ] 评价订单获得积分
- [ ] 邀请好友获得积分

#### 测试用例 1.4.2：积分使用
- [ ] 下单时使用积分抵扣
- [ ] 验证积分抵扣比例（100积分=1元）
- [ ] 验证最大抵扣比例限制
- [ ] 使用后积分余额正确减少

#### 测试用例 1.4.3：积分退款
- [ ] 订单取消时积分自动退回
- [ ] 订单退款时积分自动退回
- [ ] 退回后积分余额正确增加

#### 测试用例 1.4.4：积分过期
- [ ] 定时任务正确识别过期积分
- [ ] 过期积分自动清零
- [ ] 过期记录正确保存

#### 测试用例 1.4.5：每日签到
- [ ] 用户每日可签到一次
- [ ] 签到后获得积分奖励
- [ ] 重复签到被拒绝

### 1.5 邀请系统测试

#### 测试用例 1.5.1：邀请码生成
- [ ] 用户注册后自动生成邀请码
- [ ] 邀请码唯一性验证
- [ ] 邀请码格式正确

#### 测试用例 1.5.2：邀请绑定
- [ ] 新用户注册时输入邀请码
- [ ] 邀请码验证正确
- [ ] 邀请关系正确建立
- [ ] 自己邀请自己被拒绝

#### 测试用例 1.5.3：邀请奖励
- [ ] 被邀请人注册后邀请人获得奖励
- [ ] 被邀请人完成首单后双方获得奖励
- [ ] 奖励类型正确（优惠券/积分）
- [ ] 奖励金额正确

#### 测试用例 1.5.4：防作弊机制
- [ ] 同一手机号重复邀请被拒绝
- [ ] 每日邀请数量限制生效
- [ ] 总邀请数量限制生效
- [ ] 自己邀请自己被拒绝

### 1.6 活动系统测试

#### 测试用例 1.6.1：活动列表
- [ ] 用户查看进行中的活动列表
- [ ] 活动状态正确（pending/active/ended）
- [ ] 活动时间正确显示

#### 测试用例 1.6.2：活动折扣
- [ ] 活动折扣正确应用到订单
- [ ] 满减活动正确计算
- [ ] 折扣活动正确计算
- [ ] 最低消费限制生效

#### 测试用例 1.6.3：秒杀活动
- [ ] 秒杀商品库存正确显示
- [ ] 秒杀价格正确应用
- [ ] 秒杀库存预占成功
- [ ] 秒杀库存释放（订单取消/退款）
- [ ] 秒杀库存售罄后无法下单

#### 测试用例 1.6.4：活动状态更新
- [ ] 定时任务正确更新活动状态
- [ ] 活动开始后状态变为 `active`
- [ ] 活动结束后状态变为 `ended`

## 二、退款测试

### 2.1 订单取消退款

#### 测试用例 2.1.1：订单取消流程
- [ ] 用户取消订单
- [ ] 优惠券自动退回
- [ ] 积分自动退回
- [ ] 秒杀库存自动释放
- [ ] 订单状态正确更新

### 2.2 订单退款

#### 测试用例 2.2.1：管理员退款
- [ ] 管理员确认退款
- [ ] 优惠券自动退回
- [ ] 积分自动退回
- [ ] 秒杀库存自动释放
- [ ] 退款金额正确

#### 测试用例 2.2.2：支付服务退款
- [ ] 支付服务发起退款
- [ ] 优惠券自动退回
- [ ] 积分自动退回
- [ ] 秒杀库存自动释放
- [ ] 退款金额正确

### 2.3 退款边界情况

#### 测试用例 2.3.1：部分退款
- [ ] 部分退款时优惠券处理（暂不支持，需确认业务规则）
- [ ] 部分退款时积分处理（暂不支持，需确认业务规则）

#### 测试用例 2.3.2：重复退款
- [ ] 防止重复退款（幂等性）
- [ ] 退款状态正确记录

## 三、防刷测试

### 3.1 优惠券防刷

#### 测试用例 3.1.1：领取限制
- [ ] 每人限领数量生效
- [ ] 每日限领数量生效
- [ ] 总库存限制生效
- [ ] 同一用户重复领取被拒绝

#### 测试用例 3.1.2：使用限制
- [ ] 优惠券使用次数限制生效
- [ ] 过期优惠券无法使用
- [ ] 已使用优惠券无法重复使用

### 3.2 积分防刷

#### 测试用例 3.2.1：获得限制
- [ ] 每日签到限制生效（每日一次）
- [ ] 订单积分计算正确（防止重复计算）
- [ ] 评价积分限制生效（每单一次）

#### 测试用例 3.2.2：使用限制
- [ ] 积分使用上限生效（最大抵扣比例）
- [ ] 积分余额不足时无法使用

### 3.3 邀请防刷

#### 测试用例 3.3.1：邀请限制
- [ ] 自己邀请自己被拒绝
- [ ] 同一手机号重复邀请被拒绝
- [ ] 每日邀请数量限制生效
- [ ] 总邀请数量限制生效

#### 测试用例 3.3.2：奖励限制
- [ ] 同一被邀请人只能奖励一次
- [ ] 奖励发放正确（注册奖励/首单奖励）

### 3.4 秒杀防刷

#### 测试用例 3.4.1：库存控制
- [ ] 秒杀库存预占成功
- [ ] 库存不足时无法下单
- [ ] 并发下单时库存正确扣减
- [ ] 订单取消时库存正确释放

#### 测试用例 3.4.2：限购控制
- [ ] 每人限购数量生效
- [ ] 同一用户重复购买被限制

## 四、性能测试

### 4.1 API 响应时间

#### 测试用例 4.1.1：价格计算性能
- [ ] 价格计算接口响应时间 < 500ms
- [ ] 并发请求时响应时间稳定

#### 测试用例 4.1.2：优惠券列表性能
- [ ] 优惠券列表接口响应时间 < 300ms
- [ ] 分页查询性能良好

#### 测试用例 4.1.3：活动列表性能
- [ ] 活动列表接口响应时间 < 300ms
- [ ] 秒杀商品查询性能良好

### 4.2 数据库性能

#### 测试用例 4.2.1：查询优化
- [ ] 价格计算相关查询使用索引
- [ ] 优惠券查询使用索引
- [ ] 积分记录查询使用索引
- [ ] 邀请记录查询使用索引

#### 测试用例 4.2.2：写入性能
- [ ] 订单创建时价格快照写入性能
- [ ] 积分记录写入性能
- [ ] 邀请记录写入性能

### 4.3 定时任务性能

#### 测试用例 4.3.1：会员到期检查
- [ ] 定时任务执行时间 < 5s
- [ ] 大量会员数据时性能稳定

#### 测试用例 4.3.2：积分过期检查
- [ ] 定时任务执行时间 < 5s
- [ ] 大量积分记录时性能稳定

#### 测试用例 4.3.3：活动状态更新
- [ ] 定时任务执行时间 < 1s
- [ ] 大量活动时性能稳定

## 五、数据一致性测试

### 5.1 事务一致性

#### 测试用例 5.1.1：订单创建事务
- [ ] 订单创建失败时优惠券不扣减
- [ ] 订单创建失败时积分不扣减
- [ ] 订单创建失败时库存不扣减

#### 测试用例 5.1.2：退款事务
- [ ] 退款失败时优惠券不回退
- [ ] 退款失败时积分不回退
- [ ] 退款失败时库存不释放

### 5.2 数据完整性

#### 测试用例 5.2.1：价格快照完整性
- [ ] 每个订单都有价格快照
- [ ] 价格快照数据完整（原价、折扣、最终价）

#### 测试用例 5.2.2：积分记录完整性
- [ ] 每次积分变动都有记录
- [ ] 积分记录类型正确（获得/使用/过期/退回）

## 六、集成测试

### 6.1 订单流程集成

#### 测试用例 6.1.1：完整订单流程
- [ ] 用户选择服务
- [ ] 价格计算（包含活动、会员、优惠券、积分）
- [ ] 创建订单
- [ ] 支付订单
- [ ] 订单完成
- [ ] 自动发放优惠券
- [ ] 自动获得积分
- [ ] 触发邀请奖励（如为首单）

### 6.2 退款流程集成

#### 测试用例 6.2.1：完整退款流程
- [ ] 用户申请退款
- [ ] 管理员确认退款
- [ ] 优惠券退回
- [ ] 积分退回
- [ ] 秒杀库存释放
- [ ] 退款金额正确

## 七、测试执行计划

### 阶段一：功能测试（2天）
1. 会员系统功能测试
2. 价格引擎功能测试
3. 优惠券系统功能测试
4. 积分系统功能测试
5. 邀请系统功能测试
6. 活动系统功能测试

### 阶段二：退款测试（1天）
1. 订单取消退款测试
2. 订单退款测试
3. 退款边界情况测试

### 阶段三：防刷测试（1天）
1. 优惠券防刷测试
2. 积分防刷测试
3. 邀请防刷测试
4. 秒杀防刷测试

### 阶段四：性能测试（1天）
1. API 响应时间测试
2. 数据库性能测试
3. 定时任务性能测试

### 阶段五：集成测试（1天）
1. 订单流程集成测试
2. 退款流程集成测试

## 八、测试工具

### 8.1 API 测试工具
- Postman / Insomnia
- curl
- 自动化测试脚本

### 8.2 性能测试工具
- Apache Bench (ab)
- wrk
- k6

### 8.3 数据库测试工具
- Prisma Studio
- PostgreSQL 查询分析器

## 九、测试环境

### 9.1 开发环境
- 本地开发环境
- 测试数据库

### 9.2 测试环境
- 独立测试服务器
- 测试数据库（可重置）

## 十、测试报告

测试完成后应生成测试报告，包括：
- 测试用例执行情况
- 发现的问题列表
- 性能测试结果
- 优化建议

