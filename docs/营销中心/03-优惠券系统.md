# 优惠券系统规划文档

> 返回 [营销中心总览](./README.md)  
> 状态：✅ 已规划

---

## 一、核心概念

### 1.1 优惠券类型

| 类型 | 代码 | 说明 | 示例 |
|------|------|------|------|
| 满减券 | `amount` | 满足金额减固定金额 | 满100减20 |
| 折扣券 | `percent` | 按比例折扣 | 8折（80），最高减50 |
| 免单券 | `free` | 指定服务免费 | 代办挂号免费券 |

### 1.2 发放渠道

| 渠道 | 代码 | 说明 |
|------|------|------|
| 领取 | `claim` | 用户主动领取（活动页） |
| 发放 | `grant` | 系统自动发放 |
| 兑换 | `exchange` | 兑换码兑换 |
| 购买 | `purchase` | 积分兑换 |

### 1.3 自动发放触发条件

| 触发器 | 代码 | 说明 |
|--------|------|------|
| 新用户注册 | `register` | 注册成功后发放 |
| 会员每月 | `member_monthly` | 每月1日发放给会员 |
| 生日 | `birthday` | 生日当天发放 |
| 订单完成 | `order_complete` | 订单完成后发放 |
| 消费里程碑 | `consume_milestone` | 累计消费达标 |

---

## 二、数据模型

### 2.1 优惠券模板

```prisma
model CouponTemplate {
  id                String   @id @default(uuid())
  name              String                          // 优惠券名称
  code              String?  @unique                // 兑换码（可选）
  
  // 优惠类型
  type              String                          // amount/percent/free
  value             Decimal  @db.Decimal(10, 2)     // 面值或折扣
  maxDiscount       Decimal? @db.Decimal(10, 2) @map("max_discount") // 折扣券最大抵扣
  
  // 使用条件
  minAmount         Decimal  @default(0) @db.Decimal(10, 2) @map("min_amount")
  applicableScope   String   @default("all") @map("applicable_scope")
  // all: 全场通用
  // category: 指定分类
  // service: 指定服务
  applicableIds     String[] @map("applicable_ids")
  
  // 会员限制
  memberOnly        Boolean  @default(false) @map("member_only")
  memberLevelIds    String[] @map("member_level_ids")
  
  // 发放限制
  totalQuantity     Int?     @map("total_quantity")   // 总发放量
  perUserLimit      Int      @default(1) @map("per_user_limit")
  
  // 有效期
  validityType      String   @default("fixed") @map("validity_type")
  // fixed: 固定日期
  // relative: 领取后N天
  startAt           DateTime? @map("start_at")
  endAt             DateTime? @map("end_at")
  validDays         Int?     @map("valid_days")
  
  // 叠加规则
  stackWithMember   Boolean  @default(true) @map("stack_with_member")
  stackWithCampaign Boolean  @default(true) @map("stack_with_campaign")
  
  // 展示
  description       String?
  tips              String?                         // 使用提示
  
  status            String   @default("active")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  userCoupons       UserCoupon[]
  grantRules        CouponGrantRule[]
  
  @@map("coupon_templates")
}
```

### 2.2 用户优惠券

```prisma
model UserCoupon {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  templateId   String    @map("template_id")
  
  // 快照（领取时记录，不受模板修改影响）
  name         String
  type         String
  value        Decimal   @db.Decimal(10, 2)
  maxDiscount  Decimal?  @db.Decimal(10, 2) @map("max_discount")
  minAmount    Decimal   @db.Decimal(10, 2) @map("min_amount")
  applicableScope String @map("applicable_scope")
  applicableIds String[] @map("applicable_ids")
  stackWithMember Boolean @map("stack_with_member")
  stackWithCampaign Boolean @map("stack_with_campaign")
  
  // 状态
  status       String    @default("unused")
  // unused: 未使用
  // used: 已使用
  // expired: 已过期
  // returned: 已退回（订单退款）
  
  usedAt       DateTime? @map("used_at")
  orderId      String?   @map("order_id")
  
  // 有效期
  startAt      DateTime  @map("start_at")
  expireAt     DateTime  @map("expire_at")
  
  // 来源
  source       String    @default("claim")
  sourceId     String?   @map("source_id")
  
  createdAt    DateTime  @default(now())
  
  user         User      @relation(fields: [userId], references: [id])
  template     CouponTemplate @relation(fields: [templateId], references: [id])
  
  @@index([userId, status])
  @@index([expireAt])
  @@map("user_coupons")
}
```

### 2.3 自动发放规则

```prisma
model CouponGrantRule {
  id           String   @id @default(uuid())
  name         String
  templateId   String   @map("template_id")
  
  // 触发条件
  trigger      String
  triggerConfig Json?   @map("trigger_config")
  
  // 发放配置
  grantQuantity Int     @default(1) @map("grant_quantity")
  
  status       String   @default("active")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  template     CouponTemplate @relation(fields: [templateId], references: [id])
  
  @@map("coupon_grant_rules")
}
```

**triggerConfig 示例**：

```typescript
// 新用户注册 - 无额外配置
{}

// 会员每月发放 - 限定会员等级
{ "memberLevelIds": ["vip"] }

// 订单完成 - 限定最低订单金额
{ "minOrderAmount": 200 }

// 消费里程碑 - 累计消费门槛
{ "consumeThreshold": 1000 }

// 生日 - 提前天数
{ "daysAhead": 0 }
```

---

## 三、业务逻辑

### 3.1 领取逻辑

```typescript
async function claimCoupon(userId: string, templateId: string) {
  const template = await getTemplate(templateId);
  
  // 1. 检查模板状态
  if (template.status !== 'active') {
    throw new Error('优惠券已下架');
  }
  
  // 2. 检查总量限制
  if (template.totalQuantity !== null) {
    const issued = await countIssuedCoupons(templateId);
    if (issued >= template.totalQuantity) {
      throw new Error('优惠券已领完');
    }
  }
  
  // 3. 检查每人限领
  const userCount = await countUserCoupons(userId, templateId);
  if (userCount >= template.perUserLimit) {
    throw new Error('已达领取上限');
  }
  
  // 4. 检查会员限制
  if (template.memberOnly) {
    const membership = await getUserMembership(userId);
    if (!membership) {
      throw new Error('仅限会员领取');
    }
    if (template.memberLevelIds.length > 0) {
      if (!template.memberLevelIds.includes(membership.levelId)) {
        throw new Error('您的会员等级无法领取');
      }
    }
  }
  
  // 5. 计算有效期
  let startAt: Date, expireAt: Date;
  if (template.validityType === 'fixed') {
    startAt = template.startAt ?? new Date();
    expireAt = template.endAt!;
  } else {
    startAt = new Date();
    expireAt = addDays(startAt, template.validDays!);
  }
  
  // 6. 创建用户优惠券
  return createUserCoupon({
    userId,
    templateId,
    ...snapshotFromTemplate(template),
    startAt,
    expireAt,
    source: 'claim',
  });
}
```

### 3.2 使用验证

```typescript
function validateCouponUsage(
  coupon: UserCoupon,
  orderAmount: number,
  serviceId: string,
  categoryId: string,
  membership: UserMembership | null,
  campaign: Campaign | null,
): { valid: boolean; reason?: string } {
  
  // 1. 检查状态
  if (coupon.status !== 'unused') {
    return { valid: false, reason: '优惠券已使用或已过期' };
  }
  
  // 2. 检查有效期
  const now = new Date();
  if (now < coupon.startAt || now > coupon.expireAt) {
    return { valid: false, reason: '优惠券不在有效期内' };
  }
  
  // 3. 检查最低消费
  if (orderAmount < Number(coupon.minAmount)) {
    return { 
      valid: false, 
      reason: `需满 ¥${coupon.minAmount} 可用，还差 ¥${Number(coupon.minAmount) - orderAmount}` 
    };
  }
  
  // 4. 检查适用范围
  if (coupon.applicableScope === 'service') {
    if (!coupon.applicableIds.includes(serviceId)) {
      return { valid: false, reason: '该服务不适用此优惠券' };
    }
  } else if (coupon.applicableScope === 'category') {
    if (!coupon.applicableIds.includes(categoryId)) {
      return { valid: false, reason: '该分类不适用此优惠券' };
    }
  }
  
  // 5. 检查叠加规则
  if (!coupon.stackWithMember && membership) {
    return { valid: false, reason: '此券不可与会员折扣同享' };
  }
  if (!coupon.stackWithCampaign && campaign) {
    return { valid: false, reason: '此券不可与活动同享' };
  }
  
  return { valid: true };
}
```

### 3.3 退款退券

```typescript
async function handleCouponRefund(orderId: string) {
  const coupon = await getCouponByOrderId(orderId);
  if (!coupon) return;
  
  // 检查是否过期
  if (coupon.expireAt > new Date()) {
    // 未过期：退回可用状态
    await updateCoupon(coupon.id, {
      status: 'unused',
      usedAt: null,
      orderId: null,
    });
  } else {
    // 已过期：标记为退回（不可再用）
    await updateCoupon(coupon.id, {
      status: 'returned',
    });
  }
}
```

---

## 四、防刷机制

### 4.1 领取限制

```typescript
interface CouponClaimLimits {
  // 每人限领（模板配置）
  perUserLimit: number;
  
  // IP 限制（全局配置）
  ipDailyLimit: number;      // 同 IP 每天最多领 N 张
  
  // 设备限制
  deviceDailyLimit: number;  // 同设备每天最多领 N 张
  
  // 频率限制
  claimInterval: number;     // 两次领取间隔（秒）
}
```

### 4.2 异常检测

```typescript
async function detectAbnormalClaim(userId: string, ip: string, deviceId: string) {
  // 1. 检查 IP 领取频率
  const ipClaimCount = await getIpClaimCount(ip, 'today');
  if (ipClaimCount > config.ipDailyLimit) {
    await logSuspiciousActivity({ type: 'ip_abuse', ip, userId });
    throw new Error('操作过于频繁，请稍后再试');
  }
  
  // 2. 检查设备领取频率
  const deviceClaimCount = await getDeviceClaimCount(deviceId, 'today');
  if (deviceClaimCount > config.deviceDailyLimit) {
    await logSuspiciousActivity({ type: 'device_abuse', deviceId, userId });
    throw new Error('操作过于频繁，请稍后再试');
  }
  
  // 3. 检查用户领取频率
  const lastClaim = await getLastClaimTime(userId);
  if (lastClaim && Date.now() - lastClaim.getTime() < config.claimInterval * 1000) {
    throw new Error('操作过于频繁，请稍后再试');
  }
}
```

---

## 五、API 设计

### 5.1 用户端

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/coupons/available | 可领取的优惠券列表 |
| GET | /api/user/coupons | 我的优惠券列表 |
| GET | /api/user/coupons/usable | 下单时可用优惠券 |
| POST | /api/user/coupons/claim | 领取优惠券 |
| POST | /api/user/coupons/exchange | 兑换码兑换 |

### 5.2 后台管理

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/admin/coupons/templates | 模板列表 |
| POST | /api/admin/coupons/templates | 创建模板 |
| PUT | /api/admin/coupons/templates/:id | 更新模板 |
| DELETE | /api/admin/coupons/templates/:id | 删除模板 |
| GET | /api/admin/coupons/rules | 发放规则列表 |
| POST | /api/admin/coupons/rules | 创建发放规则 |
| POST | /api/admin/coupons/grant | 批量发放 |
| GET | /api/admin/coupons/records | 使用记录 |

---

## 六、用户界面

### 6.1 我的优惠券

```
┌─────────────────────────────────────────┐
│ ←  我的优惠券                            │
├─────────────────────────────────────────┤
│ [可用(3)]  [已使用]  [已过期]            │
├─────────────────────────────────────────┤
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ┌─────┐                             │ │
│ │ │ ¥20 │  满100元可用                │ │
│ │ └─────┘  全场通用                   │ │
│ │          有效期至 2024-12-31        │ │
│ │                                     │ │
│ │ [立即使用]                          │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ┌─────┐                             │ │
│ │ │ 8折 │  最高减50元                 │ │
│ │ └─────┘  门诊陪诊专用               │ │
│ │          有效期至 2024-12-25        │ │
│ │          仅限VIP会员使用            │ │
│ │                                     │ │
│ │ [立即使用]                          │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │            兑换优惠券                │ │
│ │ ┌─────────────────────────────────┐ │ │
│ │ │ 请输入兑换码                    │ │ │
│ │ └─────────────────────────────────┘ │ │
│ │ [兑换]                              │ │
│ └─────────────────────────────────────┘ │
│                                         │
└─────────────────────────────────────────┘
```

### 6.2 下单选择优惠券

```
┌─────────────────────────────────────────┐
│ ←  选择优惠券                            │
├─────────────────────────────────────────┤
│ 当前订单：门诊陪诊 ¥498                   │
├─────────────────────────────────────────┤
│                                         │
│ 可用优惠券 (2)                           │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ○  ¥20        满100元可用           │ │
│ │    满减券      省 ¥20                │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ●  8折        最高减50元            │ │
│ │    折扣券      省 ¥49.8   推荐 ⭐   │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 不可用优惠券 (1)                         │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │    ¥50       需满500元   差¥2可用   │ │
│ │    满减券                           │ │
│ └─────────────────────────────────────┘ │
│                                         │
├─────────────────────────────────────────┤
│ ○ 不使用优惠券                          │
├─────────────────────────────────────────┤
│ [确认选择]                               │
└─────────────────────────────────────────┘
```
