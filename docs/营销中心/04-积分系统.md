# ç§¯åˆ†ç³»ç»Ÿè§„åˆ’æ–‡æ¡£

> è¿”å› [è¥é”€ä¸­å¿ƒæ€»è§ˆ](./README.md)  
> çŠ¶æ€ï¼šğŸ“ æ¡†æ¶è§„åˆ’

---

## ä¸€ã€æ ¸å¿ƒæ¦‚å¿µ

### 1.1 ç§¯åˆ†è·å–

| åœºæ™¯ | è§„åˆ™ | è¯´æ˜ |
|------|------|------|
| è®¢å•æ¶ˆè´¹ | 1å…ƒ=1ç§¯åˆ† | å®ä»˜é‡‘é¢è®¡ç®—ï¼Œä¼˜æƒ éƒ¨åˆ†ä¸è®¡ |
| é¦–æ¬¡ä¸‹å• | +100ç§¯åˆ† | ä¸€æ¬¡æ€§å¥–åŠ± |
| æ¯æ—¥ç­¾åˆ° | +5~20ç§¯åˆ† | è¿ç»­ç­¾åˆ°é€’å¢ |
| è¯„ä»·è®¢å• | +20ç§¯åˆ† | æ¯å•ä¸€æ¬¡ |
| é‚€è¯·å¥½å‹ | +200ç§¯åˆ† | è¢«é‚€è¯·äººé¦–å•åå‘æ”¾ |

### 1.2 ç§¯åˆ†æ¶ˆè€—

| åœºæ™¯ | è§„åˆ™ | è¯´æ˜ |
|------|------|------|
| è®¢å•æŠµæ‰£ | 100ç§¯åˆ†=1å…ƒ | æœ€é«˜æŠµæ‰£è®¢å•10% |
| ç§¯åˆ†å•†åŸ | æŒ‰å•†å“å®šä»· | å…‘æ¢ä¼˜æƒ åˆ¸/ç¤¼å“ |
| æŠ½å¥–æ´»åŠ¨ | æŒ‰æ´»åŠ¨å®šä»· | æ¶ˆè€—ç§¯åˆ†å‚ä¸ |

### 1.3 ç§¯åˆ†æœ‰æ•ˆæœŸ

- **æœ‰æ•ˆæœŸ**ï¼šè·å–å 365 å¤©
- **è¿‡æœŸå¤„ç†**ï¼šæ¯æ—¥å‡Œæ™¨æ¸…ç†è¿‡æœŸç§¯åˆ†
- **ä¼˜å…ˆä½¿ç”¨**ï¼šæŒ‰è¿‡æœŸæ—¶é—´å‡åºä½¿ç”¨

---

## äºŒã€æ•°æ®æ¨¡å‹

### 2.1 ç§¯åˆ†è§„åˆ™

```prisma
model PointRule {
  id           String   @id @default(uuid())
  name         String                          // è§„åˆ™åç§°
  code         String   @unique                // order_consume/first_order/daily_checkin
  
  // ç§¯åˆ†é…ç½®
  points       Int                             // å›ºå®šç§¯åˆ†å€¼
  pointsRate   Decimal? @db.Decimal(5, 2) @map("points_rate") // æŒ‰æ¯”ä¾‹ï¼ˆå¦‚æ¶ˆè´¹1å…ƒ=1åˆ†ï¼‰
  
  // æ¯æ—¥é™åˆ¶
  dailyLimit   Int?     @map("daily_limit")    // æ¯æ—¥è·å–ä¸Šé™
  totalLimit   Int?     @map("total_limit")    // æ€»è·å–ä¸Šé™
  
  // ç”Ÿæ•ˆæ¡ä»¶
  conditions   Json?                           // é¢å¤–æ¡ä»¶
  
  status       String   @default("active")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("point_rules")
}
```

**conditions ç¤ºä¾‹**ï¼š
```typescript
// è®¢å•æ¶ˆè´¹ - æœ€ä½è®¢å•é‡‘é¢
{ "minOrderAmount": 10 }

// è¯„ä»·è®¢å• - éœ€è¦å­—æ•°
{ "minReviewLength": 20 }

// é‚€è¯·å¥½å‹ - è¢«é‚€è¯·äººéœ€å®Œæˆé¦–å•
{ "inviteeFirstOrder": true }
```

### 2.2 ç”¨æˆ·ç§¯åˆ†

```prisma
model UserPoint {
  id             String   @id @default(uuid())
  userId         String   @unique @map("user_id")
  
  totalPoints    Int      @default(0) @map("total_points")     // ç´¯è®¡è·å–
  usedPoints     Int      @default(0) @map("used_points")      // ç´¯è®¡ä½¿ç”¨
  expiredPoints  Int      @default(0) @map("expired_points")   // ç´¯è®¡è¿‡æœŸ
  currentPoints  Int      @default(0) @map("current_points")   // å½“å‰å¯ç”¨
  
  updatedAt      DateTime @updatedAt @map("updated_at")
  
  user           User     @relation(fields: [userId], references: [id])
  
  @@map("user_points")
}
```

### 2.3 ç§¯åˆ†æ˜ç»†

```prisma
model PointRecord {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  
  // å˜æ›´ä¿¡æ¯
  type         String                          // earn/use/expire/refund
  points       Int                             // æ­£æ•°è·å–ï¼Œè´Ÿæ•°æ¶ˆè€—
  balance      Int                             // å˜æ›´åä½™é¢
  
  // æ¥æº
  source       String                          // order_consume/daily_checkin/...
  sourceId     String?  @map("source_id")      // å…³è”ID
  description  String                          // æè¿°
  
  // æœ‰æ•ˆæœŸï¼ˆä»…è·å–æ—¶ï¼‰
  expireAt     DateTime? @map("expire_at")
  
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id])
  
  @@index([userId, createdAt])
  @@index([expireAt])
  @@map("point_records")
}
```

---

## ä¸‰ã€ä¸šåŠ¡é€»è¾‘

### 3.1 è·å–ç§¯åˆ†

```typescript
async function earnPoints(input: {
  userId: string;
  ruleCode: string;
  sourceId?: string;
  amount?: number;
}) {
  const rule = await getPointRule(input.ruleCode);
  if (!rule || rule.status !== 'active') return;
  
  // 1. è®¡ç®—ç§¯åˆ†
  let points: number;
  if (rule.pointsRate) {
    points = Math.floor((input.amount ?? 0) * Number(rule.pointsRate));
  } else {
    points = rule.points;
  }
  
  if (points <= 0) return;
  
  // 2. æ£€æŸ¥æ¯æ—¥é™åˆ¶
  if (rule.dailyLimit) {
    const todayEarned = await getTodayEarnedPoints(input.userId, input.ruleCode);
    points = Math.min(points, rule.dailyLimit - todayEarned);
    if (points <= 0) return;
  }
  
  // 3. æ£€æŸ¥æ€»é™åˆ¶
  if (rule.totalLimit) {
    const totalEarned = await getTotalEarnedPoints(input.userId, input.ruleCode);
    points = Math.min(points, rule.totalLimit - totalEarned);
    if (points <= 0) return;
  }
  
  // 4. è®¡ç®—æœ‰æ•ˆæœŸ
  const expireAt = addDays(new Date(), 365);
  
  // 5. åˆ›å»ºè®°å½•å¹¶æ›´æ–°ä½™é¢
  await transaction([
    createPointRecord({
      userId: input.userId,
      type: 'earn',
      points,
      source: input.ruleCode,
      sourceId: input.sourceId,
      expireAt,
    }),
    incrementUserPoints(input.userId, points),
  ]);
}
```

### 3.2 ä½¿ç”¨ç§¯åˆ†

```typescript
async function usePoints(input: {
  userId: string;
  points: number;
  orderId: string;
}) {
  // 1. æ£€æŸ¥ä½™é¢
  const userPoint = await getUserPoint(input.userId);
  if (userPoint.currentPoints < input.points) {
    throw new Error('ç§¯åˆ†ä¸è¶³');
  }
  
  // 2. æŒ‰è¿‡æœŸæ—¶é—´ä¼˜å…ˆæ‰£å‡
  let remaining = input.points;
  const records = await getActivePointRecords(input.userId);
  
  for (const record of records) {
    if (remaining <= 0) break;
    
    const available = record.points - (record.usedPoints ?? 0);
    const toUse = Math.min(available, remaining);
    
    await updateRecordUsed(record.id, toUse);
    remaining -= toUse;
  }
  
  // 3. åˆ›å»ºä½¿ç”¨è®°å½•
  await createPointRecord({
    userId: input.userId,
    type: 'use',
    points: -input.points,
    source: 'order_deduct',
    sourceId: input.orderId,
  });
  
  // 4. æ›´æ–°ç”¨æˆ·ç§¯åˆ†
  await decrementUserPoints(input.userId, input.points);
}
```

### 3.3 è¿‡æœŸæ¸…ç†

```typescript
// æ¯æ—¥å‡Œæ™¨æ‰§è¡Œ
async function cleanExpiredPoints() {
  const expiredRecords = await getExpiredPointRecords();
  
  for (const record of expiredRecords) {
    const remaining = record.points - (record.usedPoints ?? 0);
    if (remaining <= 0) continue;
    
    await transaction([
      markRecordExpired(record.id),
      createPointRecord({
        userId: record.userId,
        type: 'expire',
        points: -remaining,
        source: 'system_expire',
        description: 'ç§¯åˆ†è¿‡æœŸ',
      }),
      decrementUserPoints(record.userId, remaining),
      incrementExpiredPoints(record.userId, remaining),
    ]);
  }
}
```

### 3.4 é€€æ¬¾é€€ç§¯åˆ†

```typescript
async function handlePointsRefund(orderId: string) {
  // 1. æŸ¥æ‰¾è®¢å•ä½¿ç”¨çš„ç§¯åˆ†
  const usageRecord = await getPointUsageByOrder(orderId);
  if (!usageRecord) return;
  
  const pointsToRefund = Math.abs(usageRecord.points);
  
  // 2. é€€å›ç§¯åˆ†ï¼ˆæ–°çš„æœ‰æ•ˆæœŸï¼‰
  const expireAt = addDays(new Date(), 365);
  
  await transaction([
    createPointRecord({
      userId: usageRecord.userId,
      type: 'refund',
      points: pointsToRefund,
      source: 'order_refund',
      sourceId: orderId,
      expireAt,
    }),
    incrementUserPoints(usageRecord.userId, pointsToRefund),
  ]);
  
  // 3. æ‰£å›è®¢å•è·å¾—çš„ç§¯åˆ†ï¼ˆå¦‚æœ‰ï¼‰
  const earnRecord = await getPointEarnByOrder(orderId);
  if (earnRecord) {
    await revokeEarnedPoints(earnRecord);
  }
}
```

---

## å››ã€é˜²åˆ·æœºåˆ¶

### 4.1 ç­¾åˆ°é˜²åˆ·

```typescript
async function dailyCheckin(userId: string) {
  // 1. æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²ç­¾åˆ°
  const todayCheckin = await getTodayCheckin(userId);
  if (todayCheckin) {
    throw new Error('ä»Šæ—¥å·²ç­¾åˆ°');
  }
  
  // 2. è®¡ç®—è¿ç»­ç­¾åˆ°å¤©æ•°
  const consecutiveDays = await getConsecutiveCheckinDays(userId);
  
  // 3. è®¡ç®—ç­¾åˆ°ç§¯åˆ†ï¼ˆè¿ç»­ç­¾åˆ°é€’å¢ï¼Œæœ€é«˜20ï¼‰
  const basePoints = 5;
  const bonusPoints = Math.min(consecutiveDays, 15);
  const points = basePoints + bonusPoints;
  
  // 4. å‘æ”¾ç§¯åˆ†
  await earnPoints({
    userId,
    ruleCode: 'daily_checkin',
  });
  
  // 5. è®°å½•ç­¾åˆ°
  await createCheckinRecord(userId);
}
```

### 4.2 å¼‚å¸¸ç›‘æ§

- åŒä¸€ IP çŸ­æ—¶é—´å†…å¤šè´¦å·ç­¾åˆ°
- ç§¯åˆ†è·å–é€Ÿåº¦å¼‚å¸¸
- æ‰¹é‡è´¦å·åŒæ—¶æ“ä½œ

---

## äº”ã€API è®¾è®¡

### 5.1 ç”¨æˆ·ç«¯

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/user/points | æˆ‘çš„ç§¯åˆ†æ¦‚è§ˆ |
| GET | /api/user/points/records | ç§¯åˆ†æ˜ç»† |
| POST | /api/user/points/checkin | æ¯æ—¥ç­¾åˆ° |
| GET | /api/points/mall | ç§¯åˆ†å•†åŸå•†å“ |
| POST | /api/points/exchange | ç§¯åˆ†å…‘æ¢ |

### 5.2 åå°ç®¡ç†

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | /api/admin/points/rules | ç§¯åˆ†è§„åˆ™åˆ—è¡¨ |
| PUT | /api/admin/points/rules/:id | æ›´æ–°è§„åˆ™ |
| GET | /api/admin/points/records | ç§¯åˆ†æµæ°´ |
| POST | /api/admin/points/adjust | æ‰‹åŠ¨è°ƒæ•´ç§¯åˆ† |

---

## å…­ã€ç”¨æˆ·ç•Œé¢

### 6.1 ç§¯åˆ†ä¸­å¿ƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â†  ç§¯åˆ†ä¸­å¿ƒ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚        æˆ‘çš„ç§¯åˆ†                      â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚         1,280                       â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ å³å°†è¿‡æœŸï¼š120 (7å¤©å†…)                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ æ¯æ—¥ç­¾åˆ°                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ è¿ç»­ç­¾åˆ° 5 å¤©ï¼Œä»Šæ—¥å¯å¾— 10 ç§¯åˆ†       â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ [ç­¾åˆ° +10]                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ å¦‚ä½•è·å–ç§¯åˆ†                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ’° æ¶ˆè´¹å¾—ç§¯åˆ†    1å…ƒ=1ç§¯åˆ†           â”‚ â”‚
â”‚ â”‚ â­ è¯„ä»·å¾—ç§¯åˆ†    +20ç§¯åˆ†/å•          â”‚ â”‚
â”‚ â”‚ ğŸ‘¥ é‚€è¯·å¾—ç§¯åˆ†    +200ç§¯åˆ†/äºº         â”‚ â”‚
â”‚ â”‚ ğŸ“… ç­¾åˆ°å¾—ç§¯åˆ†    5-20ç§¯åˆ†/å¤©         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â”‚ ç§¯åˆ†æ˜ç»†                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 12-11 è®¢å•æ¶ˆè´¹   +48               â”‚ â”‚
â”‚ â”‚ 12-11 æ¯æ—¥ç­¾åˆ°   +10               â”‚ â”‚
â”‚ â”‚ 12-10 è¯„ä»·è®¢å•   +20               â”‚ â”‚
â”‚ â”‚ 12-09 è®¢å•æŠµæ‰£   -100              â”‚ â”‚
â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚ [æŸ¥çœ‹æ›´å¤š]                          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸ƒã€å¾…ç»†åŒ–å†…å®¹

- [ ] ç§¯åˆ†å•†åŸå•†å“ç®¡ç†
- [ ] ç§¯åˆ†æŠ½å¥–æ´»åŠ¨
- [ ] ç­¾åˆ°æ—¥å†ç•Œé¢
- [ ] ç§¯åˆ†æ’è¡Œæ¦œï¼ˆå¯é€‰ï¼‰
- [ ] ç§¯åˆ†è´¦å•å¯¼å‡º
