# 营销中心测试执行指南

## 一、准备工作

### 1.1 环境检查

```bash
# 检查后端服务是否运行
curl http://localhost:3000/api/services?pageSize=1

# 检查数据库连接
cd server
npx prisma studio
```

### 1.2 准备测试数据

```bash
cd server
ts-node test/marketing/test-data-setup.ts
```

这将创建所有必要的测试数据。

### 1.3 获取测试用户Token（可选）

如果需要测试需要认证的接口，需要先登录获取Token：

```bash
# 使用微信登录或测试接口获取Token
curl -X POST http://localhost:3000/api/auth/weixin \
  -H "Content-Type: application/json" \
  -d '{"code": "test_code"}'
```

## 二、执行自动化测试

### 2.1 运行所有测试

```bash
cd server
ts-node test/marketing/test-runner.ts
```

### 2.2 使用环境变量

```bash
# 指定API地址和Token
API_URL=http://localhost:3000/api \
TEST_USER_TOKEN=your_token_here \
ts-node test/marketing/test-runner.ts
```

### 2.3 查看测试报告

测试完成后，报告会保存在 `server/test-reports/` 目录下。

## 三、手动测试步骤

### 3.1 会员系统测试

#### 测试：查看会员等级列表
1. 打开小程序/管理后台
2. 进入会员中心
3. 验证会员等级列表显示正常

#### 测试：购买会员
1. 选择会员等级和方案
2. 点击购买
3. 完成支付（可使用测试支付接口）
4. 验证会员状态变为 `active`
5. 验证会员到期时间正确

#### 测试：会员权益生效
1. 选择一个服务
2. 查看价格计算
3. 验证会员折扣已应用

### 3.2 价格引擎测试

#### 测试：无折扣价格计算
```bash
curl -X POST http://localhost:3000/api/pricing/calculate \
  -H "Content-Type: application/json" \
  -d '{
    "serviceId": "your_service_id"
  }'
```

验证：
- `originalPrice` = 服务原价
- `finalPrice` = 服务原价
- `totalSavings` = 0

#### 测试：会员折扣计算
```bash
curl -X POST http://localhost:3000/api/pricing/calculate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_token" \
  -d '{
    "serviceId": "your_service_id",
    "userId": "your_user_id"
  }'
```

验证：
- `memberPrice` < `originalPrice`
- `memberDiscount` > 0
- `finalPrice` = `memberPrice`

#### 测试：优惠券折扣计算
```bash
curl -X POST http://localhost:3000/api/pricing/calculate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_token" \
  -d '{
    "serviceId": "your_service_id",
    "userId": "your_user_id",
    "couponId": "your_coupon_id"
  }'
```

验证：
- `couponDiscount` > 0
- `finalPrice` = `memberPrice` - `couponDiscount`（或按配置的叠加规则）

#### 测试：积分抵扣计算
```bash
curl -X POST http://localhost:3000/api/pricing/calculate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_token" \
  -d '{
    "serviceId": "your_service_id",
    "userId": "your_user_id",
    "pointsToUse": 5000
  }'
```

验证：
- `pointsDiscount` > 0
- `pointsUsed` = 使用的积分数
- `finalPrice` = 折扣后价格 - 积分抵扣

### 3.3 优惠券系统测试

#### 测试：领取优惠券
```bash
curl -X POST http://localhost:3000/api/coupons/claim \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your_token" \
  -d '{
    "templateId": "your_template_id"
  }'
```

验证：
- 返回成功
- 在"我的优惠券"中可以看到新领取的优惠券

#### 测试：查看我的优惠券
```bash
curl http://localhost:3000/api/coupons/my \
  -H "Authorization: Bearer your_token"
```

验证：
- 返回优惠券列表
- 包含状态、有效期等信息

#### 测试：下单使用优惠券
1. 创建订单时选择优惠券
2. 验证订单金额已扣除优惠券金额
3. 验证优惠券状态变为 `used`

### 3.4 积分系统测试

#### 测试：每日签到
```bash
curl -X POST http://localhost:3000/api/points/checkin \
  -H "Authorization: Bearer your_token"
```

验证：
- 第一次签到成功，获得积分
- 再次签到失败（今日已签到）

#### 测试：查看积分明细
```bash
curl http://localhost:3000/api/points/records \
  -H "Authorization: Bearer your_token"
```

验证：
- 返回积分记录列表
- 包含获得、使用、过期等类型

### 3.5 邀请系统测试

#### 测试：查看我的邀请码
```bash
curl http://localhost:3000/api/referrals/invite-code \
  -H "Authorization: Bearer your_token"
```

验证：
- 返回邀请码
- 邀请码格式正确

#### 测试：新用户使用邀请码注册
1. 新用户注册时输入邀请码
2. 验证邀请关系建立
3. 验证邀请统计更新

### 3.6 活动系统测试

#### 测试：查看活动列表
```bash
curl http://localhost:3000/api/campaigns/active
```

验证：
- 返回进行中的活动列表
- 活动信息完整

#### 测试：活动折扣生效
1. 选择参与活动的服务
2. 查看价格计算
3. 验证活动折扣已应用

## 四、退款测试

### 4.1 订单取消退款

1. 创建一个使用优惠券和积分的订单
2. 取消订单
3. 验证：
   - 优惠券状态变为 `unused`
   - 积分余额增加
   - 秒杀库存增加（如适用）

### 4.2 订单退款

1. 创建一个已支付的订单
2. 申请退款（管理员操作）
3. 验证：
   - 优惠券退回
   - 积分退回
   - 秒杀库存释放

## 五、防刷测试

### 5.1 优惠券防刷

#### 测试：每人限领
1. 领取优惠券直到达到每人限领数量
2. 再次尝试领取
3. 验证：返回错误"已达到每人限领数量"

#### 测试：每日限领
1. 当天领取优惠券
2. 立即再次尝试领取
3. 验证：返回错误"已达到每日限领数量"

### 5.2 积分防刷

#### 测试：每日签到限制
1. 执行签到
2. 立即再次签到
3. 验证：返回错误"今日已签到"

### 5.3 邀请防刷

#### 测试：自己邀请自己
1. 使用自己的邀请码注册
2. 验证：返回错误"不能邀请自己"

## 六、性能测试

### 6.1 使用 Apache Bench

```bash
# 价格计算接口
ab -n 100 -c 10 -p request.json -T application/json \
  http://localhost:3000/api/pricing/calculate

# 优惠券列表接口
ab -n 100 -c 10 -H "Authorization: Bearer your_token" \
  http://localhost:3000/api/coupons/my
```

### 6.2 使用 wrk

```bash
# 价格计算接口
wrk -t4 -c100 -d30s --script=price-calculate.lua \
  http://localhost:3000/api/pricing/calculate
```

## 七、测试报告

### 7.1 记录测试结果

使用测试执行清单（`docs/营销中心/测试执行清单.md`）记录每个测试项的结果。

### 7.2 问题报告

如果发现问题，记录：
- 问题描述
- 复现步骤
- 预期结果
- 实际结果
- 严重程度

### 7.3 优化建议

根据测试结果，提出：
- 性能优化建议
- 功能优化建议
- 用户体验改进建议

## 八、常见问题

### Q: 测试数据已存在怎么办？
A: 测试脚本会检查数据是否存在，如果存在则跳过创建。

### Q: 某些测试被跳过？
A: 某些测试需要特定条件（如已创建的订单），会自动跳过。这是正常的。

### Q: 性能测试结果不稳定？
A: 性能测试结果受服务器负载、网络等因素影响，建议多次测试取平均值。

### Q: 如何测试需要支付的流程？
A: 可以使用测试支付接口（`/api/test/pay-order/:id`）模拟支付。

## 九、下一步

测试完成后：
1. 查看测试报告
2. 修复发现的问题
3. 优化性能瓶颈
4. 更新文档

