// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== 用户模块 ==========

model User {
  id          String   @id @default(uuid())
  openid      String   @unique
  unionid     String?
  nickname    String?
  avatar      String?
  phone       String?  @unique
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联
  patients    Patient[]
  orders      Order[]
  escort      Escort?   // 陪诊员身份 (1:1, 可空)

  @@map("users")
}

// 就诊人
model Patient {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  name        String
  gender      String    // male, female
  birthday    DateTime? // ✅ 修正：存生日而非年龄，前端动态计算年龄
  phone       String
  idCard      String?   @map("id_card")
  relation    String    // 本人、父亲、母亲、子女、其他
  isDefault   Boolean   @default(false) @map("is_default")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id])
  orders      Order[]

  @@map("patients")
}

// ========== 服务模块 ==========

model ServiceCategory {
  id          String    @id @default(uuid())
  name        String
  icon        String?                       // 图标名称 (Lucide icon name)
  color       String?                       // 主题颜色 (如: #667eea 或 gradient)
  description String?                       // 分类描述
  isPinned    Boolean   @default(false) @map("is_pinned") // 是否置顶（最多2个）
  sort        Int       @default(0)         // 排序权重
  status      String    @default("active")  // active, inactive
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  services    Service[]

  @@map("service_categories")
}

model Service {
  id               String    @id @default(uuid())
  categoryId       String    @map("category_id")
  name             String
  description      String?   @db.Text          // 支持长文本
  content          String?   @db.Text          // 富文本内容（HTML）
  
  // ✅ 修正：使用 Decimal 处理金额，避免浮点精度问题
  price            Decimal   @db.Decimal(10, 2)
  originalPrice    Decimal?  @map("original_price") @db.Decimal(10, 2)
  unit             String    @default("次")    // 单位：次、天、小时
  duration         String?                     // 服务时长描述
  
  coverImage       String?   @map("cover_image")
  detailImages     String[]  @default([])      // ✅ 修正：使用 Postgres 数组存多图URL
  
  // ✅ 修正：使用 Json 类型，支持深层查询
  serviceIncludes    Json?     @map("service_includes")    // [{ text, icon }]
  serviceNotes       Json?     @map("service_notes")       // [{ title, content }]
  
  // 业务配置
  minQuantity      Int       @default(1) @map("min_quantity")
  maxQuantity      Int       @default(99) @map("max_quantity")
  needPatient      Boolean   @default(true) @map("need_patient")
  needHospital     Boolean   @default(true) @map("need_hospital")
  needDepartment   Boolean   @default(false) @map("need_department")
  needDoctor       Boolean   @default(false) @map("need_doctor")
  needAppointment  Boolean   @default(true) @map("need_appointment")
  needIdCard       Boolean   @default(false) @map("need_id_card")       // 需要身份证
  needGender       Boolean   @default(false) @map("need_gender")        // 需要性别
  needEmergencyContact Boolean @default(false) @map("need_emergency_contact") // 需要紧急联系人
  allowPostOrder   Boolean   @default(false) @map("allow_post_order")  // 允许先下单后填写信息
  customFields     Json?     @map("custom_fields")   // 自定义字段配置 [{ id, type, label, placeholder, required, options }]
  fieldOrder       Json?     @map("field_order")     // 字段排序 ['needPatient', 'custom_xxx', ...]
  
  orderCount       Int       @default(0) @map("order_count")
  rating           Float     @default(5.0)    // ✅ 修正：统一5分制评分
  tags             String[]  @default([])     // ✅ 标签数组
  sort             Int       @default(0)
  status           String    @default("active") // active, inactive, draft
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // 陪诊员配置
  commissionRate   Int?      @default(70) @map("commission_rate")   // 分成比例 0-100，默认70%
  commissionNote   String?   @map("commission_note")                // 分成说明

  // 关联
  category         ServiceCategory @relation(fields: [categoryId], references: [id])
  workflowId       String?   @map("workflow_id")
  workflow         Workflow? @relation(fields: [workflowId], references: [id])
  orders           Order[]
  guarantees       ServiceGuaranteeOnService[]  // 服务保障关联
  operationGuides  OperationGuideOnService[]    // 操作规范关联

  @@map("services")
}

// ========== 服务保障模块 ==========

// 服务保障条目
model ServiceGuarantee {
  id          String    @id @default(uuid())
  name        String                          // 保障名称，如"平台担保"
  icon        String    @default("shield")    // 图标名称
  description String?   @db.Text              // 详细说明（支持长文本）
  sort        Int       @default(0)           // 排序
  status      String    @default("active")    // active, inactive
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  services    ServiceGuaranteeOnService[]

  @@map("service_guarantees")
}

// 服务与保障的多对多关联表
model ServiceGuaranteeOnService {
  serviceId     String   @map("service_id")
  guaranteeId   String   @map("guarantee_id")
  sort          Int      @default(0)  // 在该服务中的排序

  service       Service          @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  guarantee     ServiceGuarantee @relation(fields: [guaranteeId], references: [id], onDelete: Cascade)

  @@id([serviceId, guaranteeId])
  @@map("service_guarantee_relations")
}

// ========== 操作规范模块 ==========

// 操作规范分类
model OperationGuideCategory {
  id          String           @id @default(uuid())
  name        String
  description String?
  icon        String?                            // lucide 图标名
  sort        Int              @default(0)
  status      String           @default("active")  // active, inactive
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  guides      OperationGuide[]

  @@map("operation_guide_categories")
}

// 操作规范
model OperationGuide {
  id          String                    @id @default(uuid())
  categoryId  String                    @map("category_id")
  title       String
  summary     String?                              // 摘要
  content     String                    @db.Text   // 富文本内容
  coverImage  String?                   @map("cover_image")
  tags        String[]
  sort        Int                       @default(0)
  status      String                    @default("draft")  // active, inactive, draft
  createdAt   DateTime                  @default(now()) @map("created_at")
  updatedAt   DateTime                  @updatedAt @map("updated_at")

  category    OperationGuideCategory    @relation(fields: [categoryId], references: [id])
  services    OperationGuideOnService[]

  @@map("operation_guides")
}

// 操作规范-服务关联表
model OperationGuideOnService {
  id        String         @id @default(uuid())
  guideId   String         @map("guide_id")
  serviceId String         @map("service_id")
  sort      Int            @default(0)  // 在该服务中的排序
  createdAt DateTime       @default(now()) @map("created_at")

  guide     OperationGuide @relation(fields: [guideId], references: [id], onDelete: Cascade)
  service   Service        @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([guideId, serviceId])
  @@map("operation_guide_on_service")
}

// ========== 流程模块 ==========

// 流程模板
model Workflow {
  id          String         @id @default(uuid())
  name        String
  description String?
  category    String         // 流程分类：陪诊流程、诊断流程、跑腿流程、售后流程
  status      String         @default("active")  // active, inactive, draft
  usageCount  Int            @default(0) @map("usage_count")
  
  // 时长配置
  baseDuration      Int       @default(240) @map("base_duration")       // 基础服务时长（分钟），默认4小时
  
  // 超时策略
  overtimeEnabled   Boolean   @default(true) @map("overtime_enabled")   // 是否允许超时加时
  overtimePrice     Decimal?  @map("overtime_price") @db.Decimal(10, 2) // 超时单价
  overtimeUnit      String    @default("小时") @map("overtime_unit")    // 超时计价单位
  overtimeMax       Int?      @map("overtime_max")                      // 最大加时时长（分钟）
  overtimeGrace     Int       @default(15) @map("overtime_grace")       // 宽限时间（分钟）
  
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  steps       WorkflowStep[]
  services    Service[]

  @@map("workflows")
}

// 流程步骤
model WorkflowStep {
  id          String   @id @default(uuid())
  workflowId  String   @map("workflow_id")
  name        String
  description String?
  type        String   // start, action, end
  sort        Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")

  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@map("workflow_steps")
}

// ========== 医院模块 ==========

model Hospital {
  id           String   @id @default(uuid())
  name         String
  shortName    String?  @map("short_name") // 医院简称，如"协和"、"301"
  level        String   // 三甲、三乙、二甲等
  levelDetail  String?  @map("level_detail") // 详细级别描述，如"综合类国家医学中心"
  type         String   // 综合、专科
  address      String
  phone        String?
  latitude     Float?
  longitude    Float?
  introduction String?
  specialties  String[] // 优势专科列表
  trafficGuide String?  @map("traffic_guide")
  parkingInfo  String?  @map("parking_info")
  coverImage   String?  @map("cover_image")
  images       String?  // 更多图片 JSON
  status       String   @default("active") // active, inactive
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联 - 移除 departments JSON，改为关系
  departments  Department[]
  doctors      Doctor[]
  orders       Order[]
  escorts      EscortHospital[]

  @@map("hospitals")
}

// ========== 科室模块 ==========

// 科室库/类目字典 (不属于任何医院，是通用的科室定义)
model DepartmentTemplate {
  id           String   @id @default(uuid())
  name         String   @unique                 // 科室名称 (唯一)
  code         String?                          // 科室编码
  category     String                           // 大类: 内科、外科、妇儿、五官、医技、其他
  parentId     String?  @map("parent_id")       // 父科室ID (支持层级)
  
  description  String?                          // 科室描述
  diseases     String?                          // 常见疾病 JSON
  color        String?                          // 显示颜色
  icon         String?                          // 图标
  
  sort         Int      @default(0)
  status       String   @default("active")      // active, inactive
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  parent       DepartmentTemplate?  @relation("SubTemplates", fields: [parentId], references: [id])
  children     DepartmentTemplate[] @relation("SubTemplates")
  departments  Department[]                     // 被哪些医院科室使用

  @@map("department_templates")
}

// 医院科室 (属于某个医院，引用科室库)
model Department {
  id           String   @id @default(uuid())
  hospitalId   String   @map("hospital_id")
  templateId   String?  @map("template_id")     // 关联科室库模板
  
  name         String                            // 科室名称 (可自定义，默认取模板名)
  parentId     String?  @map("parent_id")       // 父科室ID (支持层级)
  
  introduction String?                          // 科室简介
  location     String?                          // 位置 (如 门诊楼3层)
  phone        String?                          // 科室电话
  
  sort         Int      @default(0)
  status       String   @default("active")      // active, inactive
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  hospital     Hospital             @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  template     DepartmentTemplate?  @relation(fields: [templateId], references: [id])
  parent       Department?          @relation("SubDepartments", fields: [parentId], references: [id])
  children     Department[]         @relation("SubDepartments")
  doctors      Doctor[]
  orders       Order[]

  @@map("departments")
}

// ========== 医生模块 ==========

model Doctor {
  id             String   @id @default(uuid())
  name           String
  avatar         String?
  gender         String?                          // male, female
  
  hospitalId     String   @map("hospital_id")
  departmentId   String   @map("department_id")
  
  title          String                           // chief, associate_chief, attending, resident
  level          String?                          // expert, senior, normal
  
  introduction   String?                          // 个人简介
  specialties    String[]                         // 擅长领域 (PostgreSQL 数组)
  education      String?                          // 学历背景
  experience     String?                          // 从医年限
  
  consultCount   Int      @default(0) @map("consult_count")
  rating         Float    @default(5.0)
  reviewCount    Int      @default(0) @map("review_count")
  
  phone          String?                          // 联系电话 (内部使用)
  status         String   @default("active")      // active, inactive
  
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // 关联
  hospital       Hospital   @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  department     Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  orders         Order[]

  @@map("doctors")
}

// ========== 陪诊员模块 ==========

model Escort {
  id             String    @id @default(uuid())
  userId         String?   @unique @map("user_id") // 关联小程序账号 (手机号匹配后自动关联)
  name           String
  gender         String    // male, female
  phone          String    @unique
  idCard         String?   @map("id_card")
  avatar         String?

  // 业务属性
  cityCode       String    @default("110100") @map("city_code") // 城市代码 (默认北京)
  level          String    // senior, intermediate, junior, trainee
  experience     String?   // 从业年限
  introduction   String?   // 个人简介
  tags           String[]  @default([])  // ✅ 修正：改为原生数组，支持 { has: 'xxx' } 查询
  certificates   String?   // JSON: [{name, url, expireDate}]

  // 统计数据
  rating         Float     @default(5.0)  // 评分 (5分制)
  orderCount     Int       @default(0) @map("order_count")

  // 状态管理
  status         String    @default("pending") // pending(待审核), active(已激活), inactive(已停用), suspended(已封禁)
  workStatus     String    @default("resting") @map("work_status") // resting(休息), working(接单中), busy(服务中)

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")  // ✅ 新增：软删除支持

  // 关联
  user           User?     @relation(fields: [userId], references: [id])
  hospitals      EscortHospital[]
  orders         Order[]

  @@map("escorts")
}

// 陪诊员-医院关联表 (多对多)
model EscortHospital {
  id           String   @id @default(uuid())
  escortId     String   @map("escort_id")
  hospitalId   String   @map("hospital_id")
  familiarDepts String? @map("familiar_depts") // JSON

  escort       Escort   @relation(fields: [escortId], references: [id])
  hospital     Hospital @relation(fields: [hospitalId], references: [id])

  @@unique([escortId, hospitalId])
  @@map("escort_hospitals")
}

// ========== 订单模块 ==========

model Order {
  id               String    @id @default(uuid())
  orderNo          String    @unique @map("order_no")
  userId           String    @map("user_id")
  patientId        String    @map("patient_id")
  serviceId        String    @map("service_id")
  hospitalId       String    @map("hospital_id")
  departmentId     String?   @map("department_id")    // 新增: 科室关联
  doctorId         String?   @map("doctor_id")        // 新增: 医生关联
  escortId         String?   @map("escort_id")
  
  // 预约信息
  appointmentDate  DateTime  @map("appointment_date")
  appointmentTime  String    @map("appointment_time")
  departmentName   String?   @map("department_name")   // 保留: 兼容旧数据
  
  // 金额信息 - ✅ 使用 Decimal 避免浮点精度问题
  totalAmount      Decimal   @map("total_amount") @db.Decimal(10, 2)
  discountAmount   Decimal   @default(0) @map("discount_amount") @db.Decimal(10, 2)
  paidAmount       Decimal   @default(0) @map("paid_amount") @db.Decimal(10, 2)
  
  // 状态
  status           String    @default("pending") // pending, paid, confirmed, assigned, in_progress, completed, cancelled, refunded
  
  // 支付信息
  paymentMethod    String?   @map("payment_method")
  paymentTime      DateTime? @map("payment_time")
  transactionId    String?   @map("transaction_id")
  
  // 备注
  userRemark       String?   @map("user_remark")
  adminRemark      String?   @map("admin_remark")
  cancelReason     String?   @map("cancel_reason")
  
  // 时间节点
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  paidAt           DateTime? @map("paid_at")        // 支付时间
  assignedAt       DateTime? @map("assigned_at")    // 派单时间
  arrivedAt        DateTime? @map("arrived_at")     // 陪诊员到达时间
  startedAt        DateTime? @map("started_at")     // 服务开始时间
  completedAt      DateTime? @map("completed_at")   // 服务完成时间
  cancelledAt      DateTime? @map("cancelled_at")   // 取消时间

  // 关联
  user             User      @relation(fields: [userId], references: [id])
  patient          Patient   @relation(fields: [patientId], references: [id])
  service          Service   @relation(fields: [serviceId], references: [id])
  hospital         Hospital  @relation(fields: [hospitalId], references: [id])
  department       Department? @relation(fields: [departmentId], references: [id])
  doctor           Doctor?   @relation(fields: [doctorId], references: [id])
  escort           Escort?   @relation(fields: [escortId], references: [id])

  @@map("orders")
}

// ========== 系统配置 ==========

model Config {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   // JSON
  remark    String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("configs")
}

// 轮播图（支持多位置）
model Banner {
  id        String   @id @default(uuid())
  title     String?
  image     String
  link      String?
  position  String   @default("home") // home=首页, services=服务页, profile=个人中心, service-detail=服务详情, cases=病例页
  sort      Int      @default(0)
  status    String   @default("active") // active, inactive
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("banners")
}

// ========== 管理员模块 ==========

model Admin {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  name      String
  email     String?
  phone     String?
  role      String   @default("admin") // superadmin, admin, operator
  status    String   @default("active") // active, inactive
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("admins")
}
