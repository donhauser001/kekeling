// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== 用户模块 ==========

model User {
  id          String   @id @default(uuid())
  openid      String   @unique
  unionid     String?
  nickname    String?
  avatar      String?
  phone       String?  @unique
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联
  patients    Patient[]
  orders      Order[]
  escort      Escort?   // 陪诊员身份 (1:1, 可空)

  @@map("users")
}

// 就诊人
model Patient {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  gender      String   // male, female
  age         Int
  phone       String
  idCard      String?  @map("id_card")
  relation    String   // 本人、父亲、母亲、子女、其他
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user        User     @relation(fields: [userId], references: [id])
  orders      Order[]

  @@map("patients")
}

// ========== 服务模块 ==========

model ServiceCategory {
  id          String    @id @default(uuid())
  name        String
  icon        String?                       // 图标 URL 或图标名称
  description String?                       // 分类描述
  sort        Int       @default(0)         // 排序权重
  status      String    @default("active")  // active, inactive
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  services    Service[]

  @@map("service_categories")
}

model Service {
  id               String    @id @default(uuid())
  categoryId       String    @map("category_id")
  name             String
  description      String?   @db.Text          // 支持长文本
  
  // ✅ 修正：使用 Decimal 处理金额，避免浮点精度问题
  price            Decimal   @db.Decimal(10, 2)
  originalPrice    Decimal?  @map("original_price") @db.Decimal(10, 2)
  unit             String    @default("次")    // 单位：次、天、小时
  duration         String?                     // 服务时长描述
  
  coverImage       String?   @map("cover_image")
  detailImages     String[]  @default([])      // ✅ 修正：使用 Postgres 数组存多图URL
  
  // ✅ 修正：使用 Json 类型，支持深层查询
  serviceIncludes  Json?     @map("service_includes")  // [{ text, icon }]
  serviceNotes     Json?     @map("service_notes")     // [{ title, content }]
  
  // 业务配置
  minQuantity      Int       @default(1) @map("min_quantity")
  maxQuantity      Int       @default(99) @map("max_quantity")
  needPatient      Boolean   @default(true) @map("need_patient")
  needHospital     Boolean   @default(true) @map("need_hospital")
  needDepartment   Boolean   @default(false) @map("need_department")
  needDoctor       Boolean   @default(false) @map("need_doctor")
  needAppointment  Boolean   @default(true) @map("need_appointment")
  
  orderCount       Int       @default(0) @map("order_count")
  rating           Decimal   @default(98.0) @db.Decimal(4, 1) // ✅ 评分: 0-100 百分制
  tags             String[]  @default([])     // ✅ 标签数组
  sort             Int       @default(0)
  status           String    @default("active") // active, inactive, draft
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  category         ServiceCategory @relation(fields: [categoryId], references: [id])
  orders           Order[]

  @@map("services")
}

// ========== 医院模块 ==========

model Hospital {
  id           String   @id @default(uuid())
  name         String
  shortName    String?  @map("short_name") // 医院简称，如"协和"、"301"
  level        String   // 三甲、三乙、二甲等
  levelDetail  String?  @map("level_detail") // 详细级别描述，如"综合类国家医学中心"
  type         String   // 综合、专科
  address      String
  phone        String?
  latitude     Float?
  longitude    Float?
  introduction String?
  specialties  String[] // 优势专科列表
  trafficGuide String?  @map("traffic_guide")
  parkingInfo  String?  @map("parking_info")
  coverImage   String?  @map("cover_image")
  images       String?  // 更多图片 JSON
  status       String   @default("active") // active, inactive
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联 - 移除 departments JSON，改为关系
  departments  Department[]
  doctors      Doctor[]
  orders       Order[]
  escorts      EscortHospital[]

  @@map("hospitals")
}

// ========== 科室模块 ==========

// 科室库/类目字典 (不属于任何医院，是通用的科室定义)
model DepartmentTemplate {
  id           String   @id @default(uuid())
  name         String   @unique                 // 科室名称 (唯一)
  code         String?                          // 科室编码
  category     String                           // 大类: 内科、外科、妇儿、五官、医技、其他
  parentId     String?  @map("parent_id")       // 父科室ID (支持层级)
  
  description  String?                          // 科室描述
  diseases     String?                          // 常见疾病 JSON
  color        String?                          // 显示颜色
  icon         String?                          // 图标
  
  sort         Int      @default(0)
  status       String   @default("active")      // active, inactive
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  parent       DepartmentTemplate?  @relation("SubTemplates", fields: [parentId], references: [id])
  children     DepartmentTemplate[] @relation("SubTemplates")
  departments  Department[]                     // 被哪些医院科室使用

  @@map("department_templates")
}

// 医院科室 (属于某个医院，引用科室库)
model Department {
  id           String   @id @default(uuid())
  hospitalId   String   @map("hospital_id")
  templateId   String?  @map("template_id")     // 关联科室库模板
  
  name         String                            // 科室名称 (可自定义，默认取模板名)
  parentId     String?  @map("parent_id")       // 父科室ID (支持层级)
  
  introduction String?                          // 科室简介
  location     String?                          // 位置 (如 门诊楼3层)
  phone        String?                          // 科室电话
  
  sort         Int      @default(0)
  status       String   @default("active")      // active, inactive
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联
  hospital     Hospital             @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  template     DepartmentTemplate?  @relation(fields: [templateId], references: [id])
  parent       Department?          @relation("SubDepartments", fields: [parentId], references: [id])
  children     Department[]         @relation("SubDepartments")
  doctors      Doctor[]
  orders       Order[]

  @@map("departments")
}

// ========== 医生模块 ==========

model Doctor {
  id             String   @id @default(uuid())
  name           String
  avatar         String?
  gender         String?                          // male, female
  
  hospitalId     String   @map("hospital_id")
  departmentId   String   @map("department_id")
  
  title          String                           // chief, associate_chief, attending, resident
  level          String?                          // expert, senior, normal
  
  introduction   String?                          // 个人简介
  specialties    String[]                         // 擅长领域 (PostgreSQL 数组)
  education      String?                          // 学历背景
  experience     String?                          // 从医年限
  
  consultCount   Int      @default(0) @map("consult_count")
  rating         Float    @default(5.0)
  reviewCount    Int      @default(0) @map("review_count")
  
  phone          String?                          // 联系电话 (内部使用)
  status         String   @default("active")      // active, inactive
  
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // 关联
  hospital       Hospital   @relation(fields: [hospitalId], references: [id], onDelete: Cascade)
  department     Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  orders         Order[]

  @@map("doctors")
}

// ========== 陪诊员模块 ==========

model Escort {
  id             String    @id @default(uuid())
  userId         String?   @unique @map("user_id") // 关联小程序账号 (手机号匹配后自动关联)
  name           String
  gender         String    // male, female
  phone          String    @unique
  idCard         String?   @map("id_card")
  avatar         String?

  // 业务属性
  cityCode       String    @default("110100") @map("city_code") // 城市代码 (默认北京)
  level          String    // senior, intermediate, junior, trainee
  experience     String?   // 从业年限
  introduction   String?   // 个人简介
  tags           String?   // JSON: ["耐心细致", "经验丰富"]
  certificates   String?   // JSON: [{name, url, expireDate}]

  // 统计数据
  rating         Float     @default(5.0)  // 评分 (5分制)
  orderCount     Int       @default(0) @map("order_count")

  // 状态管理
  status         String    @default("pending") // pending(待审核), active(已激活), inactive(已停用), suspended(已封禁)
  workStatus     String    @default("resting") @map("work_status") // resting(休息), working(接单中), busy(服务中)

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // 关联
  user           User?     @relation(fields: [userId], references: [id])
  hospitals      EscortHospital[]
  orders         Order[]

  @@map("escorts")
}

// 陪诊员-医院关联表 (多对多)
model EscortHospital {
  id           String   @id @default(uuid())
  escortId     String   @map("escort_id")
  hospitalId   String   @map("hospital_id")
  familiarDepts String? @map("familiar_depts") // JSON

  escort       Escort   @relation(fields: [escortId], references: [id])
  hospital     Hospital @relation(fields: [hospitalId], references: [id])

  @@unique([escortId, hospitalId])
  @@map("escort_hospitals")
}

// ========== 订单模块 ==========

model Order {
  id               String    @id @default(uuid())
  orderNo          String    @unique @map("order_no")
  userId           String    @map("user_id")
  patientId        String    @map("patient_id")
  serviceId        String    @map("service_id")
  hospitalId       String    @map("hospital_id")
  departmentId     String?   @map("department_id")    // 新增: 科室关联
  doctorId         String?   @map("doctor_id")        // 新增: 医生关联
  escortId         String?   @map("escort_id")
  
  // 预约信息
  appointmentDate  DateTime  @map("appointment_date")
  appointmentTime  String    @map("appointment_time")
  departmentName   String?   @map("department_name")   // 保留: 兼容旧数据
  
  // 金额信息 - ✅ 使用 Decimal 避免浮点精度问题
  totalAmount      Decimal   @map("total_amount") @db.Decimal(10, 2)
  discountAmount   Decimal   @default(0) @map("discount_amount") @db.Decimal(10, 2)
  paidAmount       Decimal   @default(0) @map("paid_amount") @db.Decimal(10, 2)
  
  // 状态
  status           String    @default("pending") // pending, paid, confirmed, assigned, in_progress, completed, cancelled, refunded
  
  // 支付信息
  paymentMethod    String?   @map("payment_method")
  paymentTime      DateTime? @map("payment_time")
  transactionId    String?   @map("transaction_id")
  
  // 备注
  userRemark       String?   @map("user_remark")
  adminRemark      String?   @map("admin_remark")
  cancelReason     String?   @map("cancel_reason")
  
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // 关联
  user             User      @relation(fields: [userId], references: [id])
  patient          Patient   @relation(fields: [patientId], references: [id])
  service          Service   @relation(fields: [serviceId], references: [id])
  hospital         Hospital  @relation(fields: [hospitalId], references: [id])
  department       Department? @relation(fields: [departmentId], references: [id])
  doctor           Doctor?   @relation(fields: [doctorId], references: [id])
  escort           Escort?   @relation(fields: [escortId], references: [id])

  @@map("orders")
}

// ========== 系统配置 ==========

model Config {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   // JSON
  remark    String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("configs")
}

// 首页轮播图
model Banner {
  id        String   @id @default(uuid())
  title     String?
  image     String
  link      String?
  sort      Int      @default(0)
  status    String   @default("active") // active, inactive
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("banners")
}

// ========== 管理员模块 ==========

model Admin {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  name      String
  email     String?
  phone     String?
  role      String   @default("admin") // superadmin, admin, operator
  status    String   @default("active") // active, inactive
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("admins")
}
