# 营销中心测试

## 快速开始

### 1. 准备测试数据

```bash
# 在 server 目录下执行
ts-node test/marketing/test-data-setup.ts
```

这将创建：
- 测试服务
- 会员等级和方案
- 优惠券模板
- 活动
- 价格配置
- 积分规则
- 邀请规则

### 2. 启动后端服务

```bash
# 确保后端服务正在运行
pnpm dev
```

### 3. 执行测试

```bash
# 执行所有测试
ts-node test/marketing/test-runner.ts

# 或使用环境变量
API_URL=http://localhost:3000/api ts-node test/marketing/test-runner.ts
```

### 4. 查看测试报告

测试报告会保存在 `server/test-reports/` 目录下，文件名格式：`test-report-{timestamp}.json`

## 测试内容

### 基础功能测试
- ✅ 会员系统（查看等级、购买会员）
- ✅ 价格引擎（无折扣、会员折扣、优惠券折扣、积分抵扣）
- ✅ 优惠券系统（查看、领取）
- ✅ 积分系统（查看、签到、明细）
- ✅ 邀请系统（邀请码、统计）
- ✅ 活动系统（活动列表）

### 退款测试
- ⏭️ 订单取消退款（需要创建测试订单）
- ⏭️ 订单退款（需要管理员权限）

### 防刷测试
- ✅ 优惠券每人限领
- ✅ 积分每日签到限制
- ⏭️ 邀请防刷（需要新用户注册）
- ⏭️ 秒杀防刷（需要秒杀活动）

### 性能测试
- ✅ 价格计算接口响应时间
- ✅ 优惠券列表接口响应时间
- ✅ 活动列表接口响应时间

## 环境变量

- `API_URL`: API 基础URL（默认: http://localhost:3000/api）
- `TEST_USER_TOKEN`: 测试用户Token（可选，用于需要认证的接口）

## 注意事项

1. **测试数据**: 测试脚本会使用现有的测试数据，不会删除或修改重要数据
2. **跳过测试**: 某些测试需要特定条件（如已创建的订单），会自动跳过
3. **性能测试**: 性能测试结果可能受服务器负载影响
4. **认证**: 部分测试需要用户登录，需要提供有效的 Token

## 手动测试

对于需要手动操作的测试（如订单创建、支付等），请参考 `docs/营销中心/测试执行清单.md` 进行手动测试。

## 测试报告格式

```json
{
  "timestamp": "2024-01-01T00:00:00.000Z",
  "summary": {
    "total": 20,
    "passed": 15,
    "failed": 2,
    "skipped": 3,
    "passRate": "75.0%",
    "avgDuration": "120ms"
  },
  "results": [
    {
      "name": "测试名称",
      "status": "pass|fail|skip",
      "message": "错误信息（如有）",
      "duration": 120
    }
  ]
}
```

